<html>
<head>
<title>query.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #cf8e6d;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #67a37c; font-style: italic;}
.s7 { color: #2aacb8;}
.ln { color: #4b5059; font-weight: normal; font-style: normal; }
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
query.js</font>
</center></td></tr></table>
<pre><a name="l1"><span class="ln">1    </span></a><span class="s0">'use strict'</span><span class="s1">;</span>
<a name="l2"><span class="ln">2    </span></a>
<a name="l3"><span class="ln">3    </span></a><span class="s3">/*! 
<a name="l4"><span class="ln">4    </span></a> * Module dependencies. 
<a name="l5"><span class="ln">5    </span></a> */</span>
<a name="l6"><span class="ln">6    </span></a>
<a name="l7"><span class="ln">7    </span></a><span class="s4">const </span><span class="s2">CastError </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./error/cast'</span><span class="s1">);</span>
<a name="l8"><span class="ln">8    </span></a><span class="s4">const </span><span class="s2">DocumentNotFoundError </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./error/notFound'</span><span class="s1">);</span>
<a name="l9"><span class="ln">9    </span></a><span class="s4">const </span><span class="s2">Kareem </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'kareem'</span><span class="s1">);</span>
<a name="l10"><span class="ln">10   </span></a><span class="s4">const </span><span class="s2">MongooseError </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./error/mongooseError'</span><span class="s1">);</span>
<a name="l11"><span class="ln">11   </span></a><span class="s4">const </span><span class="s2">ObjectParameterError </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./error/objectParameter'</span><span class="s1">);</span>
<a name="l12"><span class="ln">12   </span></a><span class="s4">const </span><span class="s2">QueryCursor </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./cursor/queryCursor'</span><span class="s1">);</span>
<a name="l13"><span class="ln">13   </span></a><span class="s4">const </span><span class="s2">ValidationError </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./error/validation'</span><span class="s1">);</span>
<a name="l14"><span class="ln">14   </span></a><span class="s4">const </span><span class="s1">{ </span><span class="s2">applyGlobalMaxTimeMS</span><span class="s1">, </span><span class="s2">applyGlobalDiskUse </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/query/applyGlobalOption'</span><span class="s1">);</span>
<a name="l15"><span class="ln">15   </span></a><span class="s4">const </span><span class="s2">handleReadPreferenceAliases </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/query/handleReadPreferenceAliases'</span><span class="s1">);</span>
<a name="l16"><span class="ln">16   </span></a><span class="s4">const </span><span class="s2">applyWriteConcern </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/schema/applyWriteConcern'</span><span class="s1">);</span>
<a name="l17"><span class="ln">17   </span></a><span class="s4">const </span><span class="s2">cast </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./cast'</span><span class="s1">);</span>
<a name="l18"><span class="ln">18   </span></a><span class="s4">const </span><span class="s2">castArrayFilters </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/update/castArrayFilters'</span><span class="s1">);</span>
<a name="l19"><span class="ln">19   </span></a><span class="s4">const </span><span class="s2">castNumber </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./cast/number'</span><span class="s1">);</span>
<a name="l20"><span class="ln">20   </span></a><span class="s4">const </span><span class="s2">castUpdate </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/query/castUpdate'</span><span class="s1">);</span>
<a name="l21"><span class="ln">21   </span></a><span class="s4">const </span><span class="s2">clone </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/clone'</span><span class="s1">);</span>
<a name="l22"><span class="ln">22   </span></a><span class="s4">const </span><span class="s2">getDiscriminatorByValue </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/discriminator/getDiscriminatorByValue'</span><span class="s1">);</span>
<a name="l23"><span class="ln">23   </span></a><span class="s4">const </span><span class="s2">helpers </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./queryHelpers'</span><span class="s1">);</span>
<a name="l24"><span class="ln">24   </span></a><span class="s4">const </span><span class="s2">immediate </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/immediate'</span><span class="s1">);</span>
<a name="l25"><span class="ln">25   </span></a><span class="s4">const </span><span class="s2">internalToObjectOptions </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./options'</span><span class="s1">).</span><span class="s2">internalToObjectOptions</span><span class="s1">;</span>
<a name="l26"><span class="ln">26   </span></a><span class="s4">const </span><span class="s2">isExclusive </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/projection/isExclusive'</span><span class="s1">);</span>
<a name="l27"><span class="ln">27   </span></a><span class="s4">const </span><span class="s2">isInclusive </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/projection/isInclusive'</span><span class="s1">);</span>
<a name="l28"><span class="ln">28   </span></a><span class="s4">const </span><span class="s2">isPathSelectedInclusive </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/projection/isPathSelectedInclusive'</span><span class="s1">);</span>
<a name="l29"><span class="ln">29   </span></a><span class="s4">const </span><span class="s2">isSubpath </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/projection/isSubpath'</span><span class="s1">);</span>
<a name="l30"><span class="ln">30   </span></a><span class="s4">const </span><span class="s2">mpath </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'mpath'</span><span class="s1">);</span>
<a name="l31"><span class="ln">31   </span></a><span class="s4">const </span><span class="s2">mquery </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'mquery'</span><span class="s1">);</span>
<a name="l32"><span class="ln">32   </span></a><span class="s4">const </span><span class="s2">parseProjection </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/projection/parseProjection'</span><span class="s1">);</span>
<a name="l33"><span class="ln">33   </span></a><span class="s4">const </span><span class="s2">removeUnusedArrayFilters </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/update/removeUnusedArrayFilters'</span><span class="s1">);</span>
<a name="l34"><span class="ln">34   </span></a><span class="s4">const </span><span class="s2">sanitizeFilter </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/query/sanitizeFilter'</span><span class="s1">);</span>
<a name="l35"><span class="ln">35   </span></a><span class="s4">const </span><span class="s2">sanitizeProjection </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/query/sanitizeProjection'</span><span class="s1">);</span>
<a name="l36"><span class="ln">36   </span></a><span class="s4">const </span><span class="s2">selectPopulatedFields </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/query/selectPopulatedFields'</span><span class="s1">);</span>
<a name="l37"><span class="ln">37   </span></a><span class="s4">const </span><span class="s2">setDefaultsOnInsert </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/setDefaultsOnInsert'</span><span class="s1">);</span>
<a name="l38"><span class="ln">38   </span></a><span class="s4">const </span><span class="s2">specialProperties </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/specialProperties'</span><span class="s1">);</span>
<a name="l39"><span class="ln">39   </span></a><span class="s4">const </span><span class="s2">updateValidators </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./helpers/updateValidators'</span><span class="s1">);</span>
<a name="l40"><span class="ln">40   </span></a><span class="s4">const </span><span class="s2">util </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'util'</span><span class="s1">);</span>
<a name="l41"><span class="ln">41   </span></a><span class="s4">const </span><span class="s2">utils </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./utils'</span><span class="s1">);</span>
<a name="l42"><span class="ln">42   </span></a><span class="s4">const </span><span class="s2">queryMiddlewareFunctions </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./constants'</span><span class="s1">).</span><span class="s2">queryMiddlewareFunctions</span><span class="s1">;</span>
<a name="l43"><span class="ln">43   </span></a>
<a name="l44"><span class="ln">44   </span></a><span class="s4">const </span><span class="s2">queryOptionMethods </span><span class="s1">= </span><span class="s4">new </span><span class="s2">Set</span><span class="s1">([</span>
<a name="l45"><span class="ln">45   </span></a>  <span class="s0">'allowDiskUse'</span><span class="s1">,</span>
<a name="l46"><span class="ln">46   </span></a>  <span class="s0">'batchSize'</span><span class="s1">,</span>
<a name="l47"><span class="ln">47   </span></a>  <span class="s0">'collation'</span><span class="s1">,</span>
<a name="l48"><span class="ln">48   </span></a>  <span class="s0">'comment'</span><span class="s1">,</span>
<a name="l49"><span class="ln">49   </span></a>  <span class="s0">'explain'</span><span class="s1">,</span>
<a name="l50"><span class="ln">50   </span></a>  <span class="s0">'hint'</span><span class="s1">,</span>
<a name="l51"><span class="ln">51   </span></a>  <span class="s0">'j'</span><span class="s1">,</span>
<a name="l52"><span class="ln">52   </span></a>  <span class="s0">'lean'</span><span class="s1">,</span>
<a name="l53"><span class="ln">53   </span></a>  <span class="s0">'limit'</span><span class="s1">,</span>
<a name="l54"><span class="ln">54   </span></a>  <span class="s0">'maxTimeMS'</span><span class="s1">,</span>
<a name="l55"><span class="ln">55   </span></a>  <span class="s0">'populate'</span><span class="s1">,</span>
<a name="l56"><span class="ln">56   </span></a>  <span class="s0">'projection'</span><span class="s1">,</span>
<a name="l57"><span class="ln">57   </span></a>  <span class="s0">'read'</span><span class="s1">,</span>
<a name="l58"><span class="ln">58   </span></a>  <span class="s0">'select'</span><span class="s1">,</span>
<a name="l59"><span class="ln">59   </span></a>  <span class="s0">'skip'</span><span class="s1">,</span>
<a name="l60"><span class="ln">60   </span></a>  <span class="s0">'slice'</span><span class="s1">,</span>
<a name="l61"><span class="ln">61   </span></a>  <span class="s0">'sort'</span><span class="s1">,</span>
<a name="l62"><span class="ln">62   </span></a>  <span class="s0">'tailable'</span><span class="s1">,</span>
<a name="l63"><span class="ln">63   </span></a>  <span class="s0">'w'</span><span class="s1">,</span>
<a name="l64"><span class="ln">64   </span></a>  <span class="s0">'writeConcern'</span><span class="s1">,</span>
<a name="l65"><span class="ln">65   </span></a>  <span class="s0">'wtimeout'</span>
<a name="l66"><span class="ln">66   </span></a><span class="s1">]);</span>
<a name="l67"><span class="ln">67   </span></a>
<a name="l68"><span class="ln">68   </span></a><span class="s5">/**</span>
<a name="l69"><span class="ln">69   </span></a> <span class="s5">* Query constructor used for building queries. You do not need</span>
<a name="l70"><span class="ln">70   </span></a> <span class="s5">* to instantiate a `Query` directly. Instead use Model functions like</span>
<a name="l71"><span class="ln">71   </span></a> <span class="s5">* [`Model.find()`](https://mongoosejs.com/docs/api/model.html#Model.find()).</span>
<a name="l72"><span class="ln">72   </span></a> <span class="s5">*</span>
<a name="l73"><span class="ln">73   </span></a> <span class="s5">* #### Example:</span>
<a name="l74"><span class="ln">74   </span></a> <span class="s5">*</span>
<a name="l75"><span class="ln">75   </span></a> <span class="s5">*     const query = MyModel.find(); // `query` is an instance of `Query`</span>
<a name="l76"><span class="ln">76   </span></a> <span class="s5">*     query.setOptions({ lean : true });</span>
<a name="l77"><span class="ln">77   </span></a> <span class="s5">*     query.collection(MyModel.collection);</span>
<a name="l78"><span class="ln">78   </span></a> <span class="s5">*     query.where('age').gte(21).exec(callback);</span>
<a name="l79"><span class="ln">79   </span></a> <span class="s5">*</span>
<a name="l80"><span class="ln">80   </span></a> <span class="s5">*     // You can instantiate a query directly. There is no need to do</span>
<a name="l81"><span class="ln">81   </span></a> <span class="s5">*     // this unless you're an advanced user with a very good reason to.</span>
<a name="l82"><span class="ln">82   </span></a> <span class="s5">*     const query = new mongoose.Query();</span>
<a name="l83"><span class="ln">83   </span></a> <span class="s5">*</span>
<a name="l84"><span class="ln">84   </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l85"><span class="ln">85   </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [model]</span>
<a name="l86"><span class="ln">86   </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [conditions]</span>
<a name="l87"><span class="ln">87   </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [collection] Mongoose collection</span>
<a name="l88"><span class="ln">88   </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l89"><span class="ln">89   </span></a> <span class="s5">*/</span>
<a name="l90"><span class="ln">90   </span></a>
<a name="l91"><span class="ln">91   </span></a><span class="s4">function </span><span class="s2">Query</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">model</span><span class="s1">, </span><span class="s2">collection</span><span class="s1">) {</span>
<a name="l92"><span class="ln">92   </span></a>  <span class="s3">// this stuff is for dealing with custom queries created by #toConstructor</span>
<a name="l93"><span class="ln">93   </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">) {</span>
<a name="l94"><span class="ln">94   </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions </span><span class="s1">= {};</span>
<a name="l95"><span class="ln">95   </span></a>  <span class="s1">}</span>
<a name="l96"><span class="ln">96   </span></a>  <span class="s2">options </span><span class="s1">= </span><span class="s2">options </span><span class="s1">|| {};</span>
<a name="l97"><span class="ln">97   </span></a>
<a name="l98"><span class="ln">98   </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_transforms </span><span class="s1">= [];</span>
<a name="l99"><span class="ln">99   </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_hooks </span><span class="s1">= </span><span class="s4">new </span><span class="s2">Kareem</span><span class="s1">();</span>
<a name="l100"><span class="ln">100  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_executionStack </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l101"><span class="ln">101  </span></a>
<a name="l102"><span class="ln">102  </span></a>  <span class="s3">// this is the case where we have a CustomQuery, we need to check if we got</span>
<a name="l103"><span class="ln">103  </span></a>  <span class="s3">// options passed in, and if we did, merge them in</span>
<a name="l104"><span class="ln">104  </span></a>  <span class="s4">const </span><span class="s2">keys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l105"><span class="ln">105  </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">key of keys</span><span class="s1">) {</span>
<a name="l106"><span class="ln">106  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
<a name="l107"><span class="ln">107  </span></a>  <span class="s1">}</span>
<a name="l108"><span class="ln">108  </span></a>
<a name="l109"><span class="ln">109  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">collection</span><span class="s1">) {</span>
<a name="l110"><span class="ln">110  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">mongooseCollection </span><span class="s1">= </span><span class="s2">collection</span><span class="s1">;</span>
<a name="l111"><span class="ln">111  </span></a>  <span class="s1">}</span>
<a name="l112"><span class="ln">112  </span></a>
<a name="l113"><span class="ln">113  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">model</span><span class="s1">) {</span>
<a name="l114"><span class="ln">114  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">= </span><span class="s2">model</span><span class="s1">;</span>
<a name="l115"><span class="ln">115  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">= </span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">;</span>
<a name="l116"><span class="ln">116  </span></a>  <span class="s1">}</span>
<a name="l117"><span class="ln">117  </span></a>
<a name="l118"><span class="ln">118  </span></a>  <span class="s3">// this is needed because map reduce returns a model that can be queried, but</span>
<a name="l119"><span class="ln">119  </span></a>  <span class="s3">// all of the queries on said model should be lean</span>
<a name="l120"><span class="ln">120  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">_mapreduce</span><span class="s1">) {</span>
<a name="l121"><span class="ln">121  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">();</span>
<a name="l122"><span class="ln">122  </span></a>  <span class="s1">}</span>
<a name="l123"><span class="ln">123  </span></a>
<a name="l124"><span class="ln">124  </span></a>  <span class="s3">// inherit mquery</span>
<a name="l125"><span class="ln">125  </span></a>  <span class="s2">mquery</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l126"><span class="ln">126  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">collection</span><span class="s1">) {</span>
<a name="l127"><span class="ln">127  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">collection</span><span class="s1">(</span><span class="s2">collection</span><span class="s1">);</span>
<a name="l128"><span class="ln">128  </span></a>  <span class="s1">}</span>
<a name="l129"><span class="ln">129  </span></a>
<a name="l130"><span class="ln">130  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">) {</span>
<a name="l131"><span class="ln">131  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">);</span>
<a name="l132"><span class="ln">132  </span></a>  <span class="s1">}</span>
<a name="l133"><span class="ln">133  </span></a>
<a name="l134"><span class="ln">134  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">|| {};</span>
<a name="l135"><span class="ln">135  </span></a>
<a name="l136"><span class="ln">136  </span></a>  <span class="s3">// For gh-6880. mquery still needs to support `fields` by default for old</span>
<a name="l137"><span class="ln">137  </span></a>  <span class="s3">// versions of MongoDB</span>
<a name="l138"><span class="ln">138  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">$useProjection </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l139"><span class="ln">139  </span></a>
<a name="l140"><span class="ln">140  </span></a>  <span class="s4">const </span><span class="s2">collation </span><span class="s1">= </span><span class="s4">this </span><span class="s1">&amp;&amp;</span>
<a name="l141"><span class="ln">141  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">&amp;&amp;</span>
<a name="l142"><span class="ln">142  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp;</span>
<a name="l143"><span class="ln">143  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">collation </span><span class="s1">|| </span><span class="s4">null</span><span class="s1">;</span>
<a name="l144"><span class="ln">144  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">collation </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l145"><span class="ln">145  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">collation </span><span class="s1">= </span><span class="s2">collation</span><span class="s1">;</span>
<a name="l146"><span class="ln">146  </span></a>  <span class="s1">}</span>
<a name="l147"><span class="ln">147  </span></a><span class="s1">}</span>
<a name="l148"><span class="ln">148  </span></a>
<a name="l149"><span class="ln">149  </span></a><span class="s3">/*! 
<a name="l150"><span class="ln">150  </span></a> * inherit mquery 
<a name="l151"><span class="ln">151  </span></a> */</span>
<a name="l152"><span class="ln">152  </span></a>
<a name="l153"><span class="ln">153  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype </span><span class="s1">= </span><span class="s4">new </span><span class="s2">mquery</span><span class="s1">();</span>
<a name="l154"><span class="ln">154  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">constructor </span><span class="s1">= </span><span class="s2">Query</span><span class="s1">;</span>
<a name="l155"><span class="ln">155  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">base </span><span class="s1">= </span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">;</span>
<a name="l156"><span class="ln">156  </span></a>
<a name="l157"><span class="ln">157  </span></a><span class="s3">/*! 
<a name="l158"><span class="ln">158  </span></a> * Overwrite mquery's `_distinct`, because Mongoose uses that name 
<a name="l159"><span class="ln">159  </span></a> * to store the field to apply distinct on. 
<a name="l160"><span class="ln">160  </span></a> */</span>
<a name="l161"><span class="ln">161  </span></a>
<a name="l162"><span class="ln">162  </span></a><span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s0">'_distinct'</span><span class="s1">, {</span>
<a name="l163"><span class="ln">163  </span></a>  <span class="s2">configurable</span><span class="s1">: </span><span class="s4">true</span><span class="s1">,</span>
<a name="l164"><span class="ln">164  </span></a>  <span class="s2">writable</span><span class="s1">: </span><span class="s4">true</span><span class="s1">,</span>
<a name="l165"><span class="ln">165  </span></a>  <span class="s2">enumerable</span><span class="s1">: </span><span class="s4">true</span><span class="s1">,</span>
<a name="l166"><span class="ln">166  </span></a>  <span class="s2">value</span><span class="s1">: </span><span class="s2">undefined</span>
<a name="l167"><span class="ln">167  </span></a><span class="s1">});</span>
<a name="l168"><span class="ln">168  </span></a>
<a name="l169"><span class="ln">169  </span></a><span class="s5">/**</span>
<a name="l170"><span class="ln">170  </span></a> <span class="s5">* Flag to opt out of using `$geoWithin`.</span>
<a name="l171"><span class="ln">171  </span></a> <span class="s5">*</span>
<a name="l172"><span class="ln">172  </span></a> <span class="s5">* ```javascript</span>
<a name="l173"><span class="ln">173  </span></a> <span class="s5">* mongoose.Query.use$geoWithin = false;</span>
<a name="l174"><span class="ln">174  </span></a> <span class="s5">* ```</span>
<a name="l175"><span class="ln">175  </span></a> <span class="s5">*</span>
<a name="l176"><span class="ln">176  </span></a> <span class="s5">* MongoDB 2.4 deprecated the use of `$within`, replacing it with `$geoWithin`. Mongoose uses `$geoWithin` by default (which is 100% backward compatible with `$within`). If you are running an older version of MongoDB, set this flag to `false` so your `within()` queries continue to work.</span>
<a name="l177"><span class="ln">177  </span></a> <span class="s5">*</span>
<a name="l178"><span class="ln">178  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">geoWithin https://www.mongodb.com/docs/manual/reference/operator/geoWithin/</span>
<a name="l179"><span class="ln">179  </span></a> <span class="s5">* </span><span class="s6">@default </span><span class="s5">true</span>
<a name="l180"><span class="ln">180  </span></a> <span class="s5">* </span><span class="s6">@property </span><span class="s5">use$geoWithin</span>
<a name="l181"><span class="ln">181  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l182"><span class="ln">182  </span></a> <span class="s5">* </span><span class="s6">@static</span>
<a name="l183"><span class="ln">183  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l184"><span class="ln">184  </span></a> <span class="s5">*/</span>
<a name="l185"><span class="ln">185  </span></a>
<a name="l186"><span class="ln">186  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">use$geoWithin </span><span class="s1">= </span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">use$geoWithin</span><span class="s1">;</span>
<a name="l187"><span class="ln">187  </span></a>
<a name="l188"><span class="ln">188  </span></a><span class="s5">/**</span>
<a name="l189"><span class="ln">189  </span></a> <span class="s5">* Converts this query to a customized, reusable query constructor with all arguments and options retained.</span>
<a name="l190"><span class="ln">190  </span></a> <span class="s5">*</span>
<a name="l191"><span class="ln">191  </span></a> <span class="s5">* #### Example:</span>
<a name="l192"><span class="ln">192  </span></a> <span class="s5">*</span>
<a name="l193"><span class="ln">193  </span></a> <span class="s5">*     // Create a query for adventure movies and read from the primary</span>
<a name="l194"><span class="ln">194  </span></a> <span class="s5">*     // node in the replica-set unless it is down, in which case we'll</span>
<a name="l195"><span class="ln">195  </span></a> <span class="s5">*     // read from a secondary node.</span>
<a name="l196"><span class="ln">196  </span></a> <span class="s5">*     const query = Movie.find({ tags: 'adventure' }).read('primaryPreferred');</span>
<a name="l197"><span class="ln">197  </span></a> <span class="s5">*</span>
<a name="l198"><span class="ln">198  </span></a> <span class="s5">*     // create a custom Query constructor based off these settings</span>
<a name="l199"><span class="ln">199  </span></a> <span class="s5">*     const Adventure = query.toConstructor();</span>
<a name="l200"><span class="ln">200  </span></a> <span class="s5">*</span>
<a name="l201"><span class="ln">201  </span></a> <span class="s5">*     // further narrow down our query results while still using the previous settings</span>
<a name="l202"><span class="ln">202  </span></a> <span class="s5">*     await Adventure().where({ name: /^Life/ }).exec();</span>
<a name="l203"><span class="ln">203  </span></a> <span class="s5">*</span>
<a name="l204"><span class="ln">204  </span></a> <span class="s5">*     // since Adventure is a stand-alone constructor we can also add our own</span>
<a name="l205"><span class="ln">205  </span></a> <span class="s5">*     // helper methods and getters without impacting global queries</span>
<a name="l206"><span class="ln">206  </span></a> <span class="s5">*     Adventure.prototype.startsWith = function (prefix) {</span>
<a name="l207"><span class="ln">207  </span></a> <span class="s5">*       this.where({ name: new RegExp('^' + prefix) })</span>
<a name="l208"><span class="ln">208  </span></a> <span class="s5">*       return this;</span>
<a name="l209"><span class="ln">209  </span></a> <span class="s5">*     }</span>
<a name="l210"><span class="ln">210  </span></a> <span class="s5">*     Object.defineProperty(Adventure.prototype, 'highlyRated', {</span>
<a name="l211"><span class="ln">211  </span></a> <span class="s5">*       get: function () {</span>
<a name="l212"><span class="ln">212  </span></a> <span class="s5">*         this.where({ rating: { $gt: 4.5 }});</span>
<a name="l213"><span class="ln">213  </span></a> <span class="s5">*         return this;</span>
<a name="l214"><span class="ln">214  </span></a> <span class="s5">*       }</span>
<a name="l215"><span class="ln">215  </span></a> <span class="s5">*     })</span>
<a name="l216"><span class="ln">216  </span></a> <span class="s5">*     await Adventure().highlyRated.startsWith('Life').exec();</span>
<a name="l217"><span class="ln">217  </span></a> <span class="s5">*</span>
<a name="l218"><span class="ln">218  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} subclass-of-Query</span>
<a name="l219"><span class="ln">219  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l220"><span class="ln">220  </span></a> <span class="s5">*/</span>
<a name="l221"><span class="ln">221  </span></a>
<a name="l222"><span class="ln">222  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">toConstructor </span><span class="s1">= </span><span class="s4">function </span><span class="s2">toConstructor</span><span class="s1">() {</span>
<a name="l223"><span class="ln">223  </span></a>  <span class="s4">const </span><span class="s2">model </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">;</span>
<a name="l224"><span class="ln">224  </span></a>  <span class="s4">const </span><span class="s2">coll </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">;</span>
<a name="l225"><span class="ln">225  </span></a>
<a name="l226"><span class="ln">226  </span></a>  <span class="s4">const </span><span class="s2">CustomQuery </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">criteria</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l227"><span class="ln">227  </span></a>    <span class="s4">if </span><span class="s1">(!(</span><span class="s4">this instanceof </span><span class="s2">CustomQuery</span><span class="s1">)) {</span>
<a name="l228"><span class="ln">228  </span></a>      <span class="s4">return new </span><span class="s2">CustomQuery</span><span class="s1">(</span><span class="s2">criteria</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l229"><span class="ln">229  </span></a>    <span class="s1">}</span>
<a name="l230"><span class="ln">230  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s2">p</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">);</span>
<a name="l231"><span class="ln">231  </span></a>    <span class="s2">Query</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">criteria</span><span class="s1">, </span><span class="s2">options </span><span class="s1">|| </span><span class="s4">null</span><span class="s1">, </span><span class="s2">model</span><span class="s1">, </span><span class="s2">coll</span><span class="s1">);</span>
<a name="l232"><span class="ln">232  </span></a>  <span class="s1">};</span>
<a name="l233"><span class="ln">233  </span></a>
<a name="l234"><span class="ln">234  </span></a>  <span class="s2">util</span><span class="s1">.</span><span class="s2">inherits</span><span class="s1">(</span><span class="s2">CustomQuery</span><span class="s1">, </span><span class="s2">model</span><span class="s1">.</span><span class="s2">Query</span><span class="s1">);</span>
<a name="l235"><span class="ln">235  </span></a>
<a name="l236"><span class="ln">236  </span></a>  <span class="s3">// set inherited defaults</span>
<a name="l237"><span class="ln">237  </span></a>  <span class="s4">const </span><span class="s2">p </span><span class="s1">= </span><span class="s2">CustomQuery</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">;</span>
<a name="l238"><span class="ln">238  </span></a>
<a name="l239"><span class="ln">239  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= {};</span>
<a name="l240"><span class="ln">240  </span></a>
<a name="l241"><span class="ln">241  </span></a>  <span class="s3">// Need to handle `sort()` separately because entries-style `sort()` syntax</span>
<a name="l242"><span class="ln">242  </span></a>  <span class="s3">// `sort([['prop1', 1]])` confuses mquery into losing the outer nested array.</span>
<a name="l243"><span class="ln">243  </span></a>  <span class="s3">// See gh-8159</span>
<a name="l244"><span class="ln">244  </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l245"><span class="ln">245  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l246"><span class="ln">246  </span></a>    <span class="s2">p</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">);</span>
<a name="l247"><span class="ln">247  </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">;</span>
<a name="l248"><span class="ln">248  </span></a>  <span class="s1">}</span>
<a name="l249"><span class="ln">249  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l250"><span class="ln">250  </span></a>
<a name="l251"><span class="ln">251  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">;</span>
<a name="l252"><span class="ln">252  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l253"><span class="ln">253  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_conditions </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">);</span>
<a name="l254"><span class="ln">254  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l255"><span class="ln">255  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, {</span>
<a name="l256"><span class="ln">256  </span></a>    <span class="s2">flattenDecimals</span><span class="s1">: </span><span class="s4">false</span>
<a name="l257"><span class="ln">257  </span></a>  <span class="s1">});</span>
<a name="l258"><span class="ln">258  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_path</span><span class="s1">;</span>
<a name="l259"><span class="ln">259  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_distinct </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">;</span>
<a name="l260"><span class="ln">260  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_collection </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_collection</span><span class="s1">;</span>
<a name="l261"><span class="ln">261  </span></a>  <span class="s2">p</span><span class="s1">.</span><span class="s2">_mongooseOptions </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">;</span>
<a name="l262"><span class="ln">262  </span></a>
<a name="l263"><span class="ln">263  </span></a>  <span class="s4">return </span><span class="s2">CustomQuery</span><span class="s1">;</span>
<a name="l264"><span class="ln">264  </span></a><span class="s1">};</span>
<a name="l265"><span class="ln">265  </span></a>
<a name="l266"><span class="ln">266  </span></a><span class="s5">/**</span>
<a name="l267"><span class="ln">267  </span></a> <span class="s5">* Make a copy of this query so you can re-execute it.</span>
<a name="l268"><span class="ln">268  </span></a> <span class="s5">*</span>
<a name="l269"><span class="ln">269  </span></a> <span class="s5">* #### Example:</span>
<a name="l270"><span class="ln">270  </span></a> <span class="s5">*</span>
<a name="l271"><span class="ln">271  </span></a> <span class="s5">*     const q = Book.findOne({ title: 'Casino Royale' });</span>
<a name="l272"><span class="ln">272  </span></a> <span class="s5">*     await q.exec();</span>
<a name="l273"><span class="ln">273  </span></a> <span class="s5">*     await q.exec(); // Throws an error because you can't execute a query twice</span>
<a name="l274"><span class="ln">274  </span></a> <span class="s5">*</span>
<a name="l275"><span class="ln">275  </span></a> <span class="s5">*     await q.clone().exec(); // Works</span>
<a name="l276"><span class="ln">276  </span></a> <span class="s5">*</span>
<a name="l277"><span class="ln">277  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">clone</span>
<a name="l278"><span class="ln">278  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} copy</span>
<a name="l279"><span class="ln">279  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l280"><span class="ln">280  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l281"><span class="ln">281  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l282"><span class="ln">282  </span></a> <span class="s5">*/</span>
<a name="l283"><span class="ln">283  </span></a>
<a name="l284"><span class="ln">284  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">clone </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l285"><span class="ln">285  </span></a>  <span class="s4">const </span><span class="s2">model </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">;</span>
<a name="l286"><span class="ln">286  </span></a>  <span class="s4">const </span><span class="s2">collection </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">;</span>
<a name="l287"><span class="ln">287  </span></a>
<a name="l288"><span class="ln">288  </span></a>  <span class="s4">const </span><span class="s2">q </span><span class="s1">= </span><span class="s4">new this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">Query</span><span class="s1">({}, {}, </span><span class="s2">model</span><span class="s1">, </span><span class="s2">collection</span><span class="s1">);</span>
<a name="l289"><span class="ln">289  </span></a>
<a name="l290"><span class="ln">290  </span></a>  <span class="s3">// Need to handle `sort()` separately because entries-style `sort()` syntax</span>
<a name="l291"><span class="ln">291  </span></a>  <span class="s3">// `sort([['prop1', 1]])` confuses mquery into losing the outer nested array.</span>
<a name="l292"><span class="ln">292  </span></a>  <span class="s3">// See gh-8159</span>
<a name="l293"><span class="ln">293  </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l294"><span class="ln">294  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l295"><span class="ln">295  </span></a>    <span class="s2">q</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">);</span>
<a name="l296"><span class="ln">296  </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">;</span>
<a name="l297"><span class="ln">297  </span></a>  <span class="s1">}</span>
<a name="l298"><span class="ln">298  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l299"><span class="ln">299  </span></a>
<a name="l300"><span class="ln">300  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">;</span>
<a name="l301"><span class="ln">301  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l302"><span class="ln">302  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_conditions </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">);</span>
<a name="l303"><span class="ln">303  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l304"><span class="ln">304  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, {</span>
<a name="l305"><span class="ln">305  </span></a>    <span class="s2">flattenDecimals</span><span class="s1">: </span><span class="s4">false</span>
<a name="l306"><span class="ln">306  </span></a>  <span class="s1">});</span>
<a name="l307"><span class="ln">307  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_path</span><span class="s1">;</span>
<a name="l308"><span class="ln">308  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_distinct </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">;</span>
<a name="l309"><span class="ln">309  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_collection </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_collection</span><span class="s1">;</span>
<a name="l310"><span class="ln">310  </span></a>  <span class="s2">q</span><span class="s1">.</span><span class="s2">_mongooseOptions </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">;</span>
<a name="l311"><span class="ln">311  </span></a>
<a name="l312"><span class="ln">312  </span></a>  <span class="s4">return </span><span class="s2">q</span><span class="s1">;</span>
<a name="l313"><span class="ln">313  </span></a><span class="s1">};</span>
<a name="l314"><span class="ln">314  </span></a>
<a name="l315"><span class="ln">315  </span></a><span class="s5">/**</span>
<a name="l316"><span class="ln">316  </span></a> <span class="s5">* Specifies a javascript function or expression to pass to MongoDBs query system.</span>
<a name="l317"><span class="ln">317  </span></a> <span class="s5">*</span>
<a name="l318"><span class="ln">318  </span></a> <span class="s5">* #### Example:</span>
<a name="l319"><span class="ln">319  </span></a> <span class="s5">*</span>
<a name="l320"><span class="ln">320  </span></a> <span class="s5">*     query.$where('this.comments.length === 10 || this.name.length === 5')</span>
<a name="l321"><span class="ln">321  </span></a> <span class="s5">*</span>
<a name="l322"><span class="ln">322  </span></a> <span class="s5">*     // or</span>
<a name="l323"><span class="ln">323  </span></a> <span class="s5">*</span>
<a name="l324"><span class="ln">324  </span></a> <span class="s5">*     query.$where(function () {</span>
<a name="l325"><span class="ln">325  </span></a> <span class="s5">*       return this.comments.length === 10 || this.name.length === 5;</span>
<a name="l326"><span class="ln">326  </span></a> <span class="s5">*     })</span>
<a name="l327"><span class="ln">327  </span></a> <span class="s5">*</span>
<a name="l328"><span class="ln">328  </span></a> <span class="s5">* #### Note:</span>
<a name="l329"><span class="ln">329  </span></a> <span class="s5">*</span>
<a name="l330"><span class="ln">330  </span></a> <span class="s5">* Only use `$where` when you have a condition that cannot be met using other MongoDB operators like `$lt`.</span>
<a name="l331"><span class="ln">331  </span></a> <span class="s5">* **Be sure to read about all of [its caveats](https://www.mongodb.com/docs/manual/reference/operator/where/) before using.**</span>
<a name="l332"><span class="ln">332  </span></a> <span class="s5">*</span>
<a name="l333"><span class="ln">333  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$where https://www.mongodb.com/docs/manual/reference/operator/where/</span>
<a name="l334"><span class="ln">334  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">$where</span>
<a name="l335"><span class="ln">335  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|Function} js javascript string or function</span>
<a name="l336"><span class="ln">336  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l337"><span class="ln">337  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l338"><span class="ln">338  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l339"><span class="ln">339  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">$where</span>
<a name="l340"><span class="ln">340  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l341"><span class="ln">341  </span></a> <span class="s5">*/</span>
<a name="l342"><span class="ln">342  </span></a>
<a name="l343"><span class="ln">343  </span></a><span class="s5">/**</span>
<a name="l344"><span class="ln">344  </span></a> <span class="s5">* Specifies a `path` for use with chaining.</span>
<a name="l345"><span class="ln">345  </span></a> <span class="s5">*</span>
<a name="l346"><span class="ln">346  </span></a> <span class="s5">* #### Example:</span>
<a name="l347"><span class="ln">347  </span></a> <span class="s5">*</span>
<a name="l348"><span class="ln">348  </span></a> <span class="s5">*     // instead of writing:</span>
<a name="l349"><span class="ln">349  </span></a> <span class="s5">*     User.find({age: {$gte: 21, $lte: 65}});</span>
<a name="l350"><span class="ln">350  </span></a> <span class="s5">*</span>
<a name="l351"><span class="ln">351  </span></a> <span class="s5">*     // we can instead write:</span>
<a name="l352"><span class="ln">352  </span></a> <span class="s5">*     User.where('age').gte(21).lte(65);</span>
<a name="l353"><span class="ln">353  </span></a> <span class="s5">*</span>
<a name="l354"><span class="ln">354  </span></a> <span class="s5">*     // passing query conditions is permitted</span>
<a name="l355"><span class="ln">355  </span></a> <span class="s5">*     User.find().where({ name: 'vonderful' })</span>
<a name="l356"><span class="ln">356  </span></a> <span class="s5">*</span>
<a name="l357"><span class="ln">357  </span></a> <span class="s5">*     // chaining</span>
<a name="l358"><span class="ln">358  </span></a> <span class="s5">*     User</span>
<a name="l359"><span class="ln">359  </span></a> <span class="s5">*     .where('age').gte(21).lte(65)</span>
<a name="l360"><span class="ln">360  </span></a> <span class="s5">*     .where('name', /^vonderful/i)</span>
<a name="l361"><span class="ln">361  </span></a> <span class="s5">*     .where('friends').slice(10)</span>
<a name="l362"><span class="ln">362  </span></a> <span class="s5">*     .exec()</span>
<a name="l363"><span class="ln">363  </span></a> <span class="s5">*</span>
<a name="l364"><span class="ln">364  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">where</span>
<a name="l365"><span class="ln">365  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l366"><span class="ln">366  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l367"><span class="ln">367  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|Object} [path]</span>
<a name="l368"><span class="ln">368  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{any} [val]</span>
<a name="l369"><span class="ln">369  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l370"><span class="ln">370  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l371"><span class="ln">371  </span></a> <span class="s5">*/</span>
<a name="l372"><span class="ln">372  </span></a>
<a name="l373"><span class="ln">373  </span></a><span class="s5">/**</span>
<a name="l374"><span class="ln">374  </span></a> <span class="s5">* Specifies a `$slice` projection for an array.</span>
<a name="l375"><span class="ln">375  </span></a> <span class="s5">*</span>
<a name="l376"><span class="ln">376  </span></a> <span class="s5">* #### Example:</span>
<a name="l377"><span class="ln">377  </span></a> <span class="s5">*</span>
<a name="l378"><span class="ln">378  </span></a> <span class="s5">*     query.slice('comments', 5); // Returns the first 5 comments</span>
<a name="l379"><span class="ln">379  </span></a> <span class="s5">*     query.slice('comments', -5); // Returns the last 5 comments</span>
<a name="l380"><span class="ln">380  </span></a> <span class="s5">*     query.slice('comments', [10, 5]); // Returns the first 5 comments after the 10-th</span>
<a name="l381"><span class="ln">381  </span></a> <span class="s5">*     query.where('comments').slice(5); // Returns the first 5 comments</span>
<a name="l382"><span class="ln">382  </span></a> <span class="s5">*     query.where('comments').slice([-10, 5]); // Returns the first 5 comments after the 10-th to last</span>
<a name="l383"><span class="ln">383  </span></a> <span class="s5">*</span>
<a name="l384"><span class="ln">384  </span></a> <span class="s5">* **Note:** If the absolute value of the number of elements to be sliced is greater than the number of elements in the array, all array elements will be returned.</span>
<a name="l385"><span class="ln">385  </span></a> <span class="s5">*</span>
<a name="l386"><span class="ln">386  </span></a> <span class="s5">*      // Given `arr`: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span>
<a name="l387"><span class="ln">387  </span></a> <span class="s5">*      query.slice('arr', 20); // Returns [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span>
<a name="l388"><span class="ln">388  </span></a> <span class="s5">*      query.slice('arr', -20); // Returns [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span>
<a name="l389"><span class="ln">389  </span></a> <span class="s5">*</span>
<a name="l390"><span class="ln">390  </span></a> <span class="s5">* **Note:** If the number of elements to skip is positive and greater than the number of elements in the array, an empty array will be returned.</span>
<a name="l391"><span class="ln">391  </span></a> <span class="s5">*</span>
<a name="l392"><span class="ln">392  </span></a> <span class="s5">*      // Given `arr`: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span>
<a name="l393"><span class="ln">393  </span></a> <span class="s5">*      query.slice('arr', [20, 5]); // Returns []</span>
<a name="l394"><span class="ln">394  </span></a> <span class="s5">*</span>
<a name="l395"><span class="ln">395  </span></a> <span class="s5">* **Note:** If the number of elements to skip is negative and its absolute value is greater than the number of elements in the array, the starting position is the start of the array.</span>
<a name="l396"><span class="ln">396  </span></a> <span class="s5">*</span>
<a name="l397"><span class="ln">397  </span></a> <span class="s5">*      // Given `arr`: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span>
<a name="l398"><span class="ln">398  </span></a> <span class="s5">*      query.slice('arr', [-20, 5]); // Returns [1, 2, 3, 4, 5]</span>
<a name="l399"><span class="ln">399  </span></a> <span class="s5">*</span>
<a name="l400"><span class="ln">400  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">slice</span>
<a name="l401"><span class="ln">401  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l402"><span class="ln">402  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l403"><span class="ln">403  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l404"><span class="ln">404  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number|Array} val number of elements to slice or array with number of elements to skip and number of elements to slice</span>
<a name="l405"><span class="ln">405  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l406"><span class="ln">406  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">mongodb https://www.mongodb.com/docs/manual/tutorial/query-documents/#projection</span>
<a name="l407"><span class="ln">407  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$slice https://www.mongodb.com/docs/manual/reference/projection/slice/#prj._S_slice</span>
<a name="l408"><span class="ln">408  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l409"><span class="ln">409  </span></a> <span class="s5">*/</span>
<a name="l410"><span class="ln">410  </span></a>
<a name="l411"><span class="ln">411  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l412"><span class="ln">412  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l413"><span class="ln">413  </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l414"><span class="ln">414  </span></a>  <span class="s1">}</span>
<a name="l415"><span class="ln">415  </span></a>
<a name="l416"><span class="ln">416  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validate</span><span class="s1">(</span><span class="s0">'slice'</span><span class="s1">);</span>
<a name="l417"><span class="ln">417  </span></a>
<a name="l418"><span class="ln">418  </span></a>  <span class="s4">let </span><span class="s2">path</span><span class="s1">;</span>
<a name="l419"><span class="ln">419  </span></a>  <span class="s4">let </span><span class="s2">val</span><span class="s1">;</span>
<a name="l420"><span class="ln">420  </span></a>
<a name="l421"><span class="ln">421  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">1</span><span class="s1">) {</span>
<a name="l422"><span class="ln">422  </span></a>    <span class="s4">const </span><span class="s2">arg </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l423"><span class="ln">423  </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arg </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; !</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">)) {</span>
<a name="l424"><span class="ln">424  </span></a>      <span class="s4">const </span><span class="s2">keys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">);</span>
<a name="l425"><span class="ln">425  </span></a>      <span class="s4">const </span><span class="s2">numKeys </span><span class="s1">= </span><span class="s2">keys</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
<a name="l426"><span class="ln">426  </span></a>      <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">numKeys</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
<a name="l427"><span class="ln">427  </span></a>        <span class="s4">this</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">keys</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">arg</span><span class="s1">[</span><span class="s2">keys</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]);</span>
<a name="l428"><span class="ln">428  </span></a>      <span class="s1">}</span>
<a name="l429"><span class="ln">429  </span></a>      <span class="s4">return this</span><span class="s1">;</span>
<a name="l430"><span class="ln">430  </span></a>    <span class="s1">}</span>
<a name="l431"><span class="ln">431  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_ensurePath</span><span class="s1">(</span><span class="s0">'slice'</span><span class="s1">);</span>
<a name="l432"><span class="ln">432  </span></a>    <span class="s2">path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_path</span><span class="s1">;</span>
<a name="l433"><span class="ln">433  </span></a>    <span class="s2">val </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l434"><span class="ln">434  </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">2</span><span class="s1">) {</span>
<a name="l435"><span class="ln">435  </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s0">'number' </span><span class="s1">=== </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
<a name="l436"><span class="ln">436  </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_ensurePath</span><span class="s1">(</span><span class="s0">'slice'</span><span class="s1">);</span>
<a name="l437"><span class="ln">437  </span></a>      <span class="s2">path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_path</span><span class="s1">;</span>
<a name="l438"><span class="ln">438  </span></a>      <span class="s2">val </span><span class="s1">= [</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]];</span>
<a name="l439"><span class="ln">439  </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l440"><span class="ln">440  </span></a>      <span class="s2">path </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l441"><span class="ln">441  </span></a>      <span class="s2">val </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
<a name="l442"><span class="ln">442  </span></a>    <span class="s1">}</span>
<a name="l443"><span class="ln">443  </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">3</span><span class="s1">) {</span>
<a name="l444"><span class="ln">444  </span></a>    <span class="s2">path </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l445"><span class="ln">445  </span></a>    <span class="s2">val </span><span class="s1">= [</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">]];</span>
<a name="l446"><span class="ln">446  </span></a>  <span class="s1">}</span>
<a name="l447"><span class="ln">447  </span></a>
<a name="l448"><span class="ln">448  </span></a>  <span class="s4">const </span><span class="s2">p </span><span class="s1">= {};</span>
<a name="l449"><span class="ln">449  </span></a>  <span class="s2">p</span><span class="s1">[</span><span class="s2">path</span><span class="s1">] = { </span><span class="s2">$slice</span><span class="s1">: </span><span class="s2">val </span><span class="s1">};</span>
<a name="l450"><span class="ln">450  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">select</span><span class="s1">(</span><span class="s2">p</span><span class="s1">);</span>
<a name="l451"><span class="ln">451  </span></a>
<a name="l452"><span class="ln">452  </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l453"><span class="ln">453  </span></a><span class="s1">};</span>
<a name="l454"><span class="ln">454  </span></a>
<a name="l455"><span class="ln">455  </span></a><span class="s3">/*! 
<a name="l456"><span class="ln">456  </span></a> * ignore 
<a name="l457"><span class="ln">457  </span></a> */</span>
<a name="l458"><span class="ln">458  </span></a>
<a name="l459"><span class="ln">459  </span></a><span class="s4">const </span><span class="s2">validOpsSet </span><span class="s1">= </span><span class="s4">new </span><span class="s2">Set</span><span class="s1">(</span><span class="s2">queryMiddlewareFunctions</span><span class="s1">);</span>
<a name="l460"><span class="ln">460  </span></a>
<a name="l461"><span class="ln">461  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_validateOp </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l462"><span class="ln">462  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; !</span><span class="s2">validOpsSet</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">)) {</span>
<a name="l463"><span class="ln">463  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Query has invalid `op`: &quot;' </span><span class="s1">+ </span><span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">+ </span><span class="s0">'&quot;'</span><span class="s1">));</span>
<a name="l464"><span class="ln">464  </span></a>  <span class="s1">}</span>
<a name="l465"><span class="ln">465  </span></a><span class="s1">};</span>
<a name="l466"><span class="ln">466  </span></a>
<a name="l467"><span class="ln">467  </span></a><span class="s5">/**</span>
<a name="l468"><span class="ln">468  </span></a> <span class="s5">* Specifies the complementary comparison value for paths specified with `where()`</span>
<a name="l469"><span class="ln">469  </span></a> <span class="s5">*</span>
<a name="l470"><span class="ln">470  </span></a> <span class="s5">* #### Example:</span>
<a name="l471"><span class="ln">471  </span></a> <span class="s5">*</span>
<a name="l472"><span class="ln">472  </span></a> <span class="s5">*     User.where('age').equals(49);</span>
<a name="l473"><span class="ln">473  </span></a> <span class="s5">*</span>
<a name="l474"><span class="ln">474  </span></a> <span class="s5">*     // is the same as</span>
<a name="l475"><span class="ln">475  </span></a> <span class="s5">*</span>
<a name="l476"><span class="ln">476  </span></a> <span class="s5">*     User.where('age', 49);</span>
<a name="l477"><span class="ln">477  </span></a> <span class="s5">*</span>
<a name="l478"><span class="ln">478  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">equals</span>
<a name="l479"><span class="ln">479  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l480"><span class="ln">480  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l481"><span class="ln">481  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} val</span>
<a name="l482"><span class="ln">482  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l483"><span class="ln">483  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l484"><span class="ln">484  </span></a> <span class="s5">*/</span>
<a name="l485"><span class="ln">485  </span></a>
<a name="l486"><span class="ln">486  </span></a><span class="s5">/**</span>
<a name="l487"><span class="ln">487  </span></a> <span class="s5">* Specifies arguments for an `$or` condition.</span>
<a name="l488"><span class="ln">488  </span></a> <span class="s5">*</span>
<a name="l489"><span class="ln">489  </span></a> <span class="s5">* #### Example:</span>
<a name="l490"><span class="ln">490  </span></a> <span class="s5">*</span>
<a name="l491"><span class="ln">491  </span></a> <span class="s5">*     query.or([{ color: 'red' }, { status: 'emergency' }]);</span>
<a name="l492"><span class="ln">492  </span></a> <span class="s5">*</span>
<a name="l493"><span class="ln">493  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$or https://www.mongodb.com/docs/manual/reference/operator/or/</span>
<a name="l494"><span class="ln">494  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">or</span>
<a name="l495"><span class="ln">495  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l496"><span class="ln">496  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l497"><span class="ln">497  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} array array of conditions</span>
<a name="l498"><span class="ln">498  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l499"><span class="ln">499  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l500"><span class="ln">500  </span></a> <span class="s5">*/</span>
<a name="l501"><span class="ln">501  </span></a>
<a name="l502"><span class="ln">502  </span></a><span class="s5">/**</span>
<a name="l503"><span class="ln">503  </span></a> <span class="s5">* Specifies arguments for a `$nor` condition.</span>
<a name="l504"><span class="ln">504  </span></a> <span class="s5">*</span>
<a name="l505"><span class="ln">505  </span></a> <span class="s5">* #### Example:</span>
<a name="l506"><span class="ln">506  </span></a> <span class="s5">*</span>
<a name="l507"><span class="ln">507  </span></a> <span class="s5">*     query.nor([{ color: 'green' }, { status: 'ok' }]);</span>
<a name="l508"><span class="ln">508  </span></a> <span class="s5">*</span>
<a name="l509"><span class="ln">509  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$nor https://www.mongodb.com/docs/manual/reference/operator/nor/</span>
<a name="l510"><span class="ln">510  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">nor</span>
<a name="l511"><span class="ln">511  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l512"><span class="ln">512  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l513"><span class="ln">513  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} array array of conditions</span>
<a name="l514"><span class="ln">514  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l515"><span class="ln">515  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l516"><span class="ln">516  </span></a> <span class="s5">*/</span>
<a name="l517"><span class="ln">517  </span></a>
<a name="l518"><span class="ln">518  </span></a><span class="s5">/**</span>
<a name="l519"><span class="ln">519  </span></a> <span class="s5">* Specifies arguments for a `$and` condition.</span>
<a name="l520"><span class="ln">520  </span></a> <span class="s5">*</span>
<a name="l521"><span class="ln">521  </span></a> <span class="s5">* #### Example:</span>
<a name="l522"><span class="ln">522  </span></a> <span class="s5">*</span>
<a name="l523"><span class="ln">523  </span></a> <span class="s5">*     query.and([{ color: 'green' }, { status: 'ok' }])</span>
<a name="l524"><span class="ln">524  </span></a> <span class="s5">*</span>
<a name="l525"><span class="ln">525  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">and</span>
<a name="l526"><span class="ln">526  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l527"><span class="ln">527  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l528"><span class="ln">528  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$and https://www.mongodb.com/docs/manual/reference/operator/and/</span>
<a name="l529"><span class="ln">529  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} array array of conditions</span>
<a name="l530"><span class="ln">530  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l531"><span class="ln">531  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l532"><span class="ln">532  </span></a> <span class="s5">*/</span>
<a name="l533"><span class="ln">533  </span></a>
<a name="l534"><span class="ln">534  </span></a><span class="s5">/**</span>
<a name="l535"><span class="ln">535  </span></a> <span class="s5">* Specifies a `$gt` query condition.</span>
<a name="l536"><span class="ln">536  </span></a> <span class="s5">*</span>
<a name="l537"><span class="ln">537  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l538"><span class="ln">538  </span></a> <span class="s5">*</span>
<a name="l539"><span class="ln">539  </span></a> <span class="s5">* #### Example:</span>
<a name="l540"><span class="ln">540  </span></a> <span class="s5">*</span>
<a name="l541"><span class="ln">541  </span></a> <span class="s5">*     Thing.find().where('age').gt(21);</span>
<a name="l542"><span class="ln">542  </span></a> <span class="s5">*</span>
<a name="l543"><span class="ln">543  </span></a> <span class="s5">*     // or</span>
<a name="l544"><span class="ln">544  </span></a> <span class="s5">*     Thing.find().gt('age', 21);</span>
<a name="l545"><span class="ln">545  </span></a> <span class="s5">*</span>
<a name="l546"><span class="ln">546  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">gt</span>
<a name="l547"><span class="ln">547  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l548"><span class="ln">548  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l549"><span class="ln">549  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l550"><span class="ln">550  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l551"><span class="ln">551  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$gt https://www.mongodb.com/docs/manual/reference/operator/gt/</span>
<a name="l552"><span class="ln">552  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l553"><span class="ln">553  </span></a> <span class="s5">*/</span>
<a name="l554"><span class="ln">554  </span></a>
<a name="l555"><span class="ln">555  </span></a><span class="s5">/**</span>
<a name="l556"><span class="ln">556  </span></a> <span class="s5">* Specifies a `$gte` query condition.</span>
<a name="l557"><span class="ln">557  </span></a> <span class="s5">*</span>
<a name="l558"><span class="ln">558  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l559"><span class="ln">559  </span></a> <span class="s5">*</span>
<a name="l560"><span class="ln">560  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">gte</span>
<a name="l561"><span class="ln">561  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l562"><span class="ln">562  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l563"><span class="ln">563  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l564"><span class="ln">564  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l565"><span class="ln">565  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$gte https://www.mongodb.com/docs/manual/reference/operator/gte/</span>
<a name="l566"><span class="ln">566  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l567"><span class="ln">567  </span></a> <span class="s5">*/</span>
<a name="l568"><span class="ln">568  </span></a>
<a name="l569"><span class="ln">569  </span></a><span class="s5">/**</span>
<a name="l570"><span class="ln">570  </span></a> <span class="s5">* Specifies a `$lt` query condition.</span>
<a name="l571"><span class="ln">571  </span></a> <span class="s5">*</span>
<a name="l572"><span class="ln">572  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l573"><span class="ln">573  </span></a> <span class="s5">*</span>
<a name="l574"><span class="ln">574  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">lt</span>
<a name="l575"><span class="ln">575  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l576"><span class="ln">576  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l577"><span class="ln">577  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l578"><span class="ln">578  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l579"><span class="ln">579  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$lt https://www.mongodb.com/docs/manual/reference/operator/lt/</span>
<a name="l580"><span class="ln">580  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l581"><span class="ln">581  </span></a> <span class="s5">*/</span>
<a name="l582"><span class="ln">582  </span></a>
<a name="l583"><span class="ln">583  </span></a><span class="s5">/**</span>
<a name="l584"><span class="ln">584  </span></a> <span class="s5">* Specifies a `$lte` query condition.</span>
<a name="l585"><span class="ln">585  </span></a> <span class="s5">*</span>
<a name="l586"><span class="ln">586  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l587"><span class="ln">587  </span></a> <span class="s5">*</span>
<a name="l588"><span class="ln">588  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">lte</span>
<a name="l589"><span class="ln">589  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$lte https://www.mongodb.com/docs/manual/reference/operator/lte/</span>
<a name="l590"><span class="ln">590  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l591"><span class="ln">591  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l592"><span class="ln">592  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l593"><span class="ln">593  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l594"><span class="ln">594  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l595"><span class="ln">595  </span></a> <span class="s5">*/</span>
<a name="l596"><span class="ln">596  </span></a>
<a name="l597"><span class="ln">597  </span></a><span class="s5">/**</span>
<a name="l598"><span class="ln">598  </span></a> <span class="s5">* Specifies a `$ne` query condition.</span>
<a name="l599"><span class="ln">599  </span></a> <span class="s5">*</span>
<a name="l600"><span class="ln">600  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l601"><span class="ln">601  </span></a> <span class="s5">*</span>
<a name="l602"><span class="ln">602  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$ne https://www.mongodb.com/docs/manual/reference/operator/ne/</span>
<a name="l603"><span class="ln">603  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">ne</span>
<a name="l604"><span class="ln">604  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l605"><span class="ln">605  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l606"><span class="ln">606  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l607"><span class="ln">607  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{any} val</span>
<a name="l608"><span class="ln">608  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l609"><span class="ln">609  </span></a> <span class="s5">*/</span>
<a name="l610"><span class="ln">610  </span></a>
<a name="l611"><span class="ln">611  </span></a><span class="s5">/**</span>
<a name="l612"><span class="ln">612  </span></a> <span class="s5">* Specifies an `$in` query condition.</span>
<a name="l613"><span class="ln">613  </span></a> <span class="s5">*</span>
<a name="l614"><span class="ln">614  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l615"><span class="ln">615  </span></a> <span class="s5">*</span>
<a name="l616"><span class="ln">616  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$in https://www.mongodb.com/docs/manual/reference/operator/in/</span>
<a name="l617"><span class="ln">617  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">in</span>
<a name="l618"><span class="ln">618  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l619"><span class="ln">619  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l620"><span class="ln">620  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l621"><span class="ln">621  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} val</span>
<a name="l622"><span class="ln">622  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l623"><span class="ln">623  </span></a> <span class="s5">*/</span>
<a name="l624"><span class="ln">624  </span></a>
<a name="l625"><span class="ln">625  </span></a><span class="s5">/**</span>
<a name="l626"><span class="ln">626  </span></a> <span class="s5">* Specifies an `$nin` query condition.</span>
<a name="l627"><span class="ln">627  </span></a> <span class="s5">*</span>
<a name="l628"><span class="ln">628  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l629"><span class="ln">629  </span></a> <span class="s5">*</span>
<a name="l630"><span class="ln">630  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$nin https://www.mongodb.com/docs/manual/reference/operator/nin/</span>
<a name="l631"><span class="ln">631  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">nin</span>
<a name="l632"><span class="ln">632  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l633"><span class="ln">633  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l634"><span class="ln">634  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l635"><span class="ln">635  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} val</span>
<a name="l636"><span class="ln">636  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l637"><span class="ln">637  </span></a> <span class="s5">*/</span>
<a name="l638"><span class="ln">638  </span></a>
<a name="l639"><span class="ln">639  </span></a><span class="s5">/**</span>
<a name="l640"><span class="ln">640  </span></a> <span class="s5">* Specifies an `$all` query condition.</span>
<a name="l641"><span class="ln">641  </span></a> <span class="s5">*</span>
<a name="l642"><span class="ln">642  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l643"><span class="ln">643  </span></a> <span class="s5">*</span>
<a name="l644"><span class="ln">644  </span></a> <span class="s5">* #### Example:</span>
<a name="l645"><span class="ln">645  </span></a> <span class="s5">*</span>
<a name="l646"><span class="ln">646  </span></a> <span class="s5">*     MyModel.find().where('pets').all(['dog', 'cat', 'ferret']);</span>
<a name="l647"><span class="ln">647  </span></a> <span class="s5">*     // Equivalent:</span>
<a name="l648"><span class="ln">648  </span></a> <span class="s5">*     MyModel.find().all('pets', ['dog', 'cat', 'ferret']);</span>
<a name="l649"><span class="ln">649  </span></a> <span class="s5">*</span>
<a name="l650"><span class="ln">650  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$all https://www.mongodb.com/docs/manual/reference/operator/all/</span>
<a name="l651"><span class="ln">651  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">all</span>
<a name="l652"><span class="ln">652  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l653"><span class="ln">653  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l654"><span class="ln">654  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l655"><span class="ln">655  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} val</span>
<a name="l656"><span class="ln">656  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l657"><span class="ln">657  </span></a> <span class="s5">*/</span>
<a name="l658"><span class="ln">658  </span></a>
<a name="l659"><span class="ln">659  </span></a><span class="s5">/**</span>
<a name="l660"><span class="ln">660  </span></a> <span class="s5">* Specifies a `$size` query condition.</span>
<a name="l661"><span class="ln">661  </span></a> <span class="s5">*</span>
<a name="l662"><span class="ln">662  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l663"><span class="ln">663  </span></a> <span class="s5">*</span>
<a name="l664"><span class="ln">664  </span></a> <span class="s5">* #### Example:</span>
<a name="l665"><span class="ln">665  </span></a> <span class="s5">*</span>
<a name="l666"><span class="ln">666  </span></a> <span class="s5">*     const docs = await MyModel.where('tags').size(0).exec();</span>
<a name="l667"><span class="ln">667  </span></a> <span class="s5">*     assert(Array.isArray(docs));</span>
<a name="l668"><span class="ln">668  </span></a> <span class="s5">*     console.log('documents with 0 tags', docs);</span>
<a name="l669"><span class="ln">669  </span></a> <span class="s5">*</span>
<a name="l670"><span class="ln">670  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$size https://www.mongodb.com/docs/manual/reference/operator/size/</span>
<a name="l671"><span class="ln">671  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">size</span>
<a name="l672"><span class="ln">672  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l673"><span class="ln">673  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l674"><span class="ln">674  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l675"><span class="ln">675  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l676"><span class="ln">676  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l677"><span class="ln">677  </span></a> <span class="s5">*/</span>
<a name="l678"><span class="ln">678  </span></a>
<a name="l679"><span class="ln">679  </span></a><span class="s5">/**</span>
<a name="l680"><span class="ln">680  </span></a> <span class="s5">* Specifies a `$regex` query condition.</span>
<a name="l681"><span class="ln">681  </span></a> <span class="s5">*</span>
<a name="l682"><span class="ln">682  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l683"><span class="ln">683  </span></a> <span class="s5">*</span>
<a name="l684"><span class="ln">684  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$regex https://www.mongodb.com/docs/manual/reference/operator/regex/</span>
<a name="l685"><span class="ln">685  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">regex</span>
<a name="l686"><span class="ln">686  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l687"><span class="ln">687  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l688"><span class="ln">688  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l689"><span class="ln">689  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|RegExp} val</span>
<a name="l690"><span class="ln">690  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l691"><span class="ln">691  </span></a> <span class="s5">*/</span>
<a name="l692"><span class="ln">692  </span></a>
<a name="l693"><span class="ln">693  </span></a><span class="s5">/**</span>
<a name="l694"><span class="ln">694  </span></a> <span class="s5">* Specifies a `maxDistance` query condition.</span>
<a name="l695"><span class="ln">695  </span></a> <span class="s5">*</span>
<a name="l696"><span class="ln">696  </span></a> <span class="s5">* When called with one argument, the most recent path passed to `where()` is used.</span>
<a name="l697"><span class="ln">697  </span></a> <span class="s5">*</span>
<a name="l698"><span class="ln">698  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$maxDistance https://www.mongodb.com/docs/manual/reference/operator/maxDistance/</span>
<a name="l699"><span class="ln">699  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">maxDistance</span>
<a name="l700"><span class="ln">700  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l701"><span class="ln">701  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l702"><span class="ln">702  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l703"><span class="ln">703  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l704"><span class="ln">704  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l705"><span class="ln">705  </span></a> <span class="s5">*/</span>
<a name="l706"><span class="ln">706  </span></a>
<a name="l707"><span class="ln">707  </span></a><span class="s5">/**</span>
<a name="l708"><span class="ln">708  </span></a> <span class="s5">* Specifies a `$mod` condition, filters documents for documents whose</span>
<a name="l709"><span class="ln">709  </span></a> <span class="s5">* `path` property is a number that is equal to `remainder` modulo `divisor`.</span>
<a name="l710"><span class="ln">710  </span></a> <span class="s5">*</span>
<a name="l711"><span class="ln">711  </span></a> <span class="s5">* #### Example:</span>
<a name="l712"><span class="ln">712  </span></a> <span class="s5">*</span>
<a name="l713"><span class="ln">713  </span></a> <span class="s5">*     // All find products whose inventory is odd</span>
<a name="l714"><span class="ln">714  </span></a> <span class="s5">*     Product.find().mod('inventory', [2, 1]);</span>
<a name="l715"><span class="ln">715  </span></a> <span class="s5">*     Product.find().where('inventory').mod([2, 1]);</span>
<a name="l716"><span class="ln">716  </span></a> <span class="s5">*     // This syntax is a little strange, but supported.</span>
<a name="l717"><span class="ln">717  </span></a> <span class="s5">*     Product.find().where('inventory').mod(2, 1);</span>
<a name="l718"><span class="ln">718  </span></a> <span class="s5">*</span>
<a name="l719"><span class="ln">719  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">mod</span>
<a name="l720"><span class="ln">720  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l721"><span class="ln">721  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l722"><span class="ln">722  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l723"><span class="ln">723  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} val must be of length 2, first element is `divisor`, 2nd element is `remainder`.</span>
<a name="l724"><span class="ln">724  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l725"><span class="ln">725  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$mod https://www.mongodb.com/docs/manual/reference/operator/mod/</span>
<a name="l726"><span class="ln">726  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l727"><span class="ln">727  </span></a> <span class="s5">*/</span>
<a name="l728"><span class="ln">728  </span></a>
<a name="l729"><span class="ln">729  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mod </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l730"><span class="ln">730  </span></a>  <span class="s4">let </span><span class="s2">val</span><span class="s1">;</span>
<a name="l731"><span class="ln">731  </span></a>  <span class="s4">let </span><span class="s2">path</span><span class="s1">;</span>
<a name="l732"><span class="ln">732  </span></a>
<a name="l733"><span class="ln">733  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">1</span><span class="s1">) {</span>
<a name="l734"><span class="ln">734  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_ensurePath</span><span class="s1">(</span><span class="s0">'mod'</span><span class="s1">);</span>
<a name="l735"><span class="ln">735  </span></a>    <span class="s2">val </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l736"><span class="ln">736  </span></a>    <span class="s2">path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_path</span><span class="s1">;</span>
<a name="l737"><span class="ln">737  </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">2 </span><span class="s1">&amp;&amp; !</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">])) {</span>
<a name="l738"><span class="ln">738  </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_ensurePath</span><span class="s1">(</span><span class="s0">'mod'</span><span class="s1">);</span>
<a name="l739"><span class="ln">739  </span></a>    <span class="s2">val </span><span class="s1">= [</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]];</span>
<a name="l740"><span class="ln">740  </span></a>    <span class="s2">path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_path</span><span class="s1">;</span>
<a name="l741"><span class="ln">741  </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">3</span><span class="s1">) {</span>
<a name="l742"><span class="ln">742  </span></a>    <span class="s2">val </span><span class="s1">= [</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">]];</span>
<a name="l743"><span class="ln">743  </span></a>    <span class="s2">path </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l744"><span class="ln">744  </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l745"><span class="ln">745  </span></a>    <span class="s2">val </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">];</span>
<a name="l746"><span class="ln">746  </span></a>    <span class="s2">path </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l747"><span class="ln">747  </span></a>  <span class="s1">}</span>
<a name="l748"><span class="ln">748  </span></a>
<a name="l749"><span class="ln">749  </span></a>  <span class="s4">const </span><span class="s2">conds </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">[</span><span class="s2">path</span><span class="s1">] || (</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">[</span><span class="s2">path</span><span class="s1">] = {});</span>
<a name="l750"><span class="ln">750  </span></a>  <span class="s2">conds</span><span class="s1">.</span><span class="s2">$mod </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l751"><span class="ln">751  </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l752"><span class="ln">752  </span></a><span class="s1">};</span>
<a name="l753"><span class="ln">753  </span></a>
<a name="l754"><span class="ln">754  </span></a><span class="s5">/**</span>
<a name="l755"><span class="ln">755  </span></a> <span class="s5">* Specifies an `$exists` condition</span>
<a name="l756"><span class="ln">756  </span></a> <span class="s5">*</span>
<a name="l757"><span class="ln">757  </span></a> <span class="s5">* #### Example:</span>
<a name="l758"><span class="ln">758  </span></a> <span class="s5">*</span>
<a name="l759"><span class="ln">759  </span></a> <span class="s5">*     // { name: { $exists: true }}</span>
<a name="l760"><span class="ln">760  </span></a> <span class="s5">*     Thing.where('name').exists()</span>
<a name="l761"><span class="ln">761  </span></a> <span class="s5">*     Thing.where('name').exists(true)</span>
<a name="l762"><span class="ln">762  </span></a> <span class="s5">*     Thing.find().exists('name')</span>
<a name="l763"><span class="ln">763  </span></a> <span class="s5">*</span>
<a name="l764"><span class="ln">764  </span></a> <span class="s5">*     // { name: { $exists: false }}</span>
<a name="l765"><span class="ln">765  </span></a> <span class="s5">*     Thing.where('name').exists(false);</span>
<a name="l766"><span class="ln">766  </span></a> <span class="s5">*     Thing.find().exists('name', false);</span>
<a name="l767"><span class="ln">767  </span></a> <span class="s5">*</span>
<a name="l768"><span class="ln">768  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">exists</span>
<a name="l769"><span class="ln">769  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l770"><span class="ln">770  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l771"><span class="ln">771  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l772"><span class="ln">772  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} val</span>
<a name="l773"><span class="ln">773  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l774"><span class="ln">774  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$exists https://www.mongodb.com/docs/manual/reference/operator/exists/</span>
<a name="l775"><span class="ln">775  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l776"><span class="ln">776  </span></a> <span class="s5">*/</span>
<a name="l777"><span class="ln">777  </span></a>
<a name="l778"><span class="ln">778  </span></a><span class="s5">/**</span>
<a name="l779"><span class="ln">779  </span></a> <span class="s5">* Specifies an `$elemMatch` condition</span>
<a name="l780"><span class="ln">780  </span></a> <span class="s5">*</span>
<a name="l781"><span class="ln">781  </span></a> <span class="s5">* #### Example:</span>
<a name="l782"><span class="ln">782  </span></a> <span class="s5">*</span>
<a name="l783"><span class="ln">783  </span></a> <span class="s5">*     query.elemMatch('comment', { author: 'autobot', votes: {$gte: 5}})</span>
<a name="l784"><span class="ln">784  </span></a> <span class="s5">*</span>
<a name="l785"><span class="ln">785  </span></a> <span class="s5">*     query.where('comment').elemMatch({ author: 'autobot', votes: {$gte: 5}})</span>
<a name="l786"><span class="ln">786  </span></a> <span class="s5">*</span>
<a name="l787"><span class="ln">787  </span></a> <span class="s5">*     query.elemMatch('comment', function (elem) {</span>
<a name="l788"><span class="ln">788  </span></a> <span class="s5">*       elem.where('author').equals('autobot');</span>
<a name="l789"><span class="ln">789  </span></a> <span class="s5">*       elem.where('votes').gte(5);</span>
<a name="l790"><span class="ln">790  </span></a> <span class="s5">*     })</span>
<a name="l791"><span class="ln">791  </span></a> <span class="s5">*</span>
<a name="l792"><span class="ln">792  </span></a> <span class="s5">*     query.where('comment').elemMatch(function (elem) {</span>
<a name="l793"><span class="ln">793  </span></a> <span class="s5">*       elem.where({ author: 'autobot' });</span>
<a name="l794"><span class="ln">794  </span></a> <span class="s5">*       elem.where('votes').gte(5);</span>
<a name="l795"><span class="ln">795  </span></a> <span class="s5">*     })</span>
<a name="l796"><span class="ln">796  </span></a> <span class="s5">*</span>
<a name="l797"><span class="ln">797  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">elemMatch</span>
<a name="l798"><span class="ln">798  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l799"><span class="ln">799  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l800"><span class="ln">800  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|Object|Function} path</span>
<a name="l801"><span class="ln">801  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Function} filter</span>
<a name="l802"><span class="ln">802  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l803"><span class="ln">803  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$elemMatch https://www.mongodb.com/docs/manual/reference/operator/elemMatch/</span>
<a name="l804"><span class="ln">804  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l805"><span class="ln">805  </span></a> <span class="s5">*/</span>
<a name="l806"><span class="ln">806  </span></a>
<a name="l807"><span class="ln">807  </span></a><span class="s5">/**</span>
<a name="l808"><span class="ln">808  </span></a> <span class="s5">* Defines a `$within` or `$geoWithin` argument for geo-spatial queries.</span>
<a name="l809"><span class="ln">809  </span></a> <span class="s5">*</span>
<a name="l810"><span class="ln">810  </span></a> <span class="s5">* #### Example:</span>
<a name="l811"><span class="ln">811  </span></a> <span class="s5">*</span>
<a name="l812"><span class="ln">812  </span></a> <span class="s5">*     query.where(path).within().box()</span>
<a name="l813"><span class="ln">813  </span></a> <span class="s5">*     query.where(path).within().circle()</span>
<a name="l814"><span class="ln">814  </span></a> <span class="s5">*     query.where(path).within().geometry()</span>
<a name="l815"><span class="ln">815  </span></a> <span class="s5">*</span>
<a name="l816"><span class="ln">816  </span></a> <span class="s5">*     query.where('loc').within({ center: [50,50], radius: 10, unique: true, spherical: true });</span>
<a name="l817"><span class="ln">817  </span></a> <span class="s5">*     query.where('loc').within({ box: [[40.73, -73.9], [40.7, -73.988]] });</span>
<a name="l818"><span class="ln">818  </span></a> <span class="s5">*     query.where('loc').within({ polygon: [[],[],[],[]] });</span>
<a name="l819"><span class="ln">819  </span></a> <span class="s5">*</span>
<a name="l820"><span class="ln">820  </span></a> <span class="s5">*     query.where('loc').within([], [], []) // polygon</span>
<a name="l821"><span class="ln">821  </span></a> <span class="s5">*     query.where('loc').within([], []) // box</span>
<a name="l822"><span class="ln">822  </span></a> <span class="s5">*     query.where('loc').within({ type: 'LineString', coordinates: [...] }); // geometry</span>
<a name="l823"><span class="ln">823  </span></a> <span class="s5">*</span>
<a name="l824"><span class="ln">824  </span></a> <span class="s5">* **MUST** be used after `where()`.</span>
<a name="l825"><span class="ln">825  </span></a> <span class="s5">*</span>
<a name="l826"><span class="ln">826  </span></a> <span class="s5">* #### Note:</span>
<a name="l827"><span class="ln">827  </span></a> <span class="s5">*</span>
<a name="l828"><span class="ln">828  </span></a> <span class="s5">* As of Mongoose 3.7, `$geoWithin` is always used for queries. To change this behavior, see [Query.use$geoWithin](https://mongoosejs.com/docs/api/query.html#Query.prototype.use$geoWithin).</span>
<a name="l829"><span class="ln">829  </span></a> <span class="s5">*</span>
<a name="l830"><span class="ln">830  </span></a> <span class="s5">* #### Note:</span>
<a name="l831"><span class="ln">831  </span></a> <span class="s5">*</span>
<a name="l832"><span class="ln">832  </span></a> <span class="s5">* In Mongoose 3.7, `within` changed from a getter to a function. If you need the old syntax, use [this](https://github.com/ebensing/mongoose-within).</span>
<a name="l833"><span class="ln">833  </span></a> <span class="s5">*</span>
<a name="l834"><span class="ln">834  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">within</span>
<a name="l835"><span class="ln">835  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$polygon https://www.mongodb.com/docs/manual/reference/operator/polygon/</span>
<a name="l836"><span class="ln">836  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$box https://www.mongodb.com/docs/manual/reference/operator/box/</span>
<a name="l837"><span class="ln">837  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$geometry https://www.mongodb.com/docs/manual/reference/operator/geometry/</span>
<a name="l838"><span class="ln">838  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$center https://www.mongodb.com/docs/manual/reference/operator/center/</span>
<a name="l839"><span class="ln">839  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$centerSphere https://www.mongodb.com/docs/manual/reference/operator/centerSphere/</span>
<a name="l840"><span class="ln">840  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l841"><span class="ln">841  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l842"><span class="ln">842  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l843"><span class="ln">843  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l844"><span class="ln">844  </span></a> <span class="s5">*/</span>
<a name="l845"><span class="ln">845  </span></a>
<a name="l846"><span class="ln">846  </span></a><span class="s5">/**</span>
<a name="l847"><span class="ln">847  </span></a> <span class="s5">* Specifies the maximum number of documents the query will return.</span>
<a name="l848"><span class="ln">848  </span></a> <span class="s5">*</span>
<a name="l849"><span class="ln">849  </span></a> <span class="s5">* #### Example:</span>
<a name="l850"><span class="ln">850  </span></a> <span class="s5">*</span>
<a name="l851"><span class="ln">851  </span></a> <span class="s5">*     query.limit(20);</span>
<a name="l852"><span class="ln">852  </span></a> <span class="s5">*</span>
<a name="l853"><span class="ln">853  </span></a> <span class="s5">* #### Note:</span>
<a name="l854"><span class="ln">854  </span></a> <span class="s5">*</span>
<a name="l855"><span class="ln">855  </span></a> <span class="s5">* Cannot be used with `distinct()`</span>
<a name="l856"><span class="ln">856  </span></a> <span class="s5">*</span>
<a name="l857"><span class="ln">857  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">limit</span>
<a name="l858"><span class="ln">858  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l859"><span class="ln">859  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l860"><span class="ln">860  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l861"><span class="ln">861  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l862"><span class="ln">862  </span></a> <span class="s5">*/</span>
<a name="l863"><span class="ln">863  </span></a>
<a name="l864"><span class="ln">864  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">limit </span><span class="s1">= </span><span class="s4">function </span><span class="s2">limit</span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
<a name="l865"><span class="ln">865  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validate</span><span class="s1">(</span><span class="s0">'limit'</span><span class="s1">);</span>
<a name="l866"><span class="ln">866  </span></a>
<a name="l867"><span class="ln">867  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">v </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l868"><span class="ln">868  </span></a>    <span class="s4">try </span><span class="s1">{</span>
<a name="l869"><span class="ln">869  </span></a>      <span class="s2">v </span><span class="s1">= </span><span class="s2">castNumber</span><span class="s1">(</span><span class="s2">v</span><span class="s1">);</span>
<a name="l870"><span class="ln">870  </span></a>    <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l871"><span class="ln">871  </span></a>      <span class="s4">throw new </span><span class="s2">CastError</span><span class="s1">(</span><span class="s0">'Number'</span><span class="s1">, </span><span class="s2">v</span><span class="s1">, </span><span class="s0">'limit'</span><span class="s1">);</span>
<a name="l872"><span class="ln">872  </span></a>    <span class="s1">}</span>
<a name="l873"><span class="ln">873  </span></a>  <span class="s1">}</span>
<a name="l874"><span class="ln">874  </span></a>
<a name="l875"><span class="ln">875  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">limit </span><span class="s1">= </span><span class="s2">v</span><span class="s1">;</span>
<a name="l876"><span class="ln">876  </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l877"><span class="ln">877  </span></a><span class="s1">};</span>
<a name="l878"><span class="ln">878  </span></a>
<a name="l879"><span class="ln">879  </span></a><span class="s5">/**</span>
<a name="l880"><span class="ln">880  </span></a> <span class="s5">* Specifies the number of documents to skip.</span>
<a name="l881"><span class="ln">881  </span></a> <span class="s5">*</span>
<a name="l882"><span class="ln">882  </span></a> <span class="s5">* #### Example:</span>
<a name="l883"><span class="ln">883  </span></a> <span class="s5">*</span>
<a name="l884"><span class="ln">884  </span></a> <span class="s5">*     query.skip(100).limit(20);</span>
<a name="l885"><span class="ln">885  </span></a> <span class="s5">*</span>
<a name="l886"><span class="ln">886  </span></a> <span class="s5">* #### Note:</span>
<a name="l887"><span class="ln">887  </span></a> <span class="s5">*</span>
<a name="l888"><span class="ln">888  </span></a> <span class="s5">* Cannot be used with `distinct()`</span>
<a name="l889"><span class="ln">889  </span></a> <span class="s5">*</span>
<a name="l890"><span class="ln">890  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">skip</span>
<a name="l891"><span class="ln">891  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l892"><span class="ln">892  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l893"><span class="ln">893  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l894"><span class="ln">894  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">cursor.skip https://www.mongodb.com/docs/manual/reference/method/cursor.skip/</span>
<a name="l895"><span class="ln">895  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l896"><span class="ln">896  </span></a> <span class="s5">*/</span>
<a name="l897"><span class="ln">897  </span></a>
<a name="l898"><span class="ln">898  </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">skip </span><span class="s1">= </span><span class="s4">function </span><span class="s2">skip</span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
<a name="l899"><span class="ln">899  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validate</span><span class="s1">(</span><span class="s0">'skip'</span><span class="s1">);</span>
<a name="l900"><span class="ln">900  </span></a>
<a name="l901"><span class="ln">901  </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">v </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l902"><span class="ln">902  </span></a>    <span class="s4">try </span><span class="s1">{</span>
<a name="l903"><span class="ln">903  </span></a>      <span class="s2">v </span><span class="s1">= </span><span class="s2">castNumber</span><span class="s1">(</span><span class="s2">v</span><span class="s1">);</span>
<a name="l904"><span class="ln">904  </span></a>    <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l905"><span class="ln">905  </span></a>      <span class="s4">throw new </span><span class="s2">CastError</span><span class="s1">(</span><span class="s0">'Number'</span><span class="s1">, </span><span class="s2">v</span><span class="s1">, </span><span class="s0">'skip'</span><span class="s1">);</span>
<a name="l906"><span class="ln">906  </span></a>    <span class="s1">}</span>
<a name="l907"><span class="ln">907  </span></a>  <span class="s1">}</span>
<a name="l908"><span class="ln">908  </span></a>
<a name="l909"><span class="ln">909  </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">skip </span><span class="s1">= </span><span class="s2">v</span><span class="s1">;</span>
<a name="l910"><span class="ln">910  </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l911"><span class="ln">911  </span></a><span class="s1">};</span>
<a name="l912"><span class="ln">912  </span></a>
<a name="l913"><span class="ln">913  </span></a><span class="s5">/**</span>
<a name="l914"><span class="ln">914  </span></a> <span class="s5">* Specifies the batchSize option.</span>
<a name="l915"><span class="ln">915  </span></a> <span class="s5">*</span>
<a name="l916"><span class="ln">916  </span></a> <span class="s5">* #### Example:</span>
<a name="l917"><span class="ln">917  </span></a> <span class="s5">*</span>
<a name="l918"><span class="ln">918  </span></a> <span class="s5">*     query.batchSize(100)</span>
<a name="l919"><span class="ln">919  </span></a> <span class="s5">*</span>
<a name="l920"><span class="ln">920  </span></a> <span class="s5">* #### Note:</span>
<a name="l921"><span class="ln">921  </span></a> <span class="s5">*</span>
<a name="l922"><span class="ln">922  </span></a> <span class="s5">* Cannot be used with `distinct()`</span>
<a name="l923"><span class="ln">923  </span></a> <span class="s5">*</span>
<a name="l924"><span class="ln">924  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">batchSize</span>
<a name="l925"><span class="ln">925  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l926"><span class="ln">926  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l927"><span class="ln">927  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} val</span>
<a name="l928"><span class="ln">928  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">batchSize https://www.mongodb.com/docs/manual/reference/method/cursor.batchSize/</span>
<a name="l929"><span class="ln">929  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l930"><span class="ln">930  </span></a> <span class="s5">*/</span>
<a name="l931"><span class="ln">931  </span></a>
<a name="l932"><span class="ln">932  </span></a><span class="s5">/**</span>
<a name="l933"><span class="ln">933  </span></a> <span class="s5">* Specifies the `comment` option.</span>
<a name="l934"><span class="ln">934  </span></a> <span class="s5">*</span>
<a name="l935"><span class="ln">935  </span></a> <span class="s5">* #### Example:</span>
<a name="l936"><span class="ln">936  </span></a> <span class="s5">*</span>
<a name="l937"><span class="ln">937  </span></a> <span class="s5">*     query.comment('login query')</span>
<a name="l938"><span class="ln">938  </span></a> <span class="s5">*</span>
<a name="l939"><span class="ln">939  </span></a> <span class="s5">* #### Note:</span>
<a name="l940"><span class="ln">940  </span></a> <span class="s5">*</span>
<a name="l941"><span class="ln">941  </span></a> <span class="s5">* Cannot be used with `distinct()`</span>
<a name="l942"><span class="ln">942  </span></a> <span class="s5">*</span>
<a name="l943"><span class="ln">943  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">comment</span>
<a name="l944"><span class="ln">944  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l945"><span class="ln">945  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l946"><span class="ln">946  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} val</span>
<a name="l947"><span class="ln">947  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">comment https://www.mongodb.com/docs/manual/reference/operator/comment/</span>
<a name="l948"><span class="ln">948  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l949"><span class="ln">949  </span></a> <span class="s5">*/</span>
<a name="l950"><span class="ln">950  </span></a>
<a name="l951"><span class="ln">951  </span></a><span class="s5">/**</span>
<a name="l952"><span class="ln">952  </span></a> <span class="s5">* Sets query hints.</span>
<a name="l953"><span class="ln">953  </span></a> <span class="s5">*</span>
<a name="l954"><span class="ln">954  </span></a> <span class="s5">* #### Example:</span>
<a name="l955"><span class="ln">955  </span></a> <span class="s5">*</span>
<a name="l956"><span class="ln">956  </span></a> <span class="s5">*     query.hint({ indexA: 1, indexB: -1 });</span>
<a name="l957"><span class="ln">957  </span></a> <span class="s5">*</span>
<a name="l958"><span class="ln">958  </span></a> <span class="s5">* #### Note:</span>
<a name="l959"><span class="ln">959  </span></a> <span class="s5">*</span>
<a name="l960"><span class="ln">960  </span></a> <span class="s5">* Cannot be used with `distinct()`</span>
<a name="l961"><span class="ln">961  </span></a> <span class="s5">*</span>
<a name="l962"><span class="ln">962  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">hint</span>
<a name="l963"><span class="ln">963  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l964"><span class="ln">964  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l965"><span class="ln">965  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} val a hint object</span>
<a name="l966"><span class="ln">966  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l967"><span class="ln">967  </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$hint https://www.mongodb.com/docs/manual/reference/operator/hint/</span>
<a name="l968"><span class="ln">968  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l969"><span class="ln">969  </span></a> <span class="s5">*/</span>
<a name="l970"><span class="ln">970  </span></a>
<a name="l971"><span class="ln">971  </span></a><span class="s5">/**</span>
<a name="l972"><span class="ln">972  </span></a> <span class="s5">* Get/set the current projection (AKA fields). Pass `null` to remove the</span>
<a name="l973"><span class="ln">973  </span></a> <span class="s5">* current projection.</span>
<a name="l974"><span class="ln">974  </span></a> <span class="s5">*</span>
<a name="l975"><span class="ln">975  </span></a> <span class="s5">* Unlike `projection()`, the `select()` function modifies the current</span>
<a name="l976"><span class="ln">976  </span></a> <span class="s5">* projection in place. This function overwrites the existing projection.</span>
<a name="l977"><span class="ln">977  </span></a> <span class="s5">*</span>
<a name="l978"><span class="ln">978  </span></a> <span class="s5">* #### Example:</span>
<a name="l979"><span class="ln">979  </span></a> <span class="s5">*</span>
<a name="l980"><span class="ln">980  </span></a> <span class="s5">*     const q = Model.find();</span>
<a name="l981"><span class="ln">981  </span></a> <span class="s5">*     q.projection(); // null</span>
<a name="l982"><span class="ln">982  </span></a> <span class="s5">*</span>
<a name="l983"><span class="ln">983  </span></a> <span class="s5">*     q.select('a b');</span>
<a name="l984"><span class="ln">984  </span></a> <span class="s5">*     q.projection(); // { a: 1, b: 1 }</span>
<a name="l985"><span class="ln">985  </span></a> <span class="s5">*</span>
<a name="l986"><span class="ln">986  </span></a> <span class="s5">*     q.projection({ c: 1 });</span>
<a name="l987"><span class="ln">987  </span></a> <span class="s5">*     q.projection(); // { c: 1 }</span>
<a name="l988"><span class="ln">988  </span></a> <span class="s5">*</span>
<a name="l989"><span class="ln">989  </span></a> <span class="s5">*     q.projection(null);</span>
<a name="l990"><span class="ln">990  </span></a> <span class="s5">*     q.projection(); // null</span>
<a name="l991"><span class="ln">991  </span></a> <span class="s5">*</span>
<a name="l992"><span class="ln">992  </span></a> <span class="s5">*</span>
<a name="l993"><span class="ln">993  </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">projection</span>
<a name="l994"><span class="ln">994  </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l995"><span class="ln">995  </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l996"><span class="ln">996  </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|null} arg</span>
<a name="l997"><span class="ln">997  </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} the current projection</span>
<a name="l998"><span class="ln">998  </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l999"><span class="ln">999  </span></a> <span class="s5">*/</span>
<a name="l1000"><span class="ln">1000 </span></a>
<a name="l1001"><span class="ln">1001 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">projection </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">) {</span>
<a name="l1002"><span class="ln">1002 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l1003"><span class="ln">1003 </span></a>    <span class="s4">return this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">;</span>
<a name="l1004"><span class="ln">1004 </span></a>  <span class="s1">}</span>
<a name="l1005"><span class="ln">1005 </span></a>
<a name="l1006"><span class="ln">1006 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">= {};</span>
<a name="l1007"><span class="ln">1007 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_userProvidedFields </span><span class="s1">= {};</span>
<a name="l1008"><span class="ln">1008 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">select</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">);</span>
<a name="l1009"><span class="ln">1009 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">;</span>
<a name="l1010"><span class="ln">1010 </span></a><span class="s1">};</span>
<a name="l1011"><span class="ln">1011 </span></a>
<a name="l1012"><span class="ln">1012 </span></a><span class="s5">/**</span>
<a name="l1013"><span class="ln">1013 </span></a> <span class="s5">* Specifies which document fields to include or exclude (also known as the query &quot;projection&quot;)</span>
<a name="l1014"><span class="ln">1014 </span></a> <span class="s5">*</span>
<a name="l1015"><span class="ln">1015 </span></a> <span class="s5">* When using string syntax, prefixing a path with `-` will flag that path as excluded. When a path does not have the `-` prefix, it is included. Lastly, if a path is prefixed with `+`, it forces inclusion of the path, which is useful for paths excluded at the [schema level](https://mongoosejs.com/docs/api/schematype.html#SchemaType.prototype.select()).</span>
<a name="l1016"><span class="ln">1016 </span></a> <span class="s5">*</span>
<a name="l1017"><span class="ln">1017 </span></a> <span class="s5">* A projection _must_ be either inclusive or exclusive. In other words, you must</span>
<a name="l1018"><span class="ln">1018 </span></a> <span class="s5">* either list the fields to include (which excludes all others), or list the fields</span>
<a name="l1019"><span class="ln">1019 </span></a> <span class="s5">* to exclude (which implies all other fields are included). The [`_id` field is the only exception because MongoDB includes it by default](https://www.mongodb.com/docs/manual/tutorial/project-fields-from-query-results/#suppress-id-field).</span>
<a name="l1020"><span class="ln">1020 </span></a> <span class="s5">*</span>
<a name="l1021"><span class="ln">1021 </span></a> <span class="s5">* #### Example:</span>
<a name="l1022"><span class="ln">1022 </span></a> <span class="s5">*</span>
<a name="l1023"><span class="ln">1023 </span></a> <span class="s5">*     // include a and b, exclude other fields</span>
<a name="l1024"><span class="ln">1024 </span></a> <span class="s5">*     query.select('a b');</span>
<a name="l1025"><span class="ln">1025 </span></a> <span class="s5">*     // Equivalent syntaxes:</span>
<a name="l1026"><span class="ln">1026 </span></a> <span class="s5">*     query.select(['a', 'b']);</span>
<a name="l1027"><span class="ln">1027 </span></a> <span class="s5">*     query.select({ a: 1, b: 1 });</span>
<a name="l1028"><span class="ln">1028 </span></a> <span class="s5">*</span>
<a name="l1029"><span class="ln">1029 </span></a> <span class="s5">*     // exclude c and d, include other fields</span>
<a name="l1030"><span class="ln">1030 </span></a> <span class="s5">*     query.select('-c -d');</span>
<a name="l1031"><span class="ln">1031 </span></a> <span class="s5">*</span>
<a name="l1032"><span class="ln">1032 </span></a> <span class="s5">*     // Use `+` to override schema-level `select: false` without making the</span>
<a name="l1033"><span class="ln">1033 </span></a> <span class="s5">*     // projection inclusive.</span>
<a name="l1034"><span class="ln">1034 </span></a> <span class="s5">*     const schema = new Schema({</span>
<a name="l1035"><span class="ln">1035 </span></a> <span class="s5">*       foo: { type: String, select: false },</span>
<a name="l1036"><span class="ln">1036 </span></a> <span class="s5">*       bar: String</span>
<a name="l1037"><span class="ln">1037 </span></a> <span class="s5">*     });</span>
<a name="l1038"><span class="ln">1038 </span></a> <span class="s5">*     // ...</span>
<a name="l1039"><span class="ln">1039 </span></a> <span class="s5">*     query.select('+foo'); // Override foo's `select: false` without excluding `bar`</span>
<a name="l1040"><span class="ln">1040 </span></a> <span class="s5">*</span>
<a name="l1041"><span class="ln">1041 </span></a> <span class="s5">*     // or you may use object notation, useful when</span>
<a name="l1042"><span class="ln">1042 </span></a> <span class="s5">*     // you have keys already prefixed with a &quot;-&quot;</span>
<a name="l1043"><span class="ln">1043 </span></a> <span class="s5">*     query.select({ a: 1, b: 1 });</span>
<a name="l1044"><span class="ln">1044 </span></a> <span class="s5">*     query.select({ c: 0, d: 0 });</span>
<a name="l1045"><span class="ln">1045 </span></a> <span class="s5">*</span>
<a name="l1046"><span class="ln">1046 </span></a> <span class="s5">*     Additional calls to select can override the previous selection:</span>
<a name="l1047"><span class="ln">1047 </span></a> <span class="s5">*     query.select({ a: 1, b: 1 }).select({ b: 0 }); // selection is now { a: 1 }</span>
<a name="l1048"><span class="ln">1048 </span></a> <span class="s5">*     query.select({ a: 0, b: 0 }).select({ b: 1 }); // selection is now { a: 0 }</span>
<a name="l1049"><span class="ln">1049 </span></a> <span class="s5">*</span>
<a name="l1050"><span class="ln">1050 </span></a> <span class="s5">*</span>
<a name="l1051"><span class="ln">1051 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">select</span>
<a name="l1052"><span class="ln">1052 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1053"><span class="ln">1053 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1054"><span class="ln">1054 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|String|String[]} arg</span>
<a name="l1055"><span class="ln">1055 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1056"><span class="ln">1056 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">SchemaType https://mongoosejs.com/docs/api/schematype.html</span>
<a name="l1057"><span class="ln">1057 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1058"><span class="ln">1058 </span></a> <span class="s5">*/</span>
<a name="l1059"><span class="ln">1059 </span></a>
<a name="l1060"><span class="ln">1060 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">select </span><span class="s1">= </span><span class="s4">function </span><span class="s2">select</span><span class="s1">() {</span>
<a name="l1061"><span class="ln">1061 </span></a>  <span class="s4">let </span><span class="s2">arg </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l1062"><span class="ln">1062 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">arg</span><span class="s1">) </span><span class="s4">return this</span><span class="s1">;</span>
<a name="l1063"><span class="ln">1063 </span></a>
<a name="l1064"><span class="ln">1064 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">!== </span><span class="s7">1</span><span class="s1">) {</span>
<a name="l1065"><span class="ln">1065 </span></a>    <span class="s4">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Invalid select: select only takes 1 argument'</span><span class="s1">);</span>
<a name="l1066"><span class="ln">1066 </span></a>  <span class="s1">}</span>
<a name="l1067"><span class="ln">1067 </span></a>
<a name="l1068"><span class="ln">1068 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validate</span><span class="s1">(</span><span class="s0">'select'</span><span class="s1">);</span>
<a name="l1069"><span class="ln">1069 </span></a>
<a name="l1070"><span class="ln">1070 </span></a>  <span class="s4">const </span><span class="s2">fields </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">|| (</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">= {});</span>
<a name="l1071"><span class="ln">1071 </span></a>  <span class="s4">const </span><span class="s2">userProvidedFields </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_userProvidedFields </span><span class="s1">|| (</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_userProvidedFields </span><span class="s1">= {});</span>
<a name="l1072"><span class="ln">1072 </span></a>  <span class="s4">let </span><span class="s2">sanitizeProjection </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l1073"><span class="ln">1073 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">utils</span><span class="s1">.</span><span class="s2">hasUserDefinedProperty</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s0">'sanitizeProjection'</span><span class="s1">)) {</span>
<a name="l1074"><span class="ln">1074 </span></a>    <span class="s2">sanitizeProjection </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeProjection</span><span class="s1">;</span>
<a name="l1075"><span class="ln">1075 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">utils</span><span class="s1">.</span><span class="s2">hasUserDefinedProperty</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s0">'sanitizeProjection'</span><span class="s1">)) {</span>
<a name="l1076"><span class="ln">1076 </span></a>    <span class="s2">sanitizeProjection </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeProjection</span><span class="s1">;</span>
<a name="l1077"><span class="ln">1077 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1078"><span class="ln">1078 </span></a>    <span class="s2">sanitizeProjection </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">sanitizeProjection</span><span class="s1">;</span>
<a name="l1079"><span class="ln">1079 </span></a>  <span class="s1">}</span>
<a name="l1080"><span class="ln">1080 </span></a>
<a name="l1081"><span class="ln">1081 </span></a>  <span class="s4">function </span><span class="s2">sanitizeValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
<a name="l1082"><span class="ln">1082 </span></a>    <span class="s4">return typeof </span><span class="s2">value </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s1">&amp;&amp; </span><span class="s2">sanitizeProjection </span><span class="s1">? </span><span class="s2">value </span><span class="s1">= </span><span class="s7">1 </span><span class="s1">: </span><span class="s2">value</span><span class="s1">;</span>
<a name="l1083"><span class="ln">1083 </span></a>  <span class="s1">}</span>
<a name="l1084"><span class="ln">1084 </span></a>  <span class="s2">arg </span><span class="s1">= </span><span class="s2">parseProjection</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">, </span><span class="s4">true</span><span class="s1">); </span><span class="s3">// we want to keep the minus and pluses, so add boolean arg.</span>
<a name="l1085"><span class="ln">1085 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">utils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">)) {</span>
<a name="l1086"><span class="ln">1086 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">selectedInclusively</span><span class="s1">()) {</span>
<a name="l1087"><span class="ln">1087 </span></a>      <span class="s2">Object</span><span class="s1">.</span><span class="s2">entries</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(([</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">]) =&gt; {</span>
<a name="l1088"><span class="ln">1088 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
<a name="l1089"><span class="ln">1089 </span></a>          <span class="s3">// Add the field to the projection</span>
<a name="l1090"><span class="ln">1090 </span></a>          <span class="s4">if </span><span class="s1">(</span><span class="s2">fields</span><span class="s1">[</span><span class="s0">'-' </span><span class="s1">+ </span><span class="s2">key</span><span class="s1">] != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1091"><span class="ln">1091 </span></a>            <span class="s4">delete </span><span class="s2">fields</span><span class="s1">[</span><span class="s0">'-' </span><span class="s1">+ </span><span class="s2">key</span><span class="s1">];</span>
<a name="l1092"><span class="ln">1092 </span></a>          <span class="s1">}</span>
<a name="l1093"><span class="ln">1093 </span></a>          <span class="s2">fields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">userProvidedFields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">sanitizeValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
<a name="l1094"><span class="ln">1094 </span></a>        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1095"><span class="ln">1095 </span></a>          <span class="s3">// Remove the field from the projection</span>
<a name="l1096"><span class="ln">1096 </span></a>          <span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">userProvidedFields</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">field </span><span class="s1">=&gt; {</span>
<a name="l1097"><span class="ln">1097 </span></a>            <span class="s4">if </span><span class="s1">(</span><span class="s2">isSubpath</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">field</span><span class="s1">)) {</span>
<a name="l1098"><span class="ln">1098 </span></a>              <span class="s4">delete </span><span class="s2">fields</span><span class="s1">[</span><span class="s2">field</span><span class="s1">];</span>
<a name="l1099"><span class="ln">1099 </span></a>              <span class="s4">delete </span><span class="s2">userProvidedFields</span><span class="s1">[</span><span class="s2">field</span><span class="s1">];</span>
<a name="l1100"><span class="ln">1100 </span></a>            <span class="s1">}</span>
<a name="l1101"><span class="ln">1101 </span></a>          <span class="s1">});</span>
<a name="l1102"><span class="ln">1102 </span></a>        <span class="s1">}</span>
<a name="l1103"><span class="ln">1103 </span></a>      <span class="s1">});</span>
<a name="l1104"><span class="ln">1104 </span></a>    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">selectedExclusively</span><span class="s1">()) {</span>
<a name="l1105"><span class="ln">1105 </span></a>      <span class="s2">Object</span><span class="s1">.</span><span class="s2">entries</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(([</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">]) =&gt; {</span>
<a name="l1106"><span class="ln">1106 </span></a>        <span class="s4">if </span><span class="s1">(!</span><span class="s2">value</span><span class="s1">) {</span>
<a name="l1107"><span class="ln">1107 </span></a>          <span class="s3">// Add the field to the projection</span>
<a name="l1108"><span class="ln">1108 </span></a>          <span class="s4">if </span><span class="s1">(</span><span class="s2">fields</span><span class="s1">[</span><span class="s0">'+' </span><span class="s1">+ </span><span class="s2">key</span><span class="s1">] != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1109"><span class="ln">1109 </span></a>            <span class="s4">delete </span><span class="s2">fields</span><span class="s1">[</span><span class="s0">'+' </span><span class="s1">+ </span><span class="s2">key</span><span class="s1">];</span>
<a name="l1110"><span class="ln">1110 </span></a>          <span class="s1">}</span>
<a name="l1111"><span class="ln">1111 </span></a>          <span class="s2">fields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">userProvidedFields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">sanitizeValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
<a name="l1112"><span class="ln">1112 </span></a>        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1113"><span class="ln">1113 </span></a>          <span class="s3">// Remove the field from the projection</span>
<a name="l1114"><span class="ln">1114 </span></a>          <span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">userProvidedFields</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">field </span><span class="s1">=&gt; {</span>
<a name="l1115"><span class="ln">1115 </span></a>            <span class="s4">if </span><span class="s1">(</span><span class="s2">isSubpath</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">field</span><span class="s1">)) {</span>
<a name="l1116"><span class="ln">1116 </span></a>              <span class="s4">delete </span><span class="s2">fields</span><span class="s1">[</span><span class="s2">field</span><span class="s1">];</span>
<a name="l1117"><span class="ln">1117 </span></a>              <span class="s4">delete </span><span class="s2">userProvidedFields</span><span class="s1">[</span><span class="s2">field</span><span class="s1">];</span>
<a name="l1118"><span class="ln">1118 </span></a>            <span class="s1">}</span>
<a name="l1119"><span class="ln">1119 </span></a>          <span class="s1">});</span>
<a name="l1120"><span class="ln">1120 </span></a>        <span class="s1">}</span>
<a name="l1121"><span class="ln">1121 </span></a>      <span class="s1">});</span>
<a name="l1122"><span class="ln">1122 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1123"><span class="ln">1123 </span></a>      <span class="s4">const </span><span class="s2">keys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">);</span>
<a name="l1124"><span class="ln">1124 </span></a>      <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">keys</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
<a name="l1125"><span class="ln">1125 </span></a>        <span class="s4">const </span><span class="s2">value </span><span class="s1">= </span><span class="s2">arg</span><span class="s1">[</span><span class="s2">keys</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]];</span>
<a name="l1126"><span class="ln">1126 </span></a>        <span class="s4">const </span><span class="s2">key </span><span class="s1">= </span><span class="s2">keys</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
<a name="l1127"><span class="ln">1127 </span></a>        <span class="s2">fields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">sanitizeValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
<a name="l1128"><span class="ln">1128 </span></a>        <span class="s2">userProvidedFields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">sanitizeValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
<a name="l1129"><span class="ln">1129 </span></a>      <span class="s1">}</span>
<a name="l1130"><span class="ln">1130 </span></a>    <span class="s1">}</span>
<a name="l1131"><span class="ln">1131 </span></a>
<a name="l1132"><span class="ln">1132 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l1133"><span class="ln">1133 </span></a>  <span class="s1">}</span>
<a name="l1134"><span class="ln">1134 </span></a>
<a name="l1135"><span class="ln">1135 </span></a>  <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'Invalid select() argument. Must be string or object.'</span><span class="s1">);</span>
<a name="l1136"><span class="ln">1136 </span></a><span class="s1">};</span>
<a name="l1137"><span class="ln">1137 </span></a>
<a name="l1138"><span class="ln">1138 </span></a><span class="s5">/**</span>
<a name="l1139"><span class="ln">1139 </span></a> <span class="s5">* Determines the MongoDB nodes from which to read.</span>
<a name="l1140"><span class="ln">1140 </span></a> <span class="s5">*</span>
<a name="l1141"><span class="ln">1141 </span></a> <span class="s5">* #### Preferences:</span>
<a name="l1142"><span class="ln">1142 </span></a> <span class="s5">*</span>
<a name="l1143"><span class="ln">1143 </span></a> <span class="s5">* ```</span>
<a name="l1144"><span class="ln">1144 </span></a> <span class="s5">* primary - (default) Read from primary only. Operations will produce an error if primary is unavailable. Cannot be combined with tags.</span>
<a name="l1145"><span class="ln">1145 </span></a> <span class="s5">* secondary            Read from secondary if available, otherwise error.</span>
<a name="l1146"><span class="ln">1146 </span></a> <span class="s5">* primaryPreferred     Read from primary if available, otherwise a secondary.</span>
<a name="l1147"><span class="ln">1147 </span></a> <span class="s5">* secondaryPreferred   Read from a secondary if available, otherwise read from the primary.</span>
<a name="l1148"><span class="ln">1148 </span></a> <span class="s5">* nearest              All operations read from among the nearest candidates, but unlike other modes, this option will include both the primary and all secondaries in the random selection.</span>
<a name="l1149"><span class="ln">1149 </span></a> <span class="s5">* ```</span>
<a name="l1150"><span class="ln">1150 </span></a> <span class="s5">*</span>
<a name="l1151"><span class="ln">1151 </span></a> <span class="s5">* Aliases</span>
<a name="l1152"><span class="ln">1152 </span></a> <span class="s5">*</span>
<a name="l1153"><span class="ln">1153 </span></a> <span class="s5">* ```</span>
<a name="l1154"><span class="ln">1154 </span></a> <span class="s5">* p   primary</span>
<a name="l1155"><span class="ln">1155 </span></a> <span class="s5">* pp  primaryPreferred</span>
<a name="l1156"><span class="ln">1156 </span></a> <span class="s5">* s   secondary</span>
<a name="l1157"><span class="ln">1157 </span></a> <span class="s5">* sp  secondaryPreferred</span>
<a name="l1158"><span class="ln">1158 </span></a> <span class="s5">* n   nearest</span>
<a name="l1159"><span class="ln">1159 </span></a> <span class="s5">* ```</span>
<a name="l1160"><span class="ln">1160 </span></a> <span class="s5">*</span>
<a name="l1161"><span class="ln">1161 </span></a> <span class="s5">* #### Example:</span>
<a name="l1162"><span class="ln">1162 </span></a> <span class="s5">*</span>
<a name="l1163"><span class="ln">1163 </span></a> <span class="s5">*     new Query().read('primary')</span>
<a name="l1164"><span class="ln">1164 </span></a> <span class="s5">*     new Query().read('p')  // same as primary</span>
<a name="l1165"><span class="ln">1165 </span></a> <span class="s5">*</span>
<a name="l1166"><span class="ln">1166 </span></a> <span class="s5">*     new Query().read('primaryPreferred')</span>
<a name="l1167"><span class="ln">1167 </span></a> <span class="s5">*     new Query().read('pp') // same as primaryPreferred</span>
<a name="l1168"><span class="ln">1168 </span></a> <span class="s5">*</span>
<a name="l1169"><span class="ln">1169 </span></a> <span class="s5">*     new Query().read('secondary')</span>
<a name="l1170"><span class="ln">1170 </span></a> <span class="s5">*     new Query().read('s')  // same as secondary</span>
<a name="l1171"><span class="ln">1171 </span></a> <span class="s5">*</span>
<a name="l1172"><span class="ln">1172 </span></a> <span class="s5">*     new Query().read('secondaryPreferred')</span>
<a name="l1173"><span class="ln">1173 </span></a> <span class="s5">*     new Query().read('sp') // same as secondaryPreferred</span>
<a name="l1174"><span class="ln">1174 </span></a> <span class="s5">*</span>
<a name="l1175"><span class="ln">1175 </span></a> <span class="s5">*     new Query().read('nearest')</span>
<a name="l1176"><span class="ln">1176 </span></a> <span class="s5">*     new Query().read('n')  // same as nearest</span>
<a name="l1177"><span class="ln">1177 </span></a> <span class="s5">*</span>
<a name="l1178"><span class="ln">1178 </span></a> <span class="s5">*     // read from secondaries with matching tags</span>
<a name="l1179"><span class="ln">1179 </span></a> <span class="s5">*     new Query().read('s', [{ dc:'sf', s: 1 },{ dc:'ma', s: 2 }])</span>
<a name="l1180"><span class="ln">1180 </span></a> <span class="s5">*</span>
<a name="l1181"><span class="ln">1181 </span></a> <span class="s5">* Read more about how to use read preferences [here](https://www.mongodb.com/docs/manual/applications/replication/#read-preference).</span>
<a name="l1182"><span class="ln">1182 </span></a> <span class="s5">*</span>
<a name="l1183"><span class="ln">1183 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">read</span>
<a name="l1184"><span class="ln">1184 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1185"><span class="ln">1185 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1186"><span class="ln">1186 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} mode one of the listed preference options or aliases</span>
<a name="l1187"><span class="ln">1187 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} [tags] optional tags for this query</span>
<a name="l1188"><span class="ln">1188 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">mongodb https://www.mongodb.com/docs/manual/applications/replication/#read-preference</span>
<a name="l1189"><span class="ln">1189 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1190"><span class="ln">1190 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1191"><span class="ln">1191 </span></a> <span class="s5">*/</span>
<a name="l1192"><span class="ln">1192 </span></a>
<a name="l1193"><span class="ln">1193 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">read </span><span class="s1">= </span><span class="s4">function </span><span class="s2">read</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">) {</span>
<a name="l1194"><span class="ln">1194 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">mode </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l1195"><span class="ln">1195 </span></a>    <span class="s2">mode </span><span class="s1">= </span><span class="s2">handleReadPreferenceAliases</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">);</span>
<a name="l1196"><span class="ln">1196 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readPreference </span><span class="s1">= { </span><span class="s2">mode</span><span class="s1">, </span><span class="s2">tags </span><span class="s1">};</span>
<a name="l1197"><span class="ln">1197 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1198"><span class="ln">1198 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readPreference </span><span class="s1">= </span><span class="s2">mode</span><span class="s1">;</span>
<a name="l1199"><span class="ln">1199 </span></a>  <span class="s1">}</span>
<a name="l1200"><span class="ln">1200 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1201"><span class="ln">1201 </span></a><span class="s1">};</span>
<a name="l1202"><span class="ln">1202 </span></a>
<a name="l1203"><span class="ln">1203 </span></a><span class="s5">/**</span>
<a name="l1204"><span class="ln">1204 </span></a> <span class="s5">* Overwrite default `.toString` to make logging more useful</span>
<a name="l1205"><span class="ln">1205 </span></a> <span class="s5">*</span>
<a name="l1206"><span class="ln">1206 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1207"><span class="ln">1207 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1208"><span class="ln">1208 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">toString</span>
<a name="l1209"><span class="ln">1209 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l1210"><span class="ln">1210 </span></a> <span class="s5">*/</span>
<a name="l1211"><span class="ln">1211 </span></a>
<a name="l1212"><span class="ln">1212 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">toString </span><span class="s1">= </span><span class="s4">function </span><span class="s2">toString</span><span class="s1">() {</span>
<a name="l1213"><span class="ln">1213 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'count' </span><span class="s1">||</span>
<a name="l1214"><span class="ln">1214 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'countDocuments' </span><span class="s1">||</span>
<a name="l1215"><span class="ln">1215 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'find' </span><span class="s1">||</span>
<a name="l1216"><span class="ln">1216 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'findOne' </span><span class="s1">||</span>
<a name="l1217"><span class="ln">1217 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'deleteMany' </span><span class="s1">||</span>
<a name="l1218"><span class="ln">1218 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'deleteOne' </span><span class="s1">||</span>
<a name="l1219"><span class="ln">1219 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'findOneAndDelete' </span><span class="s1">||</span>
<a name="l1220"><span class="ln">1220 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'remove'</span><span class="s1">) {</span>
<a name="l1221"><span class="ln">1221 </span></a>    <span class="s4">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">modelName</span><span class="s1">}</span><span class="s0">.</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">}</span><span class="s0">(</span><span class="s2">$</span><span class="s1">{</span><span class="s2">util</span><span class="s1">.</span><span class="s2">inspect</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">)}</span><span class="s0">)`</span><span class="s1">;</span>
<a name="l1222"><span class="ln">1222 </span></a>  <span class="s1">}</span>
<a name="l1223"><span class="ln">1223 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'distinct'</span><span class="s1">) {</span>
<a name="l1224"><span class="ln">1224 </span></a>    <span class="s4">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">modelName</span><span class="s1">}</span><span class="s0">.distinct('</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">}</span><span class="s0">', </span><span class="s2">$</span><span class="s1">{</span><span class="s2">util</span><span class="s1">.</span><span class="s2">inspect</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">)}</span><span class="s0">)`</span><span class="s1">;</span>
<a name="l1225"><span class="ln">1225 </span></a>  <span class="s1">}</span>
<a name="l1226"><span class="ln">1226 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'findOneAndReplace' </span><span class="s1">||</span>
<a name="l1227"><span class="ln">1227 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'findOneAndUpdate' </span><span class="s1">||</span>
<a name="l1228"><span class="ln">1228 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'replaceOne' </span><span class="s1">||</span>
<a name="l1229"><span class="ln">1229 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'update' </span><span class="s1">||</span>
<a name="l1230"><span class="ln">1230 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'updateMany' </span><span class="s1">||</span>
<a name="l1231"><span class="ln">1231 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'updateOne'</span><span class="s1">) {</span>
<a name="l1232"><span class="ln">1232 </span></a>    <span class="s4">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">modelName</span><span class="s1">}</span><span class="s0">.</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">}</span><span class="s0">(</span><span class="s2">$</span><span class="s1">{</span><span class="s2">util</span><span class="s1">.</span><span class="s2">inspect</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">)}</span><span class="s0">, </span><span class="s2">$</span><span class="s1">{</span><span class="s2">util</span><span class="s1">.</span><span class="s2">inspect</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">)}</span><span class="s0">)`</span><span class="s1">;</span>
<a name="l1233"><span class="ln">1233 </span></a>  <span class="s1">}</span>
<a name="l1234"><span class="ln">1234 </span></a>
<a name="l1235"><span class="ln">1235 </span></a>  <span class="s3">// 'estimatedDocumentCount' or any others</span>
<a name="l1236"><span class="ln">1236 </span></a>  <span class="s4">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">modelName</span><span class="s1">}</span><span class="s0">.</span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">}</span><span class="s0">()`</span><span class="s1">;</span>
<a name="l1237"><span class="ln">1237 </span></a><span class="s1">};</span>
<a name="l1238"><span class="ln">1238 </span></a>
<a name="l1239"><span class="ln">1239 </span></a><span class="s5">/**</span>
<a name="l1240"><span class="ln">1240 </span></a> <span class="s5">* Sets the [MongoDB session](https://www.mongodb.com/docs/manual/reference/server-sessions/)</span>
<a name="l1241"><span class="ln">1241 </span></a> <span class="s5">* associated with this query. Sessions are how you mark a query as part of a</span>
<a name="l1242"><span class="ln">1242 </span></a> <span class="s5">* [transaction](https://mongoosejs.com/docs/transactions.html).</span>
<a name="l1243"><span class="ln">1243 </span></a> <span class="s5">*</span>
<a name="l1244"><span class="ln">1244 </span></a> <span class="s5">* Calling `session(null)` removes the session from this query.</span>
<a name="l1245"><span class="ln">1245 </span></a> <span class="s5">*</span>
<a name="l1246"><span class="ln">1246 </span></a> <span class="s5">* #### Example:</span>
<a name="l1247"><span class="ln">1247 </span></a> <span class="s5">*</span>
<a name="l1248"><span class="ln">1248 </span></a> <span class="s5">*     const s = await mongoose.startSession();</span>
<a name="l1249"><span class="ln">1249 </span></a> <span class="s5">*     await mongoose.model('Person').findOne({ name: 'Axl Rose' }).session(s);</span>
<a name="l1250"><span class="ln">1250 </span></a> <span class="s5">*</span>
<a name="l1251"><span class="ln">1251 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">session</span>
<a name="l1252"><span class="ln">1252 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1253"><span class="ln">1253 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1254"><span class="ln">1254 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{ClientSession} [session] from `await conn.startSession()`</span>
<a name="l1255"><span class="ln">1255 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Connection.prototype.startSession() https://mongoosejs.com/docs/api/connection.html#Connection.prototype.startSession()</span>
<a name="l1256"><span class="ln">1256 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">mongoose.startSession() https://mongoosejs.com/docs/api/mongoose.html#Mongoose.prototype.startSession()</span>
<a name="l1257"><span class="ln">1257 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1258"><span class="ln">1258 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1259"><span class="ln">1259 </span></a> <span class="s5">*/</span>
<a name="l1260"><span class="ln">1260 </span></a>
<a name="l1261"><span class="ln">1261 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">session </span><span class="s1">= </span><span class="s4">function </span><span class="s2">session</span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
<a name="l1262"><span class="ln">1262 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">v </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1263"><span class="ln">1263 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">session</span><span class="s1">;</span>
<a name="l1264"><span class="ln">1264 </span></a>  <span class="s1">}</span>
<a name="l1265"><span class="ln">1265 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">session </span><span class="s1">= </span><span class="s2">v</span><span class="s1">;</span>
<a name="l1266"><span class="ln">1266 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1267"><span class="ln">1267 </span></a><span class="s1">};</span>
<a name="l1268"><span class="ln">1268 </span></a>
<a name="l1269"><span class="ln">1269 </span></a><span class="s5">/**</span>
<a name="l1270"><span class="ln">1270 </span></a> <span class="s5">* Sets the 3 write concern parameters for this query:</span>
<a name="l1271"><span class="ln">1271 </span></a> <span class="s5">*</span>
<a name="l1272"><span class="ln">1272 </span></a> <span class="s5">* - `w`: Sets the specified number of `mongod` servers, or tag set of `mongod` servers, that must acknowledge this write before this write is considered successful.</span>
<a name="l1273"><span class="ln">1273 </span></a> <span class="s5">* - `j`: Boolean, set to `true` to request acknowledgement that this operation has been persisted to MongoDB's on-disk journal.</span>
<a name="l1274"><span class="ln">1274 </span></a> <span class="s5">* - `wtimeout`: If [`w &gt; 1`](https://mongoosejs.com/docs/api/query.html#Query.prototype.w()), the maximum amount of time to wait for this write to propagate through the replica set before this operation fails. The default is `0`, which means no timeout.</span>
<a name="l1275"><span class="ln">1275 </span></a> <span class="s5">*</span>
<a name="l1276"><span class="ln">1276 </span></a> <span class="s5">* This option is only valid for operations that write to the database:</span>
<a name="l1277"><span class="ln">1277 </span></a> <span class="s5">*</span>
<a name="l1278"><span class="ln">1278 </span></a> <span class="s5">* - `deleteOne()`</span>
<a name="l1279"><span class="ln">1279 </span></a> <span class="s5">* - `deleteMany()`</span>
<a name="l1280"><span class="ln">1280 </span></a> <span class="s5">* - `findOneAndDelete()`</span>
<a name="l1281"><span class="ln">1281 </span></a> <span class="s5">* - `findOneAndReplace()`</span>
<a name="l1282"><span class="ln">1282 </span></a> <span class="s5">* - `findOneAndUpdate()`</span>
<a name="l1283"><span class="ln">1283 </span></a> <span class="s5">* - `updateOne()`</span>
<a name="l1284"><span class="ln">1284 </span></a> <span class="s5">* - `updateMany()`</span>
<a name="l1285"><span class="ln">1285 </span></a> <span class="s5">*</span>
<a name="l1286"><span class="ln">1286 </span></a> <span class="s5">* Defaults to the schema's [`writeConcern` option](https://mongoosejs.com/docs/guide.html#writeConcern)</span>
<a name="l1287"><span class="ln">1287 </span></a> <span class="s5">*</span>
<a name="l1288"><span class="ln">1288 </span></a> <span class="s5">* #### Example:</span>
<a name="l1289"><span class="ln">1289 </span></a> <span class="s5">*</span>
<a name="l1290"><span class="ln">1290 </span></a> <span class="s5">*     // The 'majority' option means the `deleteOne()` promise won't resolve</span>
<a name="l1291"><span class="ln">1291 </span></a> <span class="s5">*     // until the `deleteOne()` has propagated to the majority of the replica set</span>
<a name="l1292"><span class="ln">1292 </span></a> <span class="s5">*     await mongoose.model('Person').</span>
<a name="l1293"><span class="ln">1293 </span></a> <span class="s5">*       deleteOne({ name: 'Ned Stark' }).</span>
<a name="l1294"><span class="ln">1294 </span></a> <span class="s5">*       writeConcern({ w: 'majority' });</span>
<a name="l1295"><span class="ln">1295 </span></a> <span class="s5">*</span>
<a name="l1296"><span class="ln">1296 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">writeConcern</span>
<a name="l1297"><span class="ln">1297 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1298"><span class="ln">1298 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1299"><span class="ln">1299 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} writeConcern the write concern value to set</span>
<a name="l1300"><span class="ln">1300 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">WriteConcernSettings https://mongodb.github.io/node-mongodb-native/4.9/interfaces/WriteConcernSettings.html</span>
<a name="l1301"><span class="ln">1301 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1302"><span class="ln">1302 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1303"><span class="ln">1303 </span></a> <span class="s5">*/</span>
<a name="l1304"><span class="ln">1304 </span></a>
<a name="l1305"><span class="ln">1305 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">writeConcern </span><span class="s1">= </span><span class="s4">function </span><span class="s2">writeConcern</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) {</span>
<a name="l1306"><span class="ln">1306 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1307"><span class="ln">1307 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">;</span>
<a name="l1308"><span class="ln">1308 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l1309"><span class="ln">1309 </span></a>  <span class="s1">}</span>
<a name="l1310"><span class="ln">1310 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l1311"><span class="ln">1311 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1312"><span class="ln">1312 </span></a><span class="s1">};</span>
<a name="l1313"><span class="ln">1313 </span></a>
<a name="l1314"><span class="ln">1314 </span></a><span class="s5">/**</span>
<a name="l1315"><span class="ln">1315 </span></a> <span class="s5">* Sets the specified number of `mongod` servers, or tag set of `mongod` servers,</span>
<a name="l1316"><span class="ln">1316 </span></a> <span class="s5">* that must acknowledge this write before this write is considered successful.</span>
<a name="l1317"><span class="ln">1317 </span></a> <span class="s5">* This option is only valid for operations that write to the database:</span>
<a name="l1318"><span class="ln">1318 </span></a> <span class="s5">*</span>
<a name="l1319"><span class="ln">1319 </span></a> <span class="s5">* - `deleteOne()`</span>
<a name="l1320"><span class="ln">1320 </span></a> <span class="s5">* - `deleteMany()`</span>
<a name="l1321"><span class="ln">1321 </span></a> <span class="s5">* - `findOneAndDelete()`</span>
<a name="l1322"><span class="ln">1322 </span></a> <span class="s5">* - `findOneAndReplace()`</span>
<a name="l1323"><span class="ln">1323 </span></a> <span class="s5">* - `findOneAndUpdate()`</span>
<a name="l1324"><span class="ln">1324 </span></a> <span class="s5">* - `updateOne()`</span>
<a name="l1325"><span class="ln">1325 </span></a> <span class="s5">* - `updateMany()`</span>
<a name="l1326"><span class="ln">1326 </span></a> <span class="s5">*</span>
<a name="l1327"><span class="ln">1327 </span></a> <span class="s5">* Defaults to the schema's [`writeConcern.w` option](https://mongoosejs.com/docs/guide.html#writeConcern)</span>
<a name="l1328"><span class="ln">1328 </span></a> <span class="s5">*</span>
<a name="l1329"><span class="ln">1329 </span></a> <span class="s5">* #### Example:</span>
<a name="l1330"><span class="ln">1330 </span></a> <span class="s5">*</span>
<a name="l1331"><span class="ln">1331 </span></a> <span class="s5">*     // The 'majority' option means the `deleteOne()` promise won't resolve</span>
<a name="l1332"><span class="ln">1332 </span></a> <span class="s5">*     // until the `deleteOne()` has propagated to the majority of the replica set</span>
<a name="l1333"><span class="ln">1333 </span></a> <span class="s5">*     await mongoose.model('Person').</span>
<a name="l1334"><span class="ln">1334 </span></a> <span class="s5">*       deleteOne({ name: 'Ned Stark' }).</span>
<a name="l1335"><span class="ln">1335 </span></a> <span class="s5">*       w('majority');</span>
<a name="l1336"><span class="ln">1336 </span></a> <span class="s5">*</span>
<a name="l1337"><span class="ln">1337 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">w</span>
<a name="l1338"><span class="ln">1338 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1339"><span class="ln">1339 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1340"><span class="ln">1340 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|number} val 0 for fire-and-forget, 1 for acknowledged by one server, 'majority' for majority of the replica set, or [any of the more advanced options](https://www.mongodb.com/docs/manual/reference/write-concern/#w-option).</span>
<a name="l1341"><span class="ln">1341 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">mongodb https://www.mongodb.com/docs/manual/reference/write-concern/#w-option</span>
<a name="l1342"><span class="ln">1342 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1343"><span class="ln">1343 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1344"><span class="ln">1344 </span></a> <span class="s5">*/</span>
<a name="l1345"><span class="ln">1345 </span></a>
<a name="l1346"><span class="ln">1346 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">w </span><span class="s1">= </span><span class="s4">function </span><span class="s2">w</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) {</span>
<a name="l1347"><span class="ln">1347 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1348"><span class="ln">1348 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">w</span><span class="s1">;</span>
<a name="l1349"><span class="ln">1349 </span></a>  <span class="s1">}</span>
<a name="l1350"><span class="ln">1350 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1351"><span class="ln">1351 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">.</span><span class="s2">w </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l1352"><span class="ln">1352 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1353"><span class="ln">1353 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">w </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l1354"><span class="ln">1354 </span></a>  <span class="s1">}</span>
<a name="l1355"><span class="ln">1355 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1356"><span class="ln">1356 </span></a><span class="s1">};</span>
<a name="l1357"><span class="ln">1357 </span></a>
<a name="l1358"><span class="ln">1358 </span></a><span class="s5">/**</span>
<a name="l1359"><span class="ln">1359 </span></a> <span class="s5">* Requests acknowledgement that this operation has been persisted to MongoDB's</span>
<a name="l1360"><span class="ln">1360 </span></a> <span class="s5">* on-disk journal.</span>
<a name="l1361"><span class="ln">1361 </span></a> <span class="s5">* This option is only valid for operations that write to the database:</span>
<a name="l1362"><span class="ln">1362 </span></a> <span class="s5">*</span>
<a name="l1363"><span class="ln">1363 </span></a> <span class="s5">* - `deleteOne()`</span>
<a name="l1364"><span class="ln">1364 </span></a> <span class="s5">* - `deleteMany()`</span>
<a name="l1365"><span class="ln">1365 </span></a> <span class="s5">* - `findOneAndDelete()`</span>
<a name="l1366"><span class="ln">1366 </span></a> <span class="s5">* - `findOneAndReplace()`</span>
<a name="l1367"><span class="ln">1367 </span></a> <span class="s5">* - `findOneAndUpdate()`</span>
<a name="l1368"><span class="ln">1368 </span></a> <span class="s5">* - `updateOne()`</span>
<a name="l1369"><span class="ln">1369 </span></a> <span class="s5">* - `updateMany()`</span>
<a name="l1370"><span class="ln">1370 </span></a> <span class="s5">*</span>
<a name="l1371"><span class="ln">1371 </span></a> <span class="s5">* Defaults to the schema's [`writeConcern.j` option](https://mongoosejs.com/docs/guide.html#writeConcern)</span>
<a name="l1372"><span class="ln">1372 </span></a> <span class="s5">*</span>
<a name="l1373"><span class="ln">1373 </span></a> <span class="s5">* #### Example:</span>
<a name="l1374"><span class="ln">1374 </span></a> <span class="s5">*</span>
<a name="l1375"><span class="ln">1375 </span></a> <span class="s5">*     await mongoose.model('Person').deleteOne({ name: 'Ned Stark' }).j(true);</span>
<a name="l1376"><span class="ln">1376 </span></a> <span class="s5">*</span>
<a name="l1377"><span class="ln">1377 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">j</span>
<a name="l1378"><span class="ln">1378 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1379"><span class="ln">1379 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1380"><span class="ln">1380 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{boolean} val</span>
<a name="l1381"><span class="ln">1381 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">mongodb https://www.mongodb.com/docs/manual/reference/write-concern/#j-option</span>
<a name="l1382"><span class="ln">1382 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1383"><span class="ln">1383 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1384"><span class="ln">1384 </span></a> <span class="s5">*/</span>
<a name="l1385"><span class="ln">1385 </span></a>
<a name="l1386"><span class="ln">1386 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">j </span><span class="s1">= </span><span class="s4">function </span><span class="s2">j</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) {</span>
<a name="l1387"><span class="ln">1387 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1388"><span class="ln">1388 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">j</span><span class="s1">;</span>
<a name="l1389"><span class="ln">1389 </span></a>  <span class="s1">}</span>
<a name="l1390"><span class="ln">1390 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1391"><span class="ln">1391 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">.</span><span class="s2">j </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l1392"><span class="ln">1392 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1393"><span class="ln">1393 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">j </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l1394"><span class="ln">1394 </span></a>  <span class="s1">}</span>
<a name="l1395"><span class="ln">1395 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1396"><span class="ln">1396 </span></a><span class="s1">};</span>
<a name="l1397"><span class="ln">1397 </span></a>
<a name="l1398"><span class="ln">1398 </span></a><span class="s5">/**</span>
<a name="l1399"><span class="ln">1399 </span></a> <span class="s5">* If [`w &gt; 1`](https://mongoosejs.com/docs/api/query.html#Query.prototype.w()), the maximum amount of time to</span>
<a name="l1400"><span class="ln">1400 </span></a> <span class="s5">* wait for this write to propagate through the replica set before this</span>
<a name="l1401"><span class="ln">1401 </span></a> <span class="s5">* operation fails. The default is `0`, which means no timeout.</span>
<a name="l1402"><span class="ln">1402 </span></a> <span class="s5">*</span>
<a name="l1403"><span class="ln">1403 </span></a> <span class="s5">* This option is only valid for operations that write to the database:</span>
<a name="l1404"><span class="ln">1404 </span></a> <span class="s5">*</span>
<a name="l1405"><span class="ln">1405 </span></a> <span class="s5">* - `deleteOne()`</span>
<a name="l1406"><span class="ln">1406 </span></a> <span class="s5">* - `deleteMany()`</span>
<a name="l1407"><span class="ln">1407 </span></a> <span class="s5">* - `findOneAndDelete()`</span>
<a name="l1408"><span class="ln">1408 </span></a> <span class="s5">* - `findOneAndReplace()`</span>
<a name="l1409"><span class="ln">1409 </span></a> <span class="s5">* - `findOneAndUpdate()`</span>
<a name="l1410"><span class="ln">1410 </span></a> <span class="s5">* - `updateOne()`</span>
<a name="l1411"><span class="ln">1411 </span></a> <span class="s5">* - `updateMany()`</span>
<a name="l1412"><span class="ln">1412 </span></a> <span class="s5">*</span>
<a name="l1413"><span class="ln">1413 </span></a> <span class="s5">* Defaults to the schema's [`writeConcern.wtimeout` option](https://mongoosejs.com/docs/guide.html#writeConcern)</span>
<a name="l1414"><span class="ln">1414 </span></a> <span class="s5">*</span>
<a name="l1415"><span class="ln">1415 </span></a> <span class="s5">* #### Example:</span>
<a name="l1416"><span class="ln">1416 </span></a> <span class="s5">*</span>
<a name="l1417"><span class="ln">1417 </span></a> <span class="s5">*     // The `deleteOne()` promise won't resolve until this `deleteOne()` has</span>
<a name="l1418"><span class="ln">1418 </span></a> <span class="s5">*     // propagated to at least `w = 2` members of the replica set. If it takes</span>
<a name="l1419"><span class="ln">1419 </span></a> <span class="s5">*     // longer than 1 second, this `deleteOne()` will fail.</span>
<a name="l1420"><span class="ln">1420 </span></a> <span class="s5">*     await mongoose.model('Person').</span>
<a name="l1421"><span class="ln">1421 </span></a> <span class="s5">*       deleteOne({ name: 'Ned Stark' }).</span>
<a name="l1422"><span class="ln">1422 </span></a> <span class="s5">*       w(2).</span>
<a name="l1423"><span class="ln">1423 </span></a> <span class="s5">*       wtimeout(1000);</span>
<a name="l1424"><span class="ln">1424 </span></a> <span class="s5">*</span>
<a name="l1425"><span class="ln">1425 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">wtimeout</span>
<a name="l1426"><span class="ln">1426 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1427"><span class="ln">1427 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1428"><span class="ln">1428 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{number} ms number of milliseconds to wait</span>
<a name="l1429"><span class="ln">1429 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">mongodb https://www.mongodb.com/docs/manual/reference/write-concern/#wtimeout</span>
<a name="l1430"><span class="ln">1430 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1431"><span class="ln">1431 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1432"><span class="ln">1432 </span></a> <span class="s5">*/</span>
<a name="l1433"><span class="ln">1433 </span></a>
<a name="l1434"><span class="ln">1434 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">wtimeout </span><span class="s1">= </span><span class="s4">function </span><span class="s2">wtimeout</span><span class="s1">(</span><span class="s2">ms</span><span class="s1">) {</span>
<a name="l1435"><span class="ln">1435 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">ms </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1436"><span class="ln">1436 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">wtimeout</span><span class="s1">;</span>
<a name="l1437"><span class="ln">1437 </span></a>  <span class="s1">}</span>
<a name="l1438"><span class="ln">1438 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1439"><span class="ln">1439 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">.</span><span class="s2">wtimeout </span><span class="s1">= </span><span class="s2">ms</span><span class="s1">;</span>
<a name="l1440"><span class="ln">1440 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1441"><span class="ln">1441 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">wtimeout </span><span class="s1">= </span><span class="s2">ms</span><span class="s1">;</span>
<a name="l1442"><span class="ln">1442 </span></a>  <span class="s1">}</span>
<a name="l1443"><span class="ln">1443 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1444"><span class="ln">1444 </span></a><span class="s1">};</span>
<a name="l1445"><span class="ln">1445 </span></a>
<a name="l1446"><span class="ln">1446 </span></a><span class="s5">/**</span>
<a name="l1447"><span class="ln">1447 </span></a> <span class="s5">* Sets the readConcern option for the query.</span>
<a name="l1448"><span class="ln">1448 </span></a> <span class="s5">*</span>
<a name="l1449"><span class="ln">1449 </span></a> <span class="s5">* #### Example:</span>
<a name="l1450"><span class="ln">1450 </span></a> <span class="s5">*</span>
<a name="l1451"><span class="ln">1451 </span></a> <span class="s5">*     new Query().readConcern('local')</span>
<a name="l1452"><span class="ln">1452 </span></a> <span class="s5">*     new Query().readConcern('l')  // same as local</span>
<a name="l1453"><span class="ln">1453 </span></a> <span class="s5">*</span>
<a name="l1454"><span class="ln">1454 </span></a> <span class="s5">*     new Query().readConcern('available')</span>
<a name="l1455"><span class="ln">1455 </span></a> <span class="s5">*     new Query().readConcern('a')  // same as available</span>
<a name="l1456"><span class="ln">1456 </span></a> <span class="s5">*</span>
<a name="l1457"><span class="ln">1457 </span></a> <span class="s5">*     new Query().readConcern('majority')</span>
<a name="l1458"><span class="ln">1458 </span></a> <span class="s5">*     new Query().readConcern('m')  // same as majority</span>
<a name="l1459"><span class="ln">1459 </span></a> <span class="s5">*</span>
<a name="l1460"><span class="ln">1460 </span></a> <span class="s5">*     new Query().readConcern('linearizable')</span>
<a name="l1461"><span class="ln">1461 </span></a> <span class="s5">*     new Query().readConcern('lz') // same as linearizable</span>
<a name="l1462"><span class="ln">1462 </span></a> <span class="s5">*</span>
<a name="l1463"><span class="ln">1463 </span></a> <span class="s5">*     new Query().readConcern('snapshot')</span>
<a name="l1464"><span class="ln">1464 </span></a> <span class="s5">*     new Query().readConcern('s')  // same as snapshot</span>
<a name="l1465"><span class="ln">1465 </span></a> <span class="s5">*</span>
<a name="l1466"><span class="ln">1466 </span></a> <span class="s5">*</span>
<a name="l1467"><span class="ln">1467 </span></a> <span class="s5">* #### Read Concern Level:</span>
<a name="l1468"><span class="ln">1468 </span></a> <span class="s5">*</span>
<a name="l1469"><span class="ln">1469 </span></a> <span class="s5">* ```</span>
<a name="l1470"><span class="ln">1470 </span></a> <span class="s5">* local         MongoDB 3.2+ The query returns from the instance with no guarantee guarantee that the data has been written to a majority of the replica set members (i.e. may be rolled back).</span>
<a name="l1471"><span class="ln">1471 </span></a> <span class="s5">* available     MongoDB 3.6+ The query returns from the instance with no guarantee guarantee that the data has been written to a majority of the replica set members (i.e. may be rolled back).</span>
<a name="l1472"><span class="ln">1472 </span></a> <span class="s5">* majority      MongoDB 3.2+ The query returns the data that has been acknowledged by a majority of the replica set members. The documents returned by the read operation are durable, even in the event of failure.</span>
<a name="l1473"><span class="ln">1473 </span></a> <span class="s5">* linearizable  MongoDB 3.4+ The query returns data that reflects all successful majority-acknowledged writes that completed prior to the start of the read operation. The query may wait for concurrently executing writes to propagate to a majority of replica set members before returning results.</span>
<a name="l1474"><span class="ln">1474 </span></a> <span class="s5">* snapshot      MongoDB 4.0+ Only available for operations within multi-document transactions. Upon transaction commit with write concern &quot;majority&quot;, the transaction operations are guaranteed to have read from a snapshot of majority-committed data.</span>
<a name="l1475"><span class="ln">1475 </span></a> <span class="s5">* ```</span>
<a name="l1476"><span class="ln">1476 </span></a> <span class="s5">*</span>
<a name="l1477"><span class="ln">1477 </span></a> <span class="s5">* Aliases</span>
<a name="l1478"><span class="ln">1478 </span></a> <span class="s5">*</span>
<a name="l1479"><span class="ln">1479 </span></a> <span class="s5">* ```</span>
<a name="l1480"><span class="ln">1480 </span></a> <span class="s5">* l   local</span>
<a name="l1481"><span class="ln">1481 </span></a> <span class="s5">* a   available</span>
<a name="l1482"><span class="ln">1482 </span></a> <span class="s5">* m   majority</span>
<a name="l1483"><span class="ln">1483 </span></a> <span class="s5">* lz  linearizable</span>
<a name="l1484"><span class="ln">1484 </span></a> <span class="s5">* s   snapshot</span>
<a name="l1485"><span class="ln">1485 </span></a> <span class="s5">* ```</span>
<a name="l1486"><span class="ln">1486 </span></a> <span class="s5">*</span>
<a name="l1487"><span class="ln">1487 </span></a> <span class="s5">* Read more about how to use read concern [here](https://www.mongodb.com/docs/manual/reference/read-concern/).</span>
<a name="l1488"><span class="ln">1488 </span></a> <span class="s5">*</span>
<a name="l1489"><span class="ln">1489 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1490"><span class="ln">1490 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">readConcern</span>
<a name="l1491"><span class="ln">1491 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} level one of the listed read concern level or their aliases</span>
<a name="l1492"><span class="ln">1492 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">mongodb https://www.mongodb.com/docs/manual/reference/read-concern/</span>
<a name="l1493"><span class="ln">1493 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1494"><span class="ln">1494 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1495"><span class="ln">1495 </span></a> <span class="s5">*/</span>
<a name="l1496"><span class="ln">1496 </span></a>
<a name="l1497"><span class="ln">1497 </span></a><span class="s5">/**</span>
<a name="l1498"><span class="ln">1498 </span></a> <span class="s5">* Gets query options.</span>
<a name="l1499"><span class="ln">1499 </span></a> <span class="s5">*</span>
<a name="l1500"><span class="ln">1500 </span></a> <span class="s5">* #### Example:</span>
<a name="l1501"><span class="ln">1501 </span></a> <span class="s5">*</span>
<a name="l1502"><span class="ln">1502 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1503"><span class="ln">1503 </span></a> <span class="s5">*     query.limit(10);</span>
<a name="l1504"><span class="ln">1504 </span></a> <span class="s5">*     query.setOptions({ maxTimeMS: 1000 });</span>
<a name="l1505"><span class="ln">1505 </span></a> <span class="s5">*     query.getOptions(); // { limit: 10, maxTimeMS: 1000 }</span>
<a name="l1506"><span class="ln">1506 </span></a> <span class="s5">*</span>
<a name="l1507"><span class="ln">1507 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} the options</span>
<a name="l1508"><span class="ln">1508 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1509"><span class="ln">1509 </span></a> <span class="s5">*/</span>
<a name="l1510"><span class="ln">1510 </span></a>
<a name="l1511"><span class="ln">1511 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getOptions </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l1512"><span class="ln">1512 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>
<a name="l1513"><span class="ln">1513 </span></a><span class="s1">};</span>
<a name="l1514"><span class="ln">1514 </span></a>
<a name="l1515"><span class="ln">1515 </span></a><span class="s5">/**</span>
<a name="l1516"><span class="ln">1516 </span></a> <span class="s5">* Sets query options. Some options only make sense for certain operations.</span>
<a name="l1517"><span class="ln">1517 </span></a> <span class="s5">*</span>
<a name="l1518"><span class="ln">1518 </span></a> <span class="s5">* #### Options:</span>
<a name="l1519"><span class="ln">1519 </span></a> <span class="s5">*</span>
<a name="l1520"><span class="ln">1520 </span></a> <span class="s5">* The following options are only for `find()`:</span>
<a name="l1521"><span class="ln">1521 </span></a> <span class="s5">*</span>
<a name="l1522"><span class="ln">1522 </span></a> <span class="s5">* - [tailable](https://www.mongodb.com/docs/manual/core/tailable-cursors/)</span>
<a name="l1523"><span class="ln">1523 </span></a> <span class="s5">* - [limit](https://www.mongodb.com/docs/manual/reference/method/cursor.limit/)</span>
<a name="l1524"><span class="ln">1524 </span></a> <span class="s5">* - [skip](https://www.mongodb.com/docs/manual/reference/method/cursor.skip/)</span>
<a name="l1525"><span class="ln">1525 </span></a> <span class="s5">* - [allowDiskUse](https://www.mongodb.com/docs/manual/reference/method/cursor.allowDiskUse/)</span>
<a name="l1526"><span class="ln">1526 </span></a> <span class="s5">* - [batchSize](https://www.mongodb.com/docs/manual/reference/method/cursor.batchSize/)</span>
<a name="l1527"><span class="ln">1527 </span></a> <span class="s5">* - [readPreference](https://www.mongodb.com/docs/manual/applications/replication/#read-preference)</span>
<a name="l1528"><span class="ln">1528 </span></a> <span class="s5">* - [hint](https://www.mongodb.com/docs/manual/reference/method/cursor.hint/)</span>
<a name="l1529"><span class="ln">1529 </span></a> <span class="s5">* - [comment](https://www.mongodb.com/docs/manual/reference/method/cursor.comment/)</span>
<a name="l1530"><span class="ln">1530 </span></a> <span class="s5">*</span>
<a name="l1531"><span class="ln">1531 </span></a> <span class="s5">* The following options are only for write operations: `updateOne()`, `updateMany()`, `replaceOne()`, `findOneAndUpdate()`, and `findByIdAndUpdate()`:</span>
<a name="l1532"><span class="ln">1532 </span></a> <span class="s5">*</span>
<a name="l1533"><span class="ln">1533 </span></a> <span class="s5">* - [upsert](https://www.mongodb.com/docs/manual/reference/method/db.collection.update/)</span>
<a name="l1534"><span class="ln">1534 </span></a> <span class="s5">* - [writeConcern](https://www.mongodb.com/docs/manual/reference/method/db.collection.update/)</span>
<a name="l1535"><span class="ln">1535 </span></a> <span class="s5">* - [timestamps](https://mongoosejs.com/docs/guide.html#timestamps): If `timestamps` is set in the schema, set this option to `false` to skip timestamps for that particular update. Has no effect if `timestamps` is not enabled in the schema options.</span>
<a name="l1536"><span class="ln">1536 </span></a> <span class="s5">* - overwriteDiscriminatorKey: allow setting the discriminator key in the update. Will use the correct discriminator schema if the update changes the discriminator key.</span>
<a name="l1537"><span class="ln">1537 </span></a> <span class="s5">*</span>
<a name="l1538"><span class="ln">1538 </span></a> <span class="s5">* The following options are only for `find()`, `findOne()`, `findById()`, `findOneAndUpdate()`, `findOneAndReplace()`, `findOneAndDelete()`, and `findByIdAndUpdate()`:</span>
<a name="l1539"><span class="ln">1539 </span></a> <span class="s5">*</span>
<a name="l1540"><span class="ln">1540 </span></a> <span class="s5">* - [lean](https://mongoosejs.com/docs/api/query.html#Query.prototype.lean())</span>
<a name="l1541"><span class="ln">1541 </span></a> <span class="s5">* - [populate](https://mongoosejs.com/docs/populate.html)</span>
<a name="l1542"><span class="ln">1542 </span></a> <span class="s5">* - [projection](https://mongoosejs.com/docs/api/query.html#Query.prototype.projection())</span>
<a name="l1543"><span class="ln">1543 </span></a> <span class="s5">* - sanitizeProjection</span>
<a name="l1544"><span class="ln">1544 </span></a> <span class="s5">* - useBigInt64</span>
<a name="l1545"><span class="ln">1545 </span></a> <span class="s5">*</span>
<a name="l1546"><span class="ln">1546 </span></a> <span class="s5">* The following options are only for all operations **except** `updateOne()`, `updateMany()`, `deleteOne()`, and `deleteMany()`:</span>
<a name="l1547"><span class="ln">1547 </span></a> <span class="s5">*</span>
<a name="l1548"><span class="ln">1548 </span></a> <span class="s5">* - [maxTimeMS](https://www.mongodb.com/docs/manual/reference/operator/meta/maxTimeMS/)</span>
<a name="l1549"><span class="ln">1549 </span></a> <span class="s5">*</span>
<a name="l1550"><span class="ln">1550 </span></a> <span class="s5">* The following options are for `find()`, `findOne()`, `findOneAndUpdate()`, `findOneAndDelete()`, `updateOne()`, and `deleteOne()`:</span>
<a name="l1551"><span class="ln">1551 </span></a> <span class="s5">*</span>
<a name="l1552"><span class="ln">1552 </span></a> <span class="s5">* - [sort](https://www.mongodb.com/docs/manual/reference/method/cursor.sort/)</span>
<a name="l1553"><span class="ln">1553 </span></a> <span class="s5">*</span>
<a name="l1554"><span class="ln">1554 </span></a> <span class="s5">* The following options are for `findOneAndUpdate()` and `findOneAndDelete()`</span>
<a name="l1555"><span class="ln">1555 </span></a> <span class="s5">*</span>
<a name="l1556"><span class="ln">1556 </span></a> <span class="s5">* - includeResultMetadata</span>
<a name="l1557"><span class="ln">1557 </span></a> <span class="s5">*</span>
<a name="l1558"><span class="ln">1558 </span></a> <span class="s5">* The following options are for all operations:</span>
<a name="l1559"><span class="ln">1559 </span></a> <span class="s5">*</span>
<a name="l1560"><span class="ln">1560 </span></a> <span class="s5">* - [strict](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l1561"><span class="ln">1561 </span></a> <span class="s5">* - [collation](https://www.mongodb.com/docs/manual/reference/collation/)</span>
<a name="l1562"><span class="ln">1562 </span></a> <span class="s5">* - [session](https://www.mongodb.com/docs/manual/reference/server-sessions/)</span>
<a name="l1563"><span class="ln">1563 </span></a> <span class="s5">* - [explain](https://www.mongodb.com/docs/manual/reference/method/cursor.explain/)</span>
<a name="l1564"><span class="ln">1564 </span></a> <span class="s5">*</span>
<a name="l1565"><span class="ln">1565 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} options</span>
<a name="l1566"><span class="ln">1566 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1567"><span class="ln">1567 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1568"><span class="ln">1568 </span></a> <span class="s5">*/</span>
<a name="l1569"><span class="ln">1569 </span></a>
<a name="l1570"><span class="ln">1570 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">setOptions </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">overwrite</span><span class="s1">) {</span>
<a name="l1571"><span class="ln">1571 </span></a>  <span class="s3">// overwrite is only for internal use</span>
<a name="l1572"><span class="ln">1572 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">overwrite</span><span class="s1">) {</span>
<a name="l1573"><span class="ln">1573 </span></a>    <span class="s3">// ensure that _mongooseOptions &amp; options are two different objects</span>
<a name="l1574"><span class="ln">1574 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions </span><span class="s1">= (</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s2">clone</span><span class="s1">(</span><span class="s2">options</span><span class="s1">)) || {};</span>
<a name="l1575"><span class="ln">1575 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s2">options </span><span class="s1">|| {};</span>
<a name="l1576"><span class="ln">1576 </span></a>
<a name="l1577"><span class="ln">1577 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s0">'populate' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1578"><span class="ln">1578 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">);</span>
<a name="l1579"><span class="ln">1579 </span></a>    <span class="s1">}</span>
<a name="l1580"><span class="ln">1580 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l1581"><span class="ln">1581 </span></a>  <span class="s1">}</span>
<a name="l1582"><span class="ln">1582 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1583"><span class="ln">1583 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l1584"><span class="ln">1584 </span></a>  <span class="s1">}</span>
<a name="l1585"><span class="ln">1585 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">!== </span><span class="s0">'object'</span><span class="s1">) {</span>
<a name="l1586"><span class="ln">1586 </span></a>    <span class="s4">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Options must be an object, got &quot;' </span><span class="s1">+ </span><span class="s2">options </span><span class="s1">+ </span><span class="s0">'&quot;'</span><span class="s1">);</span>
<a name="l1587"><span class="ln">1587 </span></a>  <span class="s1">}</span>
<a name="l1588"><span class="ln">1588 </span></a>
<a name="l1589"><span class="ln">1589 </span></a>  <span class="s2">options </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l1590"><span class="ln">1590 </span></a>
<a name="l1591"><span class="ln">1591 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">)) {</span>
<a name="l1592"><span class="ln">1592 </span></a>    <span class="s4">const </span><span class="s2">populate </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">;</span>
<a name="l1593"><span class="ln">1593 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">;</span>
<a name="l1594"><span class="ln">1594 </span></a>    <span class="s4">const </span><span class="s2">_numPopulate </span><span class="s1">= </span><span class="s2">populate</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
<a name="l1595"><span class="ln">1595 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">_numPopulate</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
<a name="l1596"><span class="ln">1596 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">(</span><span class="s2">populate</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
<a name="l1597"><span class="ln">1597 </span></a>    <span class="s1">}</span>
<a name="l1598"><span class="ln">1598 </span></a>  <span class="s1">}</span>
<a name="l1599"><span class="ln">1599 </span></a>
<a name="l1600"><span class="ln">1600 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'setDefaultsOnInsert' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1601"><span class="ln">1601 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">setDefaultsOnInsert </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">setDefaultsOnInsert</span><span class="s1">;</span>
<a name="l1602"><span class="ln">1602 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">setDefaultsOnInsert</span><span class="s1">;</span>
<a name="l1603"><span class="ln">1603 </span></a>  <span class="s1">}</span>
<a name="l1604"><span class="ln">1604 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'overwriteDiscriminatorKey' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1605"><span class="ln">1605 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">overwriteDiscriminatorKey </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">overwriteDiscriminatorKey</span><span class="s1">;</span>
<a name="l1606"><span class="ln">1606 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">overwriteDiscriminatorKey</span><span class="s1">;</span>
<a name="l1607"><span class="ln">1607 </span></a>  <span class="s1">}</span>
<a name="l1608"><span class="ln">1608 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'sanitizeProjection' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1609"><span class="ln">1609 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeProjection </span><span class="s1">&amp;&amp; !</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">sanitizeProjection</span><span class="s1">) {</span>
<a name="l1610"><span class="ln">1610 </span></a>      <span class="s2">sanitizeProjection</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l1611"><span class="ln">1611 </span></a>    <span class="s1">}</span>
<a name="l1612"><span class="ln">1612 </span></a>
<a name="l1613"><span class="ln">1613 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">sanitizeProjection </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeProjection</span><span class="s1">;</span>
<a name="l1614"><span class="ln">1614 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeProjection</span><span class="s1">;</span>
<a name="l1615"><span class="ln">1615 </span></a>  <span class="s1">}</span>
<a name="l1616"><span class="ln">1616 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'sanitizeFilter' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1617"><span class="ln">1617 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">sanitizeFilter </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeFilter</span><span class="s1">;</span>
<a name="l1618"><span class="ln">1618 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeFilter</span><span class="s1">;</span>
<a name="l1619"><span class="ln">1619 </span></a>  <span class="s1">}</span>
<a name="l1620"><span class="ln">1620 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'timestamps' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1621"><span class="ln">1621 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">timestamps </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">timestamps</span><span class="s1">;</span>
<a name="l1622"><span class="ln">1622 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">timestamps</span><span class="s1">;</span>
<a name="l1623"><span class="ln">1623 </span></a>  <span class="s1">}</span>
<a name="l1624"><span class="ln">1624 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'defaults' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1625"><span class="ln">1625 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">defaults </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">defaults</span><span class="s1">;</span>
<a name="l1626"><span class="ln">1626 </span></a>    <span class="s3">// deleting options.defaults will cause 7287 to fail</span>
<a name="l1627"><span class="ln">1627 </span></a>  <span class="s1">}</span>
<a name="l1628"><span class="ln">1628 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'translateAliases' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1629"><span class="ln">1629 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">translateAliases </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">;</span>
<a name="l1630"><span class="ln">1630 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">;</span>
<a name="l1631"><span class="ln">1631 </span></a>  <span class="s1">}</span>
<a name="l1632"><span class="ln">1632 </span></a>
<a name="l1633"><span class="ln">1633 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">== </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">&amp;&amp; </span><span class="s0">'lean' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l1634"><span class="ln">1634 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">;</span>
<a name="l1635"><span class="ln">1635 </span></a>  <span class="s1">}</span>
<a name="l1636"><span class="ln">1636 </span></a>
<a name="l1637"><span class="ln">1637 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">limit </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l1638"><span class="ln">1638 </span></a>    <span class="s4">try </span><span class="s1">{</span>
<a name="l1639"><span class="ln">1639 </span></a>      <span class="s2">options</span><span class="s1">.</span><span class="s2">limit </span><span class="s1">= </span><span class="s2">castNumber</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">limit</span><span class="s1">);</span>
<a name="l1640"><span class="ln">1640 </span></a>    <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l1641"><span class="ln">1641 </span></a>      <span class="s4">throw new </span><span class="s2">CastError</span><span class="s1">(</span><span class="s0">'Number'</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">limit</span><span class="s1">, </span><span class="s0">'limit'</span><span class="s1">);</span>
<a name="l1642"><span class="ln">1642 </span></a>    <span class="s1">}</span>
<a name="l1643"><span class="ln">1643 </span></a>  <span class="s1">}</span>
<a name="l1644"><span class="ln">1644 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">skip </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l1645"><span class="ln">1645 </span></a>    <span class="s4">try </span><span class="s1">{</span>
<a name="l1646"><span class="ln">1646 </span></a>      <span class="s2">options</span><span class="s1">.</span><span class="s2">skip </span><span class="s1">= </span><span class="s2">castNumber</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">skip</span><span class="s1">);</span>
<a name="l1647"><span class="ln">1647 </span></a>    <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l1648"><span class="ln">1648 </span></a>      <span class="s4">throw new </span><span class="s2">CastError</span><span class="s1">(</span><span class="s0">'Number'</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">skip</span><span class="s1">, </span><span class="s0">'skip'</span><span class="s1">);</span>
<a name="l1649"><span class="ln">1649 </span></a>    <span class="s1">}</span>
<a name="l1650"><span class="ln">1650 </span></a>  <span class="s1">}</span>
<a name="l1651"><span class="ln">1651 </span></a>
<a name="l1652"><span class="ln">1652 </span></a>  <span class="s3">// set arbitrary options</span>
<a name="l1653"><span class="ln">1653 </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">key of Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">options</span><span class="s1">)) {</span>
<a name="l1654"><span class="ln">1654 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">queryOptionMethods</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">)) {</span>
<a name="l1655"><span class="ln">1655 </span></a>      <span class="s4">const </span><span class="s2">args </span><span class="s1">= </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">]) ?</span>
<a name="l1656"><span class="ln">1656 </span></a>        <span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] :</span>
<a name="l1657"><span class="ln">1657 </span></a>        <span class="s1">[</span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">]];</span>
<a name="l1658"><span class="ln">1658 </span></a>      <span class="s4">this</span><span class="s1">[</span><span class="s2">key</span><span class="s1">].</span><span class="s2">apply</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">args</span><span class="s1">);</span>
<a name="l1659"><span class="ln">1659 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1660"><span class="ln">1660 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
<a name="l1661"><span class="ln">1661 </span></a>    <span class="s1">}</span>
<a name="l1662"><span class="ln">1662 </span></a>  <span class="s1">}</span>
<a name="l1663"><span class="ln">1663 </span></a>
<a name="l1664"><span class="ln">1664 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1665"><span class="ln">1665 </span></a><span class="s1">};</span>
<a name="l1666"><span class="ln">1666 </span></a>
<a name="l1667"><span class="ln">1667 </span></a><span class="s5">/**</span>
<a name="l1668"><span class="ln">1668 </span></a> <span class="s5">* Sets the [`explain` option](https://www.mongodb.com/docs/manual/reference/method/cursor.explain/),</span>
<a name="l1669"><span class="ln">1669 </span></a> <span class="s5">* which makes this query return detailed execution stats instead of the actual</span>
<a name="l1670"><span class="ln">1670 </span></a> <span class="s5">* query result. This method is useful for determining what index your queries</span>
<a name="l1671"><span class="ln">1671 </span></a> <span class="s5">* use.</span>
<a name="l1672"><span class="ln">1672 </span></a> <span class="s5">*</span>
<a name="l1673"><span class="ln">1673 </span></a> <span class="s5">* Calling `query.explain(v)` is equivalent to `query.setOptions({ explain: v })`</span>
<a name="l1674"><span class="ln">1674 </span></a> <span class="s5">*</span>
<a name="l1675"><span class="ln">1675 </span></a> <span class="s5">* #### Example:</span>
<a name="l1676"><span class="ln">1676 </span></a> <span class="s5">*</span>
<a name="l1677"><span class="ln">1677 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1678"><span class="ln">1678 </span></a> <span class="s5">*     const res = await query.find({ a: 1 }).explain('queryPlanner');</span>
<a name="l1679"><span class="ln">1679 </span></a> <span class="s5">*     console.log(res);</span>
<a name="l1680"><span class="ln">1680 </span></a> <span class="s5">*</span>
<a name="l1681"><span class="ln">1681 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [verbose] The verbosity mode. Either 'queryPlanner', 'executionStats', or 'allPlansExecution'. The default is 'queryPlanner'</span>
<a name="l1682"><span class="ln">1682 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1683"><span class="ln">1683 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1684"><span class="ln">1684 </span></a> <span class="s5">*/</span>
<a name="l1685"><span class="ln">1685 </span></a>
<a name="l1686"><span class="ln">1686 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">explain </span><span class="s1">= </span><span class="s4">function </span><span class="s2">explain</span><span class="s1">(</span><span class="s2">verbose</span><span class="s1">) {</span>
<a name="l1687"><span class="ln">1687 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l1688"><span class="ln">1688 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">explain </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l1689"><span class="ln">1689 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">verbose </span><span class="s1">=== </span><span class="s4">false</span><span class="s1">) {</span>
<a name="l1690"><span class="ln">1690 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">explain</span><span class="s1">;</span>
<a name="l1691"><span class="ln">1691 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1692"><span class="ln">1692 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">explain </span><span class="s1">= </span><span class="s2">verbose</span><span class="s1">;</span>
<a name="l1693"><span class="ln">1693 </span></a>  <span class="s1">}</span>
<a name="l1694"><span class="ln">1694 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1695"><span class="ln">1695 </span></a><span class="s1">};</span>
<a name="l1696"><span class="ln">1696 </span></a>
<a name="l1697"><span class="ln">1697 </span></a><span class="s5">/**</span>
<a name="l1698"><span class="ln">1698 </span></a> <span class="s5">* Sets the [`allowDiskUse` option](https://www.mongodb.com/docs/manual/reference/method/cursor.allowDiskUse/),</span>
<a name="l1699"><span class="ln">1699 </span></a> <span class="s5">* which allows the MongoDB server to use more than 100 MB for this query's `sort()`. This option can</span>
<a name="l1700"><span class="ln">1700 </span></a> <span class="s5">* let you work around `QueryExceededMemoryLimitNoDiskUseAllowed` errors from the MongoDB server.</span>
<a name="l1701"><span class="ln">1701 </span></a> <span class="s5">*</span>
<a name="l1702"><span class="ln">1702 </span></a> <span class="s5">* Note that this option requires MongoDB server &gt;= 4.4. Setting this option is a no-op for MongoDB 4.2</span>
<a name="l1703"><span class="ln">1703 </span></a> <span class="s5">* and earlier.</span>
<a name="l1704"><span class="ln">1704 </span></a> <span class="s5">*</span>
<a name="l1705"><span class="ln">1705 </span></a> <span class="s5">* Calling `query.allowDiskUse(v)` is equivalent to `query.setOptions({ allowDiskUse: v })`</span>
<a name="l1706"><span class="ln">1706 </span></a> <span class="s5">*</span>
<a name="l1707"><span class="ln">1707 </span></a> <span class="s5">* #### Example:</span>
<a name="l1708"><span class="ln">1708 </span></a> <span class="s5">*</span>
<a name="l1709"><span class="ln">1709 </span></a> <span class="s5">*     await query.find().sort({ name: 1 }).allowDiskUse(true);</span>
<a name="l1710"><span class="ln">1710 </span></a> <span class="s5">*     // Equivalent:</span>
<a name="l1711"><span class="ln">1711 </span></a> <span class="s5">*     await query.find().sort({ name: 1 }).allowDiskUse();</span>
<a name="l1712"><span class="ln">1712 </span></a> <span class="s5">*</span>
<a name="l1713"><span class="ln">1713 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [v] Enable/disable `allowDiskUse`. If called with 0 arguments, sets `allowDiskUse: true`</span>
<a name="l1714"><span class="ln">1714 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1715"><span class="ln">1715 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1716"><span class="ln">1716 </span></a> <span class="s5">*/</span>
<a name="l1717"><span class="ln">1717 </span></a>
<a name="l1718"><span class="ln">1718 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">allowDiskUse </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
<a name="l1719"><span class="ln">1719 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l1720"><span class="ln">1720 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowDiskUse </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l1721"><span class="ln">1721 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">v </span><span class="s1">=== </span><span class="s4">false</span><span class="s1">) {</span>
<a name="l1722"><span class="ln">1722 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowDiskUse</span><span class="s1">;</span>
<a name="l1723"><span class="ln">1723 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1724"><span class="ln">1724 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowDiskUse </span><span class="s1">= </span><span class="s2">v</span><span class="s1">;</span>
<a name="l1725"><span class="ln">1725 </span></a>  <span class="s1">}</span>
<a name="l1726"><span class="ln">1726 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1727"><span class="ln">1727 </span></a><span class="s1">};</span>
<a name="l1728"><span class="ln">1728 </span></a>
<a name="l1729"><span class="ln">1729 </span></a><span class="s5">/**</span>
<a name="l1730"><span class="ln">1730 </span></a> <span class="s5">* Sets the [maxTimeMS](https://www.mongodb.com/docs/manual/reference/method/cursor.maxTimeMS/)</span>
<a name="l1731"><span class="ln">1731 </span></a> <span class="s5">* option. This will tell the MongoDB server to abort if the query or write op</span>
<a name="l1732"><span class="ln">1732 </span></a> <span class="s5">* has been running for more than `ms` milliseconds.</span>
<a name="l1733"><span class="ln">1733 </span></a> <span class="s5">*</span>
<a name="l1734"><span class="ln">1734 </span></a> <span class="s5">* Calling `query.maxTimeMS(v)` is equivalent to `query.setOptions({ maxTimeMS: v })`</span>
<a name="l1735"><span class="ln">1735 </span></a> <span class="s5">*</span>
<a name="l1736"><span class="ln">1736 </span></a> <span class="s5">* #### Example:</span>
<a name="l1737"><span class="ln">1737 </span></a> <span class="s5">*</span>
<a name="l1738"><span class="ln">1738 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1739"><span class="ln">1739 </span></a> <span class="s5">*     // Throws an error 'operation exceeded time limit' as long as there's</span>
<a name="l1740"><span class="ln">1740 </span></a> <span class="s5">*     // &gt;= 1 doc in the queried collection</span>
<a name="l1741"><span class="ln">1741 </span></a> <span class="s5">*     const res = await query.find({ $where: 'sleep(1000) || true' }).maxTimeMS(100);</span>
<a name="l1742"><span class="ln">1742 </span></a> <span class="s5">*</span>
<a name="l1743"><span class="ln">1743 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} [ms] The number of milliseconds</span>
<a name="l1744"><span class="ln">1744 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l1745"><span class="ln">1745 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1746"><span class="ln">1746 </span></a> <span class="s5">*/</span>
<a name="l1747"><span class="ln">1747 </span></a>
<a name="l1748"><span class="ln">1748 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">maxTimeMS </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">ms</span><span class="s1">) {</span>
<a name="l1749"><span class="ln">1749 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">maxTimeMS </span><span class="s1">= </span><span class="s2">ms</span><span class="s1">;</span>
<a name="l1750"><span class="ln">1750 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l1751"><span class="ln">1751 </span></a><span class="s1">};</span>
<a name="l1752"><span class="ln">1752 </span></a>
<a name="l1753"><span class="ln">1753 </span></a><span class="s5">/**</span>
<a name="l1754"><span class="ln">1754 </span></a> <span class="s5">* Returns the current query filter (also known as conditions) as a [POJO](https://masteringjs.io/tutorials/fundamentals/pojo).</span>
<a name="l1755"><span class="ln">1755 </span></a> <span class="s5">*</span>
<a name="l1756"><span class="ln">1756 </span></a> <span class="s5">* #### Example:</span>
<a name="l1757"><span class="ln">1757 </span></a> <span class="s5">*</span>
<a name="l1758"><span class="ln">1758 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1759"><span class="ln">1759 </span></a> <span class="s5">*     query.find({ a: 1 }).where('b').gt(2);</span>
<a name="l1760"><span class="ln">1760 </span></a> <span class="s5">*     query.getFilter(); // { a: 1, b: { $gt: 2 } }</span>
<a name="l1761"><span class="ln">1761 </span></a> <span class="s5">*</span>
<a name="l1762"><span class="ln">1762 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} current query filter</span>
<a name="l1763"><span class="ln">1763 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1764"><span class="ln">1764 </span></a> <span class="s5">*/</span>
<a name="l1765"><span class="ln">1765 </span></a>
<a name="l1766"><span class="ln">1766 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getFilter </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l1767"><span class="ln">1767 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l1768"><span class="ln">1768 </span></a><span class="s1">};</span>
<a name="l1769"><span class="ln">1769 </span></a>
<a name="l1770"><span class="ln">1770 </span></a><span class="s5">/**</span>
<a name="l1771"><span class="ln">1771 </span></a> <span class="s5">* Returns the current query filter. Equivalent to `getFilter()`.</span>
<a name="l1772"><span class="ln">1772 </span></a> <span class="s5">*</span>
<a name="l1773"><span class="ln">1773 </span></a> <span class="s5">* You should use `getFilter()` instead of `getQuery()` where possible. `getQuery()`</span>
<a name="l1774"><span class="ln">1774 </span></a> <span class="s5">* will likely be deprecated in a future release.</span>
<a name="l1775"><span class="ln">1775 </span></a> <span class="s5">*</span>
<a name="l1776"><span class="ln">1776 </span></a> <span class="s5">* #### Example:</span>
<a name="l1777"><span class="ln">1777 </span></a> <span class="s5">*</span>
<a name="l1778"><span class="ln">1778 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1779"><span class="ln">1779 </span></a> <span class="s5">*     query.find({ a: 1 }).where('b').gt(2);</span>
<a name="l1780"><span class="ln">1780 </span></a> <span class="s5">*     query.getQuery(); // { a: 1, b: { $gt: 2 } }</span>
<a name="l1781"><span class="ln">1781 </span></a> <span class="s5">*</span>
<a name="l1782"><span class="ln">1782 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} current query filter</span>
<a name="l1783"><span class="ln">1783 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1784"><span class="ln">1784 </span></a> <span class="s5">*/</span>
<a name="l1785"><span class="ln">1785 </span></a>
<a name="l1786"><span class="ln">1786 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getQuery </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l1787"><span class="ln">1787 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l1788"><span class="ln">1788 </span></a><span class="s1">};</span>
<a name="l1789"><span class="ln">1789 </span></a>
<a name="l1790"><span class="ln">1790 </span></a><span class="s5">/**</span>
<a name="l1791"><span class="ln">1791 </span></a> <span class="s5">* Sets the query conditions to the provided JSON object.</span>
<a name="l1792"><span class="ln">1792 </span></a> <span class="s5">*</span>
<a name="l1793"><span class="ln">1793 </span></a> <span class="s5">* #### Example:</span>
<a name="l1794"><span class="ln">1794 </span></a> <span class="s5">*</span>
<a name="l1795"><span class="ln">1795 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1796"><span class="ln">1796 </span></a> <span class="s5">*     query.find({ a: 1 })</span>
<a name="l1797"><span class="ln">1797 </span></a> <span class="s5">*     query.setQuery({ a: 2 });</span>
<a name="l1798"><span class="ln">1798 </span></a> <span class="s5">*     query.getQuery(); // { a: 2 }</span>
<a name="l1799"><span class="ln">1799 </span></a> <span class="s5">*</span>
<a name="l1800"><span class="ln">1800 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} new query conditions</span>
<a name="l1801"><span class="ln">1801 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{undefined}</span>
<a name="l1802"><span class="ln">1802 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1803"><span class="ln">1803 </span></a> <span class="s5">*/</span>
<a name="l1804"><span class="ln">1804 </span></a>
<a name="l1805"><span class="ln">1805 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">setQuery </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) {</span>
<a name="l1806"><span class="ln">1806 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l1807"><span class="ln">1807 </span></a><span class="s1">};</span>
<a name="l1808"><span class="ln">1808 </span></a>
<a name="l1809"><span class="ln">1809 </span></a><span class="s5">/**</span>
<a name="l1810"><span class="ln">1810 </span></a> <span class="s5">* Returns the current update operations as a JSON object.</span>
<a name="l1811"><span class="ln">1811 </span></a> <span class="s5">*</span>
<a name="l1812"><span class="ln">1812 </span></a> <span class="s5">* #### Example:</span>
<a name="l1813"><span class="ln">1813 </span></a> <span class="s5">*</span>
<a name="l1814"><span class="ln">1814 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1815"><span class="ln">1815 </span></a> <span class="s5">*     query.updateOne({}, { $set: { a: 5 } });</span>
<a name="l1816"><span class="ln">1816 </span></a> <span class="s5">*     query.getUpdate(); // { $set: { a: 5 } }</span>
<a name="l1817"><span class="ln">1817 </span></a> <span class="s5">*</span>
<a name="l1818"><span class="ln">1818 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} current update operations</span>
<a name="l1819"><span class="ln">1819 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1820"><span class="ln">1820 </span></a> <span class="s5">*/</span>
<a name="l1821"><span class="ln">1821 </span></a>
<a name="l1822"><span class="ln">1822 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getUpdate </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l1823"><span class="ln">1823 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">;</span>
<a name="l1824"><span class="ln">1824 </span></a><span class="s1">};</span>
<a name="l1825"><span class="ln">1825 </span></a>
<a name="l1826"><span class="ln">1826 </span></a><span class="s5">/**</span>
<a name="l1827"><span class="ln">1827 </span></a> <span class="s5">* Sets the current update operation to new value.</span>
<a name="l1828"><span class="ln">1828 </span></a> <span class="s5">*</span>
<a name="l1829"><span class="ln">1829 </span></a> <span class="s5">* #### Example:</span>
<a name="l1830"><span class="ln">1830 </span></a> <span class="s5">*</span>
<a name="l1831"><span class="ln">1831 </span></a> <span class="s5">*     const query = new Query();</span>
<a name="l1832"><span class="ln">1832 </span></a> <span class="s5">*     query.updateOne({}, { $set: { a: 5 } });</span>
<a name="l1833"><span class="ln">1833 </span></a> <span class="s5">*     query.setUpdate({ $set: { b: 6 } });</span>
<a name="l1834"><span class="ln">1834 </span></a> <span class="s5">*     query.getUpdate(); // { $set: { b: 6 } }</span>
<a name="l1835"><span class="ln">1835 </span></a> <span class="s5">*</span>
<a name="l1836"><span class="ln">1836 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} new update operation</span>
<a name="l1837"><span class="ln">1837 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{undefined}</span>
<a name="l1838"><span class="ln">1838 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l1839"><span class="ln">1839 </span></a> <span class="s5">*/</span>
<a name="l1840"><span class="ln">1840 </span></a>
<a name="l1841"><span class="ln">1841 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">setUpdate </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">val</span><span class="s1">) {</span>
<a name="l1842"><span class="ln">1842 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l1843"><span class="ln">1843 </span></a><span class="s1">};</span>
<a name="l1844"><span class="ln">1844 </span></a>
<a name="l1845"><span class="ln">1845 </span></a><span class="s5">/**</span>
<a name="l1846"><span class="ln">1846 </span></a> <span class="s5">* Returns fields selection for this query.</span>
<a name="l1847"><span class="ln">1847 </span></a> <span class="s5">*</span>
<a name="l1848"><span class="ln">1848 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_fieldsForExec</span>
<a name="l1849"><span class="ln">1849 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object}</span>
<a name="l1850"><span class="ln">1850 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l1851"><span class="ln">1851 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1852"><span class="ln">1852 </span></a> <span class="s5">*/</span>
<a name="l1853"><span class="ln">1853 </span></a>
<a name="l1854"><span class="ln">1854 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_fieldsForExec </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l1855"><span class="ln">1855 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1856"><span class="ln">1856 </span></a>    <span class="s4">return null</span><span class="s1">;</span>
<a name="l1857"><span class="ln">1857 </span></a>  <span class="s1">}</span>
<a name="l1858"><span class="ln">1858 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">).</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l1859"><span class="ln">1859 </span></a>    <span class="s4">return null</span><span class="s1">;</span>
<a name="l1860"><span class="ln">1860 </span></a>  <span class="s1">}</span>
<a name="l1861"><span class="ln">1861 </span></a>  <span class="s4">return </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l1862"><span class="ln">1862 </span></a><span class="s1">};</span>
<a name="l1863"><span class="ln">1863 </span></a>
<a name="l1864"><span class="ln">1864 </span></a>
<a name="l1865"><span class="ln">1865 </span></a><span class="s5">/**</span>
<a name="l1866"><span class="ln">1866 </span></a> <span class="s5">* Return an update document with corrected `$set` operations.</span>
<a name="l1867"><span class="ln">1867 </span></a> <span class="s5">*</span>
<a name="l1868"><span class="ln">1868 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_updateForExec</span>
<a name="l1869"><span class="ln">1869 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object}</span>
<a name="l1870"><span class="ln">1870 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l1871"><span class="ln">1871 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1872"><span class="ln">1872 </span></a> <span class="s5">*/</span>
<a name="l1873"><span class="ln">1873 </span></a>
<a name="l1874"><span class="ln">1874 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_updateForExec </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l1875"><span class="ln">1875 </span></a>  <span class="s4">const </span><span class="s2">update </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, {</span>
<a name="l1876"><span class="ln">1876 </span></a>    <span class="s2">transform</span><span class="s1">: </span><span class="s4">false</span><span class="s1">,</span>
<a name="l1877"><span class="ln">1877 </span></a>    <span class="s2">depopulate</span><span class="s1">: </span><span class="s4">true</span>
<a name="l1878"><span class="ln">1878 </span></a>  <span class="s1">});</span>
<a name="l1879"><span class="ln">1879 </span></a>  <span class="s4">const </span><span class="s2">ops </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">update</span><span class="s1">);</span>
<a name="l1880"><span class="ln">1880 </span></a>  <span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">ops</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
<a name="l1881"><span class="ln">1881 </span></a>  <span class="s4">const </span><span class="s2">ret </span><span class="s1">= {};</span>
<a name="l1882"><span class="ln">1882 </span></a>
<a name="l1883"><span class="ln">1883 </span></a>  <span class="s4">while </span><span class="s1">(</span><span class="s2">i</span><span class="s1">--) {</span>
<a name="l1884"><span class="ln">1884 </span></a>    <span class="s4">const </span><span class="s2">op </span><span class="s1">= </span><span class="s2">ops</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
<a name="l1885"><span class="ln">1885 </span></a>
<a name="l1886"><span class="ln">1886 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s0">'$' </span><span class="s1">!== </span><span class="s2">op</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
<a name="l1887"><span class="ln">1887 </span></a>      <span class="s3">// fix up $set sugar</span>
<a name="l1888"><span class="ln">1888 </span></a>      <span class="s4">if </span><span class="s1">(!</span><span class="s2">ret</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">) {</span>
<a name="l1889"><span class="ln">1889 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">update</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">) {</span>
<a name="l1890"><span class="ln">1890 </span></a>          <span class="s2">ret</span><span class="s1">.</span><span class="s2">$set </span><span class="s1">= </span><span class="s2">update</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">;</span>
<a name="l1891"><span class="ln">1891 </span></a>        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1892"><span class="ln">1892 </span></a>          <span class="s2">ret</span><span class="s1">.</span><span class="s2">$set </span><span class="s1">= {};</span>
<a name="l1893"><span class="ln">1893 </span></a>        <span class="s1">}</span>
<a name="l1894"><span class="ln">1894 </span></a>      <span class="s1">}</span>
<a name="l1895"><span class="ln">1895 </span></a>      <span class="s2">ret</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">[</span><span class="s2">op</span><span class="s1">] = </span><span class="s2">update</span><span class="s1">[</span><span class="s2">op</span><span class="s1">];</span>
<a name="l1896"><span class="ln">1896 </span></a>      <span class="s2">ops</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">i</span><span class="s1">, </span><span class="s7">1</span><span class="s1">);</span>
<a name="l1897"><span class="ln">1897 </span></a>      <span class="s4">if </span><span class="s1">(!~</span><span class="s2">ops</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'$set'</span><span class="s1">)) </span><span class="s2">ops</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">'$set'</span><span class="s1">);</span>
<a name="l1898"><span class="ln">1898 </span></a>    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s0">'$set' </span><span class="s1">=== </span><span class="s2">op</span><span class="s1">) {</span>
<a name="l1899"><span class="ln">1899 </span></a>      <span class="s4">if </span><span class="s1">(!</span><span class="s2">ret</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">) {</span>
<a name="l1900"><span class="ln">1900 </span></a>        <span class="s2">ret</span><span class="s1">[</span><span class="s2">op</span><span class="s1">] = </span><span class="s2">update</span><span class="s1">[</span><span class="s2">op</span><span class="s1">];</span>
<a name="l1901"><span class="ln">1901 </span></a>      <span class="s1">}</span>
<a name="l1902"><span class="ln">1902 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l1903"><span class="ln">1903 </span></a>      <span class="s2">ret</span><span class="s1">[</span><span class="s2">op</span><span class="s1">] = </span><span class="s2">update</span><span class="s1">[</span><span class="s2">op</span><span class="s1">];</span>
<a name="l1904"><span class="ln">1904 </span></a>    <span class="s1">}</span>
<a name="l1905"><span class="ln">1905 </span></a>  <span class="s1">}</span>
<a name="l1906"><span class="ln">1906 </span></a>
<a name="l1907"><span class="ln">1907 </span></a>  <span class="s4">return </span><span class="s2">ret</span><span class="s1">;</span>
<a name="l1908"><span class="ln">1908 </span></a><span class="s1">};</span>
<a name="l1909"><span class="ln">1909 </span></a>
<a name="l1910"><span class="ln">1910 </span></a><span class="s5">/**</span>
<a name="l1911"><span class="ln">1911 </span></a> <span class="s5">* Makes sure _path is set.</span>
<a name="l1912"><span class="ln">1912 </span></a> <span class="s5">*</span>
<a name="l1913"><span class="ln">1913 </span></a> <span class="s5">* This method is inherited by `mquery`</span>
<a name="l1914"><span class="ln">1914 </span></a> <span class="s5">*</span>
<a name="l1915"><span class="ln">1915 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_ensurePath</span>
<a name="l1916"><span class="ln">1916 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} method</span>
<a name="l1917"><span class="ln">1917 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l1918"><span class="ln">1918 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1919"><span class="ln">1919 </span></a> <span class="s5">*/</span>
<a name="l1920"><span class="ln">1920 </span></a>
<a name="l1921"><span class="ln">1921 </span></a><span class="s5">/**</span>
<a name="l1922"><span class="ln">1922 </span></a> <span class="s5">* Determines if `conds` can be merged using `mquery().merge()`</span>
<a name="l1923"><span class="ln">1923 </span></a> <span class="s5">*</span>
<a name="l1924"><span class="ln">1924 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">canMerge</span>
<a name="l1925"><span class="ln">1925 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l1926"><span class="ln">1926 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l1927"><span class="ln">1927 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} conds</span>
<a name="l1928"><span class="ln">1928 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Boolean}</span>
<a name="l1929"><span class="ln">1929 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l1930"><span class="ln">1930 </span></a> <span class="s5">*/</span>
<a name="l1931"><span class="ln">1931 </span></a>
<a name="l1932"><span class="ln">1932 </span></a><span class="s5">/**</span>
<a name="l1933"><span class="ln">1933 </span></a> <span class="s5">* Returns default options for this query.</span>
<a name="l1934"><span class="ln">1934 </span></a> <span class="s5">*</span>
<a name="l1935"><span class="ln">1935 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Model} model</span>
<a name="l1936"><span class="ln">1936 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l1937"><span class="ln">1937 </span></a> <span class="s5">*/</span>
<a name="l1938"><span class="ln">1938 </span></a>
<a name="l1939"><span class="ln">1939 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_optionsForExec </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">model</span><span class="s1">) {</span>
<a name="l1940"><span class="ln">1940 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l1941"><span class="ln">1941 </span></a>  <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">;</span>
<a name="l1942"><span class="ln">1942 </span></a>  <span class="s2">model </span><span class="s1">= </span><span class="s2">model </span><span class="s1">|| </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">;</span>
<a name="l1943"><span class="ln">1943 </span></a>
<a name="l1944"><span class="ln">1944 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">model</span><span class="s1">) {</span>
<a name="l1945"><span class="ln">1945 </span></a>    <span class="s4">return </span><span class="s2">options</span><span class="s1">;</span>
<a name="l1946"><span class="ln">1946 </span></a>  <span class="s1">}</span>
<a name="l1947"><span class="ln">1947 </span></a>  <span class="s3">// Apply schema-level `writeConcern` option</span>
<a name="l1948"><span class="ln">1948 </span></a>  <span class="s2">applyWriteConcern</span><span class="s1">(</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l1949"><span class="ln">1949 </span></a>
<a name="l1950"><span class="ln">1950 </span></a>  <span class="s4">const </span><span class="s2">readPreference </span><span class="s1">= </span><span class="s2">model </span><span class="s1">&amp;&amp;</span>
<a name="l1951"><span class="ln">1951 </span></a>  <span class="s2">model</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">&amp;&amp;</span>
<a name="l1952"><span class="ln">1952 </span></a>  <span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp;</span>
<a name="l1953"><span class="ln">1953 </span></a>  <span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">read</span><span class="s1">;</span>
<a name="l1954"><span class="ln">1954 </span></a>  <span class="s4">if </span><span class="s1">(!(</span><span class="s0">'readPreference' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) &amp;&amp; </span><span class="s2">readPreference</span><span class="s1">) {</span>
<a name="l1955"><span class="ln">1955 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">readPreference </span><span class="s1">= </span><span class="s2">readPreference</span><span class="s1">;</span>
<a name="l1956"><span class="ln">1956 </span></a>  <span class="s1">}</span>
<a name="l1957"><span class="ln">1957 </span></a>
<a name="l1958"><span class="ln">1958 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">upsert </span><span class="s1">!== </span><span class="s4">void </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l1959"><span class="ln">1959 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">upsert </span><span class="s1">= !!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">upsert</span><span class="s1">;</span>
<a name="l1960"><span class="ln">1960 </span></a>  <span class="s1">}</span>
<a name="l1961"><span class="ln">1961 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">) {</span>
<a name="l1962"><span class="ln">1962 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">j</span><span class="s1">) {</span>
<a name="l1963"><span class="ln">1963 </span></a>      <span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">.</span><span class="s2">j </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">j</span><span class="s1">;</span>
<a name="l1964"><span class="ln">1964 </span></a>      <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">j</span><span class="s1">;</span>
<a name="l1965"><span class="ln">1965 </span></a>    <span class="s1">}</span>
<a name="l1966"><span class="ln">1966 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">w</span><span class="s1">) {</span>
<a name="l1967"><span class="ln">1967 </span></a>      <span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">.</span><span class="s2">w </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">w</span><span class="s1">;</span>
<a name="l1968"><span class="ln">1968 </span></a>      <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">w</span><span class="s1">;</span>
<a name="l1969"><span class="ln">1969 </span></a>    <span class="s1">}</span>
<a name="l1970"><span class="ln">1970 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">wtimeout</span><span class="s1">) {</span>
<a name="l1971"><span class="ln">1971 </span></a>      <span class="s2">options</span><span class="s1">.</span><span class="s2">writeConcern</span><span class="s1">.</span><span class="s2">wtimeout </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">wtimeout</span><span class="s1">;</span>
<a name="l1972"><span class="ln">1972 </span></a>      <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">wtimeout</span><span class="s1">;</span>
<a name="l1973"><span class="ln">1973 </span></a>    <span class="s1">}</span>
<a name="l1974"><span class="ln">1974 </span></a>  <span class="s1">}</span>
<a name="l1975"><span class="ln">1975 </span></a>
<a name="l1976"><span class="ln">1976 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyPaths</span><span class="s1">();</span>
<a name="l1977"><span class="ln">1977 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1978"><span class="ln">1978 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_castFields</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l1979"><span class="ln">1979 </span></a>    <span class="s4">const </span><span class="s2">projection </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fieldsForExec</span><span class="s1">();</span>
<a name="l1980"><span class="ln">1980 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">projection </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l1981"><span class="ln">1981 </span></a>      <span class="s2">options</span><span class="s1">.</span><span class="s2">projection </span><span class="s1">= </span><span class="s2">projection</span><span class="s1">;</span>
<a name="l1982"><span class="ln">1982 </span></a>    <span class="s1">}</span>
<a name="l1983"><span class="ln">1983 </span></a>  <span class="s1">}</span>
<a name="l1984"><span class="ln">1984 </span></a>
<a name="l1985"><span class="ln">1985 </span></a>  <span class="s4">return </span><span class="s2">options</span><span class="s1">;</span>
<a name="l1986"><span class="ln">1986 </span></a><span class="s1">};</span>
<a name="l1987"><span class="ln">1987 </span></a>
<a name="l1988"><span class="ln">1988 </span></a><span class="s5">/**</span>
<a name="l1989"><span class="ln">1989 </span></a> <span class="s5">* Sets the lean option.</span>
<a name="l1990"><span class="ln">1990 </span></a> <span class="s5">*</span>
<a name="l1991"><span class="ln">1991 </span></a> <span class="s5">* Documents returned from queries with the `lean` option enabled are plain</span>
<a name="l1992"><span class="ln">1992 </span></a> <span class="s5">* javascript objects, not [Mongoose Documents](https://mongoosejs.com/docs/api/document.html). They have no</span>
<a name="l1993"><span class="ln">1993 </span></a> <span class="s5">* `save` method, getters/setters, virtuals, or other Mongoose features.</span>
<a name="l1994"><span class="ln">1994 </span></a> <span class="s5">*</span>
<a name="l1995"><span class="ln">1995 </span></a> <span class="s5">* #### Example:</span>
<a name="l1996"><span class="ln">1996 </span></a> <span class="s5">*</span>
<a name="l1997"><span class="ln">1997 </span></a> <span class="s5">*     new Query().lean() // true</span>
<a name="l1998"><span class="ln">1998 </span></a> <span class="s5">*     new Query().lean(true)</span>
<a name="l1999"><span class="ln">1999 </span></a> <span class="s5">*     new Query().lean(false)</span>
<a name="l2000"><span class="ln">2000 </span></a> <span class="s5">*</span>
<a name="l2001"><span class="ln">2001 </span></a> <span class="s5">*     const docs = await Model.find().lean();</span>
<a name="l2002"><span class="ln">2002 </span></a> <span class="s5">*     docs[0] instanceof mongoose.Document; // false</span>
<a name="l2003"><span class="ln">2003 </span></a> <span class="s5">*</span>
<a name="l2004"><span class="ln">2004 </span></a> <span class="s5">* [Lean is great for high-performance, read-only cases](https://mongoosejs.com/docs/tutorials/lean.html),</span>
<a name="l2005"><span class="ln">2005 </span></a> <span class="s5">* especially when combined</span>
<a name="l2006"><span class="ln">2006 </span></a> <span class="s5">* with [cursors](https://mongoosejs.com/docs/queries.html#streaming).</span>
<a name="l2007"><span class="ln">2007 </span></a> <span class="s5">*</span>
<a name="l2008"><span class="ln">2008 </span></a> <span class="s5">* If you need virtuals, getters/setters, or defaults with `lean()`, you need</span>
<a name="l2009"><span class="ln">2009 </span></a> <span class="s5">* to use a plugin. See:</span>
<a name="l2010"><span class="ln">2010 </span></a> <span class="s5">*</span>
<a name="l2011"><span class="ln">2011 </span></a> <span class="s5">* - [mongoose-lean-virtuals](https://plugins.mongoosejs.io/plugins/lean-virtuals)</span>
<a name="l2012"><span class="ln">2012 </span></a> <span class="s5">* - [mongoose-lean-getters](https://plugins.mongoosejs.io/plugins/lean-getters)</span>
<a name="l2013"><span class="ln">2013 </span></a> <span class="s5">* - [mongoose-lean-defaults](https://www.npmjs.com/package/mongoose-lean-defaults)</span>
<a name="l2014"><span class="ln">2014 </span></a> <span class="s5">*</span>
<a name="l2015"><span class="ln">2015 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|Object} bool defaults to true</span>
<a name="l2016"><span class="ln">2016 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2017"><span class="ln">2017 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2018"><span class="ln">2018 </span></a> <span class="s5">*/</span>
<a name="l2019"><span class="ln">2019 </span></a>
<a name="l2020"><span class="ln">2020 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
<a name="l2021"><span class="ln">2021 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">? </span><span class="s2">v </span><span class="s1">: </span><span class="s4">true</span><span class="s1">;</span>
<a name="l2022"><span class="ln">2022 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2023"><span class="ln">2023 </span></a><span class="s1">};</span>
<a name="l2024"><span class="ln">2024 </span></a>
<a name="l2025"><span class="ln">2025 </span></a><span class="s5">/**</span>
<a name="l2026"><span class="ln">2026 </span></a> <span class="s5">* Adds a `$set` to this query's update without changing the operation.</span>
<a name="l2027"><span class="ln">2027 </span></a> <span class="s5">* This is useful for query middleware so you can add an update regardless</span>
<a name="l2028"><span class="ln">2028 </span></a> <span class="s5">* of whether you use `updateOne()`, `updateMany()`, `findOneAndUpdate()`, etc.</span>
<a name="l2029"><span class="ln">2029 </span></a> <span class="s5">*</span>
<a name="l2030"><span class="ln">2030 </span></a> <span class="s5">* #### Example:</span>
<a name="l2031"><span class="ln">2031 </span></a> <span class="s5">*</span>
<a name="l2032"><span class="ln">2032 </span></a> <span class="s5">*     // Updates `{ $set: { updatedAt: new Date() } }`</span>
<a name="l2033"><span class="ln">2033 </span></a> <span class="s5">*     new Query().updateOne({}, {}).set('updatedAt', new Date());</span>
<a name="l2034"><span class="ln">2034 </span></a> <span class="s5">*     new Query().updateMany({}, {}).set({ updatedAt: new Date() });</span>
<a name="l2035"><span class="ln">2035 </span></a> <span class="s5">*</span>
<a name="l2036"><span class="ln">2036 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|Object} path path or object of key/value pairs to set</span>
<a name="l2037"><span class="ln">2037 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Any} [val] the value to set</span>
<a name="l2038"><span class="ln">2038 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2039"><span class="ln">2039 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2040"><span class="ln">2040 </span></a> <span class="s5">*/</span>
<a name="l2041"><span class="ln">2041 </span></a>
<a name="l2042"><span class="ln">2042 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">set </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">val</span><span class="s1">) {</span>
<a name="l2043"><span class="ln">2043 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">path </span><span class="s1">=== </span><span class="s0">'object'</span><span class="s1">) {</span>
<a name="l2044"><span class="ln">2044 </span></a>    <span class="s4">const </span><span class="s2">keys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
<a name="l2045"><span class="ln">2045 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">key of keys</span><span class="s1">) {</span>
<a name="l2046"><span class="ln">2046 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">path</span><span class="s1">[</span><span class="s2">key</span><span class="s1">]);</span>
<a name="l2047"><span class="ln">2047 </span></a>    <span class="s1">}</span>
<a name="l2048"><span class="ln">2048 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l2049"><span class="ln">2049 </span></a>  <span class="s1">}</span>
<a name="l2050"><span class="ln">2050 </span></a>
<a name="l2051"><span class="ln">2051 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">|| {};</span>
<a name="l2052"><span class="ln">2052 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">path </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">) {</span>
<a name="l2053"><span class="ln">2053 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
<a name="l2054"><span class="ln">2054 </span></a>  <span class="s1">}</span>
<a name="l2055"><span class="ln">2055 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">$set </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">$set </span><span class="s1">|| {};</span>
<a name="l2056"><span class="ln">2056 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">[</span><span class="s2">path</span><span class="s1">] = </span><span class="s2">val</span><span class="s1">;</span>
<a name="l2057"><span class="ln">2057 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2058"><span class="ln">2058 </span></a><span class="s1">};</span>
<a name="l2059"><span class="ln">2059 </span></a>
<a name="l2060"><span class="ln">2060 </span></a><span class="s5">/**</span>
<a name="l2061"><span class="ln">2061 </span></a> <span class="s5">* For update operations, returns the value of a path in the update's `$set`.</span>
<a name="l2062"><span class="ln">2062 </span></a> <span class="s5">* Useful for writing getters/setters that can work with both update operations</span>
<a name="l2063"><span class="ln">2063 </span></a> <span class="s5">* and `save()`.</span>
<a name="l2064"><span class="ln">2064 </span></a> <span class="s5">*</span>
<a name="l2065"><span class="ln">2065 </span></a> <span class="s5">* #### Example:</span>
<a name="l2066"><span class="ln">2066 </span></a> <span class="s5">*</span>
<a name="l2067"><span class="ln">2067 </span></a> <span class="s5">*     const query = Model.updateOne({}, { $set: { name: 'Jean-Luc Picard' } });</span>
<a name="l2068"><span class="ln">2068 </span></a> <span class="s5">*     query.get('name'); // 'Jean-Luc Picard'</span>
<a name="l2069"><span class="ln">2069 </span></a> <span class="s5">*</span>
<a name="l2070"><span class="ln">2070 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|Object} path path or object of key/value pairs to get</span>
<a name="l2071"><span class="ln">2071 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2072"><span class="ln">2072 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2073"><span class="ln">2073 </span></a> <span class="s5">*/</span>
<a name="l2074"><span class="ln">2074 </span></a>
<a name="l2075"><span class="ln">2075 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">get </span><span class="s1">= </span><span class="s4">function </span><span class="s2">get</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
<a name="l2076"><span class="ln">2076 </span></a>  <span class="s4">const </span><span class="s2">update </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">;</span>
<a name="l2077"><span class="ln">2077 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">update </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2078"><span class="ln">2078 </span></a>    <span class="s4">return void </span><span class="s7">0</span><span class="s1">;</span>
<a name="l2079"><span class="ln">2079 </span></a>  <span class="s1">}</span>
<a name="l2080"><span class="ln">2080 </span></a>  <span class="s4">const </span><span class="s2">$set </span><span class="s1">= </span><span class="s2">update</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">;</span>
<a name="l2081"><span class="ln">2081 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">$set </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2082"><span class="ln">2082 </span></a>    <span class="s4">return </span><span class="s2">update</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
<a name="l2083"><span class="ln">2083 </span></a>  <span class="s1">}</span>
<a name="l2084"><span class="ln">2084 </span></a>
<a name="l2085"><span class="ln">2085 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">utils</span><span class="s1">.</span><span class="s2">hasUserDefinedProperty</span><span class="s1">(</span><span class="s2">update</span><span class="s1">, </span><span class="s2">path</span><span class="s1">)) {</span>
<a name="l2086"><span class="ln">2086 </span></a>    <span class="s4">return </span><span class="s2">update</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
<a name="l2087"><span class="ln">2087 </span></a>  <span class="s1">}</span>
<a name="l2088"><span class="ln">2088 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">utils</span><span class="s1">.</span><span class="s2">hasUserDefinedProperty</span><span class="s1">(</span><span class="s2">$set</span><span class="s1">, </span><span class="s2">path</span><span class="s1">)) {</span>
<a name="l2089"><span class="ln">2089 </span></a>    <span class="s4">return </span><span class="s2">$set</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
<a name="l2090"><span class="ln">2090 </span></a>  <span class="s1">}</span>
<a name="l2091"><span class="ln">2091 </span></a>
<a name="l2092"><span class="ln">2092 </span></a>  <span class="s4">return void </span><span class="s7">0</span><span class="s1">;</span>
<a name="l2093"><span class="ln">2093 </span></a><span class="s1">};</span>
<a name="l2094"><span class="ln">2094 </span></a>
<a name="l2095"><span class="ln">2095 </span></a><span class="s5">/**</span>
<a name="l2096"><span class="ln">2096 </span></a> <span class="s5">* Gets/sets the error flag on this query. If this flag is not null or</span>
<a name="l2097"><span class="ln">2097 </span></a> <span class="s5">* undefined, the `exec()` promise will reject without executing.</span>
<a name="l2098"><span class="ln">2098 </span></a> <span class="s5">*</span>
<a name="l2099"><span class="ln">2099 </span></a> <span class="s5">* #### Example:</span>
<a name="l2100"><span class="ln">2100 </span></a> <span class="s5">*</span>
<a name="l2101"><span class="ln">2101 </span></a> <span class="s5">*     Query().error(); // Get current error value</span>
<a name="l2102"><span class="ln">2102 </span></a> <span class="s5">*     Query().error(null); // Unset the current error</span>
<a name="l2103"><span class="ln">2103 </span></a> <span class="s5">*     Query().error(new Error('test')); // `exec()` will resolve with test</span>
<a name="l2104"><span class="ln">2104 </span></a> <span class="s5">*     Schema.pre('find', function() {</span>
<a name="l2105"><span class="ln">2105 </span></a> <span class="s5">*       if (!this.getQuery().userId) {</span>
<a name="l2106"><span class="ln">2106 </span></a> <span class="s5">*         this.error(new Error('Not allowed to query without setting userId'));</span>
<a name="l2107"><span class="ln">2107 </span></a> <span class="s5">*       }</span>
<a name="l2108"><span class="ln">2108 </span></a> <span class="s5">*     });</span>
<a name="l2109"><span class="ln">2109 </span></a> <span class="s5">*</span>
<a name="l2110"><span class="ln">2110 </span></a> <span class="s5">* Note that query casting runs **after** hooks, so cast errors will override</span>
<a name="l2111"><span class="ln">2111 </span></a> <span class="s5">* custom errors.</span>
<a name="l2112"><span class="ln">2112 </span></a> <span class="s5">*</span>
<a name="l2113"><span class="ln">2113 </span></a> <span class="s5">* #### Example:</span>
<a name="l2114"><span class="ln">2114 </span></a> <span class="s5">*</span>
<a name="l2115"><span class="ln">2115 </span></a> <span class="s5">*     const TestSchema = new Schema({ num: Number });</span>
<a name="l2116"><span class="ln">2116 </span></a> <span class="s5">*     const TestModel = db.model('Test', TestSchema);</span>
<a name="l2117"><span class="ln">2117 </span></a> <span class="s5">*     TestModel.find({ num: 'not a number' }).error(new Error('woops')).exec(function(error) {</span>
<a name="l2118"><span class="ln">2118 </span></a> <span class="s5">*       // `error` will be a cast error because `num` failed to cast</span>
<a name="l2119"><span class="ln">2119 </span></a> <span class="s5">*     });</span>
<a name="l2120"><span class="ln">2120 </span></a> <span class="s5">*</span>
<a name="l2121"><span class="ln">2121 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Error|null} err if set, `exec()` will fail fast before sending the query to MongoDB</span>
<a name="l2122"><span class="ln">2122 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2123"><span class="ln">2123 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2124"><span class="ln">2124 </span></a> <span class="s5">*/</span>
<a name="l2125"><span class="ln">2125 </span></a>
<a name="l2126"><span class="ln">2126 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">error </span><span class="s1">= </span><span class="s4">function </span><span class="s2">error</span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l2127"><span class="ln">2127 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l2128"><span class="ln">2128 </span></a>    <span class="s4">return this</span><span class="s1">.</span><span class="s2">_error</span><span class="s1">;</span>
<a name="l2129"><span class="ln">2129 </span></a>  <span class="s1">}</span>
<a name="l2130"><span class="ln">2130 </span></a>
<a name="l2131"><span class="ln">2131 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_error </span><span class="s1">= </span><span class="s2">err</span><span class="s1">;</span>
<a name="l2132"><span class="ln">2132 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2133"><span class="ln">2133 </span></a><span class="s1">};</span>
<a name="l2134"><span class="ln">2134 </span></a>
<a name="l2135"><span class="ln">2135 </span></a><span class="s5">/**</span>
<a name="l2136"><span class="ln">2136 </span></a> <span class="s5">* ignore</span>
<a name="l2137"><span class="ln">2137 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_unsetCastError</span>
<a name="l2138"><span class="ln">2138 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l2139"><span class="ln">2139 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l2140"><span class="ln">2140 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2141"><span class="ln">2141 </span></a> <span class="s5">*/</span>
<a name="l2142"><span class="ln">2142 </span></a>
<a name="l2143"><span class="ln">2143 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_unsetCastError </span><span class="s1">= </span><span class="s4">function </span><span class="s2">_unsetCastError</span><span class="s1">() {</span>
<a name="l2144"><span class="ln">2144 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_error </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; !(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_error </span><span class="s4">instanceof </span><span class="s2">CastError</span><span class="s1">)) {</span>
<a name="l2145"><span class="ln">2145 </span></a>    <span class="s4">return</span><span class="s1">;</span>
<a name="l2146"><span class="ln">2146 </span></a>  <span class="s1">}</span>
<a name="l2147"><span class="ln">2147 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">null</span><span class="s1">);</span>
<a name="l2148"><span class="ln">2148 </span></a><span class="s1">};</span>
<a name="l2149"><span class="ln">2149 </span></a>
<a name="l2150"><span class="ln">2150 </span></a><span class="s5">/**</span>
<a name="l2151"><span class="ln">2151 </span></a> <span class="s5">* Getter/setter around the current mongoose-specific options for this query</span>
<a name="l2152"><span class="ln">2152 </span></a> <span class="s5">* Below are the current Mongoose-specific options.</span>
<a name="l2153"><span class="ln">2153 </span></a> <span class="s5">*</span>
<a name="l2154"><span class="ln">2154 </span></a> <span class="s5">* - `populate`: an array representing what paths will be populated. Should have one entry for each call to [`Query.prototype.populate()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.populate())</span>
<a name="l2155"><span class="ln">2155 </span></a> <span class="s5">* - `lean`: if truthy, Mongoose will not [hydrate](https://mongoosejs.com/docs/api/model.html#Model.hydrate()) any documents that are returned from this query. See [`Query.prototype.lean()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.lean()) for more information.</span>
<a name="l2156"><span class="ln">2156 </span></a> <span class="s5">* - `strict`: controls how Mongoose handles keys that aren't in the schema for updates. This option is `true` by default, which means Mongoose will silently strip any paths in the update that aren't in the schema. See the [`strict` mode docs](https://mongoosejs.com/docs/guide.html#strict) for more information.</span>
<a name="l2157"><span class="ln">2157 </span></a> <span class="s5">* - `strictQuery`: controls how Mongoose handles keys that aren't in the schema for the query `filter`. This option is `false` by default, which means Mongoose will allow `Model.find({ foo: 'bar' })` even if `foo` is not in the schema. See the [`strictQuery` docs](https://mongoosejs.com/docs/guide.html#strictQuery) for more information.</span>
<a name="l2158"><span class="ln">2158 </span></a> <span class="s5">* - `nearSphere`: use `$nearSphere` instead of `near()`. See the [`Query.prototype.nearSphere()` docs](https://mongoosejs.com/docs/api/query.html#Query.prototype.nearSphere())</span>
<a name="l2159"><span class="ln">2159 </span></a> <span class="s5">*</span>
<a name="l2160"><span class="ln">2160 </span></a> <span class="s5">* Mongoose maintains a separate object for internal options because</span>
<a name="l2161"><span class="ln">2161 </span></a> <span class="s5">* Mongoose sends `Query.prototype.options` to the MongoDB server, and the</span>
<a name="l2162"><span class="ln">2162 </span></a> <span class="s5">* above options are not relevant for the MongoDB server.</span>
<a name="l2163"><span class="ln">2163 </span></a> <span class="s5">*</span>
<a name="l2164"><span class="ln">2164 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} options if specified, overwrites the current options</span>
<a name="l2165"><span class="ln">2165 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} the options</span>
<a name="l2166"><span class="ln">2166 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2167"><span class="ln">2167 </span></a> <span class="s5">*/</span>
<a name="l2168"><span class="ln">2168 </span></a>
<a name="l2169"><span class="ln">2169 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mongooseOptions </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
<a name="l2170"><span class="ln">2170 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l2171"><span class="ln">2171 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions </span><span class="s1">= </span><span class="s2">v</span><span class="s1">;</span>
<a name="l2172"><span class="ln">2172 </span></a>  <span class="s1">}</span>
<a name="l2173"><span class="ln">2173 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">;</span>
<a name="l2174"><span class="ln">2174 </span></a><span class="s1">};</span>
<a name="l2175"><span class="ln">2175 </span></a>
<a name="l2176"><span class="ln">2176 </span></a><span class="s5">/**</span>
<a name="l2177"><span class="ln">2177 </span></a> <span class="s5">* ignore</span>
<a name="l2178"><span class="ln">2178 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_castConditions</span>
<a name="l2179"><span class="ln">2179 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l2180"><span class="ln">2180 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2181"><span class="ln">2181 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l2182"><span class="ln">2182 </span></a> <span class="s5">*/</span>
<a name="l2183"><span class="ln">2183 </span></a>
<a name="l2184"><span class="ln">2184 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_castConditions </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l2185"><span class="ln">2185 </span></a>  <span class="s4">let </span><span class="s2">sanitizeFilterOpt </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l2186"><span class="ln">2186 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">utils</span><span class="s1">.</span><span class="s2">hasUserDefinedProperty</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s0">'sanitizeFilter'</span><span class="s1">)) {</span>
<a name="l2187"><span class="ln">2187 </span></a>    <span class="s2">sanitizeFilterOpt </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeFilter</span><span class="s1">;</span>
<a name="l2188"><span class="ln">2188 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">utils</span><span class="s1">.</span><span class="s2">hasUserDefinedProperty</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s0">'sanitizeFilter'</span><span class="s1">)) {</span>
<a name="l2189"><span class="ln">2189 </span></a>    <span class="s2">sanitizeFilterOpt </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sanitizeFilter</span><span class="s1">;</span>
<a name="l2190"><span class="ln">2190 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l2191"><span class="ln">2191 </span></a>    <span class="s2">sanitizeFilterOpt </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">sanitizeFilter</span><span class="s1">;</span>
<a name="l2192"><span class="ln">2192 </span></a>  <span class="s1">}</span>
<a name="l2193"><span class="ln">2193 </span></a>
<a name="l2194"><span class="ln">2194 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">sanitizeFilterOpt</span><span class="s1">) {</span>
<a name="l2195"><span class="ln">2195 </span></a>    <span class="s2">sanitizeFilter</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">);</span>
<a name="l2196"><span class="ln">2196 </span></a>  <span class="s1">}</span>
<a name="l2197"><span class="ln">2197 </span></a>
<a name="l2198"><span class="ln">2198 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l2199"><span class="ln">2199 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">cast</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">);</span>
<a name="l2200"><span class="ln">2200 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_unsetCastError</span><span class="s1">();</span>
<a name="l2201"><span class="ln">2201 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l2202"><span class="ln">2202 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l2203"><span class="ln">2203 </span></a>  <span class="s1">}</span>
<a name="l2204"><span class="ln">2204 </span></a><span class="s1">};</span>
<a name="l2205"><span class="ln">2205 </span></a>
<a name="l2206"><span class="ln">2206 </span></a><span class="s3">/*! 
<a name="l2207"><span class="ln">2207 </span></a> * ignore 
<a name="l2208"><span class="ln">2208 </span></a> */</span>
<a name="l2209"><span class="ln">2209 </span></a>
<a name="l2210"><span class="ln">2210 </span></a><span class="s4">function </span><span class="s2">_castArrayFilters</span><span class="s1">(</span><span class="s2">query</span><span class="s1">) {</span>
<a name="l2211"><span class="ln">2211 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l2212"><span class="ln">2212 </span></a>    <span class="s2">castArrayFilters</span><span class="s1">(</span><span class="s2">query</span><span class="s1">);</span>
<a name="l2213"><span class="ln">2213 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l2214"><span class="ln">2214 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l2215"><span class="ln">2215 </span></a>  <span class="s1">}</span>
<a name="l2216"><span class="ln">2216 </span></a><span class="s1">}</span>
<a name="l2217"><span class="ln">2217 </span></a>
<a name="l2218"><span class="ln">2218 </span></a><span class="s5">/**</span>
<a name="l2219"><span class="ln">2219 </span></a> <span class="s5">* Execute a `find()`</span>
<a name="l2220"><span class="ln">2220 </span></a> <span class="s5">*</span>
<a name="l2221"><span class="ln">2221 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2222"><span class="ln">2222 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2223"><span class="ln">2223 </span></a> <span class="s5">*/</span>
<a name="l2224"><span class="ln">2224 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_find </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_find</span><span class="s1">() {</span>
<a name="l2225"><span class="ln">2225 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l2226"><span class="ln">2226 </span></a>
<a name="l2227"><span class="ln">2227 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">() != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2228"><span class="ln">2228 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l2229"><span class="ln">2229 </span></a>  <span class="s1">}</span>
<a name="l2230"><span class="ln">2230 </span></a>
<a name="l2231"><span class="ln">2231 </span></a>  <span class="s4">const </span><span class="s2">mongooseOptions </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">;</span>
<a name="l2232"><span class="ln">2232 </span></a>  <span class="s4">const </span><span class="s2">_this </span><span class="s1">= </span><span class="s4">this</span><span class="s1">;</span>
<a name="l2233"><span class="ln">2233 </span></a>  <span class="s4">const </span><span class="s2">userProvidedFields </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_userProvidedFields </span><span class="s1">|| {};</span>
<a name="l2234"><span class="ln">2234 </span></a>
<a name="l2235"><span class="ln">2235 </span></a>  <span class="s2">applyGlobalMaxTimeMS</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2236"><span class="ln">2236 </span></a>  <span class="s2">applyGlobalDiskUse</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2237"><span class="ln">2237 </span></a>
<a name="l2238"><span class="ln">2238 </span></a>  <span class="s3">// Separate options to pass down to `completeMany()` in case we need to</span>
<a name="l2239"><span class="ln">2239 </span></a>  <span class="s3">// set a session on the document</span>
<a name="l2240"><span class="ln">2240 </span></a>  <span class="s4">const </span><span class="s2">completeManyOptions </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, {</span>
<a name="l2241"><span class="ln">2241 </span></a>    <span class="s2">session</span><span class="s1">: </span><span class="s4">this </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">session </span><span class="s1">|| </span><span class="s4">null</span><span class="s1">,</span>
<a name="l2242"><span class="ln">2242 </span></a>    <span class="s2">lean</span><span class="s1">: </span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">|| </span><span class="s4">null</span>
<a name="l2243"><span class="ln">2243 </span></a>  <span class="s1">});</span>
<a name="l2244"><span class="ln">2244 </span></a>
<a name="l2245"><span class="ln">2245 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l2246"><span class="ln">2246 </span></a>
<a name="l2247"><span class="ln">2247 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2248"><span class="ln">2248 </span></a>
<a name="l2249"><span class="ln">2249 </span></a>  <span class="s4">const </span><span class="s2">filter </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l2250"><span class="ln">2250 </span></a>  <span class="s4">const </span><span class="s2">fields </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">projection</span><span class="s1">;</span>
<a name="l2251"><span class="ln">2251 </span></a>
<a name="l2252"><span class="ln">2252 </span></a>  <span class="s4">const </span><span class="s2">cursor </span><span class="s1">= </span><span class="s4">await this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l2253"><span class="ln">2253 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">explain</span><span class="s1">) {</span>
<a name="l2254"><span class="ln">2254 </span></a>    <span class="s4">return </span><span class="s2">cursor</span><span class="s1">.</span><span class="s2">explain</span><span class="s1">();</span>
<a name="l2255"><span class="ln">2255 </span></a>  <span class="s1">}</span>
<a name="l2256"><span class="ln">2256 </span></a>
<a name="l2257"><span class="ln">2257 </span></a>  <span class="s4">let </span><span class="s2">docs </span><span class="s1">= </span><span class="s4">await </span><span class="s2">cursor</span><span class="s1">.</span><span class="s2">toArray</span><span class="s1">();</span>
<a name="l2258"><span class="ln">2258 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">docs</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l2259"><span class="ln">2259 </span></a>    <span class="s4">return </span><span class="s2">docs</span><span class="s1">;</span>
<a name="l2260"><span class="ln">2260 </span></a>  <span class="s1">}</span>
<a name="l2261"><span class="ln">2261 </span></a>
<a name="l2262"><span class="ln">2262 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">) {</span>
<a name="l2263"><span class="ln">2263 </span></a>    <span class="s4">const </span><span class="s2">versionKey </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">versionKey</span><span class="s1">;</span>
<a name="l2264"><span class="ln">2264 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">&amp;&amp; </span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">versionKey </span><span class="s1">=== </span><span class="s4">false </span><span class="s1">&amp;&amp; </span><span class="s2">versionKey</span><span class="s1">) {</span>
<a name="l2265"><span class="ln">2265 </span></a>      <span class="s2">docs</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">doc</span><span class="s1">) =&gt; {</span>
<a name="l2266"><span class="ln">2266 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">versionKey </span><span class="s4">in </span><span class="s2">doc</span><span class="s1">) {</span>
<a name="l2267"><span class="ln">2267 </span></a>          <span class="s4">delete </span><span class="s2">doc</span><span class="s1">[</span><span class="s2">versionKey</span><span class="s1">];</span>
<a name="l2268"><span class="ln">2268 </span></a>        <span class="s1">}</span>
<a name="l2269"><span class="ln">2269 </span></a>      <span class="s1">});</span>
<a name="l2270"><span class="ln">2270 </span></a>    <span class="s1">}</span>
<a name="l2271"><span class="ln">2271 </span></a>    <span class="s4">return </span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">?</span>
<a name="l2272"><span class="ln">2272 </span></a>      <span class="s2">_completeManyLean</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">docs</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s2">completeManyOptions</span><span class="s1">) :</span>
<a name="l2273"><span class="ln">2273 </span></a>      <span class="s2">_this</span><span class="s1">.</span><span class="s2">_completeMany</span><span class="s1">(</span><span class="s2">docs</span><span class="s1">, </span><span class="s2">fields</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">, </span><span class="s2">completeManyOptions</span><span class="s1">);</span>
<a name="l2274"><span class="ln">2274 </span></a>  <span class="s1">}</span>
<a name="l2275"><span class="ln">2275 </span></a>  <span class="s4">const </span><span class="s2">pop </span><span class="s1">= </span><span class="s2">helpers</span><span class="s1">.</span><span class="s2">preparePopulationOptionsMQ</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">, </span><span class="s2">mongooseOptions</span><span class="s1">);</span>
<a name="l2276"><span class="ln">2276 </span></a>
<a name="l2277"><span class="ln">2277 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">) {</span>
<a name="l2278"><span class="ln">2278 </span></a>    <span class="s4">return </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">(</span><span class="s2">docs</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">);</span>
<a name="l2279"><span class="ln">2279 </span></a>  <span class="s1">}</span>
<a name="l2280"><span class="ln">2280 </span></a>
<a name="l2281"><span class="ln">2281 </span></a>  <span class="s2">docs </span><span class="s1">= </span><span class="s4">await </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_completeMany</span><span class="s1">(</span><span class="s2">docs</span><span class="s1">, </span><span class="s2">fields</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">, </span><span class="s2">completeManyOptions</span><span class="s1">);</span>
<a name="l2282"><span class="ln">2282 </span></a>  <span class="s4">await this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">(</span><span class="s2">docs</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">);</span>
<a name="l2283"><span class="ln">2283 </span></a>
<a name="l2284"><span class="ln">2284 </span></a>  <span class="s4">return </span><span class="s2">docs</span><span class="s1">;</span>
<a name="l2285"><span class="ln">2285 </span></a><span class="s1">};</span>
<a name="l2286"><span class="ln">2286 </span></a>
<a name="l2287"><span class="ln">2287 </span></a><span class="s5">/**</span>
<a name="l2288"><span class="ln">2288 </span></a> <span class="s5">* Find all documents that match `selector`. The result will be an array of documents.</span>
<a name="l2289"><span class="ln">2289 </span></a> <span class="s5">*</span>
<a name="l2290"><span class="ln">2290 </span></a> <span class="s5">* If there are too many documents in the result to fit in memory, use</span>
<a name="l2291"><span class="ln">2291 </span></a> <span class="s5">* [`Query.prototype.cursor()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.cursor())</span>
<a name="l2292"><span class="ln">2292 </span></a> <span class="s5">*</span>
<a name="l2293"><span class="ln">2293 </span></a> <span class="s5">* #### Example:</span>
<a name="l2294"><span class="ln">2294 </span></a> <span class="s5">*</span>
<a name="l2295"><span class="ln">2295 </span></a> <span class="s5">*     const arr = await Movie.find({ year: { $gte: 1980, $lte: 1989 } });</span>
<a name="l2296"><span class="ln">2296 </span></a> <span class="s5">*</span>
<a name="l2297"><span class="ln">2297 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|ObjectId} [filter] mongodb filter. If not specified, returns all documents.</span>
<a name="l2298"><span class="ln">2298 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2299"><span class="ln">2299 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2300"><span class="ln">2300 </span></a> <span class="s5">*/</span>
<a name="l2301"><span class="ln">2301 </span></a>
<a name="l2302"><span class="ln">2302 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">find </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">) {</span>
<a name="l2303"><span class="ln">2303 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2304"><span class="ln">2304 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l2305"><span class="ln">2305 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.find() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l2306"><span class="ln">2306 </span></a>  <span class="s1">}</span>
<a name="l2307"><span class="ln">2307 </span></a>
<a name="l2308"><span class="ln">2308 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'find'</span><span class="s1">;</span>
<a name="l2309"><span class="ln">2309 </span></a>
<a name="l2310"><span class="ln">2310 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">)) {</span>
<a name="l2311"><span class="ln">2311 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">);</span>
<a name="l2312"><span class="ln">2312 </span></a>
<a name="l2313"><span class="ln">2313 </span></a>    <span class="s2">prepareDiscriminatorCriteria</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l2314"><span class="ln">2314 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">conditions </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2315"><span class="ln">2315 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s0">'find'</span><span class="s1">));</span>
<a name="l2316"><span class="ln">2316 </span></a>  <span class="s1">}</span>
<a name="l2317"><span class="ln">2317 </span></a>
<a name="l2318"><span class="ln">2318 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2319"><span class="ln">2319 </span></a><span class="s1">};</span>
<a name="l2320"><span class="ln">2320 </span></a>
<a name="l2321"><span class="ln">2321 </span></a><span class="s5">/**</span>
<a name="l2322"><span class="ln">2322 </span></a> <span class="s5">* Merges another Query or conditions object into this one.</span>
<a name="l2323"><span class="ln">2323 </span></a> <span class="s5">*</span>
<a name="l2324"><span class="ln">2324 </span></a> <span class="s5">* When a Query is passed, conditions, field selection and options are merged.</span>
<a name="l2325"><span class="ln">2325 </span></a> <span class="s5">*</span>
<a name="l2326"><span class="ln">2326 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Query|Object} source</span>
<a name="l2327"><span class="ln">2327 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2328"><span class="ln">2328 </span></a> <span class="s5">*/</span>
<a name="l2329"><span class="ln">2329 </span></a>
<a name="l2330"><span class="ln">2330 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">merge </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">source</span><span class="s1">) {</span>
<a name="l2331"><span class="ln">2331 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">source</span><span class="s1">) {</span>
<a name="l2332"><span class="ln">2332 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l2333"><span class="ln">2333 </span></a>  <span class="s1">}</span>
<a name="l2334"><span class="ln">2334 </span></a>
<a name="l2335"><span class="ln">2335 </span></a>  <span class="s4">const </span><span class="s2">opts </span><span class="s1">= { </span><span class="s2">overwrite</span><span class="s1">: </span><span class="s4">true </span><span class="s1">};</span>
<a name="l2336"><span class="ln">2336 </span></a>
<a name="l2337"><span class="ln">2337 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">source </span><span class="s4">instanceof </span><span class="s2">Query</span><span class="s1">) {</span>
<a name="l2338"><span class="ln">2338 </span></a>    <span class="s3">// if source has a feature, apply it to ourselves</span>
<a name="l2339"><span class="ln">2339 </span></a>
<a name="l2340"><span class="ln">2340 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">) {</span>
<a name="l2341"><span class="ln">2341 </span></a>      <span class="s2">opts</span><span class="s1">.</span><span class="s2">omit </span><span class="s1">= {};</span>
<a name="l2342"><span class="ln">2342 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and </span><span class="s1">&amp;&amp; </span><span class="s2">source</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and</span><span class="s1">) {</span>
<a name="l2343"><span class="ln">2343 </span></a>        <span class="s2">opts</span><span class="s1">.</span><span class="s2">omit</span><span class="s1">[</span><span class="s0">'$and'</span><span class="s1">] = </span><span class="s4">true</span><span class="s1">;</span>
<a name="l2344"><span class="ln">2344 </span></a>        <span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and</span><span class="s1">);</span>
<a name="l2345"><span class="ln">2345 </span></a>      <span class="s1">}</span>
<a name="l2346"><span class="ln">2346 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or </span><span class="s1">&amp;&amp; </span><span class="s2">source</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or</span><span class="s1">) {</span>
<a name="l2347"><span class="ln">2347 </span></a>        <span class="s2">opts</span><span class="s1">.</span><span class="s2">omit</span><span class="s1">[</span><span class="s0">'$or'</span><span class="s1">] = </span><span class="s4">true</span><span class="s1">;</span>
<a name="l2348"><span class="ln">2348 </span></a>        <span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or</span><span class="s1">);</span>
<a name="l2349"><span class="ln">2349 </span></a>      <span class="s1">}</span>
<a name="l2350"><span class="ln">2350 </span></a>      <span class="s2">utils</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s2">source</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
<a name="l2351"><span class="ln">2351 </span></a>    <span class="s1">}</span>
<a name="l2352"><span class="ln">2352 </span></a>
<a name="l2353"><span class="ln">2353 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">) {</span>
<a name="l2354"><span class="ln">2354 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">|| (</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">= {});</span>
<a name="l2355"><span class="ln">2355 </span></a>      <span class="s2">utils</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">, </span><span class="s2">source</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
<a name="l2356"><span class="ln">2356 </span></a>    <span class="s1">}</span>
<a name="l2357"><span class="ln">2357 </span></a>
<a name="l2358"><span class="ln">2358 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l2359"><span class="ln">2359 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">|| (</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= {});</span>
<a name="l2360"><span class="ln">2360 </span></a>      <span class="s2">utils</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s2">source</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
<a name="l2361"><span class="ln">2361 </span></a>    <span class="s1">}</span>
<a name="l2362"><span class="ln">2362 </span></a>
<a name="l2363"><span class="ln">2363 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">) {</span>
<a name="l2364"><span class="ln">2364 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">|| (</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= {});</span>
<a name="l2365"><span class="ln">2365 </span></a>      <span class="s2">utils</span><span class="s1">.</span><span class="s2">mergeClone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">source</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">);</span>
<a name="l2366"><span class="ln">2366 </span></a>    <span class="s1">}</span>
<a name="l2367"><span class="ln">2367 </span></a>
<a name="l2368"><span class="ln">2368 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">) {</span>
<a name="l2369"><span class="ln">2369 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct </span><span class="s1">= </span><span class="s2">source</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">;</span>
<a name="l2370"><span class="ln">2370 </span></a>    <span class="s1">}</span>
<a name="l2371"><span class="ln">2371 </span></a>
<a name="l2372"><span class="ln">2372 </span></a>    <span class="s2">utils</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">, </span><span class="s2">source</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">);</span>
<a name="l2373"><span class="ln">2373 </span></a>
<a name="l2374"><span class="ln">2374 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l2375"><span class="ln">2375 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">source </span><span class="s4">instanceof this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">Types</span><span class="s1">.</span><span class="s2">ObjectId</span><span class="s1">) {</span>
<a name="l2376"><span class="ln">2376 </span></a>    <span class="s2">utils</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, { </span><span class="s2">_id</span><span class="s1">: </span><span class="s2">source </span><span class="s1">}, </span><span class="s2">opts</span><span class="s1">);</span>
<a name="l2377"><span class="ln">2377 </span></a>
<a name="l2378"><span class="ln">2378 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l2379"><span class="ln">2379 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">source </span><span class="s1">&amp;&amp; </span><span class="s2">source</span><span class="s1">.</span><span class="s2">$__</span><span class="s1">) {</span>
<a name="l2380"><span class="ln">2380 </span></a>    <span class="s2">source </span><span class="s1">= </span><span class="s2">source</span><span class="s1">.</span><span class="s2">toObject</span><span class="s1">(</span><span class="s2">internalToObjectOptions</span><span class="s1">);</span>
<a name="l2381"><span class="ln">2381 </span></a>  <span class="s1">}</span>
<a name="l2382"><span class="ln">2382 </span></a>
<a name="l2383"><span class="ln">2383 </span></a>  <span class="s2">opts</span><span class="s1">.</span><span class="s2">omit </span><span class="s1">= {};</span>
<a name="l2384"><span class="ln">2384 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and </span><span class="s1">&amp;&amp; </span><span class="s2">source</span><span class="s1">.</span><span class="s2">$and</span><span class="s1">) {</span>
<a name="l2385"><span class="ln">2385 </span></a>    <span class="s2">opts</span><span class="s1">.</span><span class="s2">omit</span><span class="s1">[</span><span class="s0">'$and'</span><span class="s1">] = </span><span class="s4">true</span><span class="s1">;</span>
<a name="l2386"><span class="ln">2386 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$and</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">$and</span><span class="s1">);</span>
<a name="l2387"><span class="ln">2387 </span></a>  <span class="s1">}</span>
<a name="l2388"><span class="ln">2388 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or </span><span class="s1">&amp;&amp; </span><span class="s2">source</span><span class="s1">.</span><span class="s2">$or</span><span class="s1">) {</span>
<a name="l2389"><span class="ln">2389 </span></a>    <span class="s2">opts</span><span class="s1">.</span><span class="s2">omit</span><span class="s1">[</span><span class="s0">'$or'</span><span class="s1">] = </span><span class="s4">true</span><span class="s1">;</span>
<a name="l2390"><span class="ln">2390 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">.</span><span class="s2">$or</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">source</span><span class="s1">.</span><span class="s2">$or</span><span class="s1">);</span>
<a name="l2391"><span class="ln">2391 </span></a>  <span class="s1">}</span>
<a name="l2392"><span class="ln">2392 </span></a>
<a name="l2393"><span class="ln">2393 </span></a>  <span class="s3">// plain object</span>
<a name="l2394"><span class="ln">2394 </span></a>  <span class="s2">utils</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s2">source</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
<a name="l2395"><span class="ln">2395 </span></a>
<a name="l2396"><span class="ln">2396 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2397"><span class="ln">2397 </span></a><span class="s1">};</span>
<a name="l2398"><span class="ln">2398 </span></a>
<a name="l2399"><span class="ln">2399 </span></a><span class="s5">/**</span>
<a name="l2400"><span class="ln">2400 </span></a> <span class="s5">* Adds a collation to this op (MongoDB 3.4 and up)</span>
<a name="l2401"><span class="ln">2401 </span></a> <span class="s5">*</span>
<a name="l2402"><span class="ln">2402 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} value</span>
<a name="l2403"><span class="ln">2403 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2404"><span class="ln">2404 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB docs https://www.mongodb.com/docs/manual/reference/method/cursor.collation/#cursor.collation</span>
<a name="l2405"><span class="ln">2405 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2406"><span class="ln">2406 </span></a> <span class="s5">*/</span>
<a name="l2407"><span class="ln">2407 </span></a>
<a name="l2408"><span class="ln">2408 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">collation </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
<a name="l2409"><span class="ln">2409 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2410"><span class="ln">2410 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= {};</span>
<a name="l2411"><span class="ln">2411 </span></a>  <span class="s1">}</span>
<a name="l2412"><span class="ln">2412 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">collation </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
<a name="l2413"><span class="ln">2413 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2414"><span class="ln">2414 </span></a><span class="s1">};</span>
<a name="l2415"><span class="ln">2415 </span></a>
<a name="l2416"><span class="ln">2416 </span></a><span class="s5">/**</span>
<a name="l2417"><span class="ln">2417 </span></a> <span class="s5">* Hydrate a single doc from `findOne()`, `findOneAndUpdate()`, etc.</span>
<a name="l2418"><span class="ln">2418 </span></a> <span class="s5">*</span>
<a name="l2419"><span class="ln">2419 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2420"><span class="ln">2420 </span></a> <span class="s5">*/</span>
<a name="l2421"><span class="ln">2421 </span></a>
<a name="l2422"><span class="ln">2422 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_completeOne </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l2423"><span class="ln">2423 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">doc </span><span class="s1">&amp;&amp; !</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata</span><span class="s1">) {</span>
<a name="l2424"><span class="ln">2424 </span></a>    <span class="s4">return </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s4">null</span><span class="s1">);</span>
<a name="l2425"><span class="ln">2425 </span></a>  <span class="s1">}</span>
<a name="l2426"><span class="ln">2426 </span></a>
<a name="l2427"><span class="ln">2427 </span></a>  <span class="s4">const </span><span class="s2">model </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">;</span>
<a name="l2428"><span class="ln">2428 </span></a>  <span class="s4">const </span><span class="s2">projection </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l2429"><span class="ln">2429 </span></a>  <span class="s4">const </span><span class="s2">userProvidedFields </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_userProvidedFields </span><span class="s1">|| {};</span>
<a name="l2430"><span class="ln">2430 </span></a>  <span class="s3">// `populate`, `lean`</span>
<a name="l2431"><span class="ln">2431 </span></a>  <span class="s4">const </span><span class="s2">mongooseOptions </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">;</span>
<a name="l2432"><span class="ln">2432 </span></a>
<a name="l2433"><span class="ln">2433 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>
<a name="l2434"><span class="ln">2434 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">&amp;&amp; </span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">) {</span>
<a name="l2435"><span class="ln">2435 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">= </span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">;</span>
<a name="l2436"><span class="ln">2436 </span></a>  <span class="s1">}</span>
<a name="l2437"><span class="ln">2437 </span></a>
<a name="l2438"><span class="ln">2438 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">explain</span><span class="s1">) {</span>
<a name="l2439"><span class="ln">2439 </span></a>    <span class="s4">return </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">);</span>
<a name="l2440"><span class="ln">2440 </span></a>  <span class="s1">}</span>
<a name="l2441"><span class="ln">2441 </span></a>
<a name="l2442"><span class="ln">2442 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">) {</span>
<a name="l2443"><span class="ln">2443 </span></a>    <span class="s4">const </span><span class="s2">versionKey </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">versionKey</span><span class="s1">;</span>
<a name="l2444"><span class="ln">2444 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">&amp;&amp; </span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">versionKey </span><span class="s1">=== </span><span class="s4">false </span><span class="s1">&amp;&amp; </span><span class="s2">versionKey</span><span class="s1">) {</span>
<a name="l2445"><span class="ln">2445 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">versionKey </span><span class="s4">in </span><span class="s2">doc</span><span class="s1">) {</span>
<a name="l2446"><span class="ln">2446 </span></a>        <span class="s4">delete </span><span class="s2">doc</span><span class="s1">[</span><span class="s2">versionKey</span><span class="s1">];</span>
<a name="l2447"><span class="ln">2447 </span></a>      <span class="s1">}</span>
<a name="l2448"><span class="ln">2448 </span></a>    <span class="s1">}</span>
<a name="l2449"><span class="ln">2449 </span></a>    <span class="s4">return </span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">?</span>
<a name="l2450"><span class="ln">2450 </span></a>      <span class="s2">_completeOneLean</span><span class="s1">(</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) :</span>
<a name="l2451"><span class="ln">2451 </span></a>      <span class="s2">completeOne</span><span class="s1">(</span><span class="s2">model</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">projection</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">,</span>
<a name="l2452"><span class="ln">2452 </span></a>        <span class="s4">null</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
<a name="l2453"><span class="ln">2453 </span></a>  <span class="s1">}</span>
<a name="l2454"><span class="ln">2454 </span></a>
<a name="l2455"><span class="ln">2455 </span></a>  <span class="s4">const </span><span class="s2">pop </span><span class="s1">= </span><span class="s2">helpers</span><span class="s1">.</span><span class="s2">preparePopulationOptionsMQ</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">);</span>
<a name="l2456"><span class="ln">2456 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mongooseOptions</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">) {</span>
<a name="l2457"><span class="ln">2457 </span></a>    <span class="s4">return </span><span class="s2">model</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">).</span><span class="s2">then</span><span class="s1">(</span>
<a name="l2458"><span class="ln">2458 </span></a>      <span class="s2">doc </span><span class="s1">=&gt; {</span>
<a name="l2459"><span class="ln">2459 </span></a>        <span class="s2">_completeOneLean</span><span class="s1">(</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
<a name="l2460"><span class="ln">2460 </span></a>      <span class="s1">},</span>
<a name="l2461"><span class="ln">2461 </span></a>      <span class="s2">error </span><span class="s1">=&gt; {</span>
<a name="l2462"><span class="ln">2462 </span></a>        <span class="s2">callback</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
<a name="l2463"><span class="ln">2463 </span></a>      <span class="s1">}</span>
<a name="l2464"><span class="ln">2464 </span></a>    <span class="s1">);</span>
<a name="l2465"><span class="ln">2465 </span></a>  <span class="s1">}</span>
<a name="l2466"><span class="ln">2466 </span></a>
<a name="l2467"><span class="ln">2467 </span></a>  <span class="s2">completeOne</span><span class="s1">(</span><span class="s2">model</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">projection</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">, [], (</span><span class="s2">err</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">) =&gt; {</span>
<a name="l2468"><span class="ln">2468 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">err </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2469"><span class="ln">2469 </span></a>      <span class="s4">return </span><span class="s2">callback</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l2470"><span class="ln">2470 </span></a>    <span class="s1">}</span>
<a name="l2471"><span class="ln">2471 </span></a>    <span class="s2">model</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">).</span><span class="s2">then</span><span class="s1">(</span><span class="s2">res </span><span class="s1">=&gt; { </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">res</span><span class="s1">); }, </span><span class="s2">err </span><span class="s1">=&gt; { </span><span class="s2">callback</span><span class="s1">(</span><span class="s2">err</span><span class="s1">); });</span>
<a name="l2472"><span class="ln">2472 </span></a>  <span class="s1">});</span>
<a name="l2473"><span class="ln">2473 </span></a><span class="s1">};</span>
<a name="l2474"><span class="ln">2474 </span></a>
<a name="l2475"><span class="ln">2475 </span></a><span class="s5">/**</span>
<a name="l2476"><span class="ln">2476 </span></a> <span class="s5">* Given a model and an array of docs, hydrates all the docs to be instances</span>
<a name="l2477"><span class="ln">2477 </span></a> <span class="s5">* of the model. Used to initialize docs returned from the db from `find()`</span>
<a name="l2478"><span class="ln">2478 </span></a> <span class="s5">*</span>
<a name="l2479"><span class="ln">2479 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} docs</span>
<a name="l2480"><span class="ln">2480 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} fields the projection used, including `select` from schemas</span>
<a name="l2481"><span class="ln">2481 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} userProvidedFields the user-specified projection</span>
<a name="l2482"><span class="ln">2482 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [opts]</span>
<a name="l2483"><span class="ln">2483 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} [opts.populated]</span>
<a name="l2484"><span class="ln">2484 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{ClientSession} [opts.session]</span>
<a name="l2485"><span class="ln">2485 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2486"><span class="ln">2486 </span></a> <span class="s5">*/</span>
<a name="l2487"><span class="ln">2487 </span></a>
<a name="l2488"><span class="ln">2488 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_completeMany </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_completeMany</span><span class="s1">(</span><span class="s2">docs</span><span class="s1">, </span><span class="s2">fields</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">) {</span>
<a name="l2489"><span class="ln">2489 </span></a>  <span class="s4">const </span><span class="s2">model </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">;</span>
<a name="l2490"><span class="ln">2490 </span></a>  <span class="s4">return </span><span class="s2">Promise</span><span class="s1">.</span><span class="s2">all</span><span class="s1">(</span><span class="s2">docs</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">doc </span><span class="s1">=&gt; </span><span class="s4">new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l2491"><span class="ln">2491 </span></a>    <span class="s4">const </span><span class="s2">rawDoc </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">;</span>
<a name="l2492"><span class="ln">2492 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">helpers</span><span class="s1">.</span><span class="s2">createModel</span><span class="s1">(</span><span class="s2">model</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">fields</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">);</span>
<a name="l2493"><span class="ln">2493 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">session </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2494"><span class="ln">2494 </span></a>      <span class="s2">doc</span><span class="s1">.</span><span class="s2">$session</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">session</span><span class="s1">);</span>
<a name="l2495"><span class="ln">2495 </span></a>    <span class="s1">}</span>
<a name="l2496"><span class="ln">2496 </span></a>    <span class="s2">doc</span><span class="s1">.</span><span class="s2">$init</span><span class="s1">(</span><span class="s2">rawDoc</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">, (</span><span class="s2">err</span><span class="s1">) =&gt; {</span>
<a name="l2497"><span class="ln">2497 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">err </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2498"><span class="ln">2498 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l2499"><span class="ln">2499 </span></a>      <span class="s1">}</span>
<a name="l2500"><span class="ln">2500 </span></a>      <span class="s2">resolve</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">);</span>
<a name="l2501"><span class="ln">2501 </span></a>    <span class="s1">});</span>
<a name="l2502"><span class="ln">2502 </span></a>  <span class="s1">})));</span>
<a name="l2503"><span class="ln">2503 </span></a><span class="s1">};</span>
<a name="l2504"><span class="ln">2504 </span></a>
<a name="l2505"><span class="ln">2505 </span></a><span class="s5">/**</span>
<a name="l2506"><span class="ln">2506 </span></a> <span class="s5">* Internal helper to execute a findOne() operation</span>
<a name="l2507"><span class="ln">2507 </span></a> <span class="s5">*</span>
<a name="l2508"><span class="ln">2508 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">findOne https://www.mongodb.com/docs/manual/reference/method/db.collection.findOne/</span>
<a name="l2509"><span class="ln">2509 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2510"><span class="ln">2510 </span></a> <span class="s5">*/</span>
<a name="l2511"><span class="ln">2511 </span></a>
<a name="l2512"><span class="ln">2512 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_findOne </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_findOne</span><span class="s1">() {</span>
<a name="l2513"><span class="ln">2513 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l2514"><span class="ln">2514 </span></a>
<a name="l2515"><span class="ln">2515 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">()) {</span>
<a name="l2516"><span class="ln">2516 </span></a>    <span class="s4">const </span><span class="s2">err </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l2517"><span class="ln">2517 </span></a>    <span class="s4">throw </span><span class="s2">err</span><span class="s1">;</span>
<a name="l2518"><span class="ln">2518 </span></a>  <span class="s1">}</span>
<a name="l2519"><span class="ln">2519 </span></a>
<a name="l2520"><span class="ln">2520 </span></a>  <span class="s2">applyGlobalMaxTimeMS</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2521"><span class="ln">2521 </span></a>  <span class="s2">applyGlobalDiskUse</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2522"><span class="ln">2522 </span></a>
<a name="l2523"><span class="ln">2523 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l2524"><span class="ln">2524 </span></a>
<a name="l2525"><span class="ln">2525 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2526"><span class="ln">2526 </span></a>
<a name="l2527"><span class="ln">2527 </span></a>  <span class="s3">// don't pass in the conditions because we already merged them in</span>
<a name="l2528"><span class="ln">2528 </span></a>  <span class="s4">const </span><span class="s2">doc </span><span class="s1">= </span><span class="s4">await this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">findOne</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l2529"><span class="ln">2529 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l2530"><span class="ln">2530 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_completeOne</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, (</span><span class="s2">err</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
<a name="l2531"><span class="ln">2531 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l2532"><span class="ln">2532 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l2533"><span class="ln">2533 </span></a>      <span class="s1">}</span>
<a name="l2534"><span class="ln">2534 </span></a>      <span class="s2">resolve</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l2535"><span class="ln">2535 </span></a>    <span class="s1">});</span>
<a name="l2536"><span class="ln">2536 </span></a>  <span class="s1">});</span>
<a name="l2537"><span class="ln">2537 </span></a><span class="s1">};</span>
<a name="l2538"><span class="ln">2538 </span></a>
<a name="l2539"><span class="ln">2539 </span></a><span class="s5">/**</span>
<a name="l2540"><span class="ln">2540 </span></a> <span class="s5">* Declares the query a findOne operation. When executed, the first found document is passed to the callback.</span>
<a name="l2541"><span class="ln">2541 </span></a> <span class="s5">*</span>
<a name="l2542"><span class="ln">2542 </span></a> <span class="s5">* The result of the query is a single document, or `null` if no document was found.</span>
<a name="l2543"><span class="ln">2543 </span></a> <span class="s5">*</span>
<a name="l2544"><span class="ln">2544 </span></a> <span class="s5">* * *Note:* `conditions` is optional, and if `conditions` is null or undefined,</span>
<a name="l2545"><span class="ln">2545 </span></a> <span class="s5">* mongoose will send an empty `findOne` command to MongoDB, which will return</span>
<a name="l2546"><span class="ln">2546 </span></a> <span class="s5">* an arbitrary document. If you're querying by `_id`, use `Model.findById()`</span>
<a name="l2547"><span class="ln">2547 </span></a> <span class="s5">* instead.</span>
<a name="l2548"><span class="ln">2548 </span></a> <span class="s5">*</span>
<a name="l2549"><span class="ln">2549 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l2550"><span class="ln">2550 </span></a> <span class="s5">*</span>
<a name="l2551"><span class="ln">2551 </span></a> <span class="s5">* - `findOne()`</span>
<a name="l2552"><span class="ln">2552 </span></a> <span class="s5">*</span>
<a name="l2553"><span class="ln">2553 </span></a> <span class="s5">* #### Example:</span>
<a name="l2554"><span class="ln">2554 </span></a> <span class="s5">*</span>
<a name="l2555"><span class="ln">2555 </span></a> <span class="s5">*     const query = Kitten.where({ color: 'white' });</span>
<a name="l2556"><span class="ln">2556 </span></a> <span class="s5">*     const kitten = await query.findOne();</span>
<a name="l2557"><span class="ln">2557 </span></a> <span class="s5">*</span>
<a name="l2558"><span class="ln">2558 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [filter] mongodb selector</span>
<a name="l2559"><span class="ln">2559 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [projection] optional fields to return</span>
<a name="l2560"><span class="ln">2560 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options] see [`setOptions()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.setOptions())</span>
<a name="l2561"><span class="ln">2561 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.translateAliases=null] If set to `true`, translates any schema-defined aliases in `filter`, `projection`, `update`, and `distinct`. Throws an error if there are any conflicts where both alias and raw property are defined on the same object.</span>
<a name="l2562"><span class="ln">2562 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2563"><span class="ln">2563 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">findOne https://www.mongodb.com/docs/manual/reference/method/db.collection.findOne/</span>
<a name="l2564"><span class="ln">2564 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Query.select https://mongoosejs.com/docs/api/query.html#Query.prototype.select()</span>
<a name="l2565"><span class="ln">2565 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2566"><span class="ln">2566 </span></a> <span class="s5">*/</span>
<a name="l2567"><span class="ln">2567 </span></a>
<a name="l2568"><span class="ln">2568 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">findOne </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">projection</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l2569"><span class="ln">2569 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2570"><span class="ln">2570 </span></a>      <span class="s4">typeof </span><span class="s2">projection </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2571"><span class="ln">2571 </span></a>      <span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2572"><span class="ln">2572 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l2573"><span class="ln">2573 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.findOne() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l2574"><span class="ln">2574 </span></a>  <span class="s1">}</span>
<a name="l2575"><span class="ln">2575 </span></a>
<a name="l2576"><span class="ln">2576 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'findOne'</span><span class="s1">;</span>
<a name="l2577"><span class="ln">2577 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l2578"><span class="ln">2578 </span></a>
<a name="l2579"><span class="ln">2579 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l2580"><span class="ln">2580 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2581"><span class="ln">2581 </span></a>  <span class="s1">}</span>
<a name="l2582"><span class="ln">2582 </span></a>
<a name="l2583"><span class="ln">2583 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">projection</span><span class="s1">) {</span>
<a name="l2584"><span class="ln">2584 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">select</span><span class="s1">(</span><span class="s2">projection</span><span class="s1">);</span>
<a name="l2585"><span class="ln">2585 </span></a>  <span class="s1">}</span>
<a name="l2586"><span class="ln">2586 </span></a>
<a name="l2587"><span class="ln">2587 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">)) {</span>
<a name="l2588"><span class="ln">2588 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">);</span>
<a name="l2589"><span class="ln">2589 </span></a>
<a name="l2590"><span class="ln">2590 </span></a>    <span class="s2">prepareDiscriminatorCriteria</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l2591"><span class="ln">2591 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">conditions </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2592"><span class="ln">2592 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s0">'findOne'</span><span class="s1">));</span>
<a name="l2593"><span class="ln">2593 </span></a>  <span class="s1">}</span>
<a name="l2594"><span class="ln">2594 </span></a>
<a name="l2595"><span class="ln">2595 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2596"><span class="ln">2596 </span></a><span class="s1">};</span>
<a name="l2597"><span class="ln">2597 </span></a>
<a name="l2598"><span class="ln">2598 </span></a>
<a name="l2599"><span class="ln">2599 </span></a><span class="s5">/**</span>
<a name="l2600"><span class="ln">2600 </span></a> <span class="s5">* Execute a countDocuments query</span>
<a name="l2601"><span class="ln">2601 </span></a> <span class="s5">*</span>
<a name="l2602"><span class="ln">2602 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">countDocuments https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#countDocuments</span>
<a name="l2603"><span class="ln">2603 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2604"><span class="ln">2604 </span></a> <span class="s5">*/</span>
<a name="l2605"><span class="ln">2605 </span></a>
<a name="l2606"><span class="ln">2606 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_countDocuments </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_countDocuments</span><span class="s1">() {</span>
<a name="l2607"><span class="ln">2607 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l2608"><span class="ln">2608 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">cast</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">);</span>
<a name="l2609"><span class="ln">2609 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l2610"><span class="ln">2610 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l2611"><span class="ln">2611 </span></a>  <span class="s1">}</span>
<a name="l2612"><span class="ln">2612 </span></a>
<a name="l2613"><span class="ln">2613 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">()) {</span>
<a name="l2614"><span class="ln">2614 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l2615"><span class="ln">2615 </span></a>  <span class="s1">}</span>
<a name="l2616"><span class="ln">2616 </span></a>
<a name="l2617"><span class="ln">2617 </span></a>  <span class="s2">applyGlobalMaxTimeMS</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2618"><span class="ln">2618 </span></a>  <span class="s2">applyGlobalDiskUse</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2619"><span class="ln">2619 </span></a>
<a name="l2620"><span class="ln">2620 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l2621"><span class="ln">2621 </span></a>
<a name="l2622"><span class="ln">2622 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2623"><span class="ln">2623 </span></a>
<a name="l2624"><span class="ln">2624 </span></a>  <span class="s4">const </span><span class="s2">conds </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l2625"><span class="ln">2625 </span></a>
<a name="l2626"><span class="ln">2626 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">countDocuments</span><span class="s1">(</span><span class="s2">conds</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l2627"><span class="ln">2627 </span></a><span class="s1">};</span>
<a name="l2628"><span class="ln">2628 </span></a>
<a name="l2629"><span class="ln">2629 </span></a><span class="s3">/*! 
<a name="l2630"><span class="ln">2630 </span></a> * If `translateAliases` option is set, call `Model.translateAliases()` 
<a name="l2631"><span class="ln">2631 </span></a> * on the following query properties: filter, projection, update, distinct. 
<a name="l2632"><span class="ln">2632 </span></a> */</span>
<a name="l2633"><span class="ln">2633 </span></a>
<a name="l2634"><span class="ln">2634 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_applyTranslateAliases </span><span class="s1">= </span><span class="s4">function </span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l2635"><span class="ln">2635 </span></a>  <span class="s4">let </span><span class="s2">applyTranslateAliases </span><span class="s1">= </span><span class="s4">false</span><span class="s1">;</span>
<a name="l2636"><span class="ln">2636 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'translateAliases' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">) {</span>
<a name="l2637"><span class="ln">2637 </span></a>    <span class="s2">applyTranslateAliases </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">;</span>
<a name="l2638"><span class="ln">2638 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">?.</span><span class="s2">schema</span><span class="s1">?.</span><span class="s2">_userProvidedOptions</span><span class="s1">?.</span><span class="s2">translateAliases </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2639"><span class="ln">2639 </span></a>    <span class="s2">applyTranslateAliases </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">_userProvidedOptions</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">;</span>
<a name="l2640"><span class="ln">2640 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">?.</span><span class="s2">base</span><span class="s1">?.</span><span class="s2">options</span><span class="s1">?.</span><span class="s2">translateAliases </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2641"><span class="ln">2641 </span></a>    <span class="s2">applyTranslateAliases </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">;</span>
<a name="l2642"><span class="ln">2642 </span></a>  <span class="s1">}</span>
<a name="l2643"><span class="ln">2643 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">applyTranslateAliases</span><span class="s1">) {</span>
<a name="l2644"><span class="ln">2644 </span></a>    <span class="s4">return</span><span class="s1">;</span>
<a name="l2645"><span class="ln">2645 </span></a>  <span class="s1">}</span>
<a name="l2646"><span class="ln">2646 </span></a>
<a name="l2647"><span class="ln">2647 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">?.</span><span class="s2">schema</span><span class="s1">?.</span><span class="s2">aliases </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">aliases</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l2648"><span class="ln">2648 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s4">true</span><span class="s1">);</span>
<a name="l2649"><span class="ln">2649 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">projection</span><span class="s1">, </span><span class="s4">true</span><span class="s1">);</span>
<a name="l2650"><span class="ln">2650 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">translateAliases</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s4">true</span><span class="s1">);</span>
<a name="l2651"><span class="ln">2651 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">aliases</span><span class="s1">[</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">] != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2652"><span class="ln">2652 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">aliases</span><span class="s1">[</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">];</span>
<a name="l2653"><span class="ln">2653 </span></a>    <span class="s1">}</span>
<a name="l2654"><span class="ln">2654 </span></a>  <span class="s1">}</span>
<a name="l2655"><span class="ln">2655 </span></a><span class="s1">};</span>
<a name="l2656"><span class="ln">2656 </span></a>
<a name="l2657"><span class="ln">2657 </span></a><span class="s5">/**</span>
<a name="l2658"><span class="ln">2658 </span></a> <span class="s5">* Execute a estimatedDocumentCount() query</span>
<a name="l2659"><span class="ln">2659 </span></a> <span class="s5">*</span>
<a name="l2660"><span class="ln">2660 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">estimatedDocumentCount https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#estimatedDocumentCount</span>
<a name="l2661"><span class="ln">2661 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2662"><span class="ln">2662 </span></a> <span class="s5">*/</span>
<a name="l2663"><span class="ln">2663 </span></a>
<a name="l2664"><span class="ln">2664 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_estimatedDocumentCount </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_estimatedDocumentCount</span><span class="s1">() {</span>
<a name="l2665"><span class="ln">2665 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">()) {</span>
<a name="l2666"><span class="ln">2666 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l2667"><span class="ln">2667 </span></a>  <span class="s1">}</span>
<a name="l2668"><span class="ln">2668 </span></a>
<a name="l2669"><span class="ln">2669 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l2670"><span class="ln">2670 </span></a>
<a name="l2671"><span class="ln">2671 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">estimatedDocumentCount</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2672"><span class="ln">2672 </span></a><span class="s1">};</span>
<a name="l2673"><span class="ln">2673 </span></a>
<a name="l2674"><span class="ln">2674 </span></a><span class="s5">/**</span>
<a name="l2675"><span class="ln">2675 </span></a> <span class="s5">* Specifies this query as a `estimatedDocumentCount()` query. Faster than</span>
<a name="l2676"><span class="ln">2676 </span></a> <span class="s5">* using `countDocuments()` for large collections because</span>
<a name="l2677"><span class="ln">2677 </span></a> <span class="s5">* `estimatedDocumentCount()` uses collection metadata rather than scanning</span>
<a name="l2678"><span class="ln">2678 </span></a> <span class="s5">* the entire collection.</span>
<a name="l2679"><span class="ln">2679 </span></a> <span class="s5">*</span>
<a name="l2680"><span class="ln">2680 </span></a> <span class="s5">* `estimatedDocumentCount()` does **not** accept a filter. `Model.find({ foo: bar }).estimatedDocumentCount()`</span>
<a name="l2681"><span class="ln">2681 </span></a> <span class="s5">* is equivalent to `Model.find().estimatedDocumentCount()`</span>
<a name="l2682"><span class="ln">2682 </span></a> <span class="s5">*</span>
<a name="l2683"><span class="ln">2683 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l2684"><span class="ln">2684 </span></a> <span class="s5">*</span>
<a name="l2685"><span class="ln">2685 </span></a> <span class="s5">* - `estimatedDocumentCount()`</span>
<a name="l2686"><span class="ln">2686 </span></a> <span class="s5">*</span>
<a name="l2687"><span class="ln">2687 </span></a> <span class="s5">* #### Example:</span>
<a name="l2688"><span class="ln">2688 </span></a> <span class="s5">*</span>
<a name="l2689"><span class="ln">2689 </span></a> <span class="s5">*     await Model.find().estimatedDocumentCount();</span>
<a name="l2690"><span class="ln">2690 </span></a> <span class="s5">*</span>
<a name="l2691"><span class="ln">2691 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options] passed transparently to the [MongoDB driver](https://mongodb.github.io/node-mongodb-native/4.9/interfaces/EstimatedDocumentCountOptions.html)</span>
<a name="l2692"><span class="ln">2692 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2693"><span class="ln">2693 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">estimatedDocumentCount https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#estimatedDocumentCount</span>
<a name="l2694"><span class="ln">2694 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2695"><span class="ln">2695 </span></a> <span class="s5">*/</span>
<a name="l2696"><span class="ln">2696 </span></a>
<a name="l2697"><span class="ln">2697 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">estimatedDocumentCount </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l2698"><span class="ln">2698 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2699"><span class="ln">2699 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l2700"><span class="ln">2700 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.estimatedDocumentCount() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l2701"><span class="ln">2701 </span></a>  <span class="s1">}</span>
<a name="l2702"><span class="ln">2702 </span></a>
<a name="l2703"><span class="ln">2703 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'estimatedDocumentCount'</span><span class="s1">;</span>
<a name="l2704"><span class="ln">2704 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l2705"><span class="ln">2705 </span></a>
<a name="l2706"><span class="ln">2706 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; </span><span class="s2">options </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2707"><span class="ln">2707 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2708"><span class="ln">2708 </span></a>  <span class="s1">}</span>
<a name="l2709"><span class="ln">2709 </span></a>
<a name="l2710"><span class="ln">2710 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2711"><span class="ln">2711 </span></a><span class="s1">};</span>
<a name="l2712"><span class="ln">2712 </span></a>
<a name="l2713"><span class="ln">2713 </span></a><span class="s5">/**</span>
<a name="l2714"><span class="ln">2714 </span></a> <span class="s5">* Specifies this query as a `countDocuments()` query. Behaves like `count()`,</span>
<a name="l2715"><span class="ln">2715 </span></a> <span class="s5">* except it always does a full collection scan when passed an empty filter `{}`.</span>
<a name="l2716"><span class="ln">2716 </span></a> <span class="s5">*</span>
<a name="l2717"><span class="ln">2717 </span></a> <span class="s5">* There are also minor differences in how `countDocuments()` handles</span>
<a name="l2718"><span class="ln">2718 </span></a> <span class="s5">* [`$where` and a couple geospatial operators](https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#countDocuments).</span>
<a name="l2719"><span class="ln">2719 </span></a> <span class="s5">* versus `count()`.</span>
<a name="l2720"><span class="ln">2720 </span></a> <span class="s5">*</span>
<a name="l2721"><span class="ln">2721 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l2722"><span class="ln">2722 </span></a> <span class="s5">*</span>
<a name="l2723"><span class="ln">2723 </span></a> <span class="s5">* - `countDocuments()`</span>
<a name="l2724"><span class="ln">2724 </span></a> <span class="s5">*</span>
<a name="l2725"><span class="ln">2725 </span></a> <span class="s5">* #### Example:</span>
<a name="l2726"><span class="ln">2726 </span></a> <span class="s5">*</span>
<a name="l2727"><span class="ln">2727 </span></a> <span class="s5">*     const countQuery = model.where({ 'color': 'black' }).countDocuments();</span>
<a name="l2728"><span class="ln">2728 </span></a> <span class="s5">*</span>
<a name="l2729"><span class="ln">2729 </span></a> <span class="s5">*     query.countDocuments({ color: 'black' }).count().exec();</span>
<a name="l2730"><span class="ln">2730 </span></a> <span class="s5">*</span>
<a name="l2731"><span class="ln">2731 </span></a> <span class="s5">*     await query.countDocuments({ color: 'black' });</span>
<a name="l2732"><span class="ln">2732 </span></a> <span class="s5">*</span>
<a name="l2733"><span class="ln">2733 </span></a> <span class="s5">*     query.where('color', 'black').countDocuments().exec();</span>
<a name="l2734"><span class="ln">2734 </span></a> <span class="s5">*</span>
<a name="l2735"><span class="ln">2735 </span></a> <span class="s5">* The `countDocuments()` function is similar to `count()`, but there are a</span>
<a name="l2736"><span class="ln">2736 </span></a> <span class="s5">* [few operators that `countDocuments()` does not support](https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#countDocuments).</span>
<a name="l2737"><span class="ln">2737 </span></a> <span class="s5">* Below are the operators that `count()` supports but `countDocuments()` does not,</span>
<a name="l2738"><span class="ln">2738 </span></a> <span class="s5">* and the suggested replacement:</span>
<a name="l2739"><span class="ln">2739 </span></a> <span class="s5">*</span>
<a name="l2740"><span class="ln">2740 </span></a> <span class="s5">* - `$where`: [`$expr`](https://www.mongodb.com/docs/manual/reference/operator/query/expr/)</span>
<a name="l2741"><span class="ln">2741 </span></a> <span class="s5">* - `$near`: [`$geoWithin`](https://www.mongodb.com/docs/manual/reference/operator/query/geoWithin/) with [`$center`](https://www.mongodb.com/docs/manual/reference/operator/query/center/#op._S_center)</span>
<a name="l2742"><span class="ln">2742 </span></a> <span class="s5">* - `$nearSphere`: [`$geoWithin`](https://www.mongodb.com/docs/manual/reference/operator/query/geoWithin/) with [`$centerSphere`](https://www.mongodb.com/docs/manual/reference/operator/query/centerSphere/#op._S_centerSphere)</span>
<a name="l2743"><span class="ln">2743 </span></a> <span class="s5">*</span>
<a name="l2744"><span class="ln">2744 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [filter] mongodb selector</span>
<a name="l2745"><span class="ln">2745 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l2746"><span class="ln">2746 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2747"><span class="ln">2747 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">countDocuments https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#countDocuments</span>
<a name="l2748"><span class="ln">2748 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2749"><span class="ln">2749 </span></a> <span class="s5">*/</span>
<a name="l2750"><span class="ln">2750 </span></a>
<a name="l2751"><span class="ln">2751 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">countDocuments </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l2752"><span class="ln">2752 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2753"><span class="ln">2753 </span></a>      <span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2754"><span class="ln">2754 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l2755"><span class="ln">2755 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.countDocuments() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l2756"><span class="ln">2756 </span></a>  <span class="s1">}</span>
<a name="l2757"><span class="ln">2757 </span></a>
<a name="l2758"><span class="ln">2758 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'countDocuments'</span><span class="s1">;</span>
<a name="l2759"><span class="ln">2759 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l2760"><span class="ln">2760 </span></a>
<a name="l2761"><span class="ln">2761 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">)) {</span>
<a name="l2762"><span class="ln">2762 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">);</span>
<a name="l2763"><span class="ln">2763 </span></a>  <span class="s1">}</span>
<a name="l2764"><span class="ln">2764 </span></a>
<a name="l2765"><span class="ln">2765 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; </span><span class="s2">options </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2766"><span class="ln">2766 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2767"><span class="ln">2767 </span></a>  <span class="s1">}</span>
<a name="l2768"><span class="ln">2768 </span></a>
<a name="l2769"><span class="ln">2769 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2770"><span class="ln">2770 </span></a><span class="s1">};</span>
<a name="l2771"><span class="ln">2771 </span></a>
<a name="l2772"><span class="ln">2772 </span></a><span class="s5">/**</span>
<a name="l2773"><span class="ln">2773 </span></a> <span class="s5">* Execute a `distinct()` query</span>
<a name="l2774"><span class="ln">2774 </span></a> <span class="s5">*</span>
<a name="l2775"><span class="ln">2775 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">distinct https://www.mongodb.com/docs/manual/reference/method/db.collection.distinct/</span>
<a name="l2776"><span class="ln">2776 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2777"><span class="ln">2777 </span></a> <span class="s5">*/</span>
<a name="l2778"><span class="ln">2778 </span></a>
<a name="l2779"><span class="ln">2779 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">__distinct </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">__distinct</span><span class="s1">() {</span>
<a name="l2780"><span class="ln">2780 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l2781"><span class="ln">2781 </span></a>
<a name="l2782"><span class="ln">2782 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">()) {</span>
<a name="l2783"><span class="ln">2783 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l2784"><span class="ln">2784 </span></a>  <span class="s1">}</span>
<a name="l2785"><span class="ln">2785 </span></a>
<a name="l2786"><span class="ln">2786 </span></a>  <span class="s2">applyGlobalMaxTimeMS</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2787"><span class="ln">2787 </span></a>  <span class="s2">applyGlobalDiskUse</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2788"><span class="ln">2788 </span></a>
<a name="l2789"><span class="ln">2789 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l2790"><span class="ln">2790 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2791"><span class="ln">2791 </span></a>
<a name="l2792"><span class="ln">2792 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span>
<a name="l2793"><span class="ln">2793 </span></a>    <span class="s2">distinct</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l2794"><span class="ln">2794 </span></a><span class="s1">};</span>
<a name="l2795"><span class="ln">2795 </span></a>
<a name="l2796"><span class="ln">2796 </span></a><span class="s5">/**</span>
<a name="l2797"><span class="ln">2797 </span></a> <span class="s5">* Declares or executes a distinct() operation.</span>
<a name="l2798"><span class="ln">2798 </span></a> <span class="s5">*</span>
<a name="l2799"><span class="ln">2799 </span></a> <span class="s5">* This function does not trigger any middleware.</span>
<a name="l2800"><span class="ln">2800 </span></a> <span class="s5">*</span>
<a name="l2801"><span class="ln">2801 </span></a> <span class="s5">* #### Example:</span>
<a name="l2802"><span class="ln">2802 </span></a> <span class="s5">*</span>
<a name="l2803"><span class="ln">2803 </span></a> <span class="s5">*     distinct(field, conditions)</span>
<a name="l2804"><span class="ln">2804 </span></a> <span class="s5">*     distinct(field)</span>
<a name="l2805"><span class="ln">2805 </span></a> <span class="s5">*     distinct()</span>
<a name="l2806"><span class="ln">2806 </span></a> <span class="s5">*</span>
<a name="l2807"><span class="ln">2807 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [field]</span>
<a name="l2808"><span class="ln">2808 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Query} [filter]</span>
<a name="l2809"><span class="ln">2809 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2810"><span class="ln">2810 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">distinct https://www.mongodb.com/docs/manual/reference/method/db.collection.distinct/</span>
<a name="l2811"><span class="ln">2811 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2812"><span class="ln">2812 </span></a> <span class="s5">*/</span>
<a name="l2813"><span class="ln">2813 </span></a>
<a name="l2814"><span class="ln">2814 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">distinct </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">field</span><span class="s1">, </span><span class="s2">conditions</span><span class="s1">) {</span>
<a name="l2815"><span class="ln">2815 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">field </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2816"><span class="ln">2816 </span></a>      <span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l2817"><span class="ln">2817 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l2818"><span class="ln">2818 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.distinct() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l2819"><span class="ln">2819 </span></a>  <span class="s1">}</span>
<a name="l2820"><span class="ln">2820 </span></a>
<a name="l2821"><span class="ln">2821 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'distinct'</span><span class="s1">;</span>
<a name="l2822"><span class="ln">2822 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l2823"><span class="ln">2823 </span></a>
<a name="l2824"><span class="ln">2824 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">)) {</span>
<a name="l2825"><span class="ln">2825 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">);</span>
<a name="l2826"><span class="ln">2826 </span></a>
<a name="l2827"><span class="ln">2827 </span></a>    <span class="s2">prepareDiscriminatorCriteria</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l2828"><span class="ln">2828 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">conditions </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2829"><span class="ln">2829 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s0">'distinct'</span><span class="s1">));</span>
<a name="l2830"><span class="ln">2830 </span></a>  <span class="s1">}</span>
<a name="l2831"><span class="ln">2831 </span></a>
<a name="l2832"><span class="ln">2832 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">field </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2833"><span class="ln">2833 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_distinct </span><span class="s1">= </span><span class="s2">field</span><span class="s1">;</span>
<a name="l2834"><span class="ln">2834 </span></a>  <span class="s1">}</span>
<a name="l2835"><span class="ln">2835 </span></a>
<a name="l2836"><span class="ln">2836 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2837"><span class="ln">2837 </span></a><span class="s1">};</span>
<a name="l2838"><span class="ln">2838 </span></a>
<a name="l2839"><span class="ln">2839 </span></a><span class="s5">/**</span>
<a name="l2840"><span class="ln">2840 </span></a> <span class="s5">* Sets the sort order</span>
<a name="l2841"><span class="ln">2841 </span></a> <span class="s5">*</span>
<a name="l2842"><span class="ln">2842 </span></a> <span class="s5">* If an object is passed, values allowed are `asc`, `desc`, `ascending`, `descending`, `1`, and `-1`.</span>
<a name="l2843"><span class="ln">2843 </span></a> <span class="s5">*</span>
<a name="l2844"><span class="ln">2844 </span></a> <span class="s5">* If a string is passed, it must be a space delimited list of path names. The</span>
<a name="l2845"><span class="ln">2845 </span></a> <span class="s5">* sort order of each path is ascending unless the path name is prefixed with `-`</span>
<a name="l2846"><span class="ln">2846 </span></a> <span class="s5">* which will be treated as descending.</span>
<a name="l2847"><span class="ln">2847 </span></a> <span class="s5">*</span>
<a name="l2848"><span class="ln">2848 </span></a> <span class="s5">* #### Example:</span>
<a name="l2849"><span class="ln">2849 </span></a> <span class="s5">*</span>
<a name="l2850"><span class="ln">2850 </span></a> <span class="s5">*     // sort by &quot;field&quot; ascending and &quot;test&quot; descending</span>
<a name="l2851"><span class="ln">2851 </span></a> <span class="s5">*     query.sort({ field: 'asc', test: -1 });</span>
<a name="l2852"><span class="ln">2852 </span></a> <span class="s5">*</span>
<a name="l2853"><span class="ln">2853 </span></a> <span class="s5">*     // equivalent</span>
<a name="l2854"><span class="ln">2854 </span></a> <span class="s5">*     query.sort('field -test');</span>
<a name="l2855"><span class="ln">2855 </span></a> <span class="s5">*</span>
<a name="l2856"><span class="ln">2856 </span></a> <span class="s5">*     // also possible is to use a array with array key-value pairs</span>
<a name="l2857"><span class="ln">2857 </span></a> <span class="s5">*     query.sort([['field', 'asc']]);</span>
<a name="l2858"><span class="ln">2858 </span></a> <span class="s5">*</span>
<a name="l2859"><span class="ln">2859 </span></a> <span class="s5">* #### Note:</span>
<a name="l2860"><span class="ln">2860 </span></a> <span class="s5">*</span>
<a name="l2861"><span class="ln">2861 </span></a> <span class="s5">* Cannot be used with `distinct()`</span>
<a name="l2862"><span class="ln">2862 </span></a> <span class="s5">*</span>
<a name="l2863"><span class="ln">2863 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|String|Array&lt;Array&lt;(string | number)&gt;&gt;} arg</span>
<a name="l2864"><span class="ln">2864 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2865"><span class="ln">2865 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">cursor.sort https://www.mongodb.com/docs/manual/reference/method/cursor.sort/</span>
<a name="l2866"><span class="ln">2866 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2867"><span class="ln">2867 </span></a> <span class="s5">*/</span>
<a name="l2868"><span class="ln">2868 </span></a>
<a name="l2869"><span class="ln">2869 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">sort </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">) {</span>
<a name="l2870"><span class="ln">2870 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s7">1</span><span class="s1">) {</span>
<a name="l2871"><span class="ln">2871 </span></a>    <span class="s4">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'sort() only takes 1 Argument'</span><span class="s1">);</span>
<a name="l2872"><span class="ln">2872 </span></a>  <span class="s1">}</span>
<a name="l2873"><span class="ln">2873 </span></a>
<a name="l2874"><span class="ln">2874 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2875"><span class="ln">2875 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort </span><span class="s1">= {};</span>
<a name="l2876"><span class="ln">2876 </span></a>  <span class="s1">}</span>
<a name="l2877"><span class="ln">2877 </span></a>  <span class="s4">const </span><span class="s2">sort </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">;</span>
<a name="l2878"><span class="ln">2878 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arg </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l2879"><span class="ln">2879 </span></a>    <span class="s4">const </span><span class="s2">properties </span><span class="s1">= </span><span class="s2">arg</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">' '</span><span class="s1">) === -</span><span class="s7">1 </span><span class="s1">? [</span><span class="s2">arg</span><span class="s1">] : </span><span class="s2">arg</span><span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s0">' '</span><span class="s1">);</span>
<a name="l2880"><span class="ln">2880 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">property of properties</span><span class="s1">) {</span>
<a name="l2881"><span class="ln">2881 </span></a>      <span class="s4">const </span><span class="s2">ascend </span><span class="s1">= </span><span class="s0">'-' </span><span class="s1">== </span><span class="s2">property</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] ? -</span><span class="s7">1 </span><span class="s1">: </span><span class="s7">1</span><span class="s1">;</span>
<a name="l2882"><span class="ln">2882 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">ascend </span><span class="s1">=== -</span><span class="s7">1</span><span class="s1">) {</span>
<a name="l2883"><span class="ln">2883 </span></a>        <span class="s2">property </span><span class="s1">= </span><span class="s2">property</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s7">1</span><span class="s1">);</span>
<a name="l2884"><span class="ln">2884 </span></a>      <span class="s1">}</span>
<a name="l2885"><span class="ln">2885 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">specialProperties</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">property</span><span class="s1">)) {</span>
<a name="l2886"><span class="ln">2886 </span></a>        <span class="s4">continue</span><span class="s1">;</span>
<a name="l2887"><span class="ln">2887 </span></a>      <span class="s1">}</span>
<a name="l2888"><span class="ln">2888 </span></a>      <span class="s2">sort</span><span class="s1">[</span><span class="s2">property</span><span class="s1">] = </span><span class="s2">ascend</span><span class="s1">;</span>
<a name="l2889"><span class="ln">2889 </span></a>    <span class="s1">}</span>
<a name="l2890"><span class="ln">2890 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">)) {</span>
<a name="l2891"><span class="ln">2891 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">pair of arg</span><span class="s1">) {</span>
<a name="l2892"><span class="ln">2892 </span></a>      <span class="s4">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">)) {</span>
<a name="l2893"><span class="ln">2893 </span></a>        <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'Invalid sort() argument, must be array of arrays'</span><span class="s1">);</span>
<a name="l2894"><span class="ln">2894 </span></a>      <span class="s1">}</span>
<a name="l2895"><span class="ln">2895 </span></a>      <span class="s4">const </span><span class="s2">key </span><span class="s1">= </span><span class="s0">'' </span><span class="s1">+ </span><span class="s2">pair</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l2896"><span class="ln">2896 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">specialProperties</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">)) {</span>
<a name="l2897"><span class="ln">2897 </span></a>        <span class="s4">continue</span><span class="s1">;</span>
<a name="l2898"><span class="ln">2898 </span></a>      <span class="s1">}</span>
<a name="l2899"><span class="ln">2899 </span></a>      <span class="s2">sort</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">_handleSortValue</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">key</span><span class="s1">);</span>
<a name="l2900"><span class="ln">2900 </span></a>    <span class="s1">}</span>
<a name="l2901"><span class="ln">2901 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arg </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; </span><span class="s2">arg </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; !(</span><span class="s2">arg </span><span class="s4">instanceof </span><span class="s2">Map</span><span class="s1">)) {</span>
<a name="l2902"><span class="ln">2902 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">key of Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">)) {</span>
<a name="l2903"><span class="ln">2903 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">specialProperties</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">)) {</span>
<a name="l2904"><span class="ln">2904 </span></a>        <span class="s4">continue</span><span class="s1">;</span>
<a name="l2905"><span class="ln">2905 </span></a>      <span class="s1">}</span>
<a name="l2906"><span class="ln">2906 </span></a>      <span class="s2">sort</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">_handleSortValue</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">[</span><span class="s2">key</span><span class="s1">], </span><span class="s2">key</span><span class="s1">);</span>
<a name="l2907"><span class="ln">2907 </span></a>    <span class="s1">}</span>
<a name="l2908"><span class="ln">2908 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arg </span><span class="s4">instanceof </span><span class="s2">Map</span><span class="s1">) {</span>
<a name="l2909"><span class="ln">2909 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">key of arg</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">()) {</span>
<a name="l2910"><span class="ln">2910 </span></a>      <span class="s2">key </span><span class="s1">= </span><span class="s0">'' </span><span class="s1">+ </span><span class="s2">key</span><span class="s1">;</span>
<a name="l2911"><span class="ln">2911 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">specialProperties</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">)) {</span>
<a name="l2912"><span class="ln">2912 </span></a>        <span class="s4">continue</span><span class="s1">;</span>
<a name="l2913"><span class="ln">2913 </span></a>      <span class="s1">}</span>
<a name="l2914"><span class="ln">2914 </span></a>      <span class="s2">sort</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">_handleSortValue</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">), </span><span class="s2">key</span><span class="s1">);</span>
<a name="l2915"><span class="ln">2915 </span></a>    <span class="s1">}</span>
<a name="l2916"><span class="ln">2916 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arg </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2917"><span class="ln">2917 </span></a>    <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'Invalid sort() argument. Must be a string, object, array, or map.'</span><span class="s1">);</span>
<a name="l2918"><span class="ln">2918 </span></a>  <span class="s1">}</span>
<a name="l2919"><span class="ln">2919 </span></a>
<a name="l2920"><span class="ln">2920 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2921"><span class="ln">2921 </span></a><span class="s1">};</span>
<a name="l2922"><span class="ln">2922 </span></a>
<a name="l2923"><span class="ln">2923 </span></a><span class="s3">/*! 
<a name="l2924"><span class="ln">2924 </span></a> * Convert sort values 
<a name="l2925"><span class="ln">2925 </span></a> */</span>
<a name="l2926"><span class="ln">2926 </span></a>
<a name="l2927"><span class="ln">2927 </span></a><span class="s4">function </span><span class="s2">_handleSortValue</span><span class="s1">(</span><span class="s2">val</span><span class="s1">, </span><span class="s2">key</span><span class="s1">) {</span>
<a name="l2928"><span class="ln">2928 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">=== </span><span class="s7">1 </span><span class="s1">|| </span><span class="s2">val </span><span class="s1">=== </span><span class="s0">'asc' </span><span class="s1">|| </span><span class="s2">val </span><span class="s1">=== </span><span class="s0">'ascending'</span><span class="s1">) {</span>
<a name="l2929"><span class="ln">2929 </span></a>    <span class="s4">return </span><span class="s7">1</span><span class="s1">;</span>
<a name="l2930"><span class="ln">2930 </span></a>  <span class="s1">}</span>
<a name="l2931"><span class="ln">2931 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">=== -</span><span class="s7">1 </span><span class="s1">|| </span><span class="s2">val </span><span class="s1">=== </span><span class="s0">'desc' </span><span class="s1">|| </span><span class="s2">val </span><span class="s1">=== </span><span class="s0">'descending'</span><span class="s1">) {</span>
<a name="l2932"><span class="ln">2932 </span></a>    <span class="s4">return </span><span class="s1">-</span><span class="s7">1</span><span class="s1">;</span>
<a name="l2933"><span class="ln">2933 </span></a>  <span class="s1">}</span>
<a name="l2934"><span class="ln">2934 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val</span><span class="s1">?.</span><span class="s2">$meta </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2935"><span class="ln">2935 </span></a>    <span class="s4">return </span><span class="s1">{ </span><span class="s2">$meta</span><span class="s1">: </span><span class="s2">val</span><span class="s1">.</span><span class="s2">$meta </span><span class="s1">};</span>
<a name="l2936"><span class="ln">2936 </span></a>  <span class="s1">}</span>
<a name="l2937"><span class="ln">2937 </span></a>  <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'Invalid sort value: { ' </span><span class="s1">+ </span><span class="s2">key </span><span class="s1">+ </span><span class="s0">': ' </span><span class="s1">+ </span><span class="s2">val </span><span class="s1">+ </span><span class="s0">' }'</span><span class="s1">);</span>
<a name="l2938"><span class="ln">2938 </span></a><span class="s1">}</span>
<a name="l2939"><span class="ln">2939 </span></a>
<a name="l2940"><span class="ln">2940 </span></a><span class="s5">/**</span>
<a name="l2941"><span class="ln">2941 </span></a> <span class="s5">* Declare and/or execute this query as a `deleteOne()` operation. Works like</span>
<a name="l2942"><span class="ln">2942 </span></a> <span class="s5">* remove, except it deletes at most one document regardless of the `single`</span>
<a name="l2943"><span class="ln">2943 </span></a> <span class="s5">* option.</span>
<a name="l2944"><span class="ln">2944 </span></a> <span class="s5">*</span>
<a name="l2945"><span class="ln">2945 </span></a> <span class="s5">* This function triggers `deleteOne` middleware.</span>
<a name="l2946"><span class="ln">2946 </span></a> <span class="s5">*</span>
<a name="l2947"><span class="ln">2947 </span></a> <span class="s5">* #### Example:</span>
<a name="l2948"><span class="ln">2948 </span></a> <span class="s5">*</span>
<a name="l2949"><span class="ln">2949 </span></a> <span class="s5">*     await Character.deleteOne({ name: 'Eddard Stark' });</span>
<a name="l2950"><span class="ln">2950 </span></a> <span class="s5">*</span>
<a name="l2951"><span class="ln">2951 </span></a> <span class="s5">* This function calls the MongoDB driver's [`Collection#deleteOne()` function](https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#deleteOne).</span>
<a name="l2952"><span class="ln">2952 </span></a> <span class="s5">* The returned [promise](https://mongoosejs.com/docs/queries.html) resolves to an</span>
<a name="l2953"><span class="ln">2953 </span></a> <span class="s5">* object that contains 3 properties:</span>
<a name="l2954"><span class="ln">2954 </span></a> <span class="s5">*</span>
<a name="l2955"><span class="ln">2955 </span></a> <span class="s5">* - `ok`: `1` if no errors occurred</span>
<a name="l2956"><span class="ln">2956 </span></a> <span class="s5">* - `deletedCount`: the number of documents deleted</span>
<a name="l2957"><span class="ln">2957 </span></a> <span class="s5">* - `n`: the number of documents deleted. Equal to `deletedCount`.</span>
<a name="l2958"><span class="ln">2958 </span></a> <span class="s5">*</span>
<a name="l2959"><span class="ln">2959 </span></a> <span class="s5">* #### Example:</span>
<a name="l2960"><span class="ln">2960 </span></a> <span class="s5">*</span>
<a name="l2961"><span class="ln">2961 </span></a> <span class="s5">*     const res = await Character.deleteOne({ name: 'Eddard Stark' });</span>
<a name="l2962"><span class="ln">2962 </span></a> <span class="s5">*     // `1` if MongoDB deleted a doc, `0` if no docs matched the filter `{ name: ... }`</span>
<a name="l2963"><span class="ln">2963 </span></a> <span class="s5">*     res.deletedCount;</span>
<a name="l2964"><span class="ln">2964 </span></a> <span class="s5">*</span>
<a name="l2965"><span class="ln">2965 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Query} [filter] mongodb selector</span>
<a name="l2966"><span class="ln">2966 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options] optional see [`Query.prototype.setOptions()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.setOptions())</span>
<a name="l2967"><span class="ln">2967 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l2968"><span class="ln">2968 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">DeleteResult https://mongodb.github.io/node-mongodb-native/4.9/interfaces/DeleteResult.html</span>
<a name="l2969"><span class="ln">2969 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">deleteOne https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#deleteOne</span>
<a name="l2970"><span class="ln">2970 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l2971"><span class="ln">2971 </span></a> <span class="s5">*/</span>
<a name="l2972"><span class="ln">2972 </span></a>
<a name="l2973"><span class="ln">2973 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">deleteOne </span><span class="s1">= </span><span class="s4">function </span><span class="s2">deleteOne</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l2974"><span class="ln">2974 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">filter </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">|| </span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">|| </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l2975"><span class="ln">2975 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.deleteOne() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l2976"><span class="ln">2976 </span></a>  <span class="s1">}</span>
<a name="l2977"><span class="ln">2977 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'deleteOne'</span><span class="s1">;</span>
<a name="l2978"><span class="ln">2978 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l2979"><span class="ln">2979 </span></a>
<a name="l2980"><span class="ln">2980 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">)) {</span>
<a name="l2981"><span class="ln">2981 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">);</span>
<a name="l2982"><span class="ln">2982 </span></a>
<a name="l2983"><span class="ln">2983 </span></a>    <span class="s2">prepareDiscriminatorCriteria</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l2984"><span class="ln">2984 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">filter </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l2985"><span class="ln">2985 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s0">'deleteOne'</span><span class="s1">));</span>
<a name="l2986"><span class="ln">2986 </span></a>  <span class="s1">}</span>
<a name="l2987"><span class="ln">2987 </span></a>
<a name="l2988"><span class="ln">2988 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l2989"><span class="ln">2989 </span></a><span class="s1">};</span>
<a name="l2990"><span class="ln">2990 </span></a>
<a name="l2991"><span class="ln">2991 </span></a><span class="s5">/**</span>
<a name="l2992"><span class="ln">2992 </span></a> <span class="s5">* Internal thunk for `deleteOne()`</span>
<a name="l2993"><span class="ln">2993 </span></a> <span class="s5">*</span>
<a name="l2994"><span class="ln">2994 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_deleteOne</span>
<a name="l2995"><span class="ln">2995 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l2996"><span class="ln">2996 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l2997"><span class="ln">2997 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l2998"><span class="ln">2998 </span></a> <span class="s5">*/</span>
<a name="l2999"><span class="ln">2999 </span></a>
<a name="l3000"><span class="ln">3000 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_deleteOne </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_deleteOne</span><span class="s1">() {</span>
<a name="l3001"><span class="ln">3001 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l3002"><span class="ln">3002 </span></a>
<a name="l3003"><span class="ln">3003 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">() != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3004"><span class="ln">3004 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l3005"><span class="ln">3005 </span></a>  <span class="s1">}</span>
<a name="l3006"><span class="ln">3006 </span></a>
<a name="l3007"><span class="ln">3007 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l3008"><span class="ln">3008 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3009"><span class="ln">3009 </span></a>
<a name="l3010"><span class="ln">3010 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">deleteOne</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l3011"><span class="ln">3011 </span></a><span class="s1">};</span>
<a name="l3012"><span class="ln">3012 </span></a>
<a name="l3013"><span class="ln">3013 </span></a><span class="s5">/**</span>
<a name="l3014"><span class="ln">3014 </span></a> <span class="s5">* Declare and/or execute this query as a `deleteMany()` operation. Works like</span>
<a name="l3015"><span class="ln">3015 </span></a> <span class="s5">* remove, except it deletes _every_ document that matches `filter` in the</span>
<a name="l3016"><span class="ln">3016 </span></a> <span class="s5">* collection, regardless of the value of `single`.</span>
<a name="l3017"><span class="ln">3017 </span></a> <span class="s5">*</span>
<a name="l3018"><span class="ln">3018 </span></a> <span class="s5">* This function triggers `deleteMany` middleware.</span>
<a name="l3019"><span class="ln">3019 </span></a> <span class="s5">*</span>
<a name="l3020"><span class="ln">3020 </span></a> <span class="s5">* #### Example:</span>
<a name="l3021"><span class="ln">3021 </span></a> <span class="s5">*</span>
<a name="l3022"><span class="ln">3022 </span></a> <span class="s5">*     await Character.deleteMany({ name: /Stark/, age: { $gte: 18 } });</span>
<a name="l3023"><span class="ln">3023 </span></a> <span class="s5">*</span>
<a name="l3024"><span class="ln">3024 </span></a> <span class="s5">* This function calls the MongoDB driver's [`Collection#deleteMany()` function](https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#deleteMany).</span>
<a name="l3025"><span class="ln">3025 </span></a> <span class="s5">* The returned [promise](https://mongoosejs.com/docs/queries.html) resolves to an</span>
<a name="l3026"><span class="ln">3026 </span></a> <span class="s5">* object that contains 3 properties:</span>
<a name="l3027"><span class="ln">3027 </span></a> <span class="s5">*</span>
<a name="l3028"><span class="ln">3028 </span></a> <span class="s5">* - `ok`: `1` if no errors occurred</span>
<a name="l3029"><span class="ln">3029 </span></a> <span class="s5">* - `deletedCount`: the number of documents deleted</span>
<a name="l3030"><span class="ln">3030 </span></a> <span class="s5">* - `n`: the number of documents deleted. Equal to `deletedCount`.</span>
<a name="l3031"><span class="ln">3031 </span></a> <span class="s5">*</span>
<a name="l3032"><span class="ln">3032 </span></a> <span class="s5">* #### Example:</span>
<a name="l3033"><span class="ln">3033 </span></a> <span class="s5">*</span>
<a name="l3034"><span class="ln">3034 </span></a> <span class="s5">*     const res = await Character.deleteMany({ name: /Stark/, age: { $gte: 18 } });</span>
<a name="l3035"><span class="ln">3035 </span></a> <span class="s5">*     // `0` if no docs matched the filter, number of docs deleted otherwise</span>
<a name="l3036"><span class="ln">3036 </span></a> <span class="s5">*     res.deletedCount;</span>
<a name="l3037"><span class="ln">3037 </span></a> <span class="s5">*</span>
<a name="l3038"><span class="ln">3038 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Query} [filter] mongodb selector</span>
<a name="l3039"><span class="ln">3039 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options] optional see [`Query.prototype.setOptions()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.setOptions())</span>
<a name="l3040"><span class="ln">3040 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3041"><span class="ln">3041 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">DeleteResult https://mongodb.github.io/node-mongodb-native/4.9/interfaces/DeleteResult.html</span>
<a name="l3042"><span class="ln">3042 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">deleteMany https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#deleteMany</span>
<a name="l3043"><span class="ln">3043 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l3044"><span class="ln">3044 </span></a> <span class="s5">*/</span>
<a name="l3045"><span class="ln">3045 </span></a>
<a name="l3046"><span class="ln">3046 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">deleteMany </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3047"><span class="ln">3047 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">filter </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">|| </span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">|| </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3048"><span class="ln">3048 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.deleteMany() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l3049"><span class="ln">3049 </span></a>  <span class="s1">}</span>
<a name="l3050"><span class="ln">3050 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3051"><span class="ln">3051 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'deleteMany'</span><span class="s1">;</span>
<a name="l3052"><span class="ln">3052 </span></a>
<a name="l3053"><span class="ln">3053 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">)) {</span>
<a name="l3054"><span class="ln">3054 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">);</span>
<a name="l3055"><span class="ln">3055 </span></a>
<a name="l3056"><span class="ln">3056 </span></a>    <span class="s2">prepareDiscriminatorCriteria</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l3057"><span class="ln">3057 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">filter </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3058"><span class="ln">3058 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s0">'deleteMany'</span><span class="s1">));</span>
<a name="l3059"><span class="ln">3059 </span></a>  <span class="s1">}</span>
<a name="l3060"><span class="ln">3060 </span></a>
<a name="l3061"><span class="ln">3061 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l3062"><span class="ln">3062 </span></a><span class="s1">};</span>
<a name="l3063"><span class="ln">3063 </span></a>
<a name="l3064"><span class="ln">3064 </span></a><span class="s5">/**</span>
<a name="l3065"><span class="ln">3065 </span></a> <span class="s5">* Execute a `deleteMany()` query</span>
<a name="l3066"><span class="ln">3066 </span></a> <span class="s5">*</span>
<a name="l3067"><span class="ln">3067 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} callback</span>
<a name="l3068"><span class="ln">3068 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_deleteMany</span>
<a name="l3069"><span class="ln">3069 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3070"><span class="ln">3070 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3071"><span class="ln">3071 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3072"><span class="ln">3072 </span></a> <span class="s5">*/</span>
<a name="l3073"><span class="ln">3073 </span></a>
<a name="l3074"><span class="ln">3074 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_deleteMany </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_deleteMany</span><span class="s1">() {</span>
<a name="l3075"><span class="ln">3075 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l3076"><span class="ln">3076 </span></a>
<a name="l3077"><span class="ln">3077 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">() != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3078"><span class="ln">3078 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l3079"><span class="ln">3079 </span></a>  <span class="s1">}</span>
<a name="l3080"><span class="ln">3080 </span></a>
<a name="l3081"><span class="ln">3081 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l3082"><span class="ln">3082 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3083"><span class="ln">3083 </span></a>
<a name="l3084"><span class="ln">3084 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">deleteMany</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l3085"><span class="ln">3085 </span></a><span class="s1">};</span>
<a name="l3086"><span class="ln">3086 </span></a>
<a name="l3087"><span class="ln">3087 </span></a><span class="s5">/**</span>
<a name="l3088"><span class="ln">3088 </span></a> <span class="s5">* hydrates a document</span>
<a name="l3089"><span class="ln">3089 </span></a> <span class="s5">*</span>
<a name="l3090"><span class="ln">3090 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Model} model</span>
<a name="l3091"><span class="ln">3091 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Document} doc</span>
<a name="l3092"><span class="ln">3092 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} res 3rd parameter to callback</span>
<a name="l3093"><span class="ln">3093 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} fields</span>
<a name="l3094"><span class="ln">3094 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Query} self</span>
<a name="l3095"><span class="ln">3095 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array} [pop] array of paths used in population</span>
<a name="l3096"><span class="ln">3096 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} callback</span>
<a name="l3097"><span class="ln">3097 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3098"><span class="ln">3098 </span></a> <span class="s5">*/</span>
<a name="l3099"><span class="ln">3099 </span></a>
<a name="l3100"><span class="ln">3100 </span></a><span class="s4">function </span><span class="s2">completeOne</span><span class="s1">(</span><span class="s2">model</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">fields</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l3101"><span class="ln">3101 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata </span><span class="s1">&amp;&amp; </span><span class="s2">doc </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3102"><span class="ln">3102 </span></a>    <span class="s2">_init</span><span class="s1">(</span><span class="s4">null</span><span class="s1">);</span>
<a name="l3103"><span class="ln">3103 </span></a>    <span class="s4">return null</span><span class="s1">;</span>
<a name="l3104"><span class="ln">3104 </span></a>  <span class="s1">}</span>
<a name="l3105"><span class="ln">3105 </span></a>
<a name="l3106"><span class="ln">3106 </span></a>  <span class="s2">helpers</span><span class="s1">.</span><span class="s2">createModelAndInit</span><span class="s1">(</span><span class="s2">model</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">fields</span><span class="s1">, </span><span class="s2">userProvidedFields</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">, </span><span class="s2">_init</span><span class="s1">);</span>
<a name="l3107"><span class="ln">3107 </span></a>
<a name="l3108"><span class="ln">3108 </span></a>  <span class="s4">function </span><span class="s2">_init</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">casted</span><span class="s1">) {</span>
<a name="l3109"><span class="ln">3109 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l3110"><span class="ln">3110 </span></a>      <span class="s4">return </span><span class="s2">immediate</span><span class="s1">(() =&gt; </span><span class="s2">callback</span><span class="s1">(</span><span class="s2">err</span><span class="s1">));</span>
<a name="l3111"><span class="ln">3111 </span></a>    <span class="s1">}</span>
<a name="l3112"><span class="ln">3112 </span></a>
<a name="l3113"><span class="ln">3113 </span></a>
<a name="l3114"><span class="ln">3114 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata</span><span class="s1">) {</span>
<a name="l3115"><span class="ln">3115 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">doc </span><span class="s1">&amp;&amp; </span><span class="s2">casted</span><span class="s1">) {</span>
<a name="l3116"><span class="ln">3116 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">session </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3117"><span class="ln">3117 </span></a>          <span class="s2">casted</span><span class="s1">.</span><span class="s2">$session</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">session</span><span class="s1">);</span>
<a name="l3118"><span class="ln">3118 </span></a>        <span class="s1">}</span>
<a name="l3119"><span class="ln">3119 </span></a>        <span class="s2">res</span><span class="s1">.</span><span class="s2">value </span><span class="s1">= </span><span class="s2">casted</span><span class="s1">;</span>
<a name="l3120"><span class="ln">3120 </span></a>      <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3121"><span class="ln">3121 </span></a>        <span class="s2">res</span><span class="s1">.</span><span class="s2">value </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l3122"><span class="ln">3122 </span></a>      <span class="s1">}</span>
<a name="l3123"><span class="ln">3123 </span></a>      <span class="s4">return </span><span class="s2">immediate</span><span class="s1">(() =&gt; </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">res</span><span class="s1">));</span>
<a name="l3124"><span class="ln">3124 </span></a>    <span class="s1">}</span>
<a name="l3125"><span class="ln">3125 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">session </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3126"><span class="ln">3126 </span></a>      <span class="s2">casted</span><span class="s1">.</span><span class="s2">$session</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">session</span><span class="s1">);</span>
<a name="l3127"><span class="ln">3127 </span></a>    <span class="s1">}</span>
<a name="l3128"><span class="ln">3128 </span></a>    <span class="s2">immediate</span><span class="s1">(() =&gt; </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">casted</span><span class="s1">));</span>
<a name="l3129"><span class="ln">3129 </span></a>  <span class="s1">}</span>
<a name="l3130"><span class="ln">3130 </span></a><span class="s1">}</span>
<a name="l3131"><span class="ln">3131 </span></a>
<a name="l3132"><span class="ln">3132 </span></a><span class="s5">/**</span>
<a name="l3133"><span class="ln">3133 </span></a> <span class="s5">* If the model is a discriminator type and not root, then add the key &amp; value to the criteria.</span>
<a name="l3134"><span class="ln">3134 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Query} query</span>
<a name="l3135"><span class="ln">3135 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3136"><span class="ln">3136 </span></a> <span class="s5">*/</span>
<a name="l3137"><span class="ln">3137 </span></a>
<a name="l3138"><span class="ln">3138 </span></a><span class="s4">function </span><span class="s2">prepareDiscriminatorCriteria</span><span class="s1">(</span><span class="s2">query</span><span class="s1">) {</span>
<a name="l3139"><span class="ln">3139 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">query </span><span class="s1">|| !</span><span class="s2">query</span><span class="s1">.</span><span class="s2">model </span><span class="s1">|| !</span><span class="s2">query</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">) {</span>
<a name="l3140"><span class="ln">3140 </span></a>    <span class="s4">return</span><span class="s1">;</span>
<a name="l3141"><span class="ln">3141 </span></a>  <span class="s1">}</span>
<a name="l3142"><span class="ln">3142 </span></a>
<a name="l3143"><span class="ln">3143 </span></a>  <span class="s4">const </span><span class="s2">schema </span><span class="s1">= </span><span class="s2">query</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">;</span>
<a name="l3144"><span class="ln">3144 </span></a>
<a name="l3145"><span class="ln">3145 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">schema </span><span class="s1">&amp;&amp; </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">discriminatorMapping </span><span class="s1">&amp;&amp; !</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">discriminatorMapping</span><span class="s1">.</span><span class="s2">isRoot</span><span class="s1">) {</span>
<a name="l3146"><span class="ln">3146 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">[</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">discriminatorMapping</span><span class="s1">.</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">discriminatorMapping</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
<a name="l3147"><span class="ln">3147 </span></a>  <span class="s1">}</span>
<a name="l3148"><span class="ln">3148 </span></a><span class="s1">}</span>
<a name="l3149"><span class="ln">3149 </span></a>
<a name="l3150"><span class="ln">3150 </span></a><span class="s5">/**</span>
<a name="l3151"><span class="ln">3151 </span></a> <span class="s5">* Issues a mongodb `findOneAndUpdate()` command.</span>
<a name="l3152"><span class="ln">3152 </span></a> <span class="s5">*</span>
<a name="l3153"><span class="ln">3153 </span></a> <span class="s5">* Finds a matching document, updates it according to the `update` arg, passing any `options`, and returns the found</span>
<a name="l3154"><span class="ln">3154 </span></a> <span class="s5">* document (if any).</span>
<a name="l3155"><span class="ln">3155 </span></a> <span class="s5">*</span>
<a name="l3156"><span class="ln">3156 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l3157"><span class="ln">3157 </span></a> <span class="s5">*</span>
<a name="l3158"><span class="ln">3158 </span></a> <span class="s5">* - `findOneAndUpdate()`</span>
<a name="l3159"><span class="ln">3159 </span></a> <span class="s5">*</span>
<a name="l3160"><span class="ln">3160 </span></a> <span class="s5">* #### Available options</span>
<a name="l3161"><span class="ln">3161 </span></a> <span class="s5">*</span>
<a name="l3162"><span class="ln">3162 </span></a> <span class="s5">* - `new`: bool - if true, return the modified document rather than the original. defaults to false (changed in 4.0)</span>
<a name="l3163"><span class="ln">3163 </span></a> <span class="s5">* - `upsert`: bool - creates the object if it doesn't exist. defaults to false.</span>
<a name="l3164"><span class="ln">3164 </span></a> <span class="s5">* - `fields`: {Object|String} - Field selection. Equivalent to `.select(fields).findOneAndUpdate()`</span>
<a name="l3165"><span class="ln">3165 </span></a> <span class="s5">* - `sort`: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</span>
<a name="l3166"><span class="ln">3166 </span></a> <span class="s5">* - `maxTimeMS`: puts a time limit on the query - requires mongodb &gt;= 2.6.0</span>
<a name="l3167"><span class="ln">3167 </span></a> <span class="s5">* - `runValidators`: if true, runs [update validators](https://mongoosejs.com/docs/validation.html#update-validators) on this command. Update validators validate the update operation against the model's schema.</span>
<a name="l3168"><span class="ln">3168 </span></a> <span class="s5">* - `setDefaultsOnInsert`: `true` by default. If `setDefaultsOnInsert` and `upsert` are true, mongoose will apply the [defaults](https://mongoosejs.com/docs/defaults.html) specified in the model's schema if a new document is created.</span>
<a name="l3169"><span class="ln">3169 </span></a> <span class="s5">*</span>
<a name="l3170"><span class="ln">3170 </span></a> <span class="s5">* #### Example:</span>
<a name="l3171"><span class="ln">3171 </span></a> <span class="s5">*</span>
<a name="l3172"><span class="ln">3172 </span></a> <span class="s5">*     query.findOneAndUpdate(conditions, update, options)  // returns Query</span>
<a name="l3173"><span class="ln">3173 </span></a> <span class="s5">*     query.findOneAndUpdate(conditions, update)           // returns Query</span>
<a name="l3174"><span class="ln">3174 </span></a> <span class="s5">*     query.findOneAndUpdate(update)                       // returns Query</span>
<a name="l3175"><span class="ln">3175 </span></a> <span class="s5">*     query.findOneAndUpdate()                             // returns Query</span>
<a name="l3176"><span class="ln">3176 </span></a> <span class="s5">*</span>
<a name="l3177"><span class="ln">3177 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">findOneAndUpdate</span>
<a name="l3178"><span class="ln">3178 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3179"><span class="ln">3179 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3180"><span class="ln">3180 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Query} [filter]</span>
<a name="l3181"><span class="ln">3181 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [doc]</span>
<a name="l3182"><span class="ln">3182 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l3183"><span class="ln">3183 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.includeResultMetadata] if true, returns the full [ModifyResult from the MongoDB driver](https://mongodb.github.io/node-mongodb-native/4.9/interfaces/ModifyResult.html) rather than just the document</span>
<a name="l3184"><span class="ln">3184 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l3185"><span class="ln">3185 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{ClientSession} [options.session=null] The session associated with this query. See [transactions docs](https://mongoosejs.com/docs/transactions.html).</span>
<a name="l3186"><span class="ln">3186 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.multipleCastError] by default, mongoose only returns the first error that occurred in casting the query. Turn on this option to aggregate all the cast errors.</span>
<a name="l3187"><span class="ln">3187 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.new=false] By default, `findOneAndUpdate()` returns the document as it was **before** `update` was applied. If you set `new: true`, `findOneAndUpdate()` will instead give you the object after `update` was applied.</span>
<a name="l3188"><span class="ln">3188 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options.lean] if truthy, mongoose will return the document as a plain JavaScript object rather than a mongoose document. See [`Query.lean()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.lean()) and [the Mongoose lean tutorial](https://mongoosejs.com/docs/tutorials/lean.html).</span>
<a name="l3189"><span class="ln">3189 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{ClientSession} [options.session=null] The session associated with this query. See [transactions docs](https://mongoosejs.com/docs/transactions.html).</span>
<a name="l3190"><span class="ln">3190 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l3191"><span class="ln">3191 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.timestamps=null] If set to `false` and [schema-level timestamps](https://mongoosejs.com/docs/guide.html#timestamps) are enabled, skip timestamps for this update. Note that this allows you to overwrite timestamps. Does nothing if schema-level timestamps are not set.</span>
<a name="l3192"><span class="ln">3192 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.returnOriginal=null] An alias for the `new` option. `returnOriginal: false` is equivalent to `new: true`.</span>
<a name="l3193"><span class="ln">3193 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.translateAliases=null] If set to `true`, translates any schema-defined aliases in `filter`, `projection`, `update`, and `distinct`. Throws an error if there are any conflicts where both alias and raw property are defined on the same object.</span>
<a name="l3194"><span class="ln">3194 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.overwriteDiscriminatorKey=false] Mongoose removes discriminator key updates from `update` by default, set `overwriteDiscriminatorKey` to `true` to allow updating the discriminator key</span>
<a name="l3195"><span class="ln">3195 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Tutorial https://mongoosejs.com/docs/tutorials/findoneandupdate.html</span>
<a name="l3196"><span class="ln">3196 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">findAndModify command https://www.mongodb.com/docs/manual/reference/command/findAndModify/</span>
<a name="l3197"><span class="ln">3197 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">ModifyResult https://mongodb.github.io/node-mongodb-native/4.9/interfaces/ModifyResult.html</span>
<a name="l3198"><span class="ln">3198 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">findOneAndUpdate https://mongodb.github.io/node-mongodb-native/4.9/classes/Collection.html#findOneAndUpdate</span>
<a name="l3199"><span class="ln">3199 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3200"><span class="ln">3200 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l3201"><span class="ln">3201 </span></a> <span class="s5">*/</span>
<a name="l3202"><span class="ln">3202 </span></a>
<a name="l3203"><span class="ln">3203 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">findOneAndUpdate </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3204"><span class="ln">3204 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">filter </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3205"><span class="ln">3205 </span></a>      <span class="s4">typeof </span><span class="s2">doc </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3206"><span class="ln">3206 </span></a>      <span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3207"><span class="ln">3207 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3208"><span class="ln">3208 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.findOneAndUpdate() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l3209"><span class="ln">3209 </span></a>  <span class="s1">}</span>
<a name="l3210"><span class="ln">3210 </span></a>
<a name="l3211"><span class="ln">3211 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'findOneAndUpdate'</span><span class="s1">;</span>
<a name="l3212"><span class="ln">3212 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l3213"><span class="ln">3213 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validate</span><span class="s1">();</span>
<a name="l3214"><span class="ln">3214 </span></a>
<a name="l3215"><span class="ln">3215 </span></a>  <span class="s4">switch </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
<a name="l3216"><span class="ln">3216 </span></a>    <span class="s4">case </span><span class="s7">2</span><span class="s1">:</span>
<a name="l3217"><span class="ln">3217 </span></a>      <span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3218"><span class="ln">3218 </span></a>      <span class="s4">break</span><span class="s1">;</span>
<a name="l3219"><span class="ln">3219 </span></a>    <span class="s4">case </span><span class="s7">1</span><span class="s1">:</span>
<a name="l3220"><span class="ln">3220 </span></a>      <span class="s2">doc </span><span class="s1">= </span><span class="s2">filter</span><span class="s1">;</span>
<a name="l3221"><span class="ln">3221 </span></a>      <span class="s2">filter </span><span class="s1">= </span><span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3222"><span class="ln">3222 </span></a>      <span class="s4">break</span><span class="s1">;</span>
<a name="l3223"><span class="ln">3223 </span></a>  <span class="s1">}</span>
<a name="l3224"><span class="ln">3224 </span></a>
<a name="l3225"><span class="ln">3225 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">)) {</span>
<a name="l3226"><span class="ln">3226 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">);</span>
<a name="l3227"><span class="ln">3227 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">filter </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3228"><span class="ln">3228 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span>
<a name="l3229"><span class="ln">3229 </span></a>      <span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s0">'findOneAndUpdate'</span><span class="s1">)</span>
<a name="l3230"><span class="ln">3230 </span></a>    <span class="s1">);</span>
<a name="l3231"><span class="ln">3231 </span></a>  <span class="s1">}</span>
<a name="l3232"><span class="ln">3232 </span></a>
<a name="l3233"><span class="ln">3233 </span></a>  <span class="s3">// apply doc</span>
<a name="l3234"><span class="ln">3234 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">doc</span><span class="s1">) {</span>
<a name="l3235"><span class="ln">3235 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mergeUpdate</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3236"><span class="ln">3236 </span></a>  <span class="s1">}</span>
<a name="l3237"><span class="ln">3237 </span></a>
<a name="l3238"><span class="ln">3238 </span></a>  <span class="s2">options </span><span class="s1">= </span><span class="s2">options </span><span class="s1">? </span><span class="s2">clone</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) : {};</span>
<a name="l3239"><span class="ln">3239 </span></a>
<a name="l3240"><span class="ln">3240 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">projection</span><span class="s1">) {</span>
<a name="l3241"><span class="ln">3241 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">select</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">projection</span><span class="s1">);</span>
<a name="l3242"><span class="ln">3242 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">projection</span><span class="s1">;</span>
<a name="l3243"><span class="ln">3243 </span></a>  <span class="s1">}</span>
<a name="l3244"><span class="ln">3244 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">fields</span><span class="s1">) {</span>
<a name="l3245"><span class="ln">3245 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">select</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">fields</span><span class="s1">);</span>
<a name="l3246"><span class="ln">3246 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">fields</span><span class="s1">;</span>
<a name="l3247"><span class="ln">3247 </span></a>  <span class="s1">}</span>
<a name="l3248"><span class="ln">3248 </span></a>
<a name="l3249"><span class="ln">3249 </span></a>  <span class="s4">const </span><span class="s2">returnOriginal </span><span class="s1">= </span><span class="s4">this </span><span class="s1">&amp;&amp;</span>
<a name="l3250"><span class="ln">3250 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">&amp;&amp;</span>
<a name="l3251"><span class="ln">3251 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base </span><span class="s1">&amp;&amp;</span>
<a name="l3252"><span class="ln">3252 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp;</span>
<a name="l3253"><span class="ln">3253 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnOriginal</span><span class="s1">;</span>
<a name="l3254"><span class="ln">3254 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">new </span><span class="s1">== </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnDocument </span><span class="s1">== </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnOriginal </span><span class="s1">== </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">returnOriginal </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3255"><span class="ln">3255 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">returnOriginal </span><span class="s1">= </span><span class="s2">returnOriginal</span><span class="s1">;</span>
<a name="l3256"><span class="ln">3256 </span></a>  <span class="s1">}</span>
<a name="l3257"><span class="ln">3257 </span></a>
<a name="l3258"><span class="ln">3258 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3259"><span class="ln">3259 </span></a>
<a name="l3260"><span class="ln">3260 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l3261"><span class="ln">3261 </span></a><span class="s1">};</span>
<a name="l3262"><span class="ln">3262 </span></a>
<a name="l3263"><span class="ln">3263 </span></a><span class="s5">/**</span>
<a name="l3264"><span class="ln">3264 </span></a> <span class="s5">* Execute a findOneAndUpdate operation</span>
<a name="l3265"><span class="ln">3265 </span></a> <span class="s5">*</span>
<a name="l3266"><span class="ln">3266 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_findOneAndUpdate</span>
<a name="l3267"><span class="ln">3267 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3268"><span class="ln">3268 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3269"><span class="ln">3269 </span></a> <span class="s5">*/</span>
<a name="l3270"><span class="ln">3270 </span></a>
<a name="l3271"><span class="ln">3271 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_findOneAndUpdate </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_findOneAndUpdate</span><span class="s1">() {</span>
<a name="l3272"><span class="ln">3272 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l3273"><span class="ln">3273 </span></a>
<a name="l3274"><span class="ln">3274 </span></a>  <span class="s2">_castArrayFilters</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l3275"><span class="ln">3275 </span></a>
<a name="l3276"><span class="ln">3276 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">()) {</span>
<a name="l3277"><span class="ln">3277 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l3278"><span class="ln">3278 </span></a>  <span class="s1">}</span>
<a name="l3279"><span class="ln">3279 </span></a>
<a name="l3280"><span class="ln">3280 </span></a>  <span class="s2">applyGlobalMaxTimeMS</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3281"><span class="ln">3281 </span></a>  <span class="s2">applyGlobalDiskUse</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">db</span><span class="s1">.</span><span class="s2">options</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3282"><span class="ln">3282 </span></a>
<a name="l3283"><span class="ln">3283 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'strict' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3284"><span class="ln">3284 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">strict </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">strict</span><span class="s1">;</span>
<a name="l3285"><span class="ln">3285 </span></a>  <span class="s1">}</span>
<a name="l3286"><span class="ln">3286 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">);</span>
<a name="l3287"><span class="ln">3287 </span></a>  <span class="s2">convertNewToReturnDocument</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3288"><span class="ln">3288 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3289"><span class="ln">3289 </span></a>
<a name="l3290"><span class="ln">3290 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_castUpdate</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">);</span>
<a name="l3291"><span class="ln">3291 </span></a>
<a name="l3292"><span class="ln">3292 </span></a>  <span class="s4">const </span><span class="s2">_opts </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">options</span><span class="s1">, {</span>
<a name="l3293"><span class="ln">3293 </span></a>    <span class="s2">setDefaultsOnInsert</span><span class="s1">: </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">setDefaultsOnInsert</span>
<a name="l3294"><span class="ln">3294 </span></a>  <span class="s1">});</span>
<a name="l3295"><span class="ln">3295 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">setDefaultsOnInsert</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">,</span>
<a name="l3296"><span class="ln">3296 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">_opts</span><span class="s1">);</span>
<a name="l3297"><span class="ln">3297 </span></a>
<a name="l3298"><span class="ln">3298 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">|| </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">).</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l3299"><span class="ln">3299 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">upsert</span><span class="s1">) {</span>
<a name="l3300"><span class="ln">3300 </span></a>      <span class="s3">// still need to do the upsert to empty doc</span>
<a name="l3301"><span class="ln">3301 </span></a>      <span class="s4">const </span><span class="s2">doc </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">);</span>
<a name="l3302"><span class="ln">3302 </span></a>      <span class="s4">delete </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">_id</span><span class="s1">;</span>
<a name="l3303"><span class="ln">3303 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= { </span><span class="s2">$set</span><span class="s1">: </span><span class="s2">doc </span><span class="s1">};</span>
<a name="l3304"><span class="ln">3304 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3305"><span class="ln">3305 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_executionStack </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l3306"><span class="ln">3306 </span></a>      <span class="s4">const </span><span class="s2">res </span><span class="s1">= </span><span class="s4">await this</span><span class="s1">.</span><span class="s2">_findOne</span><span class="s1">();</span>
<a name="l3307"><span class="ln">3307 </span></a>      <span class="s4">return </span><span class="s2">res</span><span class="s1">;</span>
<a name="l3308"><span class="ln">3308 </span></a>    <span class="s1">}</span>
<a name="l3309"><span class="ln">3309 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s4">instanceof </span><span class="s2">Error</span><span class="s1">) {</span>
<a name="l3310"><span class="ln">3310 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">;</span>
<a name="l3311"><span class="ln">3311 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3312"><span class="ln">3312 </span></a>    <span class="s3">// In order to make MongoDB 2.6 happy (see</span>
<a name="l3313"><span class="ln">3313 </span></a>    <span class="s3">// https://jira.mongodb.org/browse/SERVER-12266 and related issues)</span>
<a name="l3314"><span class="ln">3314 </span></a>    <span class="s3">// if we have an actual update document but $set is empty, junk the $set.</span>
<a name="l3315"><span class="ln">3315 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">$set </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">).</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l3316"><span class="ln">3316 </span></a>      <span class="s4">delete this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">$set</span><span class="s1">;</span>
<a name="l3317"><span class="ln">3317 </span></a>    <span class="s1">}</span>
<a name="l3318"><span class="ln">3318 </span></a>  <span class="s1">}</span>
<a name="l3319"><span class="ln">3319 </span></a>
<a name="l3320"><span class="ln">3320 </span></a>  <span class="s4">const </span><span class="s2">runValidators </span><span class="s1">= </span><span class="s2">_getOption</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'runValidators'</span><span class="s1">, </span><span class="s4">false</span><span class="s1">);</span>
<a name="l3321"><span class="ln">3321 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">runValidators</span><span class="s1">) {</span>
<a name="l3322"><span class="ln">3322 </span></a>    <span class="s4">await this</span><span class="s1">.</span><span class="s2">validate</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s4">false</span><span class="s1">);</span>
<a name="l3323"><span class="ln">3323 </span></a>  <span class="s1">}</span>
<a name="l3324"><span class="ln">3324 </span></a>
<a name="l3325"><span class="ln">3325 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">toBSON</span><span class="s1">) {</span>
<a name="l3326"><span class="ln">3326 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">toBSON</span><span class="s1">();</span>
<a name="l3327"><span class="ln">3327 </span></a>  <span class="s1">}</span>
<a name="l3328"><span class="ln">3328 </span></a>
<a name="l3329"><span class="ln">3329 </span></a>  <span class="s4">let </span><span class="s2">res </span><span class="s1">= </span><span class="s4">await this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">findOneAndUpdate</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l3330"><span class="ln">3330 </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">fn of </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_transforms</span><span class="s1">) {</span>
<a name="l3331"><span class="ln">3331 </span></a>    <span class="s2">res </span><span class="s1">= </span><span class="s2">fn</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l3332"><span class="ln">3332 </span></a>  <span class="s1">}</span>
<a name="l3333"><span class="ln">3333 </span></a>  <span class="s4">const </span><span class="s2">doc </span><span class="s1">= !</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata </span><span class="s1">? </span><span class="s2">res </span><span class="s1">: </span><span class="s2">res</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
<a name="l3334"><span class="ln">3334 </span></a>
<a name="l3335"><span class="ln">3335 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l3336"><span class="ln">3336 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_completeOne</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, (</span><span class="s2">err</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
<a name="l3337"><span class="ln">3337 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l3338"><span class="ln">3338 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l3339"><span class="ln">3339 </span></a>      <span class="s1">}</span>
<a name="l3340"><span class="ln">3340 </span></a>      <span class="s2">resolve</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l3341"><span class="ln">3341 </span></a>    <span class="s1">});</span>
<a name="l3342"><span class="ln">3342 </span></a>  <span class="s1">});</span>
<a name="l3343"><span class="ln">3343 </span></a><span class="s1">};</span>
<a name="l3344"><span class="ln">3344 </span></a>
<a name="l3345"><span class="ln">3345 </span></a><span class="s5">/**</span>
<a name="l3346"><span class="ln">3346 </span></a> <span class="s5">* Issues a MongoDB [findOneAndDelete](https://www.mongodb.com/docs/manual/reference/method/db.collection.findOneAndDelete/) command.</span>
<a name="l3347"><span class="ln">3347 </span></a> <span class="s5">*</span>
<a name="l3348"><span class="ln">3348 </span></a> <span class="s5">* Finds a matching document, removes it, and returns the found document (if any).</span>
<a name="l3349"><span class="ln">3349 </span></a> <span class="s5">*</span>
<a name="l3350"><span class="ln">3350 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l3351"><span class="ln">3351 </span></a> <span class="s5">*</span>
<a name="l3352"><span class="ln">3352 </span></a> <span class="s5">* - `findOneAndDelete()`</span>
<a name="l3353"><span class="ln">3353 </span></a> <span class="s5">*</span>
<a name="l3354"><span class="ln">3354 </span></a> <span class="s5">* #### Available options</span>
<a name="l3355"><span class="ln">3355 </span></a> <span class="s5">*</span>
<a name="l3356"><span class="ln">3356 </span></a> <span class="s5">* - `sort`: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</span>
<a name="l3357"><span class="ln">3357 </span></a> <span class="s5">* - `maxTimeMS`: puts a time limit on the query - requires mongodb &gt;= 2.6.0</span>
<a name="l3358"><span class="ln">3358 </span></a> <span class="s5">*</span>
<a name="l3359"><span class="ln">3359 </span></a> <span class="s5">* #### Callback Signature</span>
<a name="l3360"><span class="ln">3360 </span></a> <span class="s5">*</span>
<a name="l3361"><span class="ln">3361 </span></a> <span class="s5">*     function(error, doc) {</span>
<a name="l3362"><span class="ln">3362 </span></a> <span class="s5">*       // error: any errors that occurred</span>
<a name="l3363"><span class="ln">3363 </span></a> <span class="s5">*       // doc: the document before updates are applied if `new: false`, or after updates if `new = true`</span>
<a name="l3364"><span class="ln">3364 </span></a> <span class="s5">*     }</span>
<a name="l3365"><span class="ln">3365 </span></a> <span class="s5">*</span>
<a name="l3366"><span class="ln">3366 </span></a> <span class="s5">* #### Example:</span>
<a name="l3367"><span class="ln">3367 </span></a> <span class="s5">*</span>
<a name="l3368"><span class="ln">3368 </span></a> <span class="s5">*     A.where().findOneAndDelete(conditions, options)  // return Query</span>
<a name="l3369"><span class="ln">3369 </span></a> <span class="s5">*     A.where().findOneAndDelete(conditions) // returns Query</span>
<a name="l3370"><span class="ln">3370 </span></a> <span class="s5">*     A.where().findOneAndDelete()           // returns Query</span>
<a name="l3371"><span class="ln">3371 </span></a> <span class="s5">*</span>
<a name="l3372"><span class="ln">3372 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">findOneAndDelete</span>
<a name="l3373"><span class="ln">3373 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3374"><span class="ln">3374 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [filter]</span>
<a name="l3375"><span class="ln">3375 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l3376"><span class="ln">3376 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.includeResultMetadata] if true, returns the full [ModifyResult from the MongoDB driver](https://mongodb.github.io/node-mongodb-native/4.9/interfaces/ModifyResult.html) rather than just the document</span>
<a name="l3377"><span class="ln">3377 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{ClientSession} [options.session=null] The session associated with this query. See [transactions docs](https://mongoosejs.com/docs/transactions.html).</span>
<a name="l3378"><span class="ln">3378 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l3379"><span class="ln">3379 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3380"><span class="ln">3380 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">findAndModify command https://www.mongodb.com/docs/manual/reference/command/findAndModify/</span>
<a name="l3381"><span class="ln">3381 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l3382"><span class="ln">3382 </span></a> <span class="s5">*/</span>
<a name="l3383"><span class="ln">3383 </span></a>
<a name="l3384"><span class="ln">3384 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">findOneAndDelete </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3385"><span class="ln">3385 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">filter </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3386"><span class="ln">3386 </span></a>      <span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3387"><span class="ln">3387 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3388"><span class="ln">3388 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.findOneAndDelete() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l3389"><span class="ln">3389 </span></a>  <span class="s1">}</span>
<a name="l3390"><span class="ln">3390 </span></a>
<a name="l3391"><span class="ln">3391 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'findOneAndDelete'</span><span class="s1">;</span>
<a name="l3392"><span class="ln">3392 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l3393"><span class="ln">3393 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validate</span><span class="s1">();</span>
<a name="l3394"><span class="ln">3394 </span></a>
<a name="l3395"><span class="ln">3395 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">)) {</span>
<a name="l3396"><span class="ln">3396 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">);</span>
<a name="l3397"><span class="ln">3397 </span></a>  <span class="s1">}</span>
<a name="l3398"><span class="ln">3398 </span></a>
<a name="l3399"><span class="ln">3399 </span></a>  <span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3400"><span class="ln">3400 </span></a>
<a name="l3401"><span class="ln">3401 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l3402"><span class="ln">3402 </span></a><span class="s1">};</span>
<a name="l3403"><span class="ln">3403 </span></a>
<a name="l3404"><span class="ln">3404 </span></a><span class="s5">/**</span>
<a name="l3405"><span class="ln">3405 </span></a> <span class="s5">* Execute a `findOneAndDelete()` query</span>
<a name="l3406"><span class="ln">3406 </span></a> <span class="s5">*</span>
<a name="l3407"><span class="ln">3407 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3408"><span class="ln">3408 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_findOneAndDelete</span>
<a name="l3409"><span class="ln">3409 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3410"><span class="ln">3410 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3411"><span class="ln">3411 </span></a> <span class="s5">*/</span>
<a name="l3412"><span class="ln">3412 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_findOneAndDelete </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_findOneAndDelete</span><span class="s1">() {</span>
<a name="l3413"><span class="ln">3413 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l3414"><span class="ln">3414 </span></a>
<a name="l3415"><span class="ln">3415 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">() != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3416"><span class="ln">3416 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l3417"><span class="ln">3417 </span></a>  <span class="s1">}</span>
<a name="l3418"><span class="ln">3418 </span></a>
<a name="l3419"><span class="ln">3419 </span></a>  <span class="s4">const </span><span class="s2">includeResultMetadata </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata</span><span class="s1">;</span>
<a name="l3420"><span class="ln">3420 </span></a>
<a name="l3421"><span class="ln">3421 </span></a>  <span class="s4">const </span><span class="s2">filter </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l3422"><span class="ln">3422 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">);</span>
<a name="l3423"><span class="ln">3423 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3424"><span class="ln">3424 </span></a>
<a name="l3425"><span class="ln">3425 </span></a>  <span class="s4">let </span><span class="s2">res </span><span class="s1">= </span><span class="s4">await this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">findOneAndDelete</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l3426"><span class="ln">3426 </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">fn of </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_transforms</span><span class="s1">) {</span>
<a name="l3427"><span class="ln">3427 </span></a>    <span class="s2">res </span><span class="s1">= </span><span class="s2">fn</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l3428"><span class="ln">3428 </span></a>  <span class="s1">}</span>
<a name="l3429"><span class="ln">3429 </span></a>  <span class="s4">const </span><span class="s2">doc </span><span class="s1">= !</span><span class="s2">includeResultMetadata </span><span class="s1">? </span><span class="s2">res </span><span class="s1">: </span><span class="s2">res</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
<a name="l3430"><span class="ln">3430 </span></a>
<a name="l3431"><span class="ln">3431 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l3432"><span class="ln">3432 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_completeOne</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, (</span><span class="s2">err</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
<a name="l3433"><span class="ln">3433 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l3434"><span class="ln">3434 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l3435"><span class="ln">3435 </span></a>      <span class="s1">}</span>
<a name="l3436"><span class="ln">3436 </span></a>      <span class="s2">resolve</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l3437"><span class="ln">3437 </span></a>    <span class="s1">});</span>
<a name="l3438"><span class="ln">3438 </span></a>  <span class="s1">});</span>
<a name="l3439"><span class="ln">3439 </span></a><span class="s1">};</span>
<a name="l3440"><span class="ln">3440 </span></a>
<a name="l3441"><span class="ln">3441 </span></a><span class="s5">/**</span>
<a name="l3442"><span class="ln">3442 </span></a> <span class="s5">* Issues a MongoDB [findOneAndReplace](https://www.mongodb.com/docs/manual/reference/method/db.collection.findOneAndReplace/) command.</span>
<a name="l3443"><span class="ln">3443 </span></a> <span class="s5">*</span>
<a name="l3444"><span class="ln">3444 </span></a> <span class="s5">* Finds a matching document, removes it, and returns the found document (if any).</span>
<a name="l3445"><span class="ln">3445 </span></a> <span class="s5">*</span>
<a name="l3446"><span class="ln">3446 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l3447"><span class="ln">3447 </span></a> <span class="s5">*</span>
<a name="l3448"><span class="ln">3448 </span></a> <span class="s5">* - `findOneAndReplace()`</span>
<a name="l3449"><span class="ln">3449 </span></a> <span class="s5">*</span>
<a name="l3450"><span class="ln">3450 </span></a> <span class="s5">* #### Available options</span>
<a name="l3451"><span class="ln">3451 </span></a> <span class="s5">*</span>
<a name="l3452"><span class="ln">3452 </span></a> <span class="s5">* - `sort`: if multiple docs are found by the conditions, sets the sort order to choose which doc to update</span>
<a name="l3453"><span class="ln">3453 </span></a> <span class="s5">* - `maxTimeMS`: puts a time limit on the query - requires mongodb &gt;= 2.6.0</span>
<a name="l3454"><span class="ln">3454 </span></a> <span class="s5">* - `includeResultMetadata`: if true, returns the full [ModifyResult from the MongoDB driver](https://mongodb.github.io/node-mongodb-native/4.9/interfaces/ModifyResult.html) rather than just the document</span>
<a name="l3455"><span class="ln">3455 </span></a> <span class="s5">*</span>
<a name="l3456"><span class="ln">3456 </span></a> <span class="s5">* #### Callback Signature</span>
<a name="l3457"><span class="ln">3457 </span></a> <span class="s5">*</span>
<a name="l3458"><span class="ln">3458 </span></a> <span class="s5">*     function(error, doc) {</span>
<a name="l3459"><span class="ln">3459 </span></a> <span class="s5">*       // error: any errors that occurred</span>
<a name="l3460"><span class="ln">3460 </span></a> <span class="s5">*       // doc: the document before updates are applied if `new: false`, or after updates if `new = true`</span>
<a name="l3461"><span class="ln">3461 </span></a> <span class="s5">*     }</span>
<a name="l3462"><span class="ln">3462 </span></a> <span class="s5">*</span>
<a name="l3463"><span class="ln">3463 </span></a> <span class="s5">* #### Example:</span>
<a name="l3464"><span class="ln">3464 </span></a> <span class="s5">*</span>
<a name="l3465"><span class="ln">3465 </span></a> <span class="s5">*     A.where().findOneAndReplace(filter, replacement, options); // return Query</span>
<a name="l3466"><span class="ln">3466 </span></a> <span class="s5">*     A.where().findOneAndReplace(filter); // returns Query</span>
<a name="l3467"><span class="ln">3467 </span></a> <span class="s5">*     A.where().findOneAndReplace(); // returns Query</span>
<a name="l3468"><span class="ln">3468 </span></a> <span class="s5">*</span>
<a name="l3469"><span class="ln">3469 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">findOneAndReplace</span>
<a name="l3470"><span class="ln">3470 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3471"><span class="ln">3471 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [filter]</span>
<a name="l3472"><span class="ln">3472 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [replacement]</span>
<a name="l3473"><span class="ln">3473 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l3474"><span class="ln">3474 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.includeResultMetadata] if true, returns the full [ModifyResult from the MongoDB driver](https://mongodb.github.io/node-mongodb-native/4.9/interfaces/ModifyResult.html) rather than just the document</span>
<a name="l3475"><span class="ln">3475 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{ClientSession} [options.session=null] The session associated with this query. See [transactions docs](https://mongoosejs.com/docs/transactions.html).</span>
<a name="l3476"><span class="ln">3476 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l3477"><span class="ln">3477 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.new=false] By default, `findOneAndUpdate()` returns the document as it was **before** `update` was applied. If you set `new: true`, `findOneAndUpdate()` will instead give you the object after `update` was applied.</span>
<a name="l3478"><span class="ln">3478 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options.lean] if truthy, mongoose will return the document as a plain JavaScript object rather than a mongoose document. See [`Query.lean()`](https://mongoosejs.com/docs/api/query.html#Query.prototype.lean()) and [the Mongoose lean tutorial](https://mongoosejs.com/docs/tutorials/lean.html).</span>
<a name="l3479"><span class="ln">3479 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{ClientSession} [options.session=null] The session associated with this query. See [transactions docs](https://mongoosejs.com/docs/transactions.html).</span>
<a name="l3480"><span class="ln">3480 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l3481"><span class="ln">3481 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.timestamps=null] If set to `false` and [schema-level timestamps](https://mongoosejs.com/docs/guide.html#timestamps) are enabled, skip timestamps for this update. Note that this allows you to overwrite timestamps. Does nothing if schema-level timestamps are not set.</span>
<a name="l3482"><span class="ln">3482 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.returnOriginal=null] An alias for the `new` option. `returnOriginal: false` is equivalent to `new: true`.</span>
<a name="l3483"><span class="ln">3483 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.translateAliases=null] If set to `true`, translates any schema-defined aliases in `filter`, `projection`, `update`, and `distinct`. Throws an error if there are any conflicts where both alias and raw property are defined on the same object.</span>
<a name="l3484"><span class="ln">3484 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3485"><span class="ln">3485 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l3486"><span class="ln">3486 </span></a> <span class="s5">*/</span>
<a name="l3487"><span class="ln">3487 </span></a>
<a name="l3488"><span class="ln">3488 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">findOneAndReplace </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">replacement</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3489"><span class="ln">3489 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">filter </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3490"><span class="ln">3490 </span></a>      <span class="s4">typeof </span><span class="s2">replacement </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3491"><span class="ln">3491 </span></a>      <span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">||</span>
<a name="l3492"><span class="ln">3492 </span></a>      <span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">4</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3493"><span class="ln">3493 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.findOneAndReplace() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l3494"><span class="ln">3494 </span></a>  <span class="s1">}</span>
<a name="l3495"><span class="ln">3495 </span></a>
<a name="l3496"><span class="ln">3496 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s0">'findOneAndReplace'</span><span class="s1">;</span>
<a name="l3497"><span class="ln">3497 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l3498"><span class="ln">3498 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validate</span><span class="s1">();</span>
<a name="l3499"><span class="ln">3499 </span></a>
<a name="l3500"><span class="ln">3500 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">mquery</span><span class="s1">.</span><span class="s2">canMerge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">)) {</span>
<a name="l3501"><span class="ln">3501 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">);</span>
<a name="l3502"><span class="ln">3502 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">filter </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3503"><span class="ln">3503 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span>
<a name="l3504"><span class="ln">3504 </span></a>      <span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s0">'findOneAndReplace'</span><span class="s1">)</span>
<a name="l3505"><span class="ln">3505 </span></a>    <span class="s1">);</span>
<a name="l3506"><span class="ln">3506 </span></a>  <span class="s1">}</span>
<a name="l3507"><span class="ln">3507 </span></a>
<a name="l3508"><span class="ln">3508 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">replacement </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3509"><span class="ln">3509 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mergeUpdate</span><span class="s1">(</span><span class="s2">replacement</span><span class="s1">);</span>
<a name="l3510"><span class="ln">3510 </span></a>  <span class="s1">}</span>
<a name="l3511"><span class="ln">3511 </span></a>
<a name="l3512"><span class="ln">3512 </span></a>  <span class="s2">options </span><span class="s1">= </span><span class="s2">options </span><span class="s1">|| {};</span>
<a name="l3513"><span class="ln">3513 </span></a>
<a name="l3514"><span class="ln">3514 </span></a>  <span class="s4">const </span><span class="s2">returnOriginal </span><span class="s1">= </span><span class="s4">this </span><span class="s1">&amp;&amp;</span>
<a name="l3515"><span class="ln">3515 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">&amp;&amp;</span>
<a name="l3516"><span class="ln">3516 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base </span><span class="s1">&amp;&amp;</span>
<a name="l3517"><span class="ln">3517 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp;</span>
<a name="l3518"><span class="ln">3518 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnOriginal</span><span class="s1">;</span>
<a name="l3519"><span class="ln">3519 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">new </span><span class="s1">== </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnDocument </span><span class="s1">== </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnOriginal </span><span class="s1">== </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">returnOriginal </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3520"><span class="ln">3520 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">returnOriginal </span><span class="s1">= </span><span class="s2">returnOriginal</span><span class="s1">;</span>
<a name="l3521"><span class="ln">3521 </span></a>  <span class="s1">}</span>
<a name="l3522"><span class="ln">3522 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3523"><span class="ln">3523 </span></a>
<a name="l3524"><span class="ln">3524 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l3525"><span class="ln">3525 </span></a><span class="s1">};</span>
<a name="l3526"><span class="ln">3526 </span></a>
<a name="l3527"><span class="ln">3527 </span></a><span class="s5">/**</span>
<a name="l3528"><span class="ln">3528 </span></a> <span class="s5">* Execute a findOneAndReplace() query</span>
<a name="l3529"><span class="ln">3529 </span></a> <span class="s5">*</span>
<a name="l3530"><span class="ln">3530 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3531"><span class="ln">3531 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_findOneAndReplace</span>
<a name="l3532"><span class="ln">3532 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3533"><span class="ln">3533 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3534"><span class="ln">3534 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3535"><span class="ln">3535 </span></a> <span class="s5">*/</span>
<a name="l3536"><span class="ln">3536 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_findOneAndReplace </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_findOneAndReplace</span><span class="s1">() {</span>
<a name="l3537"><span class="ln">3537 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l3538"><span class="ln">3538 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">() != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3539"><span class="ln">3539 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l3540"><span class="ln">3540 </span></a>  <span class="s1">}</span>
<a name="l3541"><span class="ln">3541 </span></a>
<a name="l3542"><span class="ln">3542 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'strict' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3543"><span class="ln">3543 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">strict </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">strict</span><span class="s1">;</span>
<a name="l3544"><span class="ln">3544 </span></a>    <span class="s4">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">strict</span><span class="s1">;</span>
<a name="l3545"><span class="ln">3545 </span></a>  <span class="s1">}</span>
<a name="l3546"><span class="ln">3546 </span></a>
<a name="l3547"><span class="ln">3547 </span></a>  <span class="s4">const </span><span class="s2">filter </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l3548"><span class="ln">3548 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">();</span>
<a name="l3549"><span class="ln">3549 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3550"><span class="ln">3550 </span></a>  <span class="s2">convertNewToReturnDocument</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3551"><span class="ln">3551 </span></a>
<a name="l3552"><span class="ln">3552 </span></a>  <span class="s4">const </span><span class="s2">includeResultMetadata </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata</span><span class="s1">;</span>
<a name="l3553"><span class="ln">3553 </span></a>
<a name="l3554"><span class="ln">3554 </span></a>  <span class="s4">const </span><span class="s2">modelOpts </span><span class="s1">= { </span><span class="s2">skipId</span><span class="s1">: </span><span class="s4">true </span><span class="s1">};</span>
<a name="l3555"><span class="ln">3555 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'strict' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">) {</span>
<a name="l3556"><span class="ln">3556 </span></a>    <span class="s2">modelOpts</span><span class="s1">.</span><span class="s2">strict </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">strict</span><span class="s1">;</span>
<a name="l3557"><span class="ln">3557 </span></a>  <span class="s1">}</span>
<a name="l3558"><span class="ln">3558 </span></a>
<a name="l3559"><span class="ln">3559 </span></a>  <span class="s4">const </span><span class="s2">runValidators </span><span class="s1">= </span><span class="s2">_getOption</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'runValidators'</span><span class="s1">, </span><span class="s4">false</span><span class="s1">);</span>
<a name="l3560"><span class="ln">3560 </span></a>
<a name="l3561"><span class="ln">3561 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l3562"><span class="ln">3562 </span></a>    <span class="s4">const </span><span class="s2">update </span><span class="s1">= </span><span class="s4">new this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s2">modelOpts</span><span class="s1">);</span>
<a name="l3563"><span class="ln">3563 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">runValidators</span><span class="s1">) {</span>
<a name="l3564"><span class="ln">3564 </span></a>      <span class="s4">await </span><span class="s2">update</span><span class="s1">.</span><span class="s2">validate</span><span class="s1">();</span>
<a name="l3565"><span class="ln">3565 </span></a>    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">update</span><span class="s1">.</span><span class="s2">$__</span><span class="s1">.</span><span class="s2">validationError</span><span class="s1">) {</span>
<a name="l3566"><span class="ln">3566 </span></a>      <span class="s4">throw </span><span class="s2">update</span><span class="s1">.</span><span class="s2">$__</span><span class="s1">.</span><span class="s2">validationError</span><span class="s1">;</span>
<a name="l3567"><span class="ln">3567 </span></a>    <span class="s1">}</span>
<a name="l3568"><span class="ln">3568 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">update</span><span class="s1">.</span><span class="s2">toBSON</span><span class="s1">();</span>
<a name="l3569"><span class="ln">3569 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l3570"><span class="ln">3570 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">err </span><span class="s4">instanceof </span><span class="s2">ValidationError</span><span class="s1">) {</span>
<a name="l3571"><span class="ln">3571 </span></a>      <span class="s4">throw </span><span class="s2">err</span><span class="s1">;</span>
<a name="l3572"><span class="ln">3572 </span></a>    <span class="s1">}</span>
<a name="l3573"><span class="ln">3573 </span></a>    <span class="s4">const </span><span class="s2">validationError </span><span class="s1">= </span><span class="s4">new </span><span class="s2">ValidationError</span><span class="s1">();</span>
<a name="l3574"><span class="ln">3574 </span></a>    <span class="s2">validationError</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">[</span><span class="s2">err</span><span class="s1">.</span><span class="s2">path</span><span class="s1">] = </span><span class="s2">err</span><span class="s1">;</span>
<a name="l3575"><span class="ln">3575 </span></a>    <span class="s4">throw </span><span class="s2">validationError</span><span class="s1">;</span>
<a name="l3576"><span class="ln">3576 </span></a>  <span class="s1">}</span>
<a name="l3577"><span class="ln">3577 </span></a>
<a name="l3578"><span class="ln">3578 </span></a>  <span class="s4">let </span><span class="s2">res </span><span class="s1">= </span><span class="s4">await this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">.</span><span class="s2">findOneAndReplace</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l3579"><span class="ln">3579 </span></a>
<a name="l3580"><span class="ln">3580 </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">fn of </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_transforms</span><span class="s1">) {</span>
<a name="l3581"><span class="ln">3581 </span></a>    <span class="s2">res </span><span class="s1">= </span><span class="s2">fn</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l3582"><span class="ln">3582 </span></a>  <span class="s1">}</span>
<a name="l3583"><span class="ln">3583 </span></a>
<a name="l3584"><span class="ln">3584 </span></a>  <span class="s4">const </span><span class="s2">doc </span><span class="s1">= !</span><span class="s2">includeResultMetadata </span><span class="s1">? </span><span class="s2">res </span><span class="s1">: </span><span class="s2">res</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
<a name="l3585"><span class="ln">3585 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l3586"><span class="ln">3586 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_completeOne</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, (</span><span class="s2">err</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
<a name="l3587"><span class="ln">3587 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l3588"><span class="ln">3588 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l3589"><span class="ln">3589 </span></a>      <span class="s1">}</span>
<a name="l3590"><span class="ln">3590 </span></a>      <span class="s2">resolve</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l3591"><span class="ln">3591 </span></a>    <span class="s1">});</span>
<a name="l3592"><span class="ln">3592 </span></a>  <span class="s1">});</span>
<a name="l3593"><span class="ln">3593 </span></a><span class="s1">};</span>
<a name="l3594"><span class="ln">3594 </span></a>
<a name="l3595"><span class="ln">3595 </span></a><span class="s5">/**</span>
<a name="l3596"><span class="ln">3596 </span></a> <span class="s5">* Support the `new` option as an alternative to `returnOriginal` for backwards</span>
<a name="l3597"><span class="ln">3597 </span></a> <span class="s5">* compat.</span>
<a name="l3598"><span class="ln">3598 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3599"><span class="ln">3599 </span></a> <span class="s5">*/</span>
<a name="l3600"><span class="ln">3600 </span></a>
<a name="l3601"><span class="ln">3601 </span></a><span class="s4">function </span><span class="s2">convertNewToReturnDocument</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3602"><span class="ln">3602 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'new' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3603"><span class="ln">3603 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">returnDocument </span><span class="s1">= </span><span class="s2">options</span><span class="s1">[</span><span class="s0">'new'</span><span class="s1">] ? </span><span class="s0">'after' </span><span class="s1">: </span><span class="s0">'before'</span><span class="s1">;</span>
<a name="l3604"><span class="ln">3604 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">[</span><span class="s0">'new'</span><span class="s1">];</span>
<a name="l3605"><span class="ln">3605 </span></a>  <span class="s1">}</span>
<a name="l3606"><span class="ln">3606 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'returnOriginal' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3607"><span class="ln">3607 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">returnDocument </span><span class="s1">= </span><span class="s2">options</span><span class="s1">[</span><span class="s0">'returnOriginal'</span><span class="s1">] ? </span><span class="s0">'before' </span><span class="s1">: </span><span class="s0">'after'</span><span class="s1">;</span>
<a name="l3608"><span class="ln">3608 </span></a>    <span class="s4">delete </span><span class="s2">options</span><span class="s1">[</span><span class="s0">'returnOriginal'</span><span class="s1">];</span>
<a name="l3609"><span class="ln">3609 </span></a>  <span class="s1">}</span>
<a name="l3610"><span class="ln">3610 </span></a>  <span class="s3">// Temporary since driver 4.0.0-beta does not support `returnDocument`</span>
<a name="l3611"><span class="ln">3611 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnDocument </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l3612"><span class="ln">3612 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">returnOriginal </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">returnDocument </span><span class="s1">=== </span><span class="s0">'before'</span><span class="s1">;</span>
<a name="l3613"><span class="ln">3613 </span></a>  <span class="s1">}</span>
<a name="l3614"><span class="ln">3614 </span></a><span class="s1">}</span>
<a name="l3615"><span class="ln">3615 </span></a>
<a name="l3616"><span class="ln">3616 </span></a><span class="s5">/**</span>
<a name="l3617"><span class="ln">3617 </span></a> <span class="s5">* Get options from query opts, falling back to the base mongoose object.</span>
<a name="l3618"><span class="ln">3618 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Query} query</span>
<a name="l3619"><span class="ln">3619 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} option</span>
<a name="l3620"><span class="ln">3620 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Any} def</span>
<a name="l3621"><span class="ln">3621 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3622"><span class="ln">3622 </span></a> <span class="s5">*/</span>
<a name="l3623"><span class="ln">3623 </span></a>
<a name="l3624"><span class="ln">3624 </span></a><span class="s4">function </span><span class="s2">_getOption</span><span class="s1">(</span><span class="s2">query</span><span class="s1">, </span><span class="s2">option</span><span class="s1">, </span><span class="s2">def</span><span class="s1">) {</span>
<a name="l3625"><span class="ln">3625 </span></a>  <span class="s4">const </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">query</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">(</span><span class="s2">query</span><span class="s1">.</span><span class="s2">model</span><span class="s1">);</span>
<a name="l3626"><span class="ln">3626 </span></a>
<a name="l3627"><span class="ln">3627 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">option </span><span class="s4">in </span><span class="s2">opts</span><span class="s1">) {</span>
<a name="l3628"><span class="ln">3628 </span></a>    <span class="s4">return </span><span class="s2">opts</span><span class="s1">[</span><span class="s2">option</span><span class="s1">];</span>
<a name="l3629"><span class="ln">3629 </span></a>  <span class="s1">}</span>
<a name="l3630"><span class="ln">3630 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">option </span><span class="s4">in </span><span class="s2">query</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l3631"><span class="ln">3631 </span></a>    <span class="s4">return </span><span class="s2">query</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">[</span><span class="s2">option</span><span class="s1">];</span>
<a name="l3632"><span class="ln">3632 </span></a>  <span class="s1">}</span>
<a name="l3633"><span class="ln">3633 </span></a>  <span class="s4">return </span><span class="s2">def</span><span class="s1">;</span>
<a name="l3634"><span class="ln">3634 </span></a><span class="s1">}</span>
<a name="l3635"><span class="ln">3635 </span></a>
<a name="l3636"><span class="ln">3636 </span></a><span class="s3">/*! 
<a name="l3637"><span class="ln">3637 </span></a> * ignore 
<a name="l3638"><span class="ln">3638 </span></a> */</span>
<a name="l3639"><span class="ln">3639 </span></a>
<a name="l3640"><span class="ln">3640 </span></a><span class="s4">function </span><span class="s2">_completeOneLean</span><span class="s1">(</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l3641"><span class="ln">3641 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">transform </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3642"><span class="ln">3642 </span></a>    <span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3643"><span class="ln">3643 </span></a>
<a name="l3644"><span class="ln">3644 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
<a name="l3645"><span class="ln">3645 </span></a>      <span class="s4">const </span><span class="s2">childPath </span><span class="s1">= </span><span class="s2">path </span><span class="s1">? </span><span class="s2">path </span><span class="s1">+ </span><span class="s0">'.' </span><span class="s1">+ </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">model</span><span class="s1">.</span><span class="s2">path </span><span class="s1">: </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">model</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>
<a name="l3646"><span class="ln">3646 </span></a>      <span class="s4">const </span><span class="s2">_schema </span><span class="s1">= </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">schema</span><span class="s1">;</span>
<a name="l3647"><span class="ln">3647 </span></a>      <span class="s4">const </span><span class="s2">obj </span><span class="s1">= </span><span class="s2">mpath</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">childPath</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3648"><span class="ln">3648 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">obj </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3649"><span class="ln">3649 </span></a>        <span class="s4">continue</span><span class="s1">;</span>
<a name="l3650"><span class="ln">3650 </span></a>      <span class="s1">}</span>
<a name="l3651"><span class="ln">3651 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">)) {</span>
<a name="l3652"><span class="ln">3652 </span></a>        <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">obj</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
<a name="l3653"><span class="ln">3653 </span></a>          <span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
<a name="l3654"><span class="ln">3654 </span></a>        <span class="s1">}</span>
<a name="l3655"><span class="ln">3655 </span></a>      <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3656"><span class="ln">3656 </span></a>        <span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">);</span>
<a name="l3657"><span class="ln">3657 </span></a>      <span class="s1">}</span>
<a name="l3658"><span class="ln">3658 </span></a>      <span class="s2">_completeOneLean</span><span class="s1">(</span><span class="s2">_schema</span><span class="s1">, </span><span class="s2">obj</span><span class="s1">, </span><span class="s2">childPath</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
<a name="l3659"><span class="ln">3659 </span></a>    <span class="s1">}</span>
<a name="l3660"><span class="ln">3660 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l3661"><span class="ln">3661 </span></a>      <span class="s4">return </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3662"><span class="ln">3662 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3663"><span class="ln">3663 </span></a>      <span class="s4">return</span><span class="s1">;</span>
<a name="l3664"><span class="ln">3664 </span></a>    <span class="s1">}</span>
<a name="l3665"><span class="ln">3665 </span></a>  <span class="s1">}</span>
<a name="l3666"><span class="ln">3666 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">includeResultMetadata</span><span class="s1">) {</span>
<a name="l3667"><span class="ln">3667 </span></a>    <span class="s4">return </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">res</span><span class="s1">);</span>
<a name="l3668"><span class="ln">3668 </span></a>  <span class="s1">}</span>
<a name="l3669"><span class="ln">3669 </span></a>  <span class="s4">return </span><span class="s2">callback</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3670"><span class="ln">3670 </span></a><span class="s1">}</span>
<a name="l3671"><span class="ln">3671 </span></a>
<a name="l3672"><span class="ln">3672 </span></a><span class="s3">/*! 
<a name="l3673"><span class="ln">3673 </span></a> * ignore 
<a name="l3674"><span class="ln">3674 </span></a> */</span>
<a name="l3675"><span class="ln">3675 </span></a>
<a name="l3676"><span class="ln">3676 </span></a><span class="s4">function </span><span class="s2">_completeManyLean</span><span class="s1">(</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">docs</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">) {</span>
<a name="l3677"><span class="ln">3677 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">transform </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3678"><span class="ln">3678 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">doc of docs</span><span class="s1">) {</span>
<a name="l3679"><span class="ln">3679 </span></a>      <span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3680"><span class="ln">3680 </span></a>    <span class="s1">}</span>
<a name="l3681"><span class="ln">3681 </span></a>
<a name="l3682"><span class="ln">3682 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
<a name="l3683"><span class="ln">3683 </span></a>      <span class="s4">const </span><span class="s2">childPath </span><span class="s1">= </span><span class="s2">path </span><span class="s1">? </span><span class="s2">path </span><span class="s1">+ </span><span class="s0">'.' </span><span class="s1">+ </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">model</span><span class="s1">.</span><span class="s2">path </span><span class="s1">: </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">model</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>
<a name="l3684"><span class="ln">3684 </span></a>      <span class="s4">const </span><span class="s2">_schema </span><span class="s1">= </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">childSchemas</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">schema</span><span class="s1">;</span>
<a name="l3685"><span class="ln">3685 </span></a>      <span class="s4">let </span><span class="s2">doc </span><span class="s1">= </span><span class="s2">mpath</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">childPath</span><span class="s1">, </span><span class="s2">docs</span><span class="s1">);</span>
<a name="l3686"><span class="ln">3686 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">doc </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3687"><span class="ln">3687 </span></a>        <span class="s4">continue</span><span class="s1">;</span>
<a name="l3688"><span class="ln">3688 </span></a>      <span class="s1">}</span>
<a name="l3689"><span class="ln">3689 </span></a>      <span class="s2">doc </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">flat</span><span class="s1">();</span>
<a name="l3690"><span class="ln">3690 </span></a>      <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
<a name="l3691"><span class="ln">3691 </span></a>        <span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
<a name="l3692"><span class="ln">3692 </span></a>      <span class="s1">}</span>
<a name="l3693"><span class="ln">3693 </span></a>      <span class="s2">_completeManyLean</span><span class="s1">(</span><span class="s2">_schema</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">childPath</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
<a name="l3694"><span class="ln">3694 </span></a>    <span class="s1">}</span>
<a name="l3695"><span class="ln">3695 </span></a>  <span class="s1">}</span>
<a name="l3696"><span class="ln">3696 </span></a>
<a name="l3697"><span class="ln">3697 </span></a>  <span class="s4">return </span><span class="s2">docs</span><span class="s1">;</span>
<a name="l3698"><span class="ln">3698 </span></a><span class="s1">}</span>
<a name="l3699"><span class="ln">3699 </span></a><span class="s5">/**</span>
<a name="l3700"><span class="ln">3700 </span></a> <span class="s5">* Override mquery.prototype._mergeUpdate to handle mongoose objects in</span>
<a name="l3701"><span class="ln">3701 </span></a> <span class="s5">* updates.</span>
<a name="l3702"><span class="ln">3702 </span></a> <span class="s5">*</span>
<a name="l3703"><span class="ln">3703 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} doc</span>
<a name="l3704"><span class="ln">3704 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_mergeUpdate</span>
<a name="l3705"><span class="ln">3705 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3706"><span class="ln">3706 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3707"><span class="ln">3707 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3708"><span class="ln">3708 </span></a> <span class="s5">*/</span>
<a name="l3709"><span class="ln">3709 </span></a>
<a name="l3710"><span class="ln">3710 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_mergeUpdate </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">) {</span>
<a name="l3711"><span class="ln">3711 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">) {</span>
<a name="l3712"><span class="ln">3712 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">) ? [] : {};</span>
<a name="l3713"><span class="ln">3713 </span></a>  <span class="s1">}</span>
<a name="l3714"><span class="ln">3714 </span></a>
<a name="l3715"><span class="ln">3715 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">doc </span><span class="s1">== </span><span class="s4">null </span><span class="s1">|| (</span><span class="s4">typeof </span><span class="s2">doc </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">).</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">)) {</span>
<a name="l3716"><span class="ln">3716 </span></a>    <span class="s4">return</span><span class="s1">;</span>
<a name="l3717"><span class="ln">3717 </span></a>  <span class="s1">}</span>
<a name="l3718"><span class="ln">3718 </span></a>
<a name="l3719"><span class="ln">3719 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">doc </span><span class="s4">instanceof </span><span class="s2">Query</span><span class="s1">) {</span>
<a name="l3720"><span class="ln">3720 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">)) {</span>
<a name="l3721"><span class="ln">3721 </span></a>      <span class="s4">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Cannot mix array and object updates'</span><span class="s1">);</span>
<a name="l3722"><span class="ln">3722 </span></a>    <span class="s1">}</span>
<a name="l3723"><span class="ln">3723 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">) {</span>
<a name="l3724"><span class="ln">3724 </span></a>      <span class="s2">utils</span><span class="s1">.</span><span class="s2">mergeClone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">);</span>
<a name="l3725"><span class="ln">3725 </span></a>    <span class="s1">}</span>
<a name="l3726"><span class="ln">3726 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">)) {</span>
<a name="l3727"><span class="ln">3727 </span></a>    <span class="s4">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">)) {</span>
<a name="l3728"><span class="ln">3728 </span></a>      <span class="s4">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Cannot mix array and object updates'</span><span class="s1">);</span>
<a name="l3729"><span class="ln">3729 </span></a>    <span class="s1">}</span>
<a name="l3730"><span class="ln">3730 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3731"><span class="ln">3731 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3732"><span class="ln">3732 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">)) {</span>
<a name="l3733"><span class="ln">3733 </span></a>      <span class="s4">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Cannot mix array and object updates'</span><span class="s1">);</span>
<a name="l3734"><span class="ln">3734 </span></a>    <span class="s1">}</span>
<a name="l3735"><span class="ln">3735 </span></a>    <span class="s2">utils</span><span class="s1">.</span><span class="s2">mergeClone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">);</span>
<a name="l3736"><span class="ln">3736 </span></a>  <span class="s1">}</span>
<a name="l3737"><span class="ln">3737 </span></a><span class="s1">};</span>
<a name="l3738"><span class="ln">3738 </span></a>
<a name="l3739"><span class="ln">3739 </span></a><span class="s3">/*! 
<a name="l3740"><span class="ln">3740 </span></a> * ignore 
<a name="l3741"><span class="ln">3741 </span></a> */</span>
<a name="l3742"><span class="ln">3742 </span></a>
<a name="l3743"><span class="ln">3743 </span></a><span class="s2">async </span><span class="s4">function </span><span class="s2">_updateThunk</span><span class="s1">(</span><span class="s2">op</span><span class="s1">) {</span>
<a name="l3744"><span class="ln">3744 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_castConditions</span><span class="s1">();</span>
<a name="l3745"><span class="ln">3745 </span></a>
<a name="l3746"><span class="ln">3746 </span></a>  <span class="s2">_castArrayFilters</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l3747"><span class="ln">3747 </span></a>
<a name="l3748"><span class="ln">3748 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">() != </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3749"><span class="ln">3749 </span></a>    <span class="s4">throw this</span><span class="s1">.</span><span class="s2">error</span><span class="s1">();</span>
<a name="l3750"><span class="ln">3750 </span></a>  <span class="s1">}</span>
<a name="l3751"><span class="ln">3751 </span></a>
<a name="l3752"><span class="ln">3752 </span></a>  <span class="s4">const </span><span class="s2">castedQuery </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l3753"><span class="ln">3753 </span></a>  <span class="s4">const </span><span class="s2">options </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_optionsForExec</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">);</span>
<a name="l3754"><span class="ln">3754 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_applyTranslateAliases</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l3755"><span class="ln">3755 </span></a>
<a name="l3756"><span class="ln">3756 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">clone</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l3757"><span class="ln">3757 </span></a>  <span class="s4">const </span><span class="s2">isOverwriting </span><span class="s1">= </span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'replaceOne'</span><span class="s1">;</span>
<a name="l3758"><span class="ln">3758 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">isOverwriting</span><span class="s1">) {</span>
<a name="l3759"><span class="ln">3759 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s4">new this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s4">true</span><span class="s1">);</span>
<a name="l3760"><span class="ln">3760 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3761"><span class="ln">3761 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_castUpdate</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">);</span>
<a name="l3762"><span class="ln">3762 </span></a>
<a name="l3763"><span class="ln">3763 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">== </span><span class="s4">null </span><span class="s1">|| </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">).</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l3764"><span class="ln">3764 </span></a>      <span class="s4">return </span><span class="s1">{ </span><span class="s2">acknowledged</span><span class="s1">: </span><span class="s4">false </span><span class="s1">};</span>
<a name="l3765"><span class="ln">3765 </span></a>    <span class="s1">}</span>
<a name="l3766"><span class="ln">3766 </span></a>
<a name="l3767"><span class="ln">3767 </span></a>    <span class="s4">const </span><span class="s2">_opts </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">options</span><span class="s1">, {</span>
<a name="l3768"><span class="ln">3768 </span></a>      <span class="s2">setDefaultsOnInsert</span><span class="s1">: </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">setDefaultsOnInsert</span>
<a name="l3769"><span class="ln">3769 </span></a>    <span class="s1">});</span>
<a name="l3770"><span class="ln">3770 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s2">setDefaultsOnInsert</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">,</span>
<a name="l3771"><span class="ln">3771 </span></a>      <span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">_opts</span><span class="s1">);</span>
<a name="l3772"><span class="ln">3772 </span></a>  <span class="s1">}</span>
<a name="l3773"><span class="ln">3773 </span></a>
<a name="l3774"><span class="ln">3774 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">arrayFilters</span><span class="s1">)) {</span>
<a name="l3775"><span class="ln">3775 </span></a>    <span class="s2">options</span><span class="s1">.</span><span class="s2">arrayFilters </span><span class="s1">= </span><span class="s2">removeUnusedArrayFilters</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">arrayFilters</span><span class="s1">);</span>
<a name="l3776"><span class="ln">3776 </span></a>  <span class="s1">}</span>
<a name="l3777"><span class="ln">3777 </span></a>
<a name="l3778"><span class="ln">3778 </span></a>  <span class="s4">const </span><span class="s2">runValidators </span><span class="s1">= </span><span class="s2">_getOption</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'runValidators'</span><span class="s1">, </span><span class="s4">false</span><span class="s1">);</span>
<a name="l3779"><span class="ln">3779 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">runValidators</span><span class="s1">) {</span>
<a name="l3780"><span class="ln">3780 </span></a>    <span class="s4">await this</span><span class="s1">.</span><span class="s2">validate</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">isOverwriting</span><span class="s1">);</span>
<a name="l3781"><span class="ln">3781 </span></a>  <span class="s1">}</span>
<a name="l3782"><span class="ln">3782 </span></a>
<a name="l3783"><span class="ln">3783 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">toBSON</span><span class="s1">) {</span>
<a name="l3784"><span class="ln">3784 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_update </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">.</span><span class="s2">toBSON</span><span class="s1">();</span>
<a name="l3785"><span class="ln">3785 </span></a>  <span class="s1">}</span>
<a name="l3786"><span class="ln">3786 </span></a>
<a name="l3787"><span class="ln">3787 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">mongooseCollection</span><span class="s1">[</span><span class="s2">op</span><span class="s1">](</span><span class="s2">castedQuery</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_update</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<a name="l3788"><span class="ln">3788 </span></a><span class="s1">}</span>
<a name="l3789"><span class="ln">3789 </span></a>
<a name="l3790"><span class="ln">3790 </span></a><span class="s5">/**</span>
<a name="l3791"><span class="ln">3791 </span></a> <span class="s5">* Mongoose calls this function internally to validate the query if</span>
<a name="l3792"><span class="ln">3792 </span></a> <span class="s5">* `runValidators` is set</span>
<a name="l3793"><span class="ln">3793 </span></a> <span class="s5">*</span>
<a name="l3794"><span class="ln">3794 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} castedDoc the update, after casting</span>
<a name="l3795"><span class="ln">3795 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} options the options from `_optionsForExec()`</span>
<a name="l3796"><span class="ln">3796 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} isOverwriting</span>
<a name="l3797"><span class="ln">3797 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">validate</span>
<a name="l3798"><span class="ln">3798 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3799"><span class="ln">3799 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3800"><span class="ln">3800 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3801"><span class="ln">3801 </span></a> <span class="s5">*/</span>
<a name="l3802"><span class="ln">3802 </span></a>
<a name="l3803"><span class="ln">3803 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">validate </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">validate</span><span class="s1">(</span><span class="s2">castedDoc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">isOverwriting</span><span class="s1">) {</span>
<a name="l3804"><span class="ln">3804 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">3</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3805"><span class="ln">3805 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.validate() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l3806"><span class="ln">3806 </span></a>  <span class="s1">}</span>
<a name="l3807"><span class="ln">3807 </span></a>
<a name="l3808"><span class="ln">3808 </span></a>  <span class="s4">await </span><span class="s2">_executePreHooks</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'validate'</span><span class="s1">);</span>
<a name="l3809"><span class="ln">3809 </span></a>
<a name="l3810"><span class="ln">3810 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">isOverwriting</span><span class="s1">) {</span>
<a name="l3811"><span class="ln">3811 </span></a>    <span class="s4">await </span><span class="s2">castedDoc</span><span class="s1">.</span><span class="s2">$validate</span><span class="s1">();</span>
<a name="l3812"><span class="ln">3812 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l3813"><span class="ln">3813 </span></a>    <span class="s4">await new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l3814"><span class="ln">3814 </span></a>      <span class="s2">updateValidators</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">castedDoc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, (</span><span class="s2">err</span><span class="s1">) =&gt; {</span>
<a name="l3815"><span class="ln">3815 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">err </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l3816"><span class="ln">3816 </span></a>          <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l3817"><span class="ln">3817 </span></a>        <span class="s1">}</span>
<a name="l3818"><span class="ln">3818 </span></a>        <span class="s2">resolve</span><span class="s1">();</span>
<a name="l3819"><span class="ln">3819 </span></a>      <span class="s1">});</span>
<a name="l3820"><span class="ln">3820 </span></a>    <span class="s1">});</span>
<a name="l3821"><span class="ln">3821 </span></a>  <span class="s1">}</span>
<a name="l3822"><span class="ln">3822 </span></a>
<a name="l3823"><span class="ln">3823 </span></a>  <span class="s4">await </span><span class="s2">_executePostHooks</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s0">'validate'</span><span class="s1">);</span>
<a name="l3824"><span class="ln">3824 </span></a><span class="s1">};</span>
<a name="l3825"><span class="ln">3825 </span></a>
<a name="l3826"><span class="ln">3826 </span></a><span class="s5">/**</span>
<a name="l3827"><span class="ln">3827 </span></a> <span class="s5">* Execute an updateMany query</span>
<a name="l3828"><span class="ln">3828 </span></a> <span class="s5">*</span>
<a name="l3829"><span class="ln">3829 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Model.update https://mongoosejs.com/docs/api/model.html#Model.update()</span>
<a name="l3830"><span class="ln">3830 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_updateMany</span>
<a name="l3831"><span class="ln">3831 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3832"><span class="ln">3832 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3833"><span class="ln">3833 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3834"><span class="ln">3834 </span></a> <span class="s5">*/</span>
<a name="l3835"><span class="ln">3835 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_updateMany </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_updateMany</span><span class="s1">() {</span>
<a name="l3836"><span class="ln">3836 </span></a>  <span class="s4">return </span><span class="s2">_updateThunk</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'updateMany'</span><span class="s1">);</span>
<a name="l3837"><span class="ln">3837 </span></a><span class="s1">};</span>
<a name="l3838"><span class="ln">3838 </span></a>
<a name="l3839"><span class="ln">3839 </span></a><span class="s5">/**</span>
<a name="l3840"><span class="ln">3840 </span></a> <span class="s5">* Execute an updateOne query</span>
<a name="l3841"><span class="ln">3841 </span></a> <span class="s5">*</span>
<a name="l3842"><span class="ln">3842 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Model.update https://mongoosejs.com/docs/api/model.html#Model.update()</span>
<a name="l3843"><span class="ln">3843 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_updateOne</span>
<a name="l3844"><span class="ln">3844 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3845"><span class="ln">3845 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3846"><span class="ln">3846 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3847"><span class="ln">3847 </span></a> <span class="s5">*/</span>
<a name="l3848"><span class="ln">3848 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_updateOne </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_updateOne</span><span class="s1">() {</span>
<a name="l3849"><span class="ln">3849 </span></a>  <span class="s4">return </span><span class="s2">_updateThunk</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'updateOne'</span><span class="s1">);</span>
<a name="l3850"><span class="ln">3850 </span></a><span class="s1">};</span>
<a name="l3851"><span class="ln">3851 </span></a>
<a name="l3852"><span class="ln">3852 </span></a><span class="s5">/**</span>
<a name="l3853"><span class="ln">3853 </span></a> <span class="s5">* Execute a replaceOne query</span>
<a name="l3854"><span class="ln">3854 </span></a> <span class="s5">*</span>
<a name="l3855"><span class="ln">3855 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Model.replaceOne https://mongoosejs.com/docs/api/model.html#Model.replaceOne()</span>
<a name="l3856"><span class="ln">3856 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_replaceOne</span>
<a name="l3857"><span class="ln">3857 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l3858"><span class="ln">3858 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l3859"><span class="ln">3859 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l3860"><span class="ln">3860 </span></a> <span class="s5">*/</span>
<a name="l3861"><span class="ln">3861 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_replaceOne </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">_replaceOne</span><span class="s1">() {</span>
<a name="l3862"><span class="ln">3862 </span></a>  <span class="s4">return </span><span class="s2">_updateThunk</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'replaceOne'</span><span class="s1">);</span>
<a name="l3863"><span class="ln">3863 </span></a><span class="s1">};</span>
<a name="l3864"><span class="ln">3864 </span></a>
<a name="l3865"><span class="ln">3865 </span></a><span class="s5">/**</span>
<a name="l3866"><span class="ln">3866 </span></a> <span class="s5">* Declare and/or execute this query as an updateMany() operation.</span>
<a name="l3867"><span class="ln">3867 </span></a> <span class="s5">* MongoDB will update _all_ documents that match `filter` (as opposed to just the first one).</span>
<a name="l3868"><span class="ln">3868 </span></a> <span class="s5">*</span>
<a name="l3869"><span class="ln">3869 </span></a> <span class="s5">* **Note** updateMany will _not_ fire update middleware. Use `pre('updateMany')`</span>
<a name="l3870"><span class="ln">3870 </span></a> <span class="s5">* and `post('updateMany')` instead.</span>
<a name="l3871"><span class="ln">3871 </span></a> <span class="s5">*</span>
<a name="l3872"><span class="ln">3872 </span></a> <span class="s5">* #### Example:</span>
<a name="l3873"><span class="ln">3873 </span></a> <span class="s5">*</span>
<a name="l3874"><span class="ln">3874 </span></a> <span class="s5">*     const res = await Person.updateMany({ name: /Stark$/ }, { isDeleted: true });</span>
<a name="l3875"><span class="ln">3875 </span></a> <span class="s5">*     res.n; // Number of documents matched</span>
<a name="l3876"><span class="ln">3876 </span></a> <span class="s5">*     res.nModified; // Number of documents modified</span>
<a name="l3877"><span class="ln">3877 </span></a> <span class="s5">*</span>
<a name="l3878"><span class="ln">3878 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l3879"><span class="ln">3879 </span></a> <span class="s5">*</span>
<a name="l3880"><span class="ln">3880 </span></a> <span class="s5">* - `updateMany()`</span>
<a name="l3881"><span class="ln">3881 </span></a> <span class="s5">*</span>
<a name="l3882"><span class="ln">3882 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [filter]</span>
<a name="l3883"><span class="ln">3883 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Array} [update] the update command. If array, this update will be treated as an update pipeline and not casted.</span>
<a name="l3884"><span class="ln">3884 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l3885"><span class="ln">3885 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.multipleCastError] by default, mongoose only returns the first error that occurred in casting the query. Turn on this option to aggregate all the cast errors.</span>
<a name="l3886"><span class="ln">3886 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l3887"><span class="ln">3887 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.upsert=false] if true, and no documents found, insert a new document</span>
<a name="l3888"><span class="ln">3888 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options.writeConcern=null] sets the [write concern](https://www.mongodb.com/docs/manual/reference/write-concern/) for replica sets. Overrides the [schema-level write concern](https://mongoosejs.com/docs/guide.html#writeConcern)</span>
<a name="l3889"><span class="ln">3889 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.timestamps=null] If set to `false` and [schema-level timestamps](https://mongoosejs.com/docs/guide.html#timestamps) are enabled, skip timestamps for this update. Does nothing if schema-level timestamps are not set.</span>
<a name="l3890"><span class="ln">3890 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.translateAliases=null] If set to `true`, translates any schema-defined aliases in `filter`, `projection`, `update`, and `distinct`. Throws an error if there are any conflicts where both alias and raw property are defined on the same object.</span>
<a name="l3891"><span class="ln">3891 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.overwriteDiscriminatorKey=false] Mongoose removes discriminator key updates from `update` by default, set `overwriteDiscriminatorKey` to `true` to allow updating the discriminator key</span>
<a name="l3892"><span class="ln">3892 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [callback] params are (error, writeOpResult)</span>
<a name="l3893"><span class="ln">3893 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3894"><span class="ln">3894 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Model.update https://mongoosejs.com/docs/api/model.html#Model.update()</span>
<a name="l3895"><span class="ln">3895 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Query docs https://mongoosejs.com/docs/queries.html</span>
<a name="l3896"><span class="ln">3896 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">update https://www.mongodb.com/docs/manual/reference/method/db.collection.update/</span>
<a name="l3897"><span class="ln">3897 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">UpdateResult https://mongodb.github.io/node-mongodb-native/4.9/interfaces/UpdateResult.html</span>
<a name="l3898"><span class="ln">3898 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB docs https://www.mongodb.com/docs/manual/reference/command/update/#update-command-output</span>
<a name="l3899"><span class="ln">3899 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l3900"><span class="ln">3900 </span></a> <span class="s5">*/</span>
<a name="l3901"><span class="ln">3901 </span></a>
<a name="l3902"><span class="ln">3902 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">updateMany </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l3903"><span class="ln">3903 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3904"><span class="ln">3904 </span></a>    <span class="s3">// .update(conditions, doc, callback)</span>
<a name="l3905"><span class="ln">3905 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
<a name="l3906"><span class="ln">3906 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l3907"><span class="ln">3907 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">doc </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3908"><span class="ln">3908 </span></a>    <span class="s3">// .update(doc, callback);</span>
<a name="l3909"><span class="ln">3909 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">;</span>
<a name="l3910"><span class="ln">3910 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l3911"><span class="ln">3911 </span></a>    <span class="s2">conditions </span><span class="s1">= {};</span>
<a name="l3912"><span class="ln">3912 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l3913"><span class="ln">3913 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3914"><span class="ln">3914 </span></a>    <span class="s3">// .update(callback)</span>
<a name="l3915"><span class="ln">3915 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l3916"><span class="ln">3916 </span></a>    <span class="s2">conditions </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3917"><span class="ln">3917 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3918"><span class="ln">3918 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3919"><span class="ln">3919 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; !</span><span class="s2">doc </span><span class="s1">&amp;&amp; !</span><span class="s2">options </span><span class="s1">&amp;&amp; !</span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l3920"><span class="ln">3920 </span></a>    <span class="s3">// .update(doc)</span>
<a name="l3921"><span class="ln">3921 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l3922"><span class="ln">3922 </span></a>    <span class="s2">conditions </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3923"><span class="ln">3923 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3924"><span class="ln">3924 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3925"><span class="ln">3925 </span></a>  <span class="s1">}</span>
<a name="l3926"><span class="ln">3926 </span></a>
<a name="l3927"><span class="ln">3927 </span></a>  <span class="s4">return </span><span class="s2">_update</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'updateMany'</span><span class="s1">, </span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
<a name="l3928"><span class="ln">3928 </span></a><span class="s1">};</span>
<a name="l3929"><span class="ln">3929 </span></a>
<a name="l3930"><span class="ln">3930 </span></a><span class="s5">/**</span>
<a name="l3931"><span class="ln">3931 </span></a> <span class="s5">* Declare and/or execute this query as an updateOne() operation.</span>
<a name="l3932"><span class="ln">3932 </span></a> <span class="s5">* MongoDB will update _only_ the first document that matches `filter`.</span>
<a name="l3933"><span class="ln">3933 </span></a> <span class="s5">*</span>
<a name="l3934"><span class="ln">3934 </span></a> <span class="s5">* - Use `replaceOne()` if you want to overwrite an entire document rather than using [atomic operators](https://www.mongodb.com/docs/manual/tutorial/model-data-for-atomic-operations/#pattern) like `$set`.</span>
<a name="l3935"><span class="ln">3935 </span></a> <span class="s5">*</span>
<a name="l3936"><span class="ln">3936 </span></a> <span class="s5">* **Note** updateOne will _not_ fire update middleware. Use `pre('updateOne')`</span>
<a name="l3937"><span class="ln">3937 </span></a> <span class="s5">* and `post('updateOne')` instead.</span>
<a name="l3938"><span class="ln">3938 </span></a> <span class="s5">*</span>
<a name="l3939"><span class="ln">3939 </span></a> <span class="s5">* #### Example:</span>
<a name="l3940"><span class="ln">3940 </span></a> <span class="s5">*</span>
<a name="l3941"><span class="ln">3941 </span></a> <span class="s5">*     const res = await Person.updateOne({ name: 'Jean-Luc Picard' }, { ship: 'USS Enterprise' });</span>
<a name="l3942"><span class="ln">3942 </span></a> <span class="s5">*     res.acknowledged; // Indicates if this write result was acknowledged. If not, then all other members of this result will be undefined.</span>
<a name="l3943"><span class="ln">3943 </span></a> <span class="s5">*     res.matchedCount; // Number of documents that matched the filter</span>
<a name="l3944"><span class="ln">3944 </span></a> <span class="s5">*     res.modifiedCount; // Number of documents that were modified</span>
<a name="l3945"><span class="ln">3945 </span></a> <span class="s5">*     res.upsertedCount; // Number of documents that were upserted</span>
<a name="l3946"><span class="ln">3946 </span></a> <span class="s5">*     res.upsertedId; // Identifier of the inserted document (if an upsert took place)</span>
<a name="l3947"><span class="ln">3947 </span></a> <span class="s5">*</span>
<a name="l3948"><span class="ln">3948 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l3949"><span class="ln">3949 </span></a> <span class="s5">*</span>
<a name="l3950"><span class="ln">3950 </span></a> <span class="s5">* - `updateOne()`</span>
<a name="l3951"><span class="ln">3951 </span></a> <span class="s5">*</span>
<a name="l3952"><span class="ln">3952 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [filter]</span>
<a name="l3953"><span class="ln">3953 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Array} [update] the update command. If array, this update will be treated as an update pipeline and not casted.</span>
<a name="l3954"><span class="ln">3954 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l3955"><span class="ln">3955 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.multipleCastError] by default, mongoose only returns the first error that occurred in casting the query. Turn on this option to aggregate all the cast errors.</span>
<a name="l3956"><span class="ln">3956 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l3957"><span class="ln">3957 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.upsert=false] if true, and no documents found, insert a new document</span>
<a name="l3958"><span class="ln">3958 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options.writeConcern=null] sets the [write concern](https://www.mongodb.com/docs/manual/reference/write-concern/) for replica sets. Overrides the [schema-level write concern](https://mongoosejs.com/docs/guide.html#writeConcern)</span>
<a name="l3959"><span class="ln">3959 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.timestamps=null] If set to `false` and [schema-level timestamps](https://mongoosejs.com/docs/guide.html#timestamps) are enabled, skip timestamps for this update. Note that this allows you to overwrite timestamps. Does nothing if schema-level timestamps are not set.</span>
<a name="l3960"><span class="ln">3960 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.translateAliases=null] If set to `true`, translates any schema-defined aliases in `filter`, `projection`, `update`, and `distinct`. Throws an error if there are any conflicts where both alias and raw property are defined on the same object.</span>
<a name="l3961"><span class="ln">3961 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.overwriteDiscriminatorKey=false] Mongoose removes discriminator key updates from `update` by default, set `overwriteDiscriminatorKey` to `true` to allow updating the discriminator key</span>
<a name="l3962"><span class="ln">3962 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [callback] params are (error, writeOpResult)</span>
<a name="l3963"><span class="ln">3963 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l3964"><span class="ln">3964 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Model.update https://mongoosejs.com/docs/api/model.html#Model.update()</span>
<a name="l3965"><span class="ln">3965 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Query docs https://mongoosejs.com/docs/queries.html</span>
<a name="l3966"><span class="ln">3966 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">update https://www.mongodb.com/docs/manual/reference/method/db.collection.update/</span>
<a name="l3967"><span class="ln">3967 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">UpdateResult https://mongodb.github.io/node-mongodb-native/4.9/interfaces/UpdateResult.html</span>
<a name="l3968"><span class="ln">3968 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB docs https://www.mongodb.com/docs/manual/reference/command/update/#update-command-output</span>
<a name="l3969"><span class="ln">3969 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l3970"><span class="ln">3970 </span></a> <span class="s5">*/</span>
<a name="l3971"><span class="ln">3971 </span></a>
<a name="l3972"><span class="ln">3972 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">updateOne </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l3973"><span class="ln">3973 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3974"><span class="ln">3974 </span></a>    <span class="s3">// .update(conditions, doc, callback)</span>
<a name="l3975"><span class="ln">3975 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
<a name="l3976"><span class="ln">3976 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l3977"><span class="ln">3977 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">doc </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3978"><span class="ln">3978 </span></a>    <span class="s3">// .update(doc, callback);</span>
<a name="l3979"><span class="ln">3979 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">;</span>
<a name="l3980"><span class="ln">3980 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l3981"><span class="ln">3981 </span></a>    <span class="s2">conditions </span><span class="s1">= {};</span>
<a name="l3982"><span class="ln">3982 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l3983"><span class="ln">3983 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l3984"><span class="ln">3984 </span></a>    <span class="s3">// .update(callback)</span>
<a name="l3985"><span class="ln">3985 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l3986"><span class="ln">3986 </span></a>    <span class="s2">conditions </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3987"><span class="ln">3987 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3988"><span class="ln">3988 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3989"><span class="ln">3989 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; !</span><span class="s2">doc </span><span class="s1">&amp;&amp; !</span><span class="s2">options </span><span class="s1">&amp;&amp; !</span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l3990"><span class="ln">3990 </span></a>    <span class="s3">// .update(doc)</span>
<a name="l3991"><span class="ln">3991 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l3992"><span class="ln">3992 </span></a>    <span class="s2">conditions </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3993"><span class="ln">3993 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3994"><span class="ln">3994 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l3995"><span class="ln">3995 </span></a>  <span class="s1">}</span>
<a name="l3996"><span class="ln">3996 </span></a>
<a name="l3997"><span class="ln">3997 </span></a>  <span class="s4">return </span><span class="s2">_update</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'updateOne'</span><span class="s1">, </span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
<a name="l3998"><span class="ln">3998 </span></a><span class="s1">};</span>
<a name="l3999"><span class="ln">3999 </span></a>
<a name="l4000"><span class="ln">4000 </span></a><span class="s5">/**</span>
<a name="l4001"><span class="ln">4001 </span></a> <span class="s5">* Declare and/or execute this query as a replaceOne() operation.</span>
<a name="l4002"><span class="ln">4002 </span></a> <span class="s5">* MongoDB will replace the existing document and will not accept any [atomic operators](https://www.mongodb.com/docs/manual/tutorial/model-data-for-atomic-operations/#pattern) (`$set`, etc.)</span>
<a name="l4003"><span class="ln">4003 </span></a> <span class="s5">*</span>
<a name="l4004"><span class="ln">4004 </span></a> <span class="s5">* **Note** replaceOne will _not_ fire update middleware. Use `pre('replaceOne')`</span>
<a name="l4005"><span class="ln">4005 </span></a> <span class="s5">* and `post('replaceOne')` instead.</span>
<a name="l4006"><span class="ln">4006 </span></a> <span class="s5">*</span>
<a name="l4007"><span class="ln">4007 </span></a> <span class="s5">* #### Example:</span>
<a name="l4008"><span class="ln">4008 </span></a> <span class="s5">*</span>
<a name="l4009"><span class="ln">4009 </span></a> <span class="s5">*     const res = await Person.replaceOne({ _id: 24601 }, { name: 'Jean Valjean' });</span>
<a name="l4010"><span class="ln">4010 </span></a> <span class="s5">*     res.acknowledged; // Indicates if this write result was acknowledged. If not, then all other members of this result will be undefined.</span>
<a name="l4011"><span class="ln">4011 </span></a> <span class="s5">*     res.matchedCount; // Number of documents that matched the filter</span>
<a name="l4012"><span class="ln">4012 </span></a> <span class="s5">*     res.modifiedCount; // Number of documents that were modified</span>
<a name="l4013"><span class="ln">4013 </span></a> <span class="s5">*     res.upsertedCount; // Number of documents that were upserted</span>
<a name="l4014"><span class="ln">4014 </span></a> <span class="s5">*     res.upsertedId; // Identifier of the inserted document (if an upsert took place)</span>
<a name="l4015"><span class="ln">4015 </span></a> <span class="s5">*</span>
<a name="l4016"><span class="ln">4016 </span></a> <span class="s5">* This function triggers the following middleware.</span>
<a name="l4017"><span class="ln">4017 </span></a> <span class="s5">*</span>
<a name="l4018"><span class="ln">4018 </span></a> <span class="s5">* - `replaceOne()`</span>
<a name="l4019"><span class="ln">4019 </span></a> <span class="s5">*</span>
<a name="l4020"><span class="ln">4020 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [filter]</span>
<a name="l4021"><span class="ln">4021 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [doc] the update command</span>
<a name="l4022"><span class="ln">4022 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l4023"><span class="ln">4023 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.multipleCastError] by default, mongoose only returns the first error that occurred in casting the query. Turn on this option to aggregate all the cast errors.</span>
<a name="l4024"><span class="ln">4024 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean|String} [options.strict] overwrites the schema's [strict mode option](https://mongoosejs.com/docs/guide.html#strict)</span>
<a name="l4025"><span class="ln">4025 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.upsert=false] if true, and no documents found, insert a new document</span>
<a name="l4026"><span class="ln">4026 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options.writeConcern=null] sets the [write concern](https://www.mongodb.com/docs/manual/reference/write-concern/) for replica sets. Overrides the [schema-level write concern](https://mongoosejs.com/docs/guide.html#writeConcern)</span>
<a name="l4027"><span class="ln">4027 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.timestamps=null] If set to `false` and [schema-level timestamps](https://mongoosejs.com/docs/guide.html#timestamps) are enabled, skip timestamps for this update. Does nothing if schema-level timestamps are not set.</span>
<a name="l4028"><span class="ln">4028 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [options.translateAliases=null] If set to `true`, translates any schema-defined aliases in `filter`, `projection`, `update`, and `distinct`. Throws an error if there are any conflicts where both alias and raw property are defined on the same object.</span>
<a name="l4029"><span class="ln">4029 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [callback] params are (error, writeOpResult)</span>
<a name="l4030"><span class="ln">4030 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l4031"><span class="ln">4031 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Model.update https://mongoosejs.com/docs/api/model.html#Model.update()</span>
<a name="l4032"><span class="ln">4032 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Query docs https://mongoosejs.com/docs/queries.html</span>
<a name="l4033"><span class="ln">4033 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">update https://www.mongodb.com/docs/manual/reference/method/db.collection.update/</span>
<a name="l4034"><span class="ln">4034 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">UpdateResult https://mongodb.github.io/node-mongodb-native/4.9/interfaces/UpdateResult.html</span>
<a name="l4035"><span class="ln">4035 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB docs https://www.mongodb.com/docs/manual/reference/command/update/#update-command-output</span>
<a name="l4036"><span class="ln">4036 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4037"><span class="ln">4037 </span></a> <span class="s5">*/</span>
<a name="l4038"><span class="ln">4038 </span></a>
<a name="l4039"><span class="ln">4039 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">replaceOne </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l4040"><span class="ln">4040 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l4041"><span class="ln">4041 </span></a>    <span class="s3">// .update(conditions, doc, callback)</span>
<a name="l4042"><span class="ln">4042 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
<a name="l4043"><span class="ln">4043 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l4044"><span class="ln">4044 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">doc </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l4045"><span class="ln">4045 </span></a>    <span class="s3">// .update(doc, callback);</span>
<a name="l4046"><span class="ln">4046 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">;</span>
<a name="l4047"><span class="ln">4047 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l4048"><span class="ln">4048 </span></a>    <span class="s2">conditions </span><span class="s1">= {};</span>
<a name="l4049"><span class="ln">4049 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l4050"><span class="ln">4050 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l4051"><span class="ln">4051 </span></a>    <span class="s3">// .update(callback)</span>
<a name="l4052"><span class="ln">4052 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l4053"><span class="ln">4053 </span></a>    <span class="s2">conditions </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l4054"><span class="ln">4054 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l4055"><span class="ln">4055 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l4056"><span class="ln">4056 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">conditions </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; !</span><span class="s2">doc </span><span class="s1">&amp;&amp; !</span><span class="s2">options </span><span class="s1">&amp;&amp; !</span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l4057"><span class="ln">4057 </span></a>    <span class="s3">// .update(doc)</span>
<a name="l4058"><span class="ln">4058 </span></a>    <span class="s2">doc </span><span class="s1">= </span><span class="s2">conditions</span><span class="s1">;</span>
<a name="l4059"><span class="ln">4059 </span></a>    <span class="s2">conditions </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l4060"><span class="ln">4060 </span></a>    <span class="s2">options </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l4061"><span class="ln">4061 </span></a>    <span class="s2">callback </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
<a name="l4062"><span class="ln">4062 </span></a>  <span class="s1">}</span>
<a name="l4063"><span class="ln">4063 </span></a>
<a name="l4064"><span class="ln">4064 </span></a>  <span class="s4">return </span><span class="s2">_update</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s0">'replaceOne'</span><span class="s1">, </span><span class="s2">conditions</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
<a name="l4065"><span class="ln">4065 </span></a><span class="s1">};</span>
<a name="l4066"><span class="ln">4066 </span></a>
<a name="l4067"><span class="ln">4067 </span></a><span class="s5">/**</span>
<a name="l4068"><span class="ln">4068 </span></a> <span class="s5">* Internal helper for update, updateMany, updateOne, replaceOne</span>
<a name="l4069"><span class="ln">4069 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Query} query</span>
<a name="l4070"><span class="ln">4070 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} op</span>
<a name="l4071"><span class="ln">4071 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} filter</span>
<a name="l4072"><span class="ln">4072 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Document} [doc]</span>
<a name="l4073"><span class="ln">4073 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l4074"><span class="ln">4074 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} callback</span>
<a name="l4075"><span class="ln">4075 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l4076"><span class="ln">4076 </span></a> <span class="s5">*/</span>
<a name="l4077"><span class="ln">4077 </span></a>
<a name="l4078"><span class="ln">4078 </span></a><span class="s4">function </span><span class="s2">_update</span><span class="s1">(</span><span class="s2">query</span><span class="s1">, </span><span class="s2">op</span><span class="s1">, </span><span class="s2">filter</span><span class="s1">, </span><span class="s2">doc</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l4079"><span class="ln">4079 </span></a>  <span class="s3">// make sure we don't send in the whole Document to merge()</span>
<a name="l4080"><span class="ln">4080 </span></a>  <span class="s2">query</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s2">op</span><span class="s1">;</span>
<a name="l4081"><span class="ln">4081 </span></a>  <span class="s2">query</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l4082"><span class="ln">4082 </span></a>  <span class="s2">doc </span><span class="s1">= </span><span class="s2">doc </span><span class="s1">|| {};</span>
<a name="l4083"><span class="ln">4083 </span></a>
<a name="l4084"><span class="ln">4084 </span></a>  <span class="s3">// strict is an option used in the update checking, make sure it gets set</span>
<a name="l4085"><span class="ln">4085 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">options </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4086"><span class="ln">4086 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s0">'strict' </span><span class="s4">in </span><span class="s2">options</span><span class="s1">) {</span>
<a name="l4087"><span class="ln">4087 </span></a>      <span class="s2">query</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">strict </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">strict</span><span class="s1">;</span>
<a name="l4088"><span class="ln">4088 </span></a>    <span class="s1">}</span>
<a name="l4089"><span class="ln">4089 </span></a>  <span class="s1">}</span>
<a name="l4090"><span class="ln">4090 </span></a>
<a name="l4091"><span class="ln">4091 </span></a>  <span class="s4">if </span><span class="s1">(!(</span><span class="s2">filter </span><span class="s4">instanceof </span><span class="s2">Query</span><span class="s1">) &amp;&amp;</span>
<a name="l4092"><span class="ln">4092 </span></a>      <span class="s2">filter </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp;</span>
<a name="l4093"><span class="ln">4093 </span></a>      <span class="s2">filter</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">() !== </span><span class="s0">'[object Object]'</span><span class="s1">) {</span>
<a name="l4094"><span class="ln">4094 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">error</span><span class="s1">(</span><span class="s4">new </span><span class="s2">ObjectParameterError</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s0">'filter'</span><span class="s1">, </span><span class="s2">op</span><span class="s1">));</span>
<a name="l4095"><span class="ln">4095 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l4096"><span class="ln">4096 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">merge</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">);</span>
<a name="l4097"><span class="ln">4097 </span></a>  <span class="s1">}</span>
<a name="l4098"><span class="ln">4098 </span></a>
<a name="l4099"><span class="ln">4099 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">utils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">options</span><span class="s1">)) {</span>
<a name="l4100"><span class="ln">4100 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
<a name="l4101"><span class="ln">4101 </span></a>  <span class="s1">}</span>
<a name="l4102"><span class="ln">4102 </span></a>
<a name="l4103"><span class="ln">4103 </span></a>  <span class="s2">query</span><span class="s1">.</span><span class="s2">_mergeUpdate</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">);</span>
<a name="l4104"><span class="ln">4104 </span></a>
<a name="l4105"><span class="ln">4105 </span></a>  <span class="s3">// Hooks</span>
<a name="l4106"><span class="ln">4106 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
<a name="l4107"><span class="ln">4107 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
<a name="l4108"><span class="ln">4108 </span></a>
<a name="l4109"><span class="ln">4109 </span></a>    <span class="s4">return </span><span class="s2">query</span><span class="s1">;</span>
<a name="l4110"><span class="ln">4110 </span></a>  <span class="s1">}</span>
<a name="l4111"><span class="ln">4111 </span></a>
<a name="l4112"><span class="ln">4112 </span></a>  <span class="s4">return </span><span class="s2">query</span><span class="s1">;</span>
<a name="l4113"><span class="ln">4113 </span></a><span class="s1">}</span>
<a name="l4114"><span class="ln">4114 </span></a>
<a name="l4115"><span class="ln">4115 </span></a><span class="s5">/**</span>
<a name="l4116"><span class="ln">4116 </span></a> <span class="s5">* Runs a function `fn` and treats the return value of `fn` as the new value</span>
<a name="l4117"><span class="ln">4117 </span></a> <span class="s5">* for the query to resolve to.</span>
<a name="l4118"><span class="ln">4118 </span></a> <span class="s5">*</span>
<a name="l4119"><span class="ln">4119 </span></a> <span class="s5">* Any functions you pass to `transform()` will run **after** any post hooks.</span>
<a name="l4120"><span class="ln">4120 </span></a> <span class="s5">*</span>
<a name="l4121"><span class="ln">4121 </span></a> <span class="s5">* #### Example:</span>
<a name="l4122"><span class="ln">4122 </span></a> <span class="s5">*</span>
<a name="l4123"><span class="ln">4123 </span></a> <span class="s5">*     const res = await MyModel.findOne().transform(res =&gt; {</span>
<a name="l4124"><span class="ln">4124 </span></a> <span class="s5">*       // Sets a `loadedAt` property on the doc that tells you the time the</span>
<a name="l4125"><span class="ln">4125 </span></a> <span class="s5">*       // document was loaded.</span>
<a name="l4126"><span class="ln">4126 </span></a> <span class="s5">*       return res == null ?</span>
<a name="l4127"><span class="ln">4127 </span></a> <span class="s5">*         res :</span>
<a name="l4128"><span class="ln">4128 </span></a> <span class="s5">*         Object.assign(res, { loadedAt: new Date() });</span>
<a name="l4129"><span class="ln">4129 </span></a> <span class="s5">*     });</span>
<a name="l4130"><span class="ln">4130 </span></a> <span class="s5">*</span>
<a name="l4131"><span class="ln">4131 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">transform</span>
<a name="l4132"><span class="ln">4132 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l4133"><span class="ln">4133 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l4134"><span class="ln">4134 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} fn function to run to transform the query result</span>
<a name="l4135"><span class="ln">4135 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l4136"><span class="ln">4136 </span></a> <span class="s5">*/</span>
<a name="l4137"><span class="ln">4137 </span></a>
<a name="l4138"><span class="ln">4138 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">transform </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">fn</span><span class="s1">) {</span>
<a name="l4139"><span class="ln">4139 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_transforms</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">fn</span><span class="s1">);</span>
<a name="l4140"><span class="ln">4140 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l4141"><span class="ln">4141 </span></a><span class="s1">};</span>
<a name="l4142"><span class="ln">4142 </span></a>
<a name="l4143"><span class="ln">4143 </span></a><span class="s5">/**</span>
<a name="l4144"><span class="ln">4144 </span></a> <span class="s5">* Make this query throw an error if no documents match the given `filter`.</span>
<a name="l4145"><span class="ln">4145 </span></a> <span class="s5">* This is handy for integrating with async/await, because `orFail()` saves you</span>
<a name="l4146"><span class="ln">4146 </span></a> <span class="s5">* an extra `if` statement to check if no document was found.</span>
<a name="l4147"><span class="ln">4147 </span></a> <span class="s5">*</span>
<a name="l4148"><span class="ln">4148 </span></a> <span class="s5">* #### Example:</span>
<a name="l4149"><span class="ln">4149 </span></a> <span class="s5">*</span>
<a name="l4150"><span class="ln">4150 </span></a> <span class="s5">*     // Throws if no doc returned</span>
<a name="l4151"><span class="ln">4151 </span></a> <span class="s5">*     await Model.findOne({ foo: 'bar' }).orFail();</span>
<a name="l4152"><span class="ln">4152 </span></a> <span class="s5">*</span>
<a name="l4153"><span class="ln">4153 </span></a> <span class="s5">*     // Throws if no document was updated. Note that `orFail()` will still</span>
<a name="l4154"><span class="ln">4154 </span></a> <span class="s5">*     // throw if the only document that matches is `{ foo: 'bar', name: 'test' }`,</span>
<a name="l4155"><span class="ln">4155 </span></a> <span class="s5">*     // because `orFail()` will throw if no document was _updated_, not</span>
<a name="l4156"><span class="ln">4156 </span></a> <span class="s5">*     // if no document was _found_.</span>
<a name="l4157"><span class="ln">4157 </span></a> <span class="s5">*     await Model.updateOne({ foo: 'bar' }, { name: 'test' }).orFail();</span>
<a name="l4158"><span class="ln">4158 </span></a> <span class="s5">*</span>
<a name="l4159"><span class="ln">4159 </span></a> <span class="s5">*     // Throws &quot;No docs found!&quot; error if no docs match `{ foo: 'bar' }`</span>
<a name="l4160"><span class="ln">4160 </span></a> <span class="s5">*     await Model.find({ foo: 'bar' }).orFail(new Error('No docs found!'));</span>
<a name="l4161"><span class="ln">4161 </span></a> <span class="s5">*</span>
<a name="l4162"><span class="ln">4162 </span></a> <span class="s5">*     // Throws &quot;Not found&quot; error if no document was found</span>
<a name="l4163"><span class="ln">4163 </span></a> <span class="s5">*     await Model.findOneAndUpdate({ foo: 'bar' }, { name: 'test' }).</span>
<a name="l4164"><span class="ln">4164 </span></a> <span class="s5">*       orFail(() =&gt; Error('Not found'));</span>
<a name="l4165"><span class="ln">4165 </span></a> <span class="s5">*</span>
<a name="l4166"><span class="ln">4166 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">orFail</span>
<a name="l4167"><span class="ln">4167 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l4168"><span class="ln">4168 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l4169"><span class="ln">4169 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function|Error} [err] optional error to throw if no docs match `filter`. If not specified, `orFail()` will throw a `DocumentNotFoundError`</span>
<a name="l4170"><span class="ln">4170 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l4171"><span class="ln">4171 </span></a> <span class="s5">*/</span>
<a name="l4172"><span class="ln">4172 </span></a>
<a name="l4173"><span class="ln">4173 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">orFail </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l4174"><span class="ln">4174 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">(</span><span class="s2">res </span><span class="s1">=&gt; {</span>
<a name="l4175"><span class="ln">4175 </span></a>    <span class="s4">switch </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">) {</span>
<a name="l4176"><span class="ln">4176 </span></a>      <span class="s4">case </span><span class="s0">'find'</span><span class="s1">:</span>
<a name="l4177"><span class="ln">4177 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">res</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l4178"><span class="ln">4178 </span></a>          <span class="s4">throw </span><span class="s2">_orFailError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s4">this</span><span class="s1">);</span>
<a name="l4179"><span class="ln">4179 </span></a>        <span class="s1">}</span>
<a name="l4180"><span class="ln">4180 </span></a>        <span class="s4">break</span><span class="s1">;</span>
<a name="l4181"><span class="ln">4181 </span></a>      <span class="s4">case </span><span class="s0">'findOne'</span><span class="s1">:</span>
<a name="l4182"><span class="ln">4182 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">res </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4183"><span class="ln">4183 </span></a>          <span class="s4">throw </span><span class="s2">_orFailError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s4">this</span><span class="s1">);</span>
<a name="l4184"><span class="ln">4184 </span></a>        <span class="s1">}</span>
<a name="l4185"><span class="ln">4185 </span></a>        <span class="s4">break</span><span class="s1">;</span>
<a name="l4186"><span class="ln">4186 </span></a>      <span class="s4">case </span><span class="s0">'replaceOne'</span><span class="s1">:</span>
<a name="l4187"><span class="ln">4187 </span></a>      <span class="s4">case </span><span class="s0">'updateMany'</span><span class="s1">:</span>
<a name="l4188"><span class="ln">4188 </span></a>      <span class="s4">case </span><span class="s0">'updateOne'</span><span class="s1">:</span>
<a name="l4189"><span class="ln">4189 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">res </span><span class="s1">&amp;&amp; </span><span class="s2">res</span><span class="s1">.</span><span class="s2">matchedCount </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l4190"><span class="ln">4190 </span></a>          <span class="s4">throw </span><span class="s2">_orFailError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s4">this</span><span class="s1">);</span>
<a name="l4191"><span class="ln">4191 </span></a>        <span class="s1">}</span>
<a name="l4192"><span class="ln">4192 </span></a>        <span class="s4">break</span><span class="s1">;</span>
<a name="l4193"><span class="ln">4193 </span></a>      <span class="s4">case </span><span class="s0">'findOneAndDelete'</span><span class="s1">:</span>
<a name="l4194"><span class="ln">4194 </span></a>      <span class="s4">case </span><span class="s0">'findOneAndUpdate'</span><span class="s1">:</span>
<a name="l4195"><span class="ln">4195 </span></a>      <span class="s4">case </span><span class="s0">'findOneAndReplace'</span><span class="s1">:</span>
<a name="l4196"><span class="ln">4196 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata </span><span class="s1">&amp;&amp; </span><span class="s2">res </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s2">res</span><span class="s1">.</span><span class="s2">value </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4197"><span class="ln">4197 </span></a>          <span class="s4">throw </span><span class="s2">_orFailError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s4">this</span><span class="s1">);</span>
<a name="l4198"><span class="ln">4198 </span></a>        <span class="s1">}</span>
<a name="l4199"><span class="ln">4199 </span></a>        <span class="s4">if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeResultMetadata </span><span class="s1">&amp;&amp; </span><span class="s2">res </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4200"><span class="ln">4200 </span></a>          <span class="s4">throw </span><span class="s2">_orFailError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s4">this</span><span class="s1">);</span>
<a name="l4201"><span class="ln">4201 </span></a>        <span class="s1">}</span>
<a name="l4202"><span class="ln">4202 </span></a>        <span class="s4">break</span><span class="s1">;</span>
<a name="l4203"><span class="ln">4203 </span></a>      <span class="s4">case </span><span class="s0">'deleteMany'</span><span class="s1">:</span>
<a name="l4204"><span class="ln">4204 </span></a>      <span class="s4">case </span><span class="s0">'deleteOne'</span><span class="s1">:</span>
<a name="l4205"><span class="ln">4205 </span></a>        <span class="s4">if </span><span class="s1">(</span><span class="s2">res</span><span class="s1">.</span><span class="s2">deletedCount </span><span class="s1">=== </span><span class="s7">0</span><span class="s1">) {</span>
<a name="l4206"><span class="ln">4206 </span></a>          <span class="s4">throw </span><span class="s2">_orFailError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s4">this</span><span class="s1">);</span>
<a name="l4207"><span class="ln">4207 </span></a>        <span class="s1">}</span>
<a name="l4208"><span class="ln">4208 </span></a>        <span class="s4">break</span><span class="s1">;</span>
<a name="l4209"><span class="ln">4209 </span></a>      <span class="s4">default</span><span class="s1">:</span>
<a name="l4210"><span class="ln">4210 </span></a>        <span class="s4">break</span><span class="s1">;</span>
<a name="l4211"><span class="ln">4211 </span></a>    <span class="s1">}</span>
<a name="l4212"><span class="ln">4212 </span></a>
<a name="l4213"><span class="ln">4213 </span></a>    <span class="s4">return </span><span class="s2">res</span><span class="s1">;</span>
<a name="l4214"><span class="ln">4214 </span></a>  <span class="s1">});</span>
<a name="l4215"><span class="ln">4215 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l4216"><span class="ln">4216 </span></a><span class="s1">};</span>
<a name="l4217"><span class="ln">4217 </span></a>
<a name="l4218"><span class="ln">4218 </span></a><span class="s5">/**</span>
<a name="l4219"><span class="ln">4219 </span></a> <span class="s5">* Get the error to throw for `orFail()`</span>
<a name="l4220"><span class="ln">4220 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Error|undefined} err</span>
<a name="l4221"><span class="ln">4221 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Query} query</span>
<a name="l4222"><span class="ln">4222 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l4223"><span class="ln">4223 </span></a> <span class="s5">*/</span>
<a name="l4224"><span class="ln">4224 </span></a>
<a name="l4225"><span class="ln">4225 </span></a><span class="s4">function </span><span class="s2">_orFailError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">query</span><span class="s1">) {</span>
<a name="l4226"><span class="ln">4226 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">err </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l4227"><span class="ln">4227 </span></a>    <span class="s2">err </span><span class="s1">= </span><span class="s2">err</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">query</span><span class="s1">);</span>
<a name="l4228"><span class="ln">4228 </span></a>  <span class="s1">}</span>
<a name="l4229"><span class="ln">4229 </span></a>
<a name="l4230"><span class="ln">4230 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">err </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4231"><span class="ln">4231 </span></a>    <span class="s2">err </span><span class="s1">= </span><span class="s4">new </span><span class="s2">DocumentNotFoundError</span><span class="s1">(</span><span class="s2">query</span><span class="s1">.</span><span class="s2">getQuery</span><span class="s1">(), </span><span class="s2">query</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">modelName</span><span class="s1">);</span>
<a name="l4232"><span class="ln">4232 </span></a>  <span class="s1">}</span>
<a name="l4233"><span class="ln">4233 </span></a>
<a name="l4234"><span class="ln">4234 </span></a>  <span class="s4">return </span><span class="s2">err</span><span class="s1">;</span>
<a name="l4235"><span class="ln">4235 </span></a><span class="s1">}</span>
<a name="l4236"><span class="ln">4236 </span></a>
<a name="l4237"><span class="ln">4237 </span></a><span class="s5">/**</span>
<a name="l4238"><span class="ln">4238 </span></a> <span class="s5">* Wrapper function to call isPathSelectedInclusive on a query.</span>
<a name="l4239"><span class="ln">4239 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} path</span>
<a name="l4240"><span class="ln">4240 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Boolean}</span>
<a name="l4241"><span class="ln">4241 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4242"><span class="ln">4242 </span></a> <span class="s5">*/</span>
<a name="l4243"><span class="ln">4243 </span></a>
<a name="l4244"><span class="ln">4244 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">isPathSelectedInclusive </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
<a name="l4245"><span class="ln">4245 </span></a>  <span class="s4">return </span><span class="s2">isPathSelectedInclusive</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">, </span><span class="s2">path</span><span class="s1">);</span>
<a name="l4246"><span class="ln">4246 </span></a><span class="s1">};</span>
<a name="l4247"><span class="ln">4247 </span></a>
<a name="l4248"><span class="ln">4248 </span></a><span class="s5">/**</span>
<a name="l4249"><span class="ln">4249 </span></a> <span class="s5">* Executes the query</span>
<a name="l4250"><span class="ln">4250 </span></a> <span class="s5">*</span>
<a name="l4251"><span class="ln">4251 </span></a> <span class="s5">* #### Example:</span>
<a name="l4252"><span class="ln">4252 </span></a> <span class="s5">*</span>
<a name="l4253"><span class="ln">4253 </span></a> <span class="s5">*     const promise = query.exec();</span>
<a name="l4254"><span class="ln">4254 </span></a> <span class="s5">*     const promise = query.exec('update');</span>
<a name="l4255"><span class="ln">4255 </span></a> <span class="s5">*</span>
<a name="l4256"><span class="ln">4256 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|Function} [operation]</span>
<a name="l4257"><span class="ln">4257 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise}</span>
<a name="l4258"><span class="ln">4258 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4259"><span class="ln">4259 </span></a> <span class="s5">*/</span>
<a name="l4260"><span class="ln">4260 </span></a>
<a name="l4261"><span class="ln">4261 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">exec </span><span class="s1">= </span><span class="s2">async </span><span class="s4">function </span><span class="s2">exec</span><span class="s1">(</span><span class="s2">op</span><span class="s1">) {</span>
<a name="l4262"><span class="ln">4262 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">|| (</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt;= </span><span class="s7">2 </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] === </span><span class="s0">'function'</span><span class="s1">)) {</span>
<a name="l4263"><span class="ln">4263 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query.prototype.exec() no longer accepts a callback'</span><span class="s1">);</span>
<a name="l4264"><span class="ln">4264 </span></a>  <span class="s1">}</span>
<a name="l4265"><span class="ln">4265 </span></a>
<a name="l4266"><span class="ln">4266 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l4267"><span class="ln">4267 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">= </span><span class="s2">op</span><span class="s1">;</span>
<a name="l4268"><span class="ln">4268 </span></a>  <span class="s1">}</span>
<a name="l4269"><span class="ln">4269 </span></a>
<a name="l4270"><span class="ln">4270 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4271"><span class="ln">4271 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query must have `op` before executing'</span><span class="s1">);</span>
<a name="l4272"><span class="ln">4272 </span></a>  <span class="s1">}</span>
<a name="l4273"><span class="ln">4273 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4274"><span class="ln">4274 </span></a>    <span class="s4">throw new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query must have an associated model before executing'</span><span class="s1">);</span>
<a name="l4275"><span class="ln">4275 </span></a>  <span class="s1">}</span>
<a name="l4276"><span class="ln">4276 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_validateOp</span><span class="s1">();</span>
<a name="l4277"><span class="ln">4277 </span></a>
<a name="l4278"><span class="ln">4278 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">) {</span>
<a name="l4279"><span class="ln">4279 </span></a>    <span class="s4">return</span><span class="s1">;</span>
<a name="l4280"><span class="ln">4280 </span></a>  <span class="s1">}</span>
<a name="l4281"><span class="ln">4281 </span></a>
<a name="l4282"><span class="ln">4282 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">) {</span>
<a name="l4283"><span class="ln">4283 </span></a>    <span class="s4">const </span><span class="s2">keys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">);</span>
<a name="l4284"><span class="ln">4284 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">keys</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">''</span><span class="s1">)) {</span>
<a name="l4285"><span class="ln">4285 </span></a>      <span class="s4">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Invalid field &quot;&quot; passed to sort()'</span><span class="s1">);</span>
<a name="l4286"><span class="ln">4286 </span></a>    <span class="s1">}</span>
<a name="l4287"><span class="ln">4287 </span></a>  <span class="s1">}</span>
<a name="l4288"><span class="ln">4288 </span></a>
<a name="l4289"><span class="ln">4289 </span></a>  <span class="s4">let </span><span class="s2">thunk </span><span class="s1">= </span><span class="s0">'_' </span><span class="s1">+ </span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">;</span>
<a name="l4290"><span class="ln">4290 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op </span><span class="s1">=== </span><span class="s0">'distinct'</span><span class="s1">) {</span>
<a name="l4291"><span class="ln">4291 </span></a>    <span class="s2">thunk </span><span class="s1">= </span><span class="s0">'__distinct'</span><span class="s1">;</span>
<a name="l4292"><span class="ln">4292 </span></a>  <span class="s1">}</span>
<a name="l4293"><span class="ln">4293 </span></a>
<a name="l4294"><span class="ln">4294 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_executionStack </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4295"><span class="ln">4295 </span></a>    <span class="s4">let </span><span class="s2">str </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">();</span>
<a name="l4296"><span class="ln">4296 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s7">60</span><span class="s1">) {</span>
<a name="l4297"><span class="ln">4297 </span></a>      <span class="s2">str </span><span class="s1">= </span><span class="s2">str</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s7">60</span><span class="s1">) + </span><span class="s0">'...'</span><span class="s1">;</span>
<a name="l4298"><span class="ln">4298 </span></a>    <span class="s1">}</span>
<a name="l4299"><span class="ln">4299 </span></a>    <span class="s4">const </span><span class="s2">err </span><span class="s1">= </span><span class="s4">new </span><span class="s2">MongooseError</span><span class="s1">(</span><span class="s0">'Query was already executed: ' </span><span class="s1">+ </span><span class="s2">str</span><span class="s1">);</span>
<a name="l4300"><span class="ln">4300 </span></a>    <span class="s2">err</span><span class="s1">.</span><span class="s2">originalStack </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_executionStack</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">;</span>
<a name="l4301"><span class="ln">4301 </span></a>    <span class="s4">throw </span><span class="s2">err</span><span class="s1">;</span>
<a name="l4302"><span class="ln">4302 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l4303"><span class="ln">4303 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">_executionStack </span><span class="s1">= </span><span class="s4">new </span><span class="s2">Error</span><span class="s1">();</span>
<a name="l4304"><span class="ln">4304 </span></a>  <span class="s1">}</span>
<a name="l4305"><span class="ln">4305 </span></a>
<a name="l4306"><span class="ln">4306 </span></a>  <span class="s4">let </span><span class="s2">skipWrappedFunction </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l4307"><span class="ln">4307 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l4308"><span class="ln">4308 </span></a>    <span class="s4">await </span><span class="s2">_executePreExecHooks</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l4309"><span class="ln">4309 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l4310"><span class="ln">4310 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">err </span><span class="s4">instanceof </span><span class="s2">Kareem</span><span class="s1">.</span><span class="s2">skipWrappedFunction</span><span class="s1">) {</span>
<a name="l4311"><span class="ln">4311 </span></a>      <span class="s2">skipWrappedFunction </span><span class="s1">= </span><span class="s2">err</span><span class="s1">;</span>
<a name="l4312"><span class="ln">4312 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l4313"><span class="ln">4313 </span></a>      <span class="s4">throw </span><span class="s2">err</span><span class="s1">;</span>
<a name="l4314"><span class="ln">4314 </span></a>    <span class="s1">}</span>
<a name="l4315"><span class="ln">4315 </span></a>  <span class="s1">}</span>
<a name="l4316"><span class="ln">4316 </span></a>
<a name="l4317"><span class="ln">4317 </span></a>  <span class="s4">let </span><span class="s2">res</span><span class="s1">;</span>
<a name="l4318"><span class="ln">4318 </span></a>
<a name="l4319"><span class="ln">4319 </span></a>  <span class="s4">let </span><span class="s2">error </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
<a name="l4320"><span class="ln">4320 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l4321"><span class="ln">4321 </span></a>    <span class="s4">await </span><span class="s2">_executePreHooks</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l4322"><span class="ln">4322 </span></a>    <span class="s2">res </span><span class="s1">= </span><span class="s2">skipWrappedFunction </span><span class="s1">? </span><span class="s2">skipWrappedFunction</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] : </span><span class="s4">await this</span><span class="s1">[</span><span class="s2">thunk</span><span class="s1">]();</span>
<a name="l4323"><span class="ln">4323 </span></a>
<a name="l4324"><span class="ln">4324 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">fn of </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_transforms</span><span class="s1">) {</span>
<a name="l4325"><span class="ln">4325 </span></a>      <span class="s2">res </span><span class="s1">= </span><span class="s2">fn</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l4326"><span class="ln">4326 </span></a>    <span class="s1">}</span>
<a name="l4327"><span class="ln">4327 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l4328"><span class="ln">4328 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">err </span><span class="s4">instanceof </span><span class="s2">Kareem</span><span class="s1">.</span><span class="s2">skipWrappedFunction</span><span class="s1">) {</span>
<a name="l4329"><span class="ln">4329 </span></a>      <span class="s2">res </span><span class="s1">= </span><span class="s2">err</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s7">0</span><span class="s1">];</span>
<a name="l4330"><span class="ln">4330 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l4331"><span class="ln">4331 </span></a>      <span class="s2">error </span><span class="s1">= </span><span class="s2">err</span><span class="s1">;</span>
<a name="l4332"><span class="ln">4332 </span></a>    <span class="s1">}</span>
<a name="l4333"><span class="ln">4333 </span></a>  <span class="s1">}</span>
<a name="l4334"><span class="ln">4334 </span></a>
<a name="l4335"><span class="ln">4335 </span></a>  <span class="s2">res </span><span class="s1">= </span><span class="s4">await </span><span class="s2">_executePostHooks</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">error</span><span class="s1">);</span>
<a name="l4336"><span class="ln">4336 </span></a>
<a name="l4337"><span class="ln">4337 </span></a>  <span class="s4">await </span><span class="s2">_executePostExecHooks</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l4338"><span class="ln">4338 </span></a>
<a name="l4339"><span class="ln">4339 </span></a>  <span class="s4">return </span><span class="s2">res</span><span class="s1">;</span>
<a name="l4340"><span class="ln">4340 </span></a><span class="s1">};</span>
<a name="l4341"><span class="ln">4341 </span></a>
<a name="l4342"><span class="ln">4342 </span></a><span class="s3">/*! 
<a name="l4343"><span class="ln">4343 </span></a> * ignore 
<a name="l4344"><span class="ln">4344 </span></a> */</span>
<a name="l4345"><span class="ln">4345 </span></a>
<a name="l4346"><span class="ln">4346 </span></a><span class="s4">function </span><span class="s2">_executePostExecHooks</span><span class="s1">(</span><span class="s2">query</span><span class="s1">) {</span>
<a name="l4347"><span class="ln">4347 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l4348"><span class="ln">4348 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">_hooks</span><span class="s1">.</span><span class="s2">execPost</span><span class="s1">(</span><span class="s0">'exec'</span><span class="s1">, </span><span class="s2">query</span><span class="s1">, [], {}, (</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
<a name="l4349"><span class="ln">4349 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
<a name="l4350"><span class="ln">4350 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
<a name="l4351"><span class="ln">4351 </span></a>      <span class="s1">}</span>
<a name="l4352"><span class="ln">4352 </span></a>
<a name="l4353"><span class="ln">4353 </span></a>      <span class="s2">resolve</span><span class="s1">();</span>
<a name="l4354"><span class="ln">4354 </span></a>    <span class="s1">});</span>
<a name="l4355"><span class="ln">4355 </span></a>  <span class="s1">});</span>
<a name="l4356"><span class="ln">4356 </span></a><span class="s1">}</span>
<a name="l4357"><span class="ln">4357 </span></a>
<a name="l4358"><span class="ln">4358 </span></a><span class="s3">/*! 
<a name="l4359"><span class="ln">4359 </span></a> * ignore 
<a name="l4360"><span class="ln">4360 </span></a> */</span>
<a name="l4361"><span class="ln">4361 </span></a>
<a name="l4362"><span class="ln">4362 </span></a><span class="s4">function </span><span class="s2">_executePostHooks</span><span class="s1">(</span><span class="s2">query</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">error</span><span class="s1">, </span><span class="s2">op</span><span class="s1">) {</span>
<a name="l4363"><span class="ln">4363 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">query</span><span class="s1">.</span><span class="s2">_queryMiddleware </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4364"><span class="ln">4364 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">error </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4365"><span class="ln">4365 </span></a>      <span class="s4">throw </span><span class="s2">error</span><span class="s1">;</span>
<a name="l4366"><span class="ln">4366 </span></a>    <span class="s1">}</span>
<a name="l4367"><span class="ln">4367 </span></a>    <span class="s4">return </span><span class="s2">res</span><span class="s1">;</span>
<a name="l4368"><span class="ln">4368 </span></a>  <span class="s1">}</span>
<a name="l4369"><span class="ln">4369 </span></a>
<a name="l4370"><span class="ln">4370 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l4371"><span class="ln">4371 </span></a>    <span class="s4">const </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">error </span><span class="s1">? { </span><span class="s2">error </span><span class="s1">} : {};</span>
<a name="l4372"><span class="ln">4372 </span></a>
<a name="l4373"><span class="ln">4373 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">_queryMiddleware</span><span class="s1">.</span><span class="s2">execPost</span><span class="s1">(</span><span class="s2">op </span><span class="s1">|| </span><span class="s2">query</span><span class="s1">.</span><span class="s2">op</span><span class="s1">, </span><span class="s2">query</span><span class="s1">, [</span><span class="s2">res</span><span class="s1">], </span><span class="s2">opts</span><span class="s1">, (</span><span class="s2">error</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
<a name="l4374"><span class="ln">4374 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
<a name="l4375"><span class="ln">4375 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
<a name="l4376"><span class="ln">4376 </span></a>      <span class="s1">}</span>
<a name="l4377"><span class="ln">4377 </span></a>
<a name="l4378"><span class="ln">4378 </span></a>      <span class="s2">resolve</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
<a name="l4379"><span class="ln">4379 </span></a>    <span class="s1">});</span>
<a name="l4380"><span class="ln">4380 </span></a>  <span class="s1">});</span>
<a name="l4381"><span class="ln">4381 </span></a><span class="s1">}</span>
<a name="l4382"><span class="ln">4382 </span></a>
<a name="l4383"><span class="ln">4383 </span></a><span class="s3">/*! 
<a name="l4384"><span class="ln">4384 </span></a> * ignore 
<a name="l4385"><span class="ln">4385 </span></a> */</span>
<a name="l4386"><span class="ln">4386 </span></a>
<a name="l4387"><span class="ln">4387 </span></a><span class="s4">function </span><span class="s2">_executePreExecHooks</span><span class="s1">(</span><span class="s2">query</span><span class="s1">) {</span>
<a name="l4388"><span class="ln">4388 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l4389"><span class="ln">4389 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">_hooks</span><span class="s1">.</span><span class="s2">execPre</span><span class="s1">(</span><span class="s0">'exec'</span><span class="s1">, </span><span class="s2">query</span><span class="s1">, [], (</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
<a name="l4390"><span class="ln">4390 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">error </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4391"><span class="ln">4391 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
<a name="l4392"><span class="ln">4392 </span></a>      <span class="s1">}</span>
<a name="l4393"><span class="ln">4393 </span></a>      <span class="s2">resolve</span><span class="s1">();</span>
<a name="l4394"><span class="ln">4394 </span></a>    <span class="s1">});</span>
<a name="l4395"><span class="ln">4395 </span></a>  <span class="s1">});</span>
<a name="l4396"><span class="ln">4396 </span></a><span class="s1">}</span>
<a name="l4397"><span class="ln">4397 </span></a>
<a name="l4398"><span class="ln">4398 </span></a><span class="s3">/*! 
<a name="l4399"><span class="ln">4399 </span></a> * ignore 
<a name="l4400"><span class="ln">4400 </span></a> */</span>
<a name="l4401"><span class="ln">4401 </span></a>
<a name="l4402"><span class="ln">4402 </span></a><span class="s4">function </span><span class="s2">_executePreHooks</span><span class="s1">(</span><span class="s2">query</span><span class="s1">, </span><span class="s2">op</span><span class="s1">) {</span>
<a name="l4403"><span class="ln">4403 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">query</span><span class="s1">.</span><span class="s2">_queryMiddleware </span><span class="s1">== </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4404"><span class="ln">4404 </span></a>    <span class="s4">return</span><span class="s1">;</span>
<a name="l4405"><span class="ln">4405 </span></a>  <span class="s1">}</span>
<a name="l4406"><span class="ln">4406 </span></a>
<a name="l4407"><span class="ln">4407 </span></a>  <span class="s4">return new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
<a name="l4408"><span class="ln">4408 </span></a>    <span class="s2">query</span><span class="s1">.</span><span class="s2">_queryMiddleware</span><span class="s1">.</span><span class="s2">execPre</span><span class="s1">(</span><span class="s2">op </span><span class="s1">|| </span><span class="s2">query</span><span class="s1">.</span><span class="s2">op</span><span class="s1">, </span><span class="s2">query</span><span class="s1">, [], (</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
<a name="l4409"><span class="ln">4409 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">error </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4410"><span class="ln">4410 </span></a>        <span class="s4">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
<a name="l4411"><span class="ln">4411 </span></a>      <span class="s1">}</span>
<a name="l4412"><span class="ln">4412 </span></a>      <span class="s2">resolve</span><span class="s1">();</span>
<a name="l4413"><span class="ln">4413 </span></a>    <span class="s1">});</span>
<a name="l4414"><span class="ln">4414 </span></a>  <span class="s1">});</span>
<a name="l4415"><span class="ln">4415 </span></a><span class="s1">}</span>
<a name="l4416"><span class="ln">4416 </span></a>
<a name="l4417"><span class="ln">4417 </span></a><span class="s5">/**</span>
<a name="l4418"><span class="ln">4418 </span></a> <span class="s5">* Executes the query returning a `Promise` which will be</span>
<a name="l4419"><span class="ln">4419 </span></a> <span class="s5">* resolved with either the doc(s) or rejected with the error.</span>
<a name="l4420"><span class="ln">4420 </span></a> <span class="s5">*</span>
<a name="l4421"><span class="ln">4421 </span></a> <span class="s5">* More about [`then()` in JavaScript](https://masteringjs.io/tutorials/fundamentals/then).</span>
<a name="l4422"><span class="ln">4422 </span></a> <span class="s5">*</span>
<a name="l4423"><span class="ln">4423 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [resolve]</span>
<a name="l4424"><span class="ln">4424 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [reject]</span>
<a name="l4425"><span class="ln">4425 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise}</span>
<a name="l4426"><span class="ln">4426 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4427"><span class="ln">4427 </span></a> <span class="s5">*/</span>
<a name="l4428"><span class="ln">4428 </span></a>
<a name="l4429"><span class="ln">4429 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">then </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) {</span>
<a name="l4430"><span class="ln">4430 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">exec</span><span class="s1">().</span><span class="s2">then</span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">);</span>
<a name="l4431"><span class="ln">4431 </span></a><span class="s1">};</span>
<a name="l4432"><span class="ln">4432 </span></a>
<a name="l4433"><span class="ln">4433 </span></a><span class="s5">/**</span>
<a name="l4434"><span class="ln">4434 </span></a> <span class="s5">* Executes the query returning a `Promise` which will be</span>
<a name="l4435"><span class="ln">4435 </span></a> <span class="s5">* resolved with either the doc(s) or rejected with the error.</span>
<a name="l4436"><span class="ln">4436 </span></a> <span class="s5">* Like `.then()`, but only takes a rejection handler.</span>
<a name="l4437"><span class="ln">4437 </span></a> <span class="s5">*</span>
<a name="l4438"><span class="ln">4438 </span></a> <span class="s5">* More about [Promise `catch()` in JavaScript](https://masteringjs.io/tutorials/fundamentals/catch).</span>
<a name="l4439"><span class="ln">4439 </span></a> <span class="s5">*</span>
<a name="l4440"><span class="ln">4440 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [reject]</span>
<a name="l4441"><span class="ln">4441 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise}</span>
<a name="l4442"><span class="ln">4442 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4443"><span class="ln">4443 </span></a> <span class="s5">*/</span>
<a name="l4444"><span class="ln">4444 </span></a>
<a name="l4445"><span class="ln">4445 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">catch </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">reject</span><span class="s1">) {</span>
<a name="l4446"><span class="ln">4446 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">exec</span><span class="s1">().</span><span class="s2">then</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">);</span>
<a name="l4447"><span class="ln">4447 </span></a><span class="s1">};</span>
<a name="l4448"><span class="ln">4448 </span></a>
<a name="l4449"><span class="ln">4449 </span></a><span class="s5">/**</span>
<a name="l4450"><span class="ln">4450 </span></a> <span class="s5">* Executes the query returning a `Promise` which will be</span>
<a name="l4451"><span class="ln">4451 </span></a> <span class="s5">* resolved with `.finally()` chained.</span>
<a name="l4452"><span class="ln">4452 </span></a> <span class="s5">*</span>
<a name="l4453"><span class="ln">4453 </span></a> <span class="s5">* More about [Promise `finally()` in JavaScript](https://thecodebarbarian.com/using-promise-finally-in-node-js.html).</span>
<a name="l4454"><span class="ln">4454 </span></a> <span class="s5">*</span>
<a name="l4455"><span class="ln">4455 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [onFinally]</span>
<a name="l4456"><span class="ln">4456 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise}</span>
<a name="l4457"><span class="ln">4457 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4458"><span class="ln">4458 </span></a> <span class="s5">*/</span>
<a name="l4459"><span class="ln">4459 </span></a>
<a name="l4460"><span class="ln">4460 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">finally </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">onFinally</span><span class="s1">) {</span>
<a name="l4461"><span class="ln">4461 </span></a>  <span class="s4">return this</span><span class="s1">.</span><span class="s2">exec</span><span class="s1">().</span><span class="s2">finally</span><span class="s1">(</span><span class="s2">onFinally</span><span class="s1">);</span>
<a name="l4462"><span class="ln">4462 </span></a><span class="s1">};</span>
<a name="l4463"><span class="ln">4463 </span></a>
<a name="l4464"><span class="ln">4464 </span></a><span class="s5">/**</span>
<a name="l4465"><span class="ln">4465 </span></a> <span class="s5">* Returns a string representation of this query.</span>
<a name="l4466"><span class="ln">4466 </span></a> <span class="s5">*</span>
<a name="l4467"><span class="ln">4467 </span></a> <span class="s5">* More about [`toString()` in JavaScript](https://masteringjs.io/tutorials/fundamentals/tostring).</span>
<a name="l4468"><span class="ln">4468 </span></a> <span class="s5">*</span>
<a name="l4469"><span class="ln">4469 </span></a> <span class="s5">* #### Example:</span>
<a name="l4470"><span class="ln">4470 </span></a> <span class="s5">*     const q = Model.find();</span>
<a name="l4471"><span class="ln">4471 </span></a> <span class="s5">*     console.log(q); // Prints &quot;Query { find }&quot;</span>
<a name="l4472"><span class="ln">4472 </span></a> <span class="s5">*</span>
<a name="l4473"><span class="ln">4473 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{String}</span>
<a name="l4474"><span class="ln">4474 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4475"><span class="ln">4475 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">[Symbol.toStringTag]</span>
<a name="l4476"><span class="ln">4476 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l4477"><span class="ln">4477 </span></a> <span class="s5">*/</span>
<a name="l4478"><span class="ln">4478 </span></a>
<a name="l4479"><span class="ln">4479 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">[</span><span class="s2">Symbol</span><span class="s1">.</span><span class="s2">toStringTag</span><span class="s1">] = </span><span class="s4">function </span><span class="s2">toString</span><span class="s1">() {</span>
<a name="l4480"><span class="ln">4480 </span></a>  <span class="s4">return </span><span class="s0">`Query { </span><span class="s2">$</span><span class="s1">{</span><span class="s4">this</span><span class="s1">.</span><span class="s2">op</span><span class="s1">} </span><span class="s0">}`</span><span class="s1">;</span>
<a name="l4481"><span class="ln">4481 </span></a><span class="s1">};</span>
<a name="l4482"><span class="ln">4482 </span></a>
<a name="l4483"><span class="ln">4483 </span></a><span class="s5">/**</span>
<a name="l4484"><span class="ln">4484 </span></a> <span class="s5">* Add pre [middleware](https://mongoosejs.com/docs/middleware.html) to this query instance. Doesn't affect</span>
<a name="l4485"><span class="ln">4485 </span></a> <span class="s5">* other queries.</span>
<a name="l4486"><span class="ln">4486 </span></a> <span class="s5">*</span>
<a name="l4487"><span class="ln">4487 </span></a> <span class="s5">* #### Example:</span>
<a name="l4488"><span class="ln">4488 </span></a> <span class="s5">*</span>
<a name="l4489"><span class="ln">4489 </span></a> <span class="s5">*     const q1 = Question.find({ answer: 42 });</span>
<a name="l4490"><span class="ln">4490 </span></a> <span class="s5">*     q1.pre(function middleware() {</span>
<a name="l4491"><span class="ln">4491 </span></a> <span class="s5">*       console.log(this.getFilter());</span>
<a name="l4492"><span class="ln">4492 </span></a> <span class="s5">*     });</span>
<a name="l4493"><span class="ln">4493 </span></a> <span class="s5">*     await q1.exec(); // Prints &quot;{ answer: 42 }&quot;</span>
<a name="l4494"><span class="ln">4494 </span></a> <span class="s5">*</span>
<a name="l4495"><span class="ln">4495 </span></a> <span class="s5">*     // Doesn't print anything, because `middleware()` is only</span>
<a name="l4496"><span class="ln">4496 </span></a> <span class="s5">*     // registered on `q1`.</span>
<a name="l4497"><span class="ln">4497 </span></a> <span class="s5">*     await Question.find({ answer: 42 });</span>
<a name="l4498"><span class="ln">4498 </span></a> <span class="s5">*</span>
<a name="l4499"><span class="ln">4499 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} fn</span>
<a name="l4500"><span class="ln">4500 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise}</span>
<a name="l4501"><span class="ln">4501 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4502"><span class="ln">4502 </span></a> <span class="s5">*/</span>
<a name="l4503"><span class="ln">4503 </span></a>
<a name="l4504"><span class="ln">4504 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">pre </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">fn</span><span class="s1">) {</span>
<a name="l4505"><span class="ln">4505 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_hooks</span><span class="s1">.</span><span class="s2">pre</span><span class="s1">(</span><span class="s0">'exec'</span><span class="s1">, </span><span class="s2">fn</span><span class="s1">);</span>
<a name="l4506"><span class="ln">4506 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l4507"><span class="ln">4507 </span></a><span class="s1">};</span>
<a name="l4508"><span class="ln">4508 </span></a>
<a name="l4509"><span class="ln">4509 </span></a><span class="s5">/**</span>
<a name="l4510"><span class="ln">4510 </span></a> <span class="s5">* Add post [middleware](https://mongoosejs.com/docs/middleware.html) to this query instance. Doesn't affect</span>
<a name="l4511"><span class="ln">4511 </span></a> <span class="s5">* other queries.</span>
<a name="l4512"><span class="ln">4512 </span></a> <span class="s5">*</span>
<a name="l4513"><span class="ln">4513 </span></a> <span class="s5">* #### Example:</span>
<a name="l4514"><span class="ln">4514 </span></a> <span class="s5">*</span>
<a name="l4515"><span class="ln">4515 </span></a> <span class="s5">*     const q1 = Question.find({ answer: 42 });</span>
<a name="l4516"><span class="ln">4516 </span></a> <span class="s5">*     q1.post(function middleware() {</span>
<a name="l4517"><span class="ln">4517 </span></a> <span class="s5">*       console.log(this.getFilter());</span>
<a name="l4518"><span class="ln">4518 </span></a> <span class="s5">*     });</span>
<a name="l4519"><span class="ln">4519 </span></a> <span class="s5">*     await q1.exec(); // Prints &quot;{ answer: 42 }&quot;</span>
<a name="l4520"><span class="ln">4520 </span></a> <span class="s5">*</span>
<a name="l4521"><span class="ln">4521 </span></a> <span class="s5">*     // Doesn't print anything, because `middleware()` is only</span>
<a name="l4522"><span class="ln">4522 </span></a> <span class="s5">*     // registered on `q1`.</span>
<a name="l4523"><span class="ln">4523 </span></a> <span class="s5">*     await Question.find({ answer: 42 });</span>
<a name="l4524"><span class="ln">4524 </span></a> <span class="s5">*</span>
<a name="l4525"><span class="ln">4525 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} fn</span>
<a name="l4526"><span class="ln">4526 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Promise}</span>
<a name="l4527"><span class="ln">4527 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4528"><span class="ln">4528 </span></a> <span class="s5">*/</span>
<a name="l4529"><span class="ln">4529 </span></a>
<a name="l4530"><span class="ln">4530 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">post </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">fn</span><span class="s1">) {</span>
<a name="l4531"><span class="ln">4531 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_hooks</span><span class="s1">.</span><span class="s2">post</span><span class="s1">(</span><span class="s0">'exec'</span><span class="s1">, </span><span class="s2">fn</span><span class="s1">);</span>
<a name="l4532"><span class="ln">4532 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l4533"><span class="ln">4533 </span></a><span class="s1">};</span>
<a name="l4534"><span class="ln">4534 </span></a>
<a name="l4535"><span class="ln">4535 </span></a><span class="s5">/**</span>
<a name="l4536"><span class="ln">4536 </span></a> <span class="s5">* Casts obj for an update command.</span>
<a name="l4537"><span class="ln">4537 </span></a> <span class="s5">*</span>
<a name="l4538"><span class="ln">4538 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} obj</span>
<a name="l4539"><span class="ln">4539 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object} obj after casting its values</span>
<a name="l4540"><span class="ln">4540 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">_castUpdate</span>
<a name="l4541"><span class="ln">4541 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l4542"><span class="ln">4542 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l4543"><span class="ln">4543 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l4544"><span class="ln">4544 </span></a> <span class="s5">*/</span>
<a name="l4545"><span class="ln">4545 </span></a>
<a name="l4546"><span class="ln">4546 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_castUpdate </span><span class="s1">= </span><span class="s4">function </span><span class="s2">_castUpdate</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">) {</span>
<a name="l4547"><span class="ln">4547 </span></a>  <span class="s4">let </span><span class="s2">schema </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">;</span>
<a name="l4548"><span class="ln">4548 </span></a>
<a name="l4549"><span class="ln">4549 </span></a>  <span class="s4">const </span><span class="s2">discriminatorKey </span><span class="s1">= </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">discriminatorKey</span><span class="s1">;</span>
<a name="l4550"><span class="ln">4550 </span></a>  <span class="s4">const </span><span class="s2">baseSchema </span><span class="s1">= </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">_baseSchema </span><span class="s1">? </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">_baseSchema </span><span class="s1">: </span><span class="s2">schema</span><span class="s1">;</span>
<a name="l4551"><span class="ln">4551 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">overwriteDiscriminatorKey </span><span class="s1">&amp;&amp;</span>
<a name="l4552"><span class="ln">4552 </span></a>      <span class="s2">obj</span><span class="s1">[</span><span class="s2">discriminatorKey</span><span class="s1">] != </span><span class="s4">null </span><span class="s1">&amp;&amp;</span>
<a name="l4553"><span class="ln">4553 </span></a>      <span class="s2">baseSchema</span><span class="s1">.</span><span class="s2">discriminators</span><span class="s1">) {</span>
<a name="l4554"><span class="ln">4554 </span></a>    <span class="s4">const </span><span class="s2">_schema </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">values</span><span class="s1">(</span><span class="s2">baseSchema</span><span class="s1">.</span><span class="s2">discriminators</span><span class="s1">).</span><span class="s2">find</span><span class="s1">(</span>
<a name="l4555"><span class="ln">4555 </span></a>      <span class="s2">discriminator </span><span class="s1">=&gt; </span><span class="s2">discriminator</span><span class="s1">.</span><span class="s2">discriminatorMapping</span><span class="s1">.</span><span class="s2">value </span><span class="s1">=== </span><span class="s2">obj</span><span class="s1">[</span><span class="s2">discriminatorKey</span><span class="s1">]</span>
<a name="l4556"><span class="ln">4556 </span></a>    <span class="s1">);</span>
<a name="l4557"><span class="ln">4557 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">_schema </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4558"><span class="ln">4558 </span></a>      <span class="s2">schema </span><span class="s1">= </span><span class="s2">_schema</span><span class="s1">;</span>
<a name="l4559"><span class="ln">4559 </span></a>    <span class="s1">}</span>
<a name="l4560"><span class="ln">4560 </span></a>  <span class="s1">}</span>
<a name="l4561"><span class="ln">4561 </span></a>
<a name="l4562"><span class="ln">4562 </span></a>  <span class="s4">let </span><span class="s2">upsert</span><span class="s1">;</span>
<a name="l4563"><span class="ln">4563 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'upsert' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l4564"><span class="ln">4564 </span></a>    <span class="s2">upsert </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">upsert</span><span class="s1">;</span>
<a name="l4565"><span class="ln">4565 </span></a>  <span class="s1">}</span>
<a name="l4566"><span class="ln">4566 </span></a>
<a name="l4567"><span class="ln">4567 </span></a>  <span class="s4">const </span><span class="s2">filter </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">;</span>
<a name="l4568"><span class="ln">4568 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">schema </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp;</span>
<a name="l4569"><span class="ln">4569 </span></a>      <span class="s2">utils</span><span class="s1">.</span><span class="s2">hasUserDefinedProperty</span><span class="s1">(</span><span class="s2">filter</span><span class="s1">, </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">discriminatorKey</span><span class="s1">) &amp;&amp;</span>
<a name="l4570"><span class="ln">4570 </span></a>      <span class="s4">typeof </span><span class="s2">filter</span><span class="s1">[</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">discriminatorKey</span><span class="s1">] !== </span><span class="s0">'object' </span><span class="s1">&amp;&amp;</span>
<a name="l4571"><span class="ln">4571 </span></a>      <span class="s2">schema</span><span class="s1">.</span><span class="s2">discriminators </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4572"><span class="ln">4572 </span></a>    <span class="s4">const </span><span class="s2">discriminatorValue </span><span class="s1">= </span><span class="s2">filter</span><span class="s1">[</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">discriminatorKey</span><span class="s1">];</span>
<a name="l4573"><span class="ln">4573 </span></a>    <span class="s4">const </span><span class="s2">byValue </span><span class="s1">= </span><span class="s2">getDiscriminatorByValue</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">discriminators</span><span class="s1">, </span><span class="s2">discriminatorValue</span><span class="s1">);</span>
<a name="l4574"><span class="ln">4574 </span></a>    <span class="s2">schema </span><span class="s1">= </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">discriminators</span><span class="s1">[</span><span class="s2">discriminatorValue</span><span class="s1">] ||</span>
<a name="l4575"><span class="ln">4575 </span></a>      <span class="s1">(</span><span class="s2">byValue </span><span class="s1">&amp;&amp; </span><span class="s2">byValue</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">) ||</span>
<a name="l4576"><span class="ln">4576 </span></a>      <span class="s2">schema</span><span class="s1">;</span>
<a name="l4577"><span class="ln">4577 </span></a>  <span class="s1">}</span>
<a name="l4578"><span class="ln">4578 </span></a>
<a name="l4579"><span class="ln">4579 </span></a>  <span class="s4">return </span><span class="s2">castUpdate</span><span class="s1">(</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">obj</span><span class="s1">, {</span>
<a name="l4580"><span class="ln">4580 </span></a>    <span class="s2">strict</span><span class="s1">: </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">strict</span><span class="s1">,</span>
<a name="l4581"><span class="ln">4581 </span></a>    <span class="s2">upsert</span><span class="s1">: </span><span class="s2">upsert</span><span class="s1">,</span>
<a name="l4582"><span class="ln">4582 </span></a>    <span class="s2">arrayFilters</span><span class="s1">: </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">arrayFilters</span><span class="s1">,</span>
<a name="l4583"><span class="ln">4583 </span></a>    <span class="s2">overwriteDiscriminatorKey</span><span class="s1">: </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">overwriteDiscriminatorKey</span>
<a name="l4584"><span class="ln">4584 </span></a>  <span class="s1">}, </span><span class="s4">this</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">);</span>
<a name="l4585"><span class="ln">4585 </span></a><span class="s1">};</span>
<a name="l4586"><span class="ln">4586 </span></a>
<a name="l4587"><span class="ln">4587 </span></a><span class="s5">/**</span>
<a name="l4588"><span class="ln">4588 </span></a> <span class="s5">* Specifies paths which should be populated with other documents.</span>
<a name="l4589"><span class="ln">4589 </span></a> <span class="s5">*</span>
<a name="l4590"><span class="ln">4590 </span></a> <span class="s5">* #### Example:</span>
<a name="l4591"><span class="ln">4591 </span></a> <span class="s5">*</span>
<a name="l4592"><span class="ln">4592 </span></a> <span class="s5">*     let book = await Book.findOne().populate('authors');</span>
<a name="l4593"><span class="ln">4593 </span></a> <span class="s5">*     book.title; // 'Node.js in Action'</span>
<a name="l4594"><span class="ln">4594 </span></a> <span class="s5">*     book.authors[0].name; // 'TJ Holowaychuk'</span>
<a name="l4595"><span class="ln">4595 </span></a> <span class="s5">*     book.authors[1].name; // 'Nathan Rajlich'</span>
<a name="l4596"><span class="ln">4596 </span></a> <span class="s5">*</span>
<a name="l4597"><span class="ln">4597 </span></a> <span class="s5">*     let books = await Book.find().populate({</span>
<a name="l4598"><span class="ln">4598 </span></a> <span class="s5">*       path: 'authors',</span>
<a name="l4599"><span class="ln">4599 </span></a> <span class="s5">*       // `match` and `sort` apply to the Author model,</span>
<a name="l4600"><span class="ln">4600 </span></a> <span class="s5">*       // not the Book model. These options do not affect</span>
<a name="l4601"><span class="ln">4601 </span></a> <span class="s5">*       // which documents are in `books`, just the order and</span>
<a name="l4602"><span class="ln">4602 </span></a> <span class="s5">*       // contents of each book document's `authors`.</span>
<a name="l4603"><span class="ln">4603 </span></a> <span class="s5">*       match: { name: new RegExp('.*h.*', 'i') },</span>
<a name="l4604"><span class="ln">4604 </span></a> <span class="s5">*       sort: { name: -1 }</span>
<a name="l4605"><span class="ln">4605 </span></a> <span class="s5">*     });</span>
<a name="l4606"><span class="ln">4606 </span></a> <span class="s5">*     books[0].title; // 'Node.js in Action'</span>
<a name="l4607"><span class="ln">4607 </span></a> <span class="s5">*     // Each book's `authors` are sorted by name, descending.</span>
<a name="l4608"><span class="ln">4608 </span></a> <span class="s5">*     books[0].authors[0].name; // 'TJ Holowaychuk'</span>
<a name="l4609"><span class="ln">4609 </span></a> <span class="s5">*     books[0].authors[1].name; // 'Marc Harter'</span>
<a name="l4610"><span class="ln">4610 </span></a> <span class="s5">*</span>
<a name="l4611"><span class="ln">4611 </span></a> <span class="s5">*     books[1].title; // 'Professional AngularJS'</span>
<a name="l4612"><span class="ln">4612 </span></a> <span class="s5">*     // Empty array, no authors' name has the letter 'h'</span>
<a name="l4613"><span class="ln">4613 </span></a> <span class="s5">*     books[1].authors; // []</span>
<a name="l4614"><span class="ln">4614 </span></a> <span class="s5">*</span>
<a name="l4615"><span class="ln">4615 </span></a> <span class="s5">* Paths are populated after the query executes and a response is received. A</span>
<a name="l4616"><span class="ln">4616 </span></a> <span class="s5">* separate query is then executed for each path specified for population. After</span>
<a name="l4617"><span class="ln">4617 </span></a> <span class="s5">* a response for each query has also been returned, the results are passed to</span>
<a name="l4618"><span class="ln">4618 </span></a> <span class="s5">* the callback.</span>
<a name="l4619"><span class="ln">4619 </span></a> <span class="s5">*</span>
<a name="l4620"><span class="ln">4620 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|String|String[]} path either the path(s) to populate or an object specifying all parameters</span>
<a name="l4621"><span class="ln">4621 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|String} [select] Field selection for the population query</span>
<a name="l4622"><span class="ln">4622 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Model} [model] The model you wish to use for population. If not specified, populate will look up the model by the name in the Schema's `ref` field.</span>
<a name="l4623"><span class="ln">4623 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [match] Conditions for the population query</span>
<a name="l4624"><span class="ln">4624 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options] Options for the population query (sort, etc)</span>
<a name="l4625"><span class="ln">4625 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [options.path=null] The path to populate.</span>
<a name="l4626"><span class="ln">4626 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{boolean} [options.retainNullValues=false] by default, Mongoose removes null and undefined values from populated arrays. Use this option to make `populate()` retain `null` and `undefined` array entries.</span>
<a name="l4627"><span class="ln">4627 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{boolean} [options.getters=false] if true, Mongoose will call any getters defined on the `localField`. By default, Mongoose gets the raw value of `localField`. For example, you would need to set this option to `true` if you wanted to [add a `lowercase` getter to your `localField`](https://mongoosejs.com/docs/schematypes.html#schematype-options).</span>
<a name="l4628"><span class="ln">4628 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{boolean} [options.clone=false] When you do `BlogPost.find().populate('author')`, blog posts with the same author will share 1 copy of an `author` doc. Enable this option to make Mongoose clone populated docs before assigning them.</span>
<a name="l4629"><span class="ln">4629 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Function} [options.match=null] Add an additional filter to the populate query. Can be a filter object containing [MongoDB query syntax](https://www.mongodb.com/docs/manual/tutorial/query-documents/), or a function that returns a filter object.</span>
<a name="l4630"><span class="ln">4630 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Function} [options.transform=null] Function that Mongoose will call on every populated document that allows you to transform the populated document.</span>
<a name="l4631"><span class="ln">4631 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options.options=null] Additional options like `limit` and `lean`.</span>
<a name="l4632"><span class="ln">4632 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">population https://mongoosejs.com/docs/populate.html</span>
<a name="l4633"><span class="ln">4633 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Query#select https://mongoosejs.com/docs/api/query.html#Query.prototype.select()</span>
<a name="l4634"><span class="ln">4634 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Model.populate https://mongoosejs.com/docs/api/model.html#Model.populate()</span>
<a name="l4635"><span class="ln">4635 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l4636"><span class="ln">4636 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4637"><span class="ln">4637 </span></a> <span class="s5">*/</span>
<a name="l4638"><span class="ln">4638 </span></a>
<a name="l4639"><span class="ln">4639 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">populate </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l4640"><span class="ln">4640 </span></a>  <span class="s3">// Bail when given no truthy arguments</span>
<a name="l4641"><span class="ln">4641 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">).</span><span class="s2">some</span><span class="s1">(</span><span class="s2">Boolean</span><span class="s1">)) {</span>
<a name="l4642"><span class="ln">4642 </span></a>    <span class="s4">return this</span><span class="s1">;</span>
<a name="l4643"><span class="ln">4643 </span></a>  <span class="s1">}</span>
<a name="l4644"><span class="ln">4644 </span></a>
<a name="l4645"><span class="ln">4645 </span></a>  <span class="s4">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">utils</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s4">null</span><span class="s1">, </span><span class="s2">arguments</span><span class="s1">);</span>
<a name="l4646"><span class="ln">4646 </span></a>
<a name="l4647"><span class="ln">4647 </span></a>  <span class="s3">// Propagate readConcern and readPreference and lean from parent query,</span>
<a name="l4648"><span class="ln">4648 </span></a>  <span class="s3">// unless one already specified</span>
<a name="l4649"><span class="ln">4649 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4650"><span class="ln">4650 </span></a>    <span class="s4">const </span><span class="s2">readConcern </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readConcern</span><span class="s1">;</span>
<a name="l4651"><span class="ln">4651 </span></a>    <span class="s4">const </span><span class="s2">readPref </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readPreference</span><span class="s1">;</span>
<a name="l4652"><span class="ln">4652 </span></a>
<a name="l4653"><span class="ln">4653 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">populateOptions of res</span><span class="s1">) {</span>
<a name="l4654"><span class="ln">4654 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">readConcern </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; (</span><span class="s2">populateOptions </span><span class="s1">&amp;&amp; </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readConcern</span><span class="s1">) == </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4655"><span class="ln">4655 </span></a>        <span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">|| {};</span>
<a name="l4656"><span class="ln">4656 </span></a>        <span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readConcern </span><span class="s1">= </span><span class="s2">readConcern</span><span class="s1">;</span>
<a name="l4657"><span class="ln">4657 </span></a>      <span class="s1">}</span>
<a name="l4658"><span class="ln">4658 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">readPref </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; (</span><span class="s2">populateOptions </span><span class="s1">&amp;&amp; </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readPreference</span><span class="s1">) == </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4659"><span class="ln">4659 </span></a>        <span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">|| {};</span>
<a name="l4660"><span class="ln">4660 </span></a>        <span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">readPreference </span><span class="s1">= </span><span class="s2">readPref</span><span class="s1">;</span>
<a name="l4661"><span class="ln">4661 </span></a>      <span class="s1">}</span>
<a name="l4662"><span class="ln">4662 </span></a>    <span class="s1">}</span>
<a name="l4663"><span class="ln">4663 </span></a>  <span class="s1">}</span>
<a name="l4664"><span class="ln">4664 </span></a>
<a name="l4665"><span class="ln">4665 </span></a>  <span class="s4">const </span><span class="s2">opts </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">;</span>
<a name="l4666"><span class="ln">4666 </span></a>
<a name="l4667"><span class="ln">4667 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4668"><span class="ln">4668 </span></a>    <span class="s4">const </span><span class="s2">lean </span><span class="s1">= </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">;</span>
<a name="l4669"><span class="ln">4669 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">populateOptions of res</span><span class="s1">) {</span>
<a name="l4670"><span class="ln">4670 </span></a>      <span class="s4">if </span><span class="s1">((</span><span class="s2">populateOptions </span><span class="s1">&amp;&amp; </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">lean</span><span class="s1">) == </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l4671"><span class="ln">4671 </span></a>        <span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options </span><span class="s1">|| {};</span>
<a name="l4672"><span class="ln">4672 </span></a>        <span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">lean </span><span class="s1">= </span><span class="s2">lean</span><span class="s1">;</span>
<a name="l4673"><span class="ln">4673 </span></a>      <span class="s1">}</span>
<a name="l4674"><span class="ln">4674 </span></a>    <span class="s1">}</span>
<a name="l4675"><span class="ln">4675 </span></a>  <span class="s1">}</span>
<a name="l4676"><span class="ln">4676 </span></a>
<a name="l4677"><span class="ln">4677 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">utils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">)) {</span>
<a name="l4678"><span class="ln">4678 </span></a>    <span class="s2">opts</span><span class="s1">.</span><span class="s2">populate </span><span class="s1">= {};</span>
<a name="l4679"><span class="ln">4679 </span></a>  <span class="s1">}</span>
<a name="l4680"><span class="ln">4680 </span></a>
<a name="l4681"><span class="ln">4681 </span></a>  <span class="s4">const </span><span class="s2">pop </span><span class="s1">= </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">;</span>
<a name="l4682"><span class="ln">4682 </span></a>
<a name="l4683"><span class="ln">4683 </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">populateOptions of res</span><span class="s1">) {</span>
<a name="l4684"><span class="ln">4684 </span></a>    <span class="s4">const </span><span class="s2">path </span><span class="s1">= </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>
<a name="l4685"><span class="ln">4685 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">pop</span><span class="s1">[</span><span class="s2">path</span><span class="s1">] &amp;&amp; </span><span class="s2">pop</span><span class="s1">[</span><span class="s2">path</span><span class="s1">].</span><span class="s2">populate </span><span class="s1">&amp;&amp; </span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">) {</span>
<a name="l4686"><span class="ln">4686 </span></a>      <span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">populate </span><span class="s1">= </span><span class="s2">pop</span><span class="s1">[</span><span class="s2">path</span><span class="s1">].</span><span class="s2">populate</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">);</span>
<a name="l4687"><span class="ln">4687 </span></a>    <span class="s1">}</span>
<a name="l4688"><span class="ln">4688 </span></a>
<a name="l4689"><span class="ln">4689 </span></a>    <span class="s2">pop</span><span class="s1">[</span><span class="s2">populateOptions</span><span class="s1">.</span><span class="s2">path</span><span class="s1">] = </span><span class="s2">populateOptions</span><span class="s1">;</span>
<a name="l4690"><span class="ln">4690 </span></a>  <span class="s1">}</span>
<a name="l4691"><span class="ln">4691 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l4692"><span class="ln">4692 </span></a><span class="s1">};</span>
<a name="l4693"><span class="ln">4693 </span></a>
<a name="l4694"><span class="ln">4694 </span></a><span class="s5">/**</span>
<a name="l4695"><span class="ln">4695 </span></a> <span class="s5">* Gets a list of paths to be populated by this query</span>
<a name="l4696"><span class="ln">4696 </span></a> <span class="s5">*</span>
<a name="l4697"><span class="ln">4697 </span></a> <span class="s5">* #### Example:</span>
<a name="l4698"><span class="ln">4698 </span></a> <span class="s5">*</span>
<a name="l4699"><span class="ln">4699 </span></a> <span class="s5">*      bookSchema.pre('findOne', function() {</span>
<a name="l4700"><span class="ln">4700 </span></a> <span class="s5">*        let keys = this.getPopulatedPaths(); // ['author']</span>
<a name="l4701"><span class="ln">4701 </span></a> <span class="s5">*      });</span>
<a name="l4702"><span class="ln">4702 </span></a> <span class="s5">*      ...</span>
<a name="l4703"><span class="ln">4703 </span></a> <span class="s5">*      Book.findOne({}).populate('author');</span>
<a name="l4704"><span class="ln">4704 </span></a> <span class="s5">*</span>
<a name="l4705"><span class="ln">4705 </span></a> <span class="s5">* #### Example:</span>
<a name="l4706"><span class="ln">4706 </span></a> <span class="s5">*</span>
<a name="l4707"><span class="ln">4707 </span></a> <span class="s5">*      // Deep populate</span>
<a name="l4708"><span class="ln">4708 </span></a> <span class="s5">*      const q = L1.find().populate({</span>
<a name="l4709"><span class="ln">4709 </span></a> <span class="s5">*        path: 'level2',</span>
<a name="l4710"><span class="ln">4710 </span></a> <span class="s5">*        populate: { path: 'level3' }</span>
<a name="l4711"><span class="ln">4711 </span></a> <span class="s5">*      });</span>
<a name="l4712"><span class="ln">4712 </span></a> <span class="s5">*      q.getPopulatedPaths(); // ['level2', 'level2.level3']</span>
<a name="l4713"><span class="ln">4713 </span></a> <span class="s5">*</span>
<a name="l4714"><span class="ln">4714 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Array} an array of strings representing populated paths</span>
<a name="l4715"><span class="ln">4715 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4716"><span class="ln">4716 </span></a> <span class="s5">*/</span>
<a name="l4717"><span class="ln">4717 </span></a>
<a name="l4718"><span class="ln">4718 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getPopulatedPaths </span><span class="s1">= </span><span class="s4">function </span><span class="s2">getPopulatedPaths</span><span class="s1">() {</span>
<a name="l4719"><span class="ln">4719 </span></a>  <span class="s4">const </span><span class="s2">obj </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">populate </span><span class="s1">|| {};</span>
<a name="l4720"><span class="ln">4720 </span></a>  <span class="s4">const </span><span class="s2">ret </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">);</span>
<a name="l4721"><span class="ln">4721 </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">path of Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">)) {</span>
<a name="l4722"><span class="ln">4722 </span></a>    <span class="s4">const </span><span class="s2">pop </span><span class="s1">= </span><span class="s2">obj</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
<a name="l4723"><span class="ln">4723 </span></a>    <span class="s4">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">pop</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">)) {</span>
<a name="l4724"><span class="ln">4724 </span></a>      <span class="s4">continue</span><span class="s1">;</span>
<a name="l4725"><span class="ln">4725 </span></a>    <span class="s1">}</span>
<a name="l4726"><span class="ln">4726 </span></a>    <span class="s2">_getPopulatedPaths</span><span class="s1">(</span><span class="s2">ret</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">, </span><span class="s2">path </span><span class="s1">+ </span><span class="s0">'.'</span><span class="s1">);</span>
<a name="l4727"><span class="ln">4727 </span></a>  <span class="s1">}</span>
<a name="l4728"><span class="ln">4728 </span></a>  <span class="s4">return </span><span class="s2">ret</span><span class="s1">;</span>
<a name="l4729"><span class="ln">4729 </span></a><span class="s1">};</span>
<a name="l4730"><span class="ln">4730 </span></a>
<a name="l4731"><span class="ln">4731 </span></a><span class="s3">/*! 
<a name="l4732"><span class="ln">4732 </span></a> * ignore 
<a name="l4733"><span class="ln">4733 </span></a> */</span>
<a name="l4734"><span class="ln">4734 </span></a>
<a name="l4735"><span class="ln">4735 </span></a><span class="s4">function </span><span class="s2">_getPopulatedPaths</span><span class="s1">(</span><span class="s2">list</span><span class="s1">, </span><span class="s2">arr</span><span class="s1">, </span><span class="s2">prefix</span><span class="s1">) {</span>
<a name="l4736"><span class="ln">4736 </span></a>  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">pop of arr</span><span class="s1">) {</span>
<a name="l4737"><span class="ln">4737 </span></a>    <span class="s2">list</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">prefix </span><span class="s1">+ </span><span class="s2">pop</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
<a name="l4738"><span class="ln">4738 </span></a>    <span class="s4">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">pop</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">)) {</span>
<a name="l4739"><span class="ln">4739 </span></a>      <span class="s4">continue</span><span class="s1">;</span>
<a name="l4740"><span class="ln">4740 </span></a>    <span class="s1">}</span>
<a name="l4741"><span class="ln">4741 </span></a>    <span class="s2">_getPopulatedPaths</span><span class="s1">(</span><span class="s2">list</span><span class="s1">, </span><span class="s2">pop</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">, </span><span class="s2">prefix </span><span class="s1">+ </span><span class="s2">pop</span><span class="s1">.</span><span class="s2">path </span><span class="s1">+ </span><span class="s0">'.'</span><span class="s1">);</span>
<a name="l4742"><span class="ln">4742 </span></a>  <span class="s1">}</span>
<a name="l4743"><span class="ln">4743 </span></a><span class="s1">}</span>
<a name="l4744"><span class="ln">4744 </span></a>
<a name="l4745"><span class="ln">4745 </span></a><span class="s5">/**</span>
<a name="l4746"><span class="ln">4746 </span></a> <span class="s5">* Casts this query to the schema of `model`</span>
<a name="l4747"><span class="ln">4747 </span></a> <span class="s5">*</span>
<a name="l4748"><span class="ln">4748 </span></a> <span class="s5">* #### Note:</span>
<a name="l4749"><span class="ln">4749 </span></a> <span class="s5">*</span>
<a name="l4750"><span class="ln">4750 </span></a> <span class="s5">* If `obj` is present, it is cast instead of this query.</span>
<a name="l4751"><span class="ln">4751 </span></a> <span class="s5">*</span>
<a name="l4752"><span class="ln">4752 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Model} [model] the model to cast to. If not set, defaults to `this.model`</span>
<a name="l4753"><span class="ln">4753 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [obj]</span>
<a name="l4754"><span class="ln">4754 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Object}</span>
<a name="l4755"><span class="ln">4755 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4756"><span class="ln">4756 </span></a> <span class="s5">*/</span>
<a name="l4757"><span class="ln">4757 </span></a>
<a name="l4758"><span class="ln">4758 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">cast </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">model</span><span class="s1">, </span><span class="s2">obj</span><span class="s1">) {</span>
<a name="l4759"><span class="ln">4759 </span></a>  <span class="s2">obj </span><span class="s1">|| (</span><span class="s2">obj </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_conditions</span><span class="s1">);</span>
<a name="l4760"><span class="ln">4760 </span></a>  <span class="s2">model </span><span class="s1">= </span><span class="s2">model </span><span class="s1">|| </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">;</span>
<a name="l4761"><span class="ln">4761 </span></a>  <span class="s4">const </span><span class="s2">discriminatorKey </span><span class="s1">= </span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">discriminatorKey</span><span class="s1">;</span>
<a name="l4762"><span class="ln">4762 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">obj </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp;</span>
<a name="l4763"><span class="ln">4763 </span></a>      <span class="s2">obj</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">discriminatorKey</span><span class="s1">)) {</span>
<a name="l4764"><span class="ln">4764 </span></a>    <span class="s2">model </span><span class="s1">= </span><span class="s2">getDiscriminatorByValue</span><span class="s1">(</span><span class="s2">model</span><span class="s1">.</span><span class="s2">discriminators</span><span class="s1">, </span><span class="s2">obj</span><span class="s1">[</span><span class="s2">discriminatorKey</span><span class="s1">]) || </span><span class="s2">model</span><span class="s1">;</span>
<a name="l4765"><span class="ln">4765 </span></a>  <span class="s1">}</span>
<a name="l4766"><span class="ln">4766 </span></a>
<a name="l4767"><span class="ln">4767 </span></a>  <span class="s4">const </span><span class="s2">opts </span><span class="s1">= { </span><span class="s2">upsert</span><span class="s1">: </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">upsert </span><span class="s1">};</span>
<a name="l4768"><span class="ln">4768 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l4769"><span class="ln">4769 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s0">'strict' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l4770"><span class="ln">4770 </span></a>      <span class="s2">opts</span><span class="s1">.</span><span class="s2">strict </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">strict</span><span class="s1">;</span>
<a name="l4771"><span class="ln">4771 </span></a>    <span class="s1">}</span>
<a name="l4772"><span class="ln">4772 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s0">'strictQuery' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l4773"><span class="ln">4773 </span></a>      <span class="s2">opts</span><span class="s1">.</span><span class="s2">strictQuery </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">strictQuery</span><span class="s1">;</span>
<a name="l4774"><span class="ln">4774 </span></a>    <span class="s1">}</span>
<a name="l4775"><span class="ln">4775 </span></a>  <span class="s1">}</span>
<a name="l4776"><span class="ln">4776 </span></a>
<a name="l4777"><span class="ln">4777 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l4778"><span class="ln">4778 </span></a>    <span class="s4">return </span><span class="s2">cast</span><span class="s1">(</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">obj</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">, </span><span class="s4">this</span><span class="s1">);</span>
<a name="l4779"><span class="ln">4779 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l4780"><span class="ln">4780 </span></a>    <span class="s3">// CastError, assign model</span>
<a name="l4781"><span class="ln">4781 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">err</span><span class="s1">.</span><span class="s2">setModel </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
<a name="l4782"><span class="ln">4782 </span></a>      <span class="s2">err</span><span class="s1">.</span><span class="s2">setModel</span><span class="s1">(</span><span class="s2">model</span><span class="s1">);</span>
<a name="l4783"><span class="ln">4783 </span></a>    <span class="s1">}</span>
<a name="l4784"><span class="ln">4784 </span></a>    <span class="s4">throw </span><span class="s2">err</span><span class="s1">;</span>
<a name="l4785"><span class="ln">4785 </span></a>  <span class="s1">}</span>
<a name="l4786"><span class="ln">4786 </span></a><span class="s1">};</span>
<a name="l4787"><span class="ln">4787 </span></a>
<a name="l4788"><span class="ln">4788 </span></a><span class="s5">/**</span>
<a name="l4789"><span class="ln">4789 </span></a> <span class="s5">* Casts selected field arguments for field selection with mongo 2.2</span>
<a name="l4790"><span class="ln">4790 </span></a> <span class="s5">*</span>
<a name="l4791"><span class="ln">4791 </span></a> <span class="s5">*     query.select({ ids: { $elemMatch: { $in: [hexString] }})</span>
<a name="l4792"><span class="ln">4792 </span></a> <span class="s5">*</span>
<a name="l4793"><span class="ln">4793 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} fields</span>
<a name="l4794"><span class="ln">4794 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">https://github.com/Automattic/mongoose/issues/1091</span>
<a name="l4795"><span class="ln">4795 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">https://www.mongodb.com/docs/manual/reference/projection/elemMatch/</span>
<a name="l4796"><span class="ln">4796 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l4797"><span class="ln">4797 </span></a> <span class="s5">*/</span>
<a name="l4798"><span class="ln">4798 </span></a>
<a name="l4799"><span class="ln">4799 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_castFields </span><span class="s1">= </span><span class="s4">function </span><span class="s2">_castFields</span><span class="s1">(</span><span class="s2">fields</span><span class="s1">) {</span>
<a name="l4800"><span class="ln">4800 </span></a>  <span class="s4">let </span><span class="s2">selected</span><span class="s1">,</span>
<a name="l4801"><span class="ln">4801 </span></a>      <span class="s2">elemMatchKeys</span><span class="s1">,</span>
<a name="l4802"><span class="ln">4802 </span></a>      <span class="s2">keys</span><span class="s1">,</span>
<a name="l4803"><span class="ln">4803 </span></a>      <span class="s2">key</span><span class="s1">,</span>
<a name="l4804"><span class="ln">4804 </span></a>      <span class="s2">out</span><span class="s1">;</span>
<a name="l4805"><span class="ln">4805 </span></a>
<a name="l4806"><span class="ln">4806 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">fields</span><span class="s1">) {</span>
<a name="l4807"><span class="ln">4807 </span></a>    <span class="s2">keys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">fields</span><span class="s1">);</span>
<a name="l4808"><span class="ln">4808 </span></a>    <span class="s2">elemMatchKeys </span><span class="s1">= [];</span>
<a name="l4809"><span class="ln">4809 </span></a>
<a name="l4810"><span class="ln">4810 </span></a>    <span class="s3">// collect $elemMatch args</span>
<a name="l4811"><span class="ln">4811 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">keys</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
<a name="l4812"><span class="ln">4812 </span></a>      <span class="s2">key </span><span class="s1">= </span><span class="s2">keys</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
<a name="l4813"><span class="ln">4813 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">fields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">].</span><span class="s2">$elemMatch</span><span class="s1">) {</span>
<a name="l4814"><span class="ln">4814 </span></a>        <span class="s2">selected </span><span class="s1">|| (</span><span class="s2">selected </span><span class="s1">= {});</span>
<a name="l4815"><span class="ln">4815 </span></a>        <span class="s2">selected</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">fields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
<a name="l4816"><span class="ln">4816 </span></a>        <span class="s2">elemMatchKeys</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
<a name="l4817"><span class="ln">4817 </span></a>      <span class="s1">}</span>
<a name="l4818"><span class="ln">4818 </span></a>    <span class="s1">}</span>
<a name="l4819"><span class="ln">4819 </span></a>  <span class="s1">}</span>
<a name="l4820"><span class="ln">4820 </span></a>
<a name="l4821"><span class="ln">4821 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">selected</span><span class="s1">) {</span>
<a name="l4822"><span class="ln">4822 </span></a>    <span class="s3">// they passed $elemMatch, cast em</span>
<a name="l4823"><span class="ln">4823 </span></a>    <span class="s4">try </span><span class="s1">{</span>
<a name="l4824"><span class="ln">4824 </span></a>      <span class="s2">out </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">cast</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">, </span><span class="s2">selected</span><span class="s1">);</span>
<a name="l4825"><span class="ln">4825 </span></a>    <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l4826"><span class="ln">4826 </span></a>      <span class="s4">return </span><span class="s2">err</span><span class="s1">;</span>
<a name="l4827"><span class="ln">4827 </span></a>    <span class="s1">}</span>
<a name="l4828"><span class="ln">4828 </span></a>
<a name="l4829"><span class="ln">4829 </span></a>    <span class="s3">// apply the casted field args</span>
<a name="l4830"><span class="ln">4830 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">let </span><span class="s2">i </span><span class="s1">= </span><span class="s7">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">elemMatchKeys</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
<a name="l4831"><span class="ln">4831 </span></a>      <span class="s2">key </span><span class="s1">= </span><span class="s2">elemMatchKeys</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
<a name="l4832"><span class="ln">4832 </span></a>      <span class="s2">fields</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">out</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
<a name="l4833"><span class="ln">4833 </span></a>    <span class="s1">}</span>
<a name="l4834"><span class="ln">4834 </span></a>  <span class="s1">}</span>
<a name="l4835"><span class="ln">4835 </span></a>
<a name="l4836"><span class="ln">4836 </span></a>  <span class="s4">return </span><span class="s2">fields</span><span class="s1">;</span>
<a name="l4837"><span class="ln">4837 </span></a><span class="s1">};</span>
<a name="l4838"><span class="ln">4838 </span></a>
<a name="l4839"><span class="ln">4839 </span></a><span class="s5">/**</span>
<a name="l4840"><span class="ln">4840 </span></a> <span class="s5">* Applies schematype selected options to this query.</span>
<a name="l4841"><span class="ln">4841 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l4842"><span class="ln">4842 </span></a> <span class="s5">*/</span>
<a name="l4843"><span class="ln">4843 </span></a>
<a name="l4844"><span class="ln">4844 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_applyPaths </span><span class="s1">= </span><span class="s4">function </span><span class="s2">applyPaths</span><span class="s1">() {</span>
<a name="l4845"><span class="ln">4845 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">) {</span>
<a name="l4846"><span class="ln">4846 </span></a>    <span class="s4">return</span><span class="s1">;</span>
<a name="l4847"><span class="ln">4847 </span></a>  <span class="s1">}</span>
<a name="l4848"><span class="ln">4848 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields </span><span class="s1">|| {};</span>
<a name="l4849"><span class="ln">4849 </span></a>  <span class="s2">helpers</span><span class="s1">.</span><span class="s2">applyPaths</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">);</span>
<a name="l4850"><span class="ln">4850 </span></a>
<a name="l4851"><span class="ln">4851 </span></a>  <span class="s4">let </span><span class="s2">_selectPopulatedPaths </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l4852"><span class="ln">4852 </span></a>
<a name="l4853"><span class="ln">4853 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'selectPopulatedPaths' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l4854"><span class="ln">4854 </span></a>    <span class="s2">_selectPopulatedPaths </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">selectPopulatedPaths</span><span class="s1">;</span>
<a name="l4855"><span class="ln">4855 </span></a>  <span class="s1">}</span>
<a name="l4856"><span class="ln">4856 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s0">'selectPopulatedPaths' </span><span class="s4">in this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">) {</span>
<a name="l4857"><span class="ln">4857 </span></a>    <span class="s2">_selectPopulatedPaths </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">selectPopulatedPaths</span><span class="s1">;</span>
<a name="l4858"><span class="ln">4858 </span></a>  <span class="s1">}</span>
<a name="l4859"><span class="ln">4859 </span></a>
<a name="l4860"><span class="ln">4860 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">_selectPopulatedPaths</span><span class="s1">) {</span>
<a name="l4861"><span class="ln">4861 </span></a>    <span class="s2">selectPopulatedFields</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_userProvidedFields</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">populate</span><span class="s1">);</span>
<a name="l4862"><span class="ln">4862 </span></a>  <span class="s1">}</span>
<a name="l4863"><span class="ln">4863 </span></a><span class="s1">};</span>
<a name="l4864"><span class="ln">4864 </span></a>
<a name="l4865"><span class="ln">4865 </span></a><span class="s5">/**</span>
<a name="l4866"><span class="ln">4866 </span></a> <span class="s5">* Returns a wrapper around a [mongodb driver cursor](https://mongodb.github.io/node-mongodb-native/4.9/classes/FindCursor.html).</span>
<a name="l4867"><span class="ln">4867 </span></a> <span class="s5">* A QueryCursor exposes a Streams3 interface, as well as a `.next()` function.</span>
<a name="l4868"><span class="ln">4868 </span></a> <span class="s5">*</span>
<a name="l4869"><span class="ln">4869 </span></a> <span class="s5">* The `.cursor()` function triggers pre find hooks, but **not** post find hooks.</span>
<a name="l4870"><span class="ln">4870 </span></a> <span class="s5">*</span>
<a name="l4871"><span class="ln">4871 </span></a> <span class="s5">* #### Example:</span>
<a name="l4872"><span class="ln">4872 </span></a> <span class="s5">*</span>
<a name="l4873"><span class="ln">4873 </span></a> <span class="s5">*     // There are 2 ways to use a cursor. First, as a stream:</span>
<a name="l4874"><span class="ln">4874 </span></a> <span class="s5">*     Thing.</span>
<a name="l4875"><span class="ln">4875 </span></a> <span class="s5">*       find({ name: /^hello/ }).</span>
<a name="l4876"><span class="ln">4876 </span></a> <span class="s5">*       cursor().</span>
<a name="l4877"><span class="ln">4877 </span></a> <span class="s5">*       on('data', function(doc) { console.log(doc); }).</span>
<a name="l4878"><span class="ln">4878 </span></a> <span class="s5">*       on('end', function() { console.log('Done!'); });</span>
<a name="l4879"><span class="ln">4879 </span></a> <span class="s5">*</span>
<a name="l4880"><span class="ln">4880 </span></a> <span class="s5">*     // Or you can use `.next()` to manually get the next doc in the stream.</span>
<a name="l4881"><span class="ln">4881 </span></a> <span class="s5">*     // `.next()` returns a promise, so you can use promises or callbacks.</span>
<a name="l4882"><span class="ln">4882 </span></a> <span class="s5">*     const cursor = Thing.find({ name: /^hello/ }).cursor();</span>
<a name="l4883"><span class="ln">4883 </span></a> <span class="s5">*     cursor.next(function(error, doc) {</span>
<a name="l4884"><span class="ln">4884 </span></a> <span class="s5">*       console.log(doc);</span>
<a name="l4885"><span class="ln">4885 </span></a> <span class="s5">*     });</span>
<a name="l4886"><span class="ln">4886 </span></a> <span class="s5">*</span>
<a name="l4887"><span class="ln">4887 </span></a> <span class="s5">*     // Because `.next()` returns a promise, you can use co</span>
<a name="l4888"><span class="ln">4888 </span></a> <span class="s5">*     // to easily iterate through all documents without loading them</span>
<a name="l4889"><span class="ln">4889 </span></a> <span class="s5">*     // all into memory.</span>
<a name="l4890"><span class="ln">4890 </span></a> <span class="s5">*     const cursor = Thing.find({ name: /^hello/ }).cursor();</span>
<a name="l4891"><span class="ln">4891 </span></a> <span class="s5">*     for (let doc = await cursor.next(); doc != null; doc = await cursor.next()) {</span>
<a name="l4892"><span class="ln">4892 </span></a> <span class="s5">*       console.log(doc);</span>
<a name="l4893"><span class="ln">4893 </span></a> <span class="s5">*     }</span>
<a name="l4894"><span class="ln">4894 </span></a> <span class="s5">*</span>
<a name="l4895"><span class="ln">4895 </span></a> <span class="s5">* #### Valid options</span>
<a name="l4896"><span class="ln">4896 </span></a> <span class="s5">*</span>
<a name="l4897"><span class="ln">4897 </span></a> <span class="s5">*   - `transform`: optional function which accepts a mongoose document. The return value of the function will be emitted on `data` and returned by `.next()`.</span>
<a name="l4898"><span class="ln">4898 </span></a> <span class="s5">*</span>
<a name="l4899"><span class="ln">4899 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{QueryCursor}</span>
<a name="l4900"><span class="ln">4900 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [options]</span>
<a name="l4901"><span class="ln">4901 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">QueryCursor https://mongoosejs.com/docs/api/querycursor.html</span>
<a name="l4902"><span class="ln">4902 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4903"><span class="ln">4903 </span></a> <span class="s5">*/</span>
<a name="l4904"><span class="ln">4904 </span></a>
<a name="l4905"><span class="ln">4905 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">cursor </span><span class="s1">= </span><span class="s4">function </span><span class="s2">cursor</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">) {</span>
<a name="l4906"><span class="ln">4906 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">) {</span>
<a name="l4907"><span class="ln">4907 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">setOptions</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">);</span>
<a name="l4908"><span class="ln">4908 </span></a>  <span class="s1">}</span>
<a name="l4909"><span class="ln">4909 </span></a>
<a name="l4910"><span class="ln">4910 </span></a>  <span class="s4">try </span><span class="s1">{</span>
<a name="l4911"><span class="ln">4911 </span></a>    <span class="s4">this</span><span class="s1">.</span><span class="s2">cast</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">model</span><span class="s1">);</span>
<a name="l4912"><span class="ln">4912 </span></a>  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
<a name="l4913"><span class="ln">4913 </span></a>    <span class="s4">return </span><span class="s1">(</span><span class="s4">new </span><span class="s2">QueryCursor</span><span class="s1">(</span><span class="s4">this</span><span class="s1">)).</span><span class="s2">_markError</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
<a name="l4914"><span class="ln">4914 </span></a>  <span class="s1">}</span>
<a name="l4915"><span class="ln">4915 </span></a>
<a name="l4916"><span class="ln">4916 </span></a>  <span class="s4">return new </span><span class="s2">QueryCursor</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
<a name="l4917"><span class="ln">4917 </span></a><span class="s1">};</span>
<a name="l4918"><span class="ln">4918 </span></a>
<a name="l4919"><span class="ln">4919 </span></a><span class="s3">// the rest of these are basically to support older Mongoose syntax with mquery</span>
<a name="l4920"><span class="ln">4920 </span></a>
<a name="l4921"><span class="ln">4921 </span></a><span class="s5">/**</span>
<a name="l4922"><span class="ln">4922 </span></a> <span class="s5">* Sets the tailable option (for use with capped collections).</span>
<a name="l4923"><span class="ln">4923 </span></a> <span class="s5">*</span>
<a name="l4924"><span class="ln">4924 </span></a> <span class="s5">* #### Example:</span>
<a name="l4925"><span class="ln">4925 </span></a> <span class="s5">*</span>
<a name="l4926"><span class="ln">4926 </span></a> <span class="s5">*     query.tailable(); // true</span>
<a name="l4927"><span class="ln">4927 </span></a> <span class="s5">*     query.tailable(true);</span>
<a name="l4928"><span class="ln">4928 </span></a> <span class="s5">*     query.tailable(false);</span>
<a name="l4929"><span class="ln">4929 </span></a> <span class="s5">*</span>
<a name="l4930"><span class="ln">4930 </span></a> <span class="s5">*     // Set both `tailable` and `awaitData` options</span>
<a name="l4931"><span class="ln">4931 </span></a> <span class="s5">*     query.tailable({ awaitData: true });</span>
<a name="l4932"><span class="ln">4932 </span></a> <span class="s5">*</span>
<a name="l4933"><span class="ln">4933 </span></a> <span class="s5">* #### Note:</span>
<a name="l4934"><span class="ln">4934 </span></a> <span class="s5">*</span>
<a name="l4935"><span class="ln">4935 </span></a> <span class="s5">* Cannot be used with `distinct()`</span>
<a name="l4936"><span class="ln">4936 </span></a> <span class="s5">*</span>
<a name="l4937"><span class="ln">4937 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} bool defaults to true</span>
<a name="l4938"><span class="ln">4938 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [opts] options to set</span>
<a name="l4939"><span class="ln">4939 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Boolean} [opts.awaitData] false by default. Set to true to keep the cursor open even if there's no data.</span>
<a name="l4940"><span class="ln">4940 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Number} [opts.maxAwaitTimeMS] the maximum amount of time for the server to wait on new documents to satisfy a tailable cursor query. Requires `tailable` and `awaitData` to be true</span>
<a name="l4941"><span class="ln">4941 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">tailable https://www.mongodb.com/docs/manual/tutorial/create-tailable-cursor/</span>
<a name="l4942"><span class="ln">4942 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l4943"><span class="ln">4943 </span></a> <span class="s5">*/</span>
<a name="l4944"><span class="ln">4944 </span></a>
<a name="l4945"><span class="ln">4945 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">tailable </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">val</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">) {</span>
<a name="l4946"><span class="ln">4946 </span></a>  <span class="s3">// we need to support the tailable({ awaitData : true }) as well as the</span>
<a name="l4947"><span class="ln">4947 </span></a>  <span class="s3">// tailable(true, {awaitData :true}) syntax that mquery does not support</span>
<a name="l4948"><span class="ln">4948 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">!= </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">val</span><span class="s1">.</span><span class="s2">constructor </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">&amp;&amp; </span><span class="s2">val</span><span class="s1">.</span><span class="s2">constructor</span><span class="s1">.</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">'Object'</span><span class="s1">) {</span>
<a name="l4949"><span class="ln">4949 </span></a>    <span class="s2">opts </span><span class="s1">= </span><span class="s2">val</span><span class="s1">;</span>
<a name="l4950"><span class="ln">4950 </span></a>    <span class="s2">val </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l4951"><span class="ln">4951 </span></a>  <span class="s1">}</span>
<a name="l4952"><span class="ln">4952 </span></a>
<a name="l4953"><span class="ln">4953 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">val </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
<a name="l4954"><span class="ln">4954 </span></a>    <span class="s2">val </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l4955"><span class="ln">4955 </span></a>  <span class="s1">}</span>
<a name="l4956"><span class="ln">4956 </span></a>
<a name="l4957"><span class="ln">4957 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">opts </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">opts </span><span class="s1">=== </span><span class="s0">'object'</span><span class="s1">) {</span>
<a name="l4958"><span class="ln">4958 </span></a>    <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s2">key of Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">)) {</span>
<a name="l4959"><span class="ln">4959 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">=== </span><span class="s0">'awaitData' </span><span class="s1">|| </span><span class="s2">key </span><span class="s1">=== </span><span class="s0">'awaitdata'</span><span class="s1">) { </span><span class="s3">// backwards compat, see gh-10875</span>
<a name="l4960"><span class="ln">4960 </span></a>        <span class="s3">// For backwards compatibility</span>
<a name="l4961"><span class="ln">4961 </span></a>        <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">[</span><span class="s0">'awaitData'</span><span class="s1">] = !!</span><span class="s2">opts</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
<a name="l4962"><span class="ln">4962 </span></a>      <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l4963"><span class="ln">4963 </span></a>        <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">opts</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
<a name="l4964"><span class="ln">4964 </span></a>      <span class="s1">}</span>
<a name="l4965"><span class="ln">4965 </span></a>    <span class="s1">}</span>
<a name="l4966"><span class="ln">4966 </span></a>  <span class="s1">}</span>
<a name="l4967"><span class="ln">4967 </span></a>
<a name="l4968"><span class="ln">4968 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">tailable </span><span class="s1">= </span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">? !!</span><span class="s2">val </span><span class="s1">: </span><span class="s4">true</span><span class="s1">;</span>
<a name="l4969"><span class="ln">4969 </span></a>
<a name="l4970"><span class="ln">4970 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l4971"><span class="ln">4971 </span></a><span class="s1">};</span>
<a name="l4972"><span class="ln">4972 </span></a>
<a name="l4973"><span class="ln">4973 </span></a><span class="s5">/**</span>
<a name="l4974"><span class="ln">4974 </span></a> <span class="s5">* Declares an intersects query for `geometry()`.</span>
<a name="l4975"><span class="ln">4975 </span></a> <span class="s5">*</span>
<a name="l4976"><span class="ln">4976 </span></a> <span class="s5">* #### Example:</span>
<a name="l4977"><span class="ln">4977 </span></a> <span class="s5">*</span>
<a name="l4978"><span class="ln">4978 </span></a> <span class="s5">*     query.where('path').intersects().geometry({</span>
<a name="l4979"><span class="ln">4979 </span></a> <span class="s5">*       type: 'LineString',</span>
<a name="l4980"><span class="ln">4980 </span></a> <span class="s5">*       coordinates: [[180.0, 11.0], [180, 9.0]]</span>
<a name="l4981"><span class="ln">4981 </span></a> <span class="s5">*     });</span>
<a name="l4982"><span class="ln">4982 </span></a> <span class="s5">*</span>
<a name="l4983"><span class="ln">4983 </span></a> <span class="s5">*     query.where('path').intersects({</span>
<a name="l4984"><span class="ln">4984 </span></a> <span class="s5">*       type: 'LineString',</span>
<a name="l4985"><span class="ln">4985 </span></a> <span class="s5">*       coordinates: [[180.0, 11.0], [180, 9.0]]</span>
<a name="l4986"><span class="ln">4986 </span></a> <span class="s5">*     });</span>
<a name="l4987"><span class="ln">4987 </span></a> <span class="s5">*</span>
<a name="l4988"><span class="ln">4988 </span></a> <span class="s5">* #### Note:</span>
<a name="l4989"><span class="ln">4989 </span></a> <span class="s5">*</span>
<a name="l4990"><span class="ln">4990 </span></a> <span class="s5">* **MUST** be used after `where()`.</span>
<a name="l4991"><span class="ln">4991 </span></a> <span class="s5">*</span>
<a name="l4992"><span class="ln">4992 </span></a> <span class="s5">* #### Note:</span>
<a name="l4993"><span class="ln">4993 </span></a> <span class="s5">*</span>
<a name="l4994"><span class="ln">4994 </span></a> <span class="s5">* In Mongoose 3.7, `intersects` changed from a getter to a function. If you need the old syntax, use [this](https://github.com/ebensing/mongoose-within).</span>
<a name="l4995"><span class="ln">4995 </span></a> <span class="s5">*</span>
<a name="l4996"><span class="ln">4996 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">intersects</span>
<a name="l4997"><span class="ln">4997 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l4998"><span class="ln">4998 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l4999"><span class="ln">4999 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} [arg]</span>
<a name="l5000"><span class="ln">5000 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l5001"><span class="ln">5001 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$geometry https://www.mongodb.com/docs/manual/reference/operator/geometry/</span>
<a name="l5002"><span class="ln">5002 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">geoIntersects https://www.mongodb.com/docs/manual/reference/operator/geoIntersects/</span>
<a name="l5003"><span class="ln">5003 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5004"><span class="ln">5004 </span></a> <span class="s5">*/</span>
<a name="l5005"><span class="ln">5005 </span></a>
<a name="l5006"><span class="ln">5006 </span></a><span class="s5">/**</span>
<a name="l5007"><span class="ln">5007 </span></a> <span class="s5">* Specifies a `$geometry` condition</span>
<a name="l5008"><span class="ln">5008 </span></a> <span class="s5">*</span>
<a name="l5009"><span class="ln">5009 </span></a> <span class="s5">* #### Example:</span>
<a name="l5010"><span class="ln">5010 </span></a> <span class="s5">*</span>
<a name="l5011"><span class="ln">5011 </span></a> <span class="s5">*     const polyA = [[[ 10, 20 ], [ 10, 40 ], [ 30, 40 ], [ 30, 20 ]]]</span>
<a name="l5012"><span class="ln">5012 </span></a> <span class="s5">*     query.where('loc').within().geometry({ type: 'Polygon', coordinates: polyA })</span>
<a name="l5013"><span class="ln">5013 </span></a> <span class="s5">*</span>
<a name="l5014"><span class="ln">5014 </span></a> <span class="s5">*     // or</span>
<a name="l5015"><span class="ln">5015 </span></a> <span class="s5">*     const polyB = [[ 0, 0 ], [ 1, 1 ]]</span>
<a name="l5016"><span class="ln">5016 </span></a> <span class="s5">*     query.where('loc').within().geometry({ type: 'LineString', coordinates: polyB })</span>
<a name="l5017"><span class="ln">5017 </span></a> <span class="s5">*</span>
<a name="l5018"><span class="ln">5018 </span></a> <span class="s5">*     // or</span>
<a name="l5019"><span class="ln">5019 </span></a> <span class="s5">*     const polyC = [ 0, 0 ]</span>
<a name="l5020"><span class="ln">5020 </span></a> <span class="s5">*     query.where('loc').within().geometry({ type: 'Point', coordinates: polyC })</span>
<a name="l5021"><span class="ln">5021 </span></a> <span class="s5">*</span>
<a name="l5022"><span class="ln">5022 </span></a> <span class="s5">*     // or</span>
<a name="l5023"><span class="ln">5023 </span></a> <span class="s5">*     query.where('loc').intersects().geometry({ type: 'Point', coordinates: polyC })</span>
<a name="l5024"><span class="ln">5024 </span></a> <span class="s5">*</span>
<a name="l5025"><span class="ln">5025 </span></a> <span class="s5">* The argument is assigned to the most recent path passed to `where()`.</span>
<a name="l5026"><span class="ln">5026 </span></a> <span class="s5">*</span>
<a name="l5027"><span class="ln">5027 </span></a> <span class="s5">* #### Note:</span>
<a name="l5028"><span class="ln">5028 </span></a> <span class="s5">*</span>
<a name="l5029"><span class="ln">5029 </span></a> <span class="s5">* `geometry()` **must** come after either `intersects()` or `within()`.</span>
<a name="l5030"><span class="ln">5030 </span></a> <span class="s5">*</span>
<a name="l5031"><span class="ln">5031 </span></a> <span class="s5">* The `object` argument must contain `type` and `coordinates` properties.</span>
<a name="l5032"><span class="ln">5032 </span></a> <span class="s5">* - type {String}</span>
<a name="l5033"><span class="ln">5033 </span></a> <span class="s5">* - coordinates {Array}</span>
<a name="l5034"><span class="ln">5034 </span></a> <span class="s5">*</span>
<a name="l5035"><span class="ln">5035 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">geometry</span>
<a name="l5036"><span class="ln">5036 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5037"><span class="ln">5037 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5038"><span class="ln">5038 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} object Must contain a `type` property which is a String and a `coordinates` property which is an Array. See the examples.</span>
<a name="l5039"><span class="ln">5039 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l5040"><span class="ln">5040 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$geometry https://www.mongodb.com/docs/manual/reference/operator/geometry/</span>
<a name="l5041"><span class="ln">5041 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">Geospatial Support Enhancements https://www.mongodb.com/docs/manual/release-notes/2.4/#geospatial-support-enhancements</span>
<a name="l5042"><span class="ln">5042 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB Geospatial Indexing https://www.mongodb.com/docs/manual/core/geospatial-indexes/</span>
<a name="l5043"><span class="ln">5043 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5044"><span class="ln">5044 </span></a> <span class="s5">*/</span>
<a name="l5045"><span class="ln">5045 </span></a>
<a name="l5046"><span class="ln">5046 </span></a><span class="s5">/**</span>
<a name="l5047"><span class="ln">5047 </span></a> <span class="s5">* Specifies a `$near` or `$nearSphere` condition</span>
<a name="l5048"><span class="ln">5048 </span></a> <span class="s5">*</span>
<a name="l5049"><span class="ln">5049 </span></a> <span class="s5">* These operators return documents sorted by distance.</span>
<a name="l5050"><span class="ln">5050 </span></a> <span class="s5">*</span>
<a name="l5051"><span class="ln">5051 </span></a> <span class="s5">* #### Example:</span>
<a name="l5052"><span class="ln">5052 </span></a> <span class="s5">*</span>
<a name="l5053"><span class="ln">5053 </span></a> <span class="s5">*     query.where('loc').near({ center: [10, 10] });</span>
<a name="l5054"><span class="ln">5054 </span></a> <span class="s5">*     query.where('loc').near({ center: [10, 10], maxDistance: 5 });</span>
<a name="l5055"><span class="ln">5055 </span></a> <span class="s5">*     query.where('loc').near({ center: [10, 10], maxDistance: 5, spherical: true });</span>
<a name="l5056"><span class="ln">5056 </span></a> <span class="s5">*     query.near('loc', { center: [10, 10], maxDistance: 5 });</span>
<a name="l5057"><span class="ln">5057 </span></a> <span class="s5">*</span>
<a name="l5058"><span class="ln">5058 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">near</span>
<a name="l5059"><span class="ln">5059 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5060"><span class="ln">5060 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5061"><span class="ln">5061 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l5062"><span class="ln">5062 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} val</span>
<a name="l5063"><span class="ln">5063 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l5064"><span class="ln">5064 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$near https://www.mongodb.com/docs/manual/reference/operator/near/</span>
<a name="l5065"><span class="ln">5065 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$nearSphere https://www.mongodb.com/docs/manual/reference/operator/nearSphere/</span>
<a name="l5066"><span class="ln">5066 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$maxDistance https://www.mongodb.com/docs/manual/reference/operator/maxDistance/</span>
<a name="l5067"><span class="ln">5067 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB Geospatial Indexing https://www.mongodb.com/docs/manual/core/geospatial-indexes/</span>
<a name="l5068"><span class="ln">5068 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5069"><span class="ln">5069 </span></a> <span class="s5">*/</span>
<a name="l5070"><span class="ln">5070 </span></a>
<a name="l5071"><span class="ln">5071 </span></a><span class="s5">/**</span>
<a name="l5072"><span class="ln">5072 </span></a> <span class="s5">* Overwriting mquery is needed to support a couple different near() forms found in older</span>
<a name="l5073"><span class="ln">5073 </span></a> <span class="s5">* versions of mongoose</span>
<a name="l5074"><span class="ln">5074 </span></a> <span class="s5">* near([1,1])</span>
<a name="l5075"><span class="ln">5075 </span></a> <span class="s5">* near(1,1)</span>
<a name="l5076"><span class="ln">5076 </span></a> <span class="s5">* near(field, [1,2])</span>
<a name="l5077"><span class="ln">5077 </span></a> <span class="s5">* near(field, 1, 2)</span>
<a name="l5078"><span class="ln">5078 </span></a> <span class="s5">* In addition to all of the normal forms supported by mquery</span>
<a name="l5079"><span class="ln">5079 </span></a> <span class="s5">*</span>
<a name="l5080"><span class="ln">5080 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">near</span>
<a name="l5081"><span class="ln">5081 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5082"><span class="ln">5082 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5083"><span class="ln">5083 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l5084"><span class="ln">5084 </span></a> <span class="s5">*/</span>
<a name="l5085"><span class="ln">5085 </span></a>
<a name="l5086"><span class="ln">5086 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">near </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l5087"><span class="ln">5087 </span></a>  <span class="s4">const </span><span class="s2">params </span><span class="s1">= [];</span>
<a name="l5088"><span class="ln">5088 </span></a>  <span class="s4">const </span><span class="s2">sphere </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">nearSphere</span><span class="s1">;</span>
<a name="l5089"><span class="ln">5089 </span></a>
<a name="l5090"><span class="ln">5090 </span></a>  <span class="s3">// TODO refactor</span>
<a name="l5091"><span class="ln">5091 </span></a>
<a name="l5092"><span class="ln">5092 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">1</span><span class="s1">) {</span>
<a name="l5093"><span class="ln">5093 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">])) {</span>
<a name="l5094"><span class="ln">5094 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">center</span><span class="s1">: </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">spherical</span><span class="s1">: </span><span class="s2">sphere </span><span class="s1">});</span>
<a name="l5095"><span class="ln">5095 </span></a>    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] === </span><span class="s0">'string'</span><span class="s1">) {</span>
<a name="l5096"><span class="ln">5096 </span></a>      <span class="s3">// just passing a path</span>
<a name="l5097"><span class="ln">5097 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]);</span>
<a name="l5098"><span class="ln">5098 </span></a>    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">utils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">])) {</span>
<a name="l5099"><span class="ln">5099 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">].</span><span class="s2">spherical </span><span class="s1">!== </span><span class="s0">'boolean'</span><span class="s1">) {</span>
<a name="l5100"><span class="ln">5100 </span></a>        <span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">].</span><span class="s2">spherical </span><span class="s1">= </span><span class="s2">sphere</span><span class="s1">;</span>
<a name="l5101"><span class="ln">5101 </span></a>      <span class="s1">}</span>
<a name="l5102"><span class="ln">5102 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]);</span>
<a name="l5103"><span class="ln">5103 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l5104"><span class="ln">5104 </span></a>      <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'invalid argument'</span><span class="s1">);</span>
<a name="l5105"><span class="ln">5105 </span></a>    <span class="s1">}</span>
<a name="l5106"><span class="ln">5106 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">2</span><span class="s1">) {</span>
<a name="l5107"><span class="ln">5107 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] === </span><span class="s0">'number' </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] === </span><span class="s0">'number'</span><span class="s1">) {</span>
<a name="l5108"><span class="ln">5108 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">center</span><span class="s1">: [</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">], </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]], </span><span class="s2">spherical</span><span class="s1">: </span><span class="s2">sphere </span><span class="s1">});</span>
<a name="l5109"><span class="ln">5109 </span></a>    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] === </span><span class="s0">'string' </span><span class="s1">&amp;&amp; </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">])) {</span>
<a name="l5110"><span class="ln">5110 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]);</span>
<a name="l5111"><span class="ln">5111 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">center</span><span class="s1">: </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">spherical</span><span class="s1">: </span><span class="s2">sphere </span><span class="s1">});</span>
<a name="l5112"><span class="ln">5112 </span></a>    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] === </span><span class="s0">'string' </span><span class="s1">&amp;&amp; </span><span class="s2">utils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">])) {</span>
<a name="l5113"><span class="ln">5113 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]);</span>
<a name="l5114"><span class="ln">5114 </span></a>      <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">].</span><span class="s2">spherical </span><span class="s1">!== </span><span class="s0">'boolean'</span><span class="s1">) {</span>
<a name="l5115"><span class="ln">5115 </span></a>        <span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">].</span><span class="s2">spherical </span><span class="s1">= </span><span class="s2">sphere</span><span class="s1">;</span>
<a name="l5116"><span class="ln">5116 </span></a>      <span class="s1">}</span>
<a name="l5117"><span class="ln">5117 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]);</span>
<a name="l5118"><span class="ln">5118 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l5119"><span class="ln">5119 </span></a>      <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'invalid argument'</span><span class="s1">);</span>
<a name="l5120"><span class="ln">5120 </span></a>    <span class="s1">}</span>
<a name="l5121"><span class="ln">5121 </span></a>  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s7">3</span><span class="s1">) {</span>
<a name="l5122"><span class="ln">5122 </span></a>    <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] === </span><span class="s0">'string' </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] === </span><span class="s0">'number'</span>
<a name="l5123"><span class="ln">5123 </span></a>        <span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">] === </span><span class="s0">'number'</span><span class="s1">) {</span>
<a name="l5124"><span class="ln">5124 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]);</span>
<a name="l5125"><span class="ln">5125 </span></a>      <span class="s2">params</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">center</span><span class="s1">: [</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">], </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">2</span><span class="s1">]], </span><span class="s2">spherical</span><span class="s1">: </span><span class="s2">sphere </span><span class="s1">});</span>
<a name="l5126"><span class="ln">5126 </span></a>    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l5127"><span class="ln">5127 </span></a>      <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'invalid argument'</span><span class="s1">);</span>
<a name="l5128"><span class="ln">5128 </span></a>    <span class="s1">}</span>
<a name="l5129"><span class="ln">5129 </span></a>  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
<a name="l5130"><span class="ln">5130 </span></a>    <span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'invalid argument'</span><span class="s1">);</span>
<a name="l5131"><span class="ln">5131 </span></a>  <span class="s1">}</span>
<a name="l5132"><span class="ln">5132 </span></a>
<a name="l5133"><span class="ln">5133 </span></a>  <span class="s4">return </span><span class="s2">Query</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">near</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">params</span><span class="s1">);</span>
<a name="l5134"><span class="ln">5134 </span></a><span class="s1">};</span>
<a name="l5135"><span class="ln">5135 </span></a>
<a name="l5136"><span class="ln">5136 </span></a><span class="s5">/**</span>
<a name="l5137"><span class="ln">5137 </span></a> <span class="s5">* _DEPRECATED_ Specifies a `$nearSphere` condition</span>
<a name="l5138"><span class="ln">5138 </span></a> <span class="s5">*</span>
<a name="l5139"><span class="ln">5139 </span></a> <span class="s5">* #### Example:</span>
<a name="l5140"><span class="ln">5140 </span></a> <span class="s5">*</span>
<a name="l5141"><span class="ln">5141 </span></a> <span class="s5">*     query.where('loc').nearSphere({ center: [10, 10], maxDistance: 5 });</span>
<a name="l5142"><span class="ln">5142 </span></a> <span class="s5">*</span>
<a name="l5143"><span class="ln">5143 </span></a> <span class="s5">* **Deprecated.** Use `query.near()` instead with the `spherical` option set to `true`.</span>
<a name="l5144"><span class="ln">5144 </span></a> <span class="s5">*</span>
<a name="l5145"><span class="ln">5145 </span></a> <span class="s5">* #### Example:</span>
<a name="l5146"><span class="ln">5146 </span></a> <span class="s5">*</span>
<a name="l5147"><span class="ln">5147 </span></a> <span class="s5">*     query.where('loc').near({ center: [10, 10], spherical: true });</span>
<a name="l5148"><span class="ln">5148 </span></a> <span class="s5">*</span>
<a name="l5149"><span class="ln">5149 </span></a> <span class="s5">* </span><span class="s6">@deprecated</span>
<a name="l5150"><span class="ln">5150 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">near() https://mongoosejs.com/docs/api/query.html#Query.prototype.near()</span>
<a name="l5151"><span class="ln">5151 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$near https://www.mongodb.com/docs/manual/reference/operator/near/</span>
<a name="l5152"><span class="ln">5152 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$nearSphere https://www.mongodb.com/docs/manual/reference/operator/nearSphere/</span>
<a name="l5153"><span class="ln">5153 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$maxDistance https://www.mongodb.com/docs/manual/reference/operator/maxDistance/</span>
<a name="l5154"><span class="ln">5154 </span></a> <span class="s5">*/</span>
<a name="l5155"><span class="ln">5155 </span></a>
<a name="l5156"><span class="ln">5156 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">nearSphere </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l5157"><span class="ln">5157 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">_mongooseOptions</span><span class="s1">.</span><span class="s2">nearSphere </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l5158"><span class="ln">5158 </span></a>  <span class="s4">this</span><span class="s1">.</span><span class="s2">near</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">arguments</span><span class="s1">);</span>
<a name="l5159"><span class="ln">5159 </span></a>  <span class="s4">return this</span><span class="s1">;</span>
<a name="l5160"><span class="ln">5160 </span></a><span class="s1">};</span>
<a name="l5161"><span class="ln">5161 </span></a>
<a name="l5162"><span class="ln">5162 </span></a><span class="s5">/**</span>
<a name="l5163"><span class="ln">5163 </span></a> <span class="s5">* Returns an asyncIterator for use with [`for/await/of` loops](https://thecodebarbarian.com/getting-started-with-async-iterators-in-node-js)</span>
<a name="l5164"><span class="ln">5164 </span></a> <span class="s5">* This function *only* works for `find()` queries.</span>
<a name="l5165"><span class="ln">5165 </span></a> <span class="s5">* You do not need to call this function explicitly, the JavaScript runtime</span>
<a name="l5166"><span class="ln">5166 </span></a> <span class="s5">* will call it for you.</span>
<a name="l5167"><span class="ln">5167 </span></a> <span class="s5">*</span>
<a name="l5168"><span class="ln">5168 </span></a> <span class="s5">* #### Example:</span>
<a name="l5169"><span class="ln">5169 </span></a> <span class="s5">*</span>
<a name="l5170"><span class="ln">5170 </span></a> <span class="s5">*     for await (const doc of Model.aggregate([{ $sort: { name: 1 } }])) {</span>
<a name="l5171"><span class="ln">5171 </span></a> <span class="s5">*       console.log(doc.name);</span>
<a name="l5172"><span class="ln">5172 </span></a> <span class="s5">*     }</span>
<a name="l5173"><span class="ln">5173 </span></a> <span class="s5">*</span>
<a name="l5174"><span class="ln">5174 </span></a> <span class="s5">* Node.js 10.x supports async iterators natively without any flags. You can</span>
<a name="l5175"><span class="ln">5175 </span></a> <span class="s5">* enable async iterators in Node.js 8.x using the [`--harmony_async_iteration` flag](https://github.com/tc39/proposal-async-iteration/issues/117#issuecomment-346695187).</span>
<a name="l5176"><span class="ln">5176 </span></a> <span class="s5">*</span>
<a name="l5177"><span class="ln">5177 </span></a> <span class="s5">* **Note:** This function is not if `Symbol.asyncIterator` is undefined. If</span>
<a name="l5178"><span class="ln">5178 </span></a> <span class="s5">* `Symbol.asyncIterator` is undefined, that means your Node.js version does not</span>
<a name="l5179"><span class="ln">5179 </span></a> <span class="s5">* support async iterators.</span>
<a name="l5180"><span class="ln">5180 </span></a> <span class="s5">*</span>
<a name="l5181"><span class="ln">5181 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">[Symbol.asyncIterator]</span>
<a name="l5182"><span class="ln">5182 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5183"><span class="ln">5183 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5184"><span class="ln">5184 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5185"><span class="ln">5185 </span></a> <span class="s5">*/</span>
<a name="l5186"><span class="ln">5186 </span></a>
<a name="l5187"><span class="ln">5187 </span></a><span class="s4">if </span><span class="s1">(</span><span class="s2">Symbol</span><span class="s1">.</span><span class="s2">asyncIterator </span><span class="s1">!= </span><span class="s4">null</span><span class="s1">) {</span>
<a name="l5188"><span class="ln">5188 </span></a>  <span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">[</span><span class="s2">Symbol</span><span class="s1">.</span><span class="s2">asyncIterator</span><span class="s1">] = </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l5189"><span class="ln">5189 </span></a>    <span class="s4">return this</span><span class="s1">.</span><span class="s2">cursor</span><span class="s1">().</span><span class="s2">transformNull</span><span class="s1">().</span><span class="s2">_transformForAsyncIterator</span><span class="s1">();</span>
<a name="l5190"><span class="ln">5190 </span></a>  <span class="s1">};</span>
<a name="l5191"><span class="ln">5191 </span></a><span class="s1">}</span>
<a name="l5192"><span class="ln">5192 </span></a>
<a name="l5193"><span class="ln">5193 </span></a><span class="s5">/**</span>
<a name="l5194"><span class="ln">5194 </span></a> <span class="s5">* Specifies a `$polygon` condition</span>
<a name="l5195"><span class="ln">5195 </span></a> <span class="s5">*</span>
<a name="l5196"><span class="ln">5196 </span></a> <span class="s5">* #### Example:</span>
<a name="l5197"><span class="ln">5197 </span></a> <span class="s5">*</span>
<a name="l5198"><span class="ln">5198 </span></a> <span class="s5">*     query.where('loc').within().polygon([10, 20], [13, 25], [7, 15]);</span>
<a name="l5199"><span class="ln">5199 </span></a> <span class="s5">*     query.polygon('loc', [10, 20], [13, 25], [7, 15]);</span>
<a name="l5200"><span class="ln">5200 </span></a> <span class="s5">*</span>
<a name="l5201"><span class="ln">5201 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">polygon</span>
<a name="l5202"><span class="ln">5202 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5203"><span class="ln">5203 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5204"><span class="ln">5204 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String|Array} [path]</span>
<a name="l5205"><span class="ln">5205 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{...Array|Object} [coordinatePairs]</span>
<a name="l5206"><span class="ln">5206 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l5207"><span class="ln">5207 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$polygon https://www.mongodb.com/docs/manual/reference/operator/polygon/</span>
<a name="l5208"><span class="ln">5208 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB Geospatial Indexing https://www.mongodb.com/docs/manual/core/geospatial-indexes/</span>
<a name="l5209"><span class="ln">5209 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5210"><span class="ln">5210 </span></a> <span class="s5">*/</span>
<a name="l5211"><span class="ln">5211 </span></a>
<a name="l5212"><span class="ln">5212 </span></a><span class="s5">/**</span>
<a name="l5213"><span class="ln">5213 </span></a> <span class="s5">* Specifies a `$box` condition</span>
<a name="l5214"><span class="ln">5214 </span></a> <span class="s5">*</span>
<a name="l5215"><span class="ln">5215 </span></a> <span class="s5">* #### Example:</span>
<a name="l5216"><span class="ln">5216 </span></a> <span class="s5">*</span>
<a name="l5217"><span class="ln">5217 </span></a> <span class="s5">*     const lowerLeft = [40.73083, -73.99756]</span>
<a name="l5218"><span class="ln">5218 </span></a> <span class="s5">*     const upperRight= [40.741404,  -73.988135]</span>
<a name="l5219"><span class="ln">5219 </span></a> <span class="s5">*</span>
<a name="l5220"><span class="ln">5220 </span></a> <span class="s5">*     query.where('loc').within().box(lowerLeft, upperRight)</span>
<a name="l5221"><span class="ln">5221 </span></a> <span class="s5">*     query.box({ ll : lowerLeft, ur : upperRight })</span>
<a name="l5222"><span class="ln">5222 </span></a> <span class="s5">*</span>
<a name="l5223"><span class="ln">5223 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">box</span>
<a name="l5224"><span class="ln">5224 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5225"><span class="ln">5225 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5226"><span class="ln">5226 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$box https://www.mongodb.com/docs/manual/reference/operator/box/</span>
<a name="l5227"><span class="ln">5227 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">within() Query#within https://mongoosejs.com/docs/api/query.html#Query.prototype.within()</span>
<a name="l5228"><span class="ln">5228 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB Geospatial Indexing https://www.mongodb.com/docs/manual/core/geospatial-indexes/</span>
<a name="l5229"><span class="ln">5229 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object|Array&lt;Number&gt;} val1 Lower Left Coordinates OR a object of lower-left(ll) and upper-right(ur) Coordinates</span>
<a name="l5230"><span class="ln">5230 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Array&lt;Number&gt;} [val2] Upper Right Coordinates</span>
<a name="l5231"><span class="ln">5231 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l5232"><span class="ln">5232 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5233"><span class="ln">5233 </span></a> <span class="s5">*/</span>
<a name="l5234"><span class="ln">5234 </span></a>
<a name="l5235"><span class="ln">5235 </span></a><span class="s5">/**</span>
<a name="l5236"><span class="ln">5236 </span></a> <span class="s5">* this is needed to support the mongoose syntax of:</span>
<a name="l5237"><span class="ln">5237 </span></a> <span class="s5">* box(field, { ll : [x,y], ur : [x2,y2] })</span>
<a name="l5238"><span class="ln">5238 </span></a> <span class="s5">* box({ ll : [x,y], ur : [x2,y2] })</span>
<a name="l5239"><span class="ln">5239 </span></a> <span class="s5">*</span>
<a name="l5240"><span class="ln">5240 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">box</span>
<a name="l5241"><span class="ln">5241 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5242"><span class="ln">5242 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5243"><span class="ln">5243 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">private</span>
<a name="l5244"><span class="ln">5244 </span></a> <span class="s5">*/</span>
<a name="l5245"><span class="ln">5245 </span></a>
<a name="l5246"><span class="ln">5246 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">box </span><span class="s1">= </span><span class="s4">function</span><span class="s1">(</span><span class="s2">ll</span><span class="s1">, </span><span class="s2">ur</span><span class="s1">) {</span>
<a name="l5247"><span class="ln">5247 </span></a>  <span class="s4">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">ll</span><span class="s1">) &amp;&amp; </span><span class="s2">utils</span><span class="s1">.</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">ll</span><span class="s1">)) {</span>
<a name="l5248"><span class="ln">5248 </span></a>    <span class="s2">ur </span><span class="s1">= </span><span class="s2">ll</span><span class="s1">.</span><span class="s2">ur</span><span class="s1">;</span>
<a name="l5249"><span class="ln">5249 </span></a>    <span class="s2">ll </span><span class="s1">= </span><span class="s2">ll</span><span class="s1">.</span><span class="s2">ll</span><span class="s1">;</span>
<a name="l5250"><span class="ln">5250 </span></a>  <span class="s1">}</span>
<a name="l5251"><span class="ln">5251 </span></a>  <span class="s4">return </span><span class="s2">Query</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">box</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">ll</span><span class="s1">, </span><span class="s2">ur</span><span class="s1">);</span>
<a name="l5252"><span class="ln">5252 </span></a><span class="s1">};</span>
<a name="l5253"><span class="ln">5253 </span></a>
<a name="l5254"><span class="ln">5254 </span></a><span class="s5">/**</span>
<a name="l5255"><span class="ln">5255 </span></a> <span class="s5">* Specifies a `$center` or `$centerSphere` condition.</span>
<a name="l5256"><span class="ln">5256 </span></a> <span class="s5">*</span>
<a name="l5257"><span class="ln">5257 </span></a> <span class="s5">* #### Example:</span>
<a name="l5258"><span class="ln">5258 </span></a> <span class="s5">*</span>
<a name="l5259"><span class="ln">5259 </span></a> <span class="s5">*     const area = { center: [50, 50], radius: 10, unique: true }</span>
<a name="l5260"><span class="ln">5260 </span></a> <span class="s5">*     query.where('loc').within().circle(area)</span>
<a name="l5261"><span class="ln">5261 </span></a> <span class="s5">*     // alternatively</span>
<a name="l5262"><span class="ln">5262 </span></a> <span class="s5">*     query.circle('loc', area);</span>
<a name="l5263"><span class="ln">5263 </span></a> <span class="s5">*</span>
<a name="l5264"><span class="ln">5264 </span></a> <span class="s5">*     // spherical calculations</span>
<a name="l5265"><span class="ln">5265 </span></a> <span class="s5">*     const area = { center: [50, 50], radius: 10, unique: true, spherical: true }</span>
<a name="l5266"><span class="ln">5266 </span></a> <span class="s5">*     query.where('loc').within().circle(area)</span>
<a name="l5267"><span class="ln">5267 </span></a> <span class="s5">*     // alternatively</span>
<a name="l5268"><span class="ln">5268 </span></a> <span class="s5">*     query.circle('loc', area);</span>
<a name="l5269"><span class="ln">5269 </span></a> <span class="s5">*</span>
<a name="l5270"><span class="ln">5270 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">circle</span>
<a name="l5271"><span class="ln">5271 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5272"><span class="ln">5272 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5273"><span class="ln">5273 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l5274"><span class="ln">5274 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} area</span>
<a name="l5275"><span class="ln">5275 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l5276"><span class="ln">5276 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$center https://www.mongodb.com/docs/manual/reference/operator/center/</span>
<a name="l5277"><span class="ln">5277 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$centerSphere https://www.mongodb.com/docs/manual/reference/operator/centerSphere/</span>
<a name="l5278"><span class="ln">5278 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$geoWithin https://www.mongodb.com/docs/manual/reference/operator/geoWithin/</span>
<a name="l5279"><span class="ln">5279 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB Geospatial Indexing https://www.mongodb.com/docs/manual/core/geospatial-indexes/</span>
<a name="l5280"><span class="ln">5280 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5281"><span class="ln">5281 </span></a> <span class="s5">*/</span>
<a name="l5282"><span class="ln">5282 </span></a>
<a name="l5283"><span class="ln">5283 </span></a><span class="s5">/**</span>
<a name="l5284"><span class="ln">5284 </span></a> <span class="s5">* _DEPRECATED_ Alias for [circle](https://mongoosejs.com/docs/api/query.html#Query.prototype.circle())</span>
<a name="l5285"><span class="ln">5285 </span></a> <span class="s5">*</span>
<a name="l5286"><span class="ln">5286 </span></a> <span class="s5">* **Deprecated.** Use [circle](https://mongoosejs.com/docs/api/query.html#Query.prototype.circle()) instead.</span>
<a name="l5287"><span class="ln">5287 </span></a> <span class="s5">*</span>
<a name="l5288"><span class="ln">5288 </span></a> <span class="s5">* </span><span class="s6">@deprecated</span>
<a name="l5289"><span class="ln">5289 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">center</span>
<a name="l5290"><span class="ln">5290 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5291"><span class="ln">5291 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5292"><span class="ln">5292 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5293"><span class="ln">5293 </span></a> <span class="s5">*/</span>
<a name="l5294"><span class="ln">5294 </span></a>
<a name="l5295"><span class="ln">5295 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">center </span><span class="s1">= </span><span class="s2">Query</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">circle</span><span class="s1">;</span>
<a name="l5296"><span class="ln">5296 </span></a>
<a name="l5297"><span class="ln">5297 </span></a><span class="s5">/**</span>
<a name="l5298"><span class="ln">5298 </span></a> <span class="s5">* _DEPRECATED_ Specifies a `$centerSphere` condition</span>
<a name="l5299"><span class="ln">5299 </span></a> <span class="s5">*</span>
<a name="l5300"><span class="ln">5300 </span></a> <span class="s5">* **Deprecated.** Use [circle](https://mongoosejs.com/docs/api/query.html#Query.prototype.circle()) instead.</span>
<a name="l5301"><span class="ln">5301 </span></a> <span class="s5">*</span>
<a name="l5302"><span class="ln">5302 </span></a> <span class="s5">* #### Example:</span>
<a name="l5303"><span class="ln">5303 </span></a> <span class="s5">*</span>
<a name="l5304"><span class="ln">5304 </span></a> <span class="s5">*     const area = { center: [50, 50], radius: 10 };</span>
<a name="l5305"><span class="ln">5305 </span></a> <span class="s5">*     query.where('loc').within().centerSphere(area);</span>
<a name="l5306"><span class="ln">5306 </span></a> <span class="s5">*</span>
<a name="l5307"><span class="ln">5307 </span></a> <span class="s5">* </span><span class="s6">@deprecated</span>
<a name="l5308"><span class="ln">5308 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{String} [path]</span>
<a name="l5309"><span class="ln">5309 </span></a> <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} val</span>
<a name="l5310"><span class="ln">5310 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Query} this</span>
<a name="l5311"><span class="ln">5311 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">MongoDB Geospatial Indexing https://www.mongodb.com/docs/manual/core/geospatial-indexes/</span>
<a name="l5312"><span class="ln">5312 </span></a> <span class="s5">* </span><span class="s6">@see </span><span class="s5">$centerSphere https://www.mongodb.com/docs/manual/reference/operator/centerSphere/</span>
<a name="l5313"><span class="ln">5313 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5314"><span class="ln">5314 </span></a> <span class="s5">*/</span>
<a name="l5315"><span class="ln">5315 </span></a>
<a name="l5316"><span class="ln">5316 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">centerSphere </span><span class="s1">= </span><span class="s4">function</span><span class="s1">() {</span>
<a name="l5317"><span class="ln">5317 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] != </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">].</span><span class="s2">constructor </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">&amp;&amp; </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">].</span><span class="s2">constructor</span><span class="s1">.</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">'Object'</span><span class="s1">) {</span>
<a name="l5318"><span class="ln">5318 </span></a>    <span class="s2">arguments</span><span class="s1">[</span><span class="s7">0</span><span class="s1">].</span><span class="s2">spherical </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l5319"><span class="ln">5319 </span></a>  <span class="s1">}</span>
<a name="l5320"><span class="ln">5320 </span></a>
<a name="l5321"><span class="ln">5321 </span></a>  <span class="s4">if </span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">] != </span><span class="s4">null </span><span class="s1">&amp;&amp; </span><span class="s4">typeof </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">].</span><span class="s2">constructor </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">&amp;&amp; </span><span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">].</span><span class="s2">constructor</span><span class="s1">.</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">'Object'</span><span class="s1">) {</span>
<a name="l5322"><span class="ln">5322 </span></a>    <span class="s2">arguments</span><span class="s1">[</span><span class="s7">1</span><span class="s1">].</span><span class="s2">spherical </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
<a name="l5323"><span class="ln">5323 </span></a>  <span class="s1">}</span>
<a name="l5324"><span class="ln">5324 </span></a>
<a name="l5325"><span class="ln">5325 </span></a>  <span class="s2">Query</span><span class="s1">.</span><span class="s2">base</span><span class="s1">.</span><span class="s2">circle</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">arguments</span><span class="s1">);</span>
<a name="l5326"><span class="ln">5326 </span></a><span class="s1">};</span>
<a name="l5327"><span class="ln">5327 </span></a>
<a name="l5328"><span class="ln">5328 </span></a><span class="s5">/**</span>
<a name="l5329"><span class="ln">5329 </span></a> <span class="s5">* Determines if field selection has been made.</span>
<a name="l5330"><span class="ln">5330 </span></a> <span class="s5">*</span>
<a name="l5331"><span class="ln">5331 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">selected</span>
<a name="l5332"><span class="ln">5332 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5333"><span class="ln">5333 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5334"><span class="ln">5334 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Boolean}</span>
<a name="l5335"><span class="ln">5335 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5336"><span class="ln">5336 </span></a> <span class="s5">*/</span>
<a name="l5337"><span class="ln">5337 </span></a>
<a name="l5338"><span class="ln">5338 </span></a><span class="s5">/**</span>
<a name="l5339"><span class="ln">5339 </span></a> <span class="s5">* Determines if inclusive field selection has been made.</span>
<a name="l5340"><span class="ln">5340 </span></a> <span class="s5">*</span>
<a name="l5341"><span class="ln">5341 </span></a> <span class="s5">*     query.selectedInclusively(); // false</span>
<a name="l5342"><span class="ln">5342 </span></a> <span class="s5">*     query.select('name');</span>
<a name="l5343"><span class="ln">5343 </span></a> <span class="s5">*     query.selectedInclusively(); // true</span>
<a name="l5344"><span class="ln">5344 </span></a> <span class="s5">*</span>
<a name="l5345"><span class="ln">5345 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">selectedInclusively</span>
<a name="l5346"><span class="ln">5346 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5347"><span class="ln">5347 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5348"><span class="ln">5348 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Boolean}</span>
<a name="l5349"><span class="ln">5349 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5350"><span class="ln">5350 </span></a> <span class="s5">*/</span>
<a name="l5351"><span class="ln">5351 </span></a>
<a name="l5352"><span class="ln">5352 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">selectedInclusively </span><span class="s1">= </span><span class="s4">function </span><span class="s2">selectedInclusively</span><span class="s1">() {</span>
<a name="l5353"><span class="ln">5353 </span></a>  <span class="s4">return </span><span class="s2">isInclusive</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l5354"><span class="ln">5354 </span></a><span class="s1">};</span>
<a name="l5355"><span class="ln">5355 </span></a>
<a name="l5356"><span class="ln">5356 </span></a><span class="s5">/**</span>
<a name="l5357"><span class="ln">5357 </span></a> <span class="s5">* Determines if exclusive field selection has been made.</span>
<a name="l5358"><span class="ln">5358 </span></a> <span class="s5">*</span>
<a name="l5359"><span class="ln">5359 </span></a> <span class="s5">*     query.selectedExclusively(); // false</span>
<a name="l5360"><span class="ln">5360 </span></a> <span class="s5">*     query.select('-name');</span>
<a name="l5361"><span class="ln">5361 </span></a> <span class="s5">*     query.selectedExclusively(); // true</span>
<a name="l5362"><span class="ln">5362 </span></a> <span class="s5">*     query.selectedInclusively(); // false</span>
<a name="l5363"><span class="ln">5363 </span></a> <span class="s5">*</span>
<a name="l5364"><span class="ln">5364 </span></a> <span class="s5">* </span><span class="s6">@method </span><span class="s5">selectedExclusively</span>
<a name="l5365"><span class="ln">5365 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5366"><span class="ln">5366 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5367"><span class="ln">5367 </span></a> <span class="s5">* </span><span class="s6">@return </span><span class="s5">{Boolean}</span>
<a name="l5368"><span class="ln">5368 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5369"><span class="ln">5369 </span></a> <span class="s5">*/</span>
<a name="l5370"><span class="ln">5370 </span></a>
<a name="l5371"><span class="ln">5371 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">selectedExclusively </span><span class="s1">= </span><span class="s4">function </span><span class="s2">selectedExclusively</span><span class="s1">() {</span>
<a name="l5372"><span class="ln">5372 </span></a>  <span class="s4">return </span><span class="s2">isExclusive</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">_fields</span><span class="s1">);</span>
<a name="l5373"><span class="ln">5373 </span></a><span class="s1">};</span>
<a name="l5374"><span class="ln">5374 </span></a>
<a name="l5375"><span class="ln">5375 </span></a><span class="s5">/**</span>
<a name="l5376"><span class="ln">5376 </span></a> <span class="s5">* The model this query is associated with.</span>
<a name="l5377"><span class="ln">5377 </span></a> <span class="s5">*</span>
<a name="l5378"><span class="ln">5378 </span></a> <span class="s5">* #### Example:</span>
<a name="l5379"><span class="ln">5379 </span></a> <span class="s5">*</span>
<a name="l5380"><span class="ln">5380 </span></a> <span class="s5">*     const q = MyModel.find();</span>
<a name="l5381"><span class="ln">5381 </span></a> <span class="s5">*     q.model === MyModel; // true</span>
<a name="l5382"><span class="ln">5382 </span></a> <span class="s5">*</span>
<a name="l5383"><span class="ln">5383 </span></a> <span class="s5">* </span><span class="s6">@api </span><span class="s5">public</span>
<a name="l5384"><span class="ln">5384 </span></a> <span class="s5">* </span><span class="s6">@property </span><span class="s5">model</span>
<a name="l5385"><span class="ln">5385 </span></a> <span class="s5">* </span><span class="s6">@memberOf </span><span class="s5">Query</span>
<a name="l5386"><span class="ln">5386 </span></a> <span class="s5">* </span><span class="s6">@instance</span>
<a name="l5387"><span class="ln">5387 </span></a> <span class="s5">*/</span>
<a name="l5388"><span class="ln">5388 </span></a>
<a name="l5389"><span class="ln">5389 </span></a><span class="s2">Query</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">model</span><span class="s1">;</span>
<a name="l5390"><span class="ln">5390 </span></a>
<a name="l5391"><span class="ln">5391 </span></a><span class="s3">/*! 
<a name="l5392"><span class="ln">5392 </span></a> * Export 
<a name="l5393"><span class="ln">5393 </span></a> */</span>
<a name="l5394"><span class="ln">5394 </span></a>
<a name="l5395"><span class="ln">5395 </span></a><span class="s2">module</span><span class="s1">.</span><span class="s2">exports </span><span class="s1">= </span><span class="s2">Query</span><span class="s1">;</span>
<a name="l5396"><span class="ln">5396 </span></a></pre>
</body>
</html>